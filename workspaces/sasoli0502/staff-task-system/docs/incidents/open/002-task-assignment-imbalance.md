# インシデント #002: タスク配置の不均衡問題

## 概要
2025-10-31のタスク配置において、特定のスタッフ（須加尾さん）に過重な負荷がかかり、大量の未割当タスクが発生している問題。

## 発生日時
2025-10-31

## 影響範囲
- 須加尾さん: 73件のタスク（過重負荷）
- 未割当タスク: 90件（全タスクの27%）
- 業務効率の大幅な低下

## 問題の詳細

### 1. タスク配置の現状

#### スタッフ別タスク数
| スタッフ | タスク数 | 内訳 |
|---------|---------|------|
| **須加尾** | **73件** | 発送準備30件、送り状作成30件、査定7件、開封6件 |
| 雜賀 | 51件 | 修理30件、査定7件、開封6件、出品8件 |
| 佐々木 | 27件 | 査定6件、検品7件、開封6件、出品8件 |
| 細谷 | 27件 | 査定5件、検品8件、開封6件、出品8件 |
| 高橋 | 11件 | 査定5件、開封6件 |
| **未割当** | **90件** | 査定30件、アクティベート30件、出品24件など |

#### タスク種別の状況
| タスク種別 | 合計 | 完了 | 未着手 | 主な割当先 |
|-----------|-----|------|--------|-----------|
| アクティベート | 30件 | 0件 | 30件 | **全て未割当** |
| 査定 | 60件 | 7件 | 53件 | 未割当30件、他スタッフ分散 |
| 修理 | 45件 | 5件 | 40件 | 雜賀30件、未割当15件 |
| 出品 | 48件 | 6件 | 42件 | 未割当24件、他スタッフ分散 |
| 検品 | 30件 | 6件 | 24件 | 未割当15件、他スタッフ分散 |
| 開封 | 60件 | 30件 | 30件 | 未割当30件、他スタッフ分散 |
| **発送準備** | **30件** | **0件** | **30件** | **全て須加尾** |
| **送り状作成** | **30件** | **0件** | **30件** | **全て須加尾** |

### 2. 問題発生の経緯

#### 10:00 - 朝のタスク生成
- **生成件数**: 144件
- **割り当て状況**: すべて未割当（`assigned_to: null`）
- **タスク種別**: 査定、修理、検品、出品、開封、アクティベート
- **notes**: "10:00に自動追加"

```bash
# 実行されたコマンド（推測）
uv run python scripts/input_morning_summary.py --satei 30 --kaifuu 30
uv run python scripts/add_scheduled_tasks.py --time 10:00
```

#### 13:00 - 午後のタスク生成
- **生成件数**: 60件
- **割り当て状況**: すべて須加尾さんに割り当て
- **タスク種別**: 発送準備30件、送り状作成30件
- **notes**: "13:00に自動追加"

```bash
# 実行されたコマンド（推測）
uv run python scripts/input_afternoon_summary.py --time 13:00 --hassou-junbi 30
uv run python scripts/add_scheduled_tasks.py --time 13:00
```

**⚠️ 問題点**: なぜ須加尾さんに自動割り当てされたのか不明
- `add_scheduled_tasks.py`のコード（186行目）では`'assigned_to': None`となっている
- `task-types.yaml`にも自動割り当ての設定なし
- `role-assignments.yaml`も存在しない

#### その後 - 役割分担の実行
- 一部のタスクが各スタッフに割り当てられた
- しかし、**metadata.total_staff = 0**となっており、役割分担が正常に完了していない可能性

### 3. 根本原因の推測

以下の可能性が考えられる：

#### A. `add_scheduled_tasks.py`のバグ
- 13:00の時間帯に限り、特定のスタッフに自動割り当てするロジックが隠れている？
- しかし、コードレビューでは見つからず

#### B. 手動での割り当て
- 誰かが手動でYAMLファイルを編集して須加尾さんに割り当てた？
- しかし、60件すべてを手動で割り当てるのは非現実的

#### C. `suggest_assignments.py`の実行
- 役割分担スクリプトが実行され、発送準備と送り状作成を須加尾さんに割り当てた
- スタッフリストに須加尾さんしか含まれていなかった？

```bash
# 実行されたコマンド（推測）
uv run python scripts/suggest_assignments.py --staff "須加尾" --auto-create
```

#### D. デフォルト割り当てのロジック
- 発送準備と送り状作成に対して、暗黙的なデフォルト担当者が設定されている？
- しかし、そのような設定は見つからず

## 影響

### 業務への影響
1. **須加尾さんの過重負荷**
   - 73件のタスクは1日で完了不可能（予想所要時間: 約8時間）
   - 発送業務が滞る可能性

2. **他スタッフのリソース浪費**
   - 他のスタッフは比較的軽い負荷（11-51件）
   - スキルを持っているのに活用されていない

3. **未割当タスクの放置**
   - 90件の未割当タスク（特にアクティベート30件）が放置
   - 業務が進まない

## 対応策

### 短期対応（今すぐ実施）

#### 1. 須加尾さんのタスクを再配分
```bash
# 発送準備を他のスタッフに移す
uv run python scripts/show_staff.py --skill 発送準備
# → 発送準備ができるスタッフを確認

# タスクを再割り当て（手動）
# ※ 現時点ではタスク再割り当てスクリプトが存在しないため、手動でYAMLを編集する必要がある
```

#### 2. 未割当タスクを配分
```bash
# 出勤しているスタッフを確認
uv run python scripts/show_staff.py

# 役割分担を再実行
uv run python scripts/suggest_assignments.py --staff "佐々木,細谷,雜賀,高橋,須加尾" --auto-create
```

### 中期対応（1週間以内）

#### 1. タスク再割り当てスクリプトの作成
- 既存タスクの担当者を変更できるスクリプトを作成
- 例: `scripts/reassign_task.py`

#### 2. 役割分担の見直し
- 発送準備・送り状作成のデフォルト担当者を複数人に分散
- `config/role-assignments.yaml`を作成し、明示的なルールを定義

#### 3. 自動割り当てロジックの透明化
- `add_scheduled_tasks.py`で自動割り当てを行う場合、明確にログ出力
- 割り当て理由をnotesに記録

### 長期対応（1ヶ月以内）

#### 1. バランシングアルゴリズムの実装
- スタッフの稼働状況を考慮した自動配分
- 各スタッフの実働時間を均等化

#### 2. リアルタイムモニタリング
- ダッシュボードでスタッフ別のタスク負荷を可視化
- 偏りが発生したら自動アラート

#### 3. 柔軟な再配分機能
- タスク開始前なら簡単に再配分できる仕組み
- スタッフ間でタスクを移譲できる機能

## 再発防止策

### 運用ルール
1. **タスク生成後は必ず役割分担を実行**
   ```bash
   uv run python scripts/add_scheduled_tasks.py --time 13:00
   uv run python scripts/suggest_assignments.py --staff "..." --auto-create  # 忘れずに実行
   ```

2. **タスク配置の確認を習慣化**
   ```bash
   uv run python scripts/show_status.py  # タスク生成後に必ず確認
   ```

3. **特定スタッフへの偏りをチェック**
   - 1人あたり50件以上は警告
   - 未割当タスクが30件以上は警告

### システム改善
1. **自動バリデーションの追加**
   - タスク生成時に配置の偏りをチェック
   - 問題があれば警告を表示

2. **デフォルト割り当てルールの文書化**
   - `config/role-assignments.yaml`に明記
   - スクリプト実行時にルールを表示

## 関連ドキュメント
- [scripts/add_scheduled_tasks.py](../../scripts/add_scheduled_tasks.py)
- [scripts/suggest_assignments.py](../../scripts/suggest_assignments.py)
- [config/task-types.yaml](../../config/task-types.yaml)

## ステータス
**Open** - 調査完了、対応待ち

## 担当者
野口 器

## 更新履歴
- 2025-10-31: インシデント作成、根本原因の調査
