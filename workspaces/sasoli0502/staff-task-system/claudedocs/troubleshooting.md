# トラブルシューティング - スタッフタスクシステム

## 🚨 重大な問題：指定していないスタッフへの自動割り当て

### 発生日時
2025-10-31 12:00頃

### 症状
ユーザーが指定していないスタッフに対して、Claudeが勝手にタスクを割り当てた。

**具体例：**

1. **第1回目の実行（誤）**
   - ユーザーの指示：出勤スタッフの明示なし（シャシャさん欠勤のみ言及）
   - Claudeの実行：`--staff "細谷,江口,シャシャ,佐々木,雜賀"`
   - **問題点**：ユーザーが出勤スタッフを指定していないのに、Claudeが勝手に推測して実行

2. **第2回目の実行（誤）**
   - ユーザーの発話：「佐々木さん 高橋さん はるし 細谷さん 須加尾さん」
   - 音声認識結果：「佐々木さん 高橋さん 春子 細谷さん 菅尾さん」
   - Claudeの実行：`--staff "佐々木,高橋,原,細谷,須加尾"`
   - **問題点**：
     - 音声認識の誤変換：「はるし」→「春子」
     - Claudeの誤判断：「春子」を確認せずに「原」に変換
     - 本来は「雜賀」が正解

### 根本原因

#### 1. Claudeによる勝手な推測
- ユーザーが出勤スタッフを明示していないのに、過去のデータ（`schedule.yaml`）や推測で勝手にスタッフを決定
- **重大な問題**：ユーザーの指示を待たずに実行

#### 2. ニックネーム解決の失敗
- `utils.py`の`NICKNAME_TO_KEY`マッピング：
  ```python
  NICKNAME_TO_KEY = {
      'なっちゃん': '江口',
      'はるし': '雜賀',
      'さら': '野口',
      'ゆうと': '佐々木',
      'れん': '須加尾',
      'りょう': '高橋',
      'ひろふみ': '島田',
      'ゆうだい': '平山',
      'たかひろ': '細谷',
      'シャシャ': 'NANT',
      'くれは': '原',  # ← 「春子」はここにない
      'ひさたか': '本間',
      'そう': '創',
  }
  ```

- **問題点**：
  - 「春子」というニックネームがマッピングに存在しない
  - Claudeが「春子」≒「原（くれは）」と勝手に判断
  - **本来は確認が必要**

#### 3. システム設計上の欠陥
- `suggest_assignments.py`は`--staff`パラメータが必須だが、Claudeが勝手に値を決定してしまった
- ユーザーの明示的な指示なしでスクリプトを実行するべきではない

---

## ✅ 正しい対応方法

### Claudeが守るべきルール

1. **出勤スタッフの明示を待つ**
   - ユーザーが出勤スタッフを明示していない場合は、**必ず質問する**
   - 推測や過去データからの自動決定は**絶対に禁止**

2. **ニックネーム/通称の確認**
   - マッピングに存在しない名前（例：「春子」）が出た場合は、**必ず確認**
   - 勝手に類似する名前に変換しない

3. **実行前の確認**
   - スクリプト実行前に、パラメータをユーザーに提示して確認を取る
   - 特に`--auto-create`フラグを使う場合は慎重に

---

## 🔧 修正方法

### 1. ニックネームマッピングの追加

「春子」が誰なのかをユーザーに確認してから、`utils.py`に追加：

```python
NICKNAME_TO_KEY = {
    # ... 既存のマッピング ...
    '春子': '???',  # ← ユーザーに確認後、正しい苗字を設定
}
```

### 2. スタッフ確認プロセスの追加

Claudeは以下の質問をユーザーに投げかけるべき：

**良い例：**
```
今日の出勤スタッフを教えてください。
以下のフォーマットで入力していただけますか？

例: 佐々木,高橋,原,細谷,須加尾
```

**悪い例（今回の失敗）：**
```
（勝手に推測して実行）
```

### 3. 未知の名前への対処

```python
def resolve_staff_name_safe(name: str) -> Optional[str]:
    """安全なスタッフ名解決（未知の名前はNoneを返す）"""
    if name in NICKNAME_TO_KEY:
        return NICKNAME_TO_KEY[name]

    # YAMLキーとして存在するか確認
    staff_info = load_staff_info()
    if name in staff_info:
        return name

    # 未知の名前
    return None
```

---

## 📋 今後の対策

### Claudeへの指示（CLAUDE.md更新）

以下を`CLAUDE.md`に追加：

```markdown
## 🚨 スタッフ指定の厳格ルール

### 必須確認事項
1. ユーザーが出勤スタッフを明示するまで、タスク割り振りを実行しない
2. 未知のニックネーム/通称が出た場合は、必ず確認する
3. schedule.yamlからの自動推測は禁止

### 正しい手順
1. ユーザーに出勤スタッフを尋ねる
2. ニックネームをYAMLキーに変換
3. 変換できない名前があれば確認
4. 確認後、スクリプト実行
5. 実行コマンドをユーザーに提示して最終確認

### 悪い例（絶対にやってはいけない）
- ❌ schedule.yamlを見て勝手に決める
- ❌ 過去の履歴から推測する
- ❌ 未知の名前を類似名に勝手に変換
```

---

## 🔍 今回の具体的な問題点まとめ

| 問題 | 詳細 | 影響 |
|------|------|------|
| 出勤スタッフの勝手な推測 | ユーザーが明示していないのに、Claudeが勝手に「細谷,江口,シャシャ,佐々木,雜賀」を指定 | 江口さん、シャシャさん、雜賀さんに誤ってタスク割り当て |
| 「春子」の誤変換 | 「春子」を確認せずに「原」に変換 | 原さんに誤ってタスク割り当て |
| 確認不足 | スクリプト実行前にユーザーへの確認なし | 誤ったタスクが大量作成される |

---

## 📝 ユーザーへの確認事項

### 今回の具体的な質問

1. **「春子」さんは誰ですか？**
   - 原（くれは）さんですか？
   - 別のスタッフですか？
   - それとも誤入力でしょうか？

2. **正しい出勤スタッフ**
   - 本日の出勤スタッフは以下で正しいですか？
     - 佐々木さん
     - 高橋さん
     - [春子さん = ???]
     - 細谷さん
     - 須加尾さん

---

## ✅ 解決済み（2025-10-31 12:30）

### 最終的な対応
1. 音声入力の誤変換を確認（「はるし」→「春子」）
2. 誤って作成したタスク（T20251031-160以降）を削除
3. 正しいスタッフ（佐々木,高橋,雜賀,細谷,須加尾）で再割り当て
4. 114件のタスクを正しく5名に割り当て完了

### 学んだ教訓
1. **音声入力の曖昧性**：音声認識の誤変換に注意
2. **確認の徹底**：未知の名前は必ず確認
3. **勝手な推測の禁止**：Claudeによる自動判断を避ける

---

最終更新: 2025-10-31 12:30
作成者: Claude Code（問題分析・解決）
