# 作業手順（2025-11-20～）

## 📅 現在の状況と方針

- **価格変更日**: 2025-11-19（火）
- **買取価格**: 変更前・変更後のCSVあり
- **効果計測システム**: 構築完了
- **価格変更履歴**: 生成完了（517件の変更記録）

### ⚠️ 重要：今回は練習期間

**過去のLINE仮査定データが取得できないため、今回の11/19価格変更の効果分析は実施できません。**

**この期間は以下の目的で活用します**:
1. データ収集フローの確立（毎日の運用に慣れる）
2. CSVフォーマットの確認と調整
3. システムの動作確認とテスト
4. **次回の価格変更時に備える準備**

### 🎯 次回の価格変更時の正しい手順

**必ず価格変更の1週間前からデータ収集を開始すること！**

```
例: 12/10に価格変更する場合
- 12/3～12/9: 変更前データ収集（7日間）
- 12/10: 価格変更実施
- 12/10～12/16: 変更後データ収集（7日間）
- 12/17: 効果分析実行
```

---

## ✅ 今日やること（2025-11-20）

### 1. ✅ 価格変更履歴の生成（完了済み）

```bash
cd /Users/noguchisara/projects/work/iphone-market-research/price-impact-analysis
uv run python scripts/create_price_change_log.py --auto
```

**結果**:
- ✅ `data/price_changes/price_changes.csv` に517件の変更記録を生成済み
- ✅ 値上げ: 262件、値下げ: 255件

---

### 2. ✅ 環境セットアップ（完了済み）

```bash
cd /Users/noguchisara/projects/work/iphone-market-research/price-impact-analysis
uv sync
```

**結果**:
- ✅ 依存パッケージのインストール完了
- ✅ pyproject.tomlの修正完了

---

### 3. データ収集の準備（練習期間）

#### 3-1. 練習として収集するデータ

**11/19以降のデータを毎日収集**（練習期間）:
- [ ] LINE仮査定データ（不良なし）- 毎日収集
- [ ] 梱包キット数 - 毎日収集
- [ ] 集荷要請数 - 毎日収集

**目的**:
- CSVフォーマットの確認
- 収集フローの習熟
- システムの動作テスト

#### 3-2. CSVフォーマットの確認

実際のCSVを1つ開いて、以下を確認：

**LINE仮査定データ**:
- カラム名: `日付`, `機種`, `容量`, `ランク`, `仮査定数`, `不良有無` など
- 不良有無の値: `無/有`, `0/1`, `False/True` のどれか

**梱包キット数・集荷要請数**:
- カラム名: `日付`, `機種`, `容量`, `ランク`, `キット数`/`集荷数` など

→ **カラム名が異なる場合は、`scripts/collect_data.py` の `COLUMN_MAPPING` を修正**

---

### 4. データ配置（練習期間）

収集したCSVを以下に配置：

```
price-impact-analysis/data/raw/
├── line_estimates/
│   ├── line_estimates_20251119.csv  ← 11/19分から開始
│   ├── line_estimates_20251120.csv  ← 今日の分
│   └── line_estimates_20251121.csv  ← 明日の分...
│
├── packing_kits/
│   ├── packing_kits_20251119.csv
│   ├── packing_kits_20251120.csv
│   └── ...
│
└── pickup_requests/
    ├── pickup_requests_20251119.csv
    ├── pickup_requests_20251120.csv
    └── ...
```

**ファイル名の規則**:
- `line_estimates_YYYYMMDD.csv`
- `packing_kits_YYYYMMDD.csv`
- `pickup_requests_YYYYMMDD.csv`

---

### 5. データ収集テスト（データが1-2日分揃ったら）

```bash
cd /Users/noguchisara/projects/work/iphone-market-research/price-impact-analysis

# データ収集・整形スクリプトを実行
uv run python scripts/collect_data.py
```

**期待される結果**:
- エラーがないこと
- `data/results/collected_data_YYYYMMDD.csv` が生成されること
- サマリーが表示されること（対象期間、総レコード数、コンバージョン率など）

**エラーが出た場合**:
- カラム名のマッピングを修正する
- 不良有無の値の形式を確認する

---

## 📅 今後の運用スケジュール

### 練習期間（11/20～次回価格変更まで）

**毎日やること（18:30）**:
1. LINE仮査定データ、梱包キット数、集荷要請数をエクスポート
2. `data/raw/` の各ディレクトリに配置
3. （オプション）`collect_data.py` を実行してフォーマット確認

**目的**:
- データ収集の習慣化
- CSVフォーマットの確認と調整
- システムの動作テスト

### 次回の価格変更時（本番）

**価格変更の1週間前**:
1. データ収集を開始（7日間継続）
2. 毎日18:30にLINE仮査定、梱包キット、集荷要請をエクスポート

**価格変更当日**:
1. 買取価格を変更
2. 変更前後のCSVをiphone-market-research直下に保存
3. `create_price_change_log.py --auto` で履歴生成

**価格変更後1週間**:
1. データ収集を継続（7日間）

**データが揃ったら（変更後8日目）**:

```bash
cd /Users/noguchisara/projects/work/iphone-market-research/price-impact-analysis

# 1. データ収集・整形
uv run python scripts/collect_data.py

# 2. 効果分析
uv run python scripts/analyze_impact.py --change-date YYYY-MM-DD

# 3. レポート生成
uv run python scripts/generate_report.py --change-date YYYY-MM-DD
```

**生成されるファイル**:
- `data/results/impact_report_YYYYMMDD.xlsx` ← これを開いて確認

**レポート内容**:
- サマリーシート: 全体のコンバージョン率変化
- 機種別詳細シート: 各機種・容量・ランクの分析（色分け判定付き）
- 日次推移シート: 日々の変化グラフ

---

## 🔧 トラブルシューティング

### Q1. カラム名が違う場合

`scripts/collect_data.py` の 30行目あたりの `COLUMN_MAPPING` を編集：

```python
COLUMN_MAPPING = {
    'line_estimates': {
        'date': '日付',          # ← 実際のカラム名に変更
        'model': '機種',
        'capacity': '容量',
        'rank': 'ランク',
        'count': '仮査定数',     # ← 実際のカラム名に変更
        'has_defect': '不良有無',
    },
    # ...
}
```

### Q2. 不良有無の値の形式が違う場合

`scripts/collect_data.py` の 120行目あたりを修正：

```python
# 例: "なし"/"あり" の場合
df['has_defect'] = df['has_defect'].apply(lambda x:
    x in ['あり', 'アリ', '有'] if pd.notna(x) else False
)
```

### Q3. データが取得できない日がある場合

- その日のデータがない場合は、ファイルを配置しなくてOK
- ただし、できるだけ連続した14日間のデータが望ましい

---

## 📝 備考

- すべてのデータファイルは `.gitignore` でGit管理外
- 個人情報や機密情報が含まれていても安全
- 詳細な使い方は [README.md](README.md) を参照

---

## 📞 確認が必要な場合

- CSVフォーマットが想定と異なる場合
- エラーが解決できない場合
- 追加の機能が必要な場合

→ Claudeに相談してください

---

最終更新: 2025-11-19 (水)
