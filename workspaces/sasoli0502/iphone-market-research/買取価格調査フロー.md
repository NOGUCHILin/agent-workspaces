# 買取価格調査フロー

**作成日**: 2025-11-25 (火)
**目的**: 弊社の内部データを活用した買取価格の最適化

---

## 🎯 調査の目的

### 目標
**買取価格の最適化** = 粗利最大化 + 成約数の維持

### アプローチ
1. **買取価格が高すぎる構成を発見**
   - 成約率が高い → 価格を下げても成約数が変わらない可能性
   - → 価格を下げて粗利を増やす

2. **買取価格が低すぎる構成を発見**
   - 成約率が低い → 価格を上げて成約数を増やす

3. **最適化の対象**
   - **基準価格**（機種・容量・ランク別）
   - **減額率/減額固有値**（特にグループBの認識しにくい不具合・修理）

---

## 📊 データソース

### きんとんからエクスポート
- **データ期間**: 過去1ヶ月（約9,000件）
- **データ形式**: CSV（Shift-JIS）
- **エクスポート方法**: きんとんの一括エクスポート機能
- **絞り込み**: なし（全機種・全ランク・全ステータス）

### 必要なデータ
- 仮査定データ（提示価格）
- 成約データ（最終買取価格）
- 進捗ステータス（仮査定 / 成約）

### データ量の目安
- 1日あたり約300件の仮査定
- 過去1ヶ月で約9,000件
- CSVファイルサイズ: 数MB〜10MB程度

---

## 🔄 調査フロー

### ステップ1: データ収集

#### 1-1. きんとんからCSVエクスポート
```bash
# 手動でkintoneからエクスポート
# ファイル名: kintone_YYYYMMDD.csv
# 保存先: work/iphone-market-research/
```

#### 1-2. データ前処理スクリプトの実行
```bash
cd /Users/noguchisara/projects/work/iphone-market-research
uv run python scripts/preprocess_kintone_data.py kintone_YYYYMMDD.csv
```

**出力**:
- `data/processed/preprocessed_YYYYMMDD.csv`（UTF-8、前処理済み）

---

### ステップ2: データ前処理

#### 2-1. 不具合・修理のグループ化

**グループA: お客様が認識しやすい**（減額率を上げにくい）

不具合:
- TouchIDやFaceIDの故障
- サイドボタンの故障
- 正常に起動しない
- 初期化できない
- ネットワーク利用制限

修理:
- 画面修理
- アウトカメラガラス交換

**グループB: お客様が認識しにくい**（減額余地あり）

不具合:
- **バッテリーの劣化**（最重要）
- 表示やタッチ操作の劣化
- アウトカメラの故障
- バイブレーション不具合
- 端末上部の不具合
- 端末下部の不具合
- Wi-FiやBluetoothの不具合
- フラッシュの故障
- 水没歴あり
- その他

修理:
- ドック修理
- インカメラ修理
- アウトカメラ修理
- タプティックエンジン修理
- バッテリー交換

#### 2-2. 集計キーの作成

各レコードに以下のフラグを追加:
- `グループA不具合あり` (1/0)
- `グループA修理あり` (1/0)
- `グループB不具合あり` (1/0)
- `グループB修理あり` (1/0)

**集計キー**: 機種 + 容量 + ランク + グループA + グループB

---

### ステップ3: データ集計・分析

#### 3-1. 基本集計スクリプトの実行
```bash
cd /Users/noguchisara/projects/work/iphone-market-research
uv run python scripts/analyze_buyback_data.py data/processed/preprocessed_YYYYMMDD.csv
```

**集計内容**:
- 仮査定数
- 成約数
- **成約率**（成約数 / 仮査定数）
- 平均提示価格
- 平均最終買取価格
- 粗利額（平均）

**出力**:
- `data/results/analysis_YYYYMMDD.csv`

#### 3-2. 問題の発見

スクリプトが以下のパターンを自動検出:

**パターンA: 買取価格が高すぎる**
- 成約率が高い（例: 40%以上）
- → 価格を下げる余地あり

**パターンB: 買取価格が低すぎる**
- 成約率が低い（例: 10%以下）
- → 価格を上げるべき

**パターンC: 適正価格**
- 成約率が中程度（例: 15%〜35%）
- → 現状維持

---

### ステップ4: 価格調整案の策定

#### 4-1. 基準価格の調整案
```bash
cd /Users/noguchisara/projects/work/iphone-market-research
uv run python scripts/recommend_base_price.py data/results/analysis_YYYYMMDD.csv
```

**調整ロジック**:
- 成約率が高い（40%以上） → 基準価格を5%〜10%下げる
- 成約率が低い（10%以下） → 基準価格を5%〜10%上げる

**出力**:
- `data/results/base_price_recommendations_YYYYMMDD.csv`

#### 4-2. 減額率の調整案（グループBのみ）
```bash
cd /Users/noguchisara/projects/work/iphone-market-research
uv run python scripts/recommend_deduction_rate.py data/results/analysis_YYYYMMDD.csv
```

**調整ロジック**:
- グループBの不具合・修理がある場合でも成約率が高い
- → 減額率を上げる（例: バッテリー劣化 ×0.7 → ×0.6）

**出力**:
- `data/results/deduction_rate_recommendations_YYYYMMDD.csv`

---

### ステップ5: シミュレーション

#### 5-1. 新価格でのシミュレーション
```bash
cd /Users/noguchisara/projects/work/iphone-market-research
uv run python scripts/simulate_new_prices.py \
  data/results/base_price_recommendations_YYYYMMDD.csv \
  data/results/deduction_rate_recommendations_YYYYMMDD.csv
```

**シミュレーション内容**:
- 過去データに新しい基準価格・減額率を適用
- 粗利の変化を予測
- 成約数の変化を予測（成約率が変わらないと仮定）

**出力**:
- `data/results/simulation_YYYYMMDD.xlsx`（Excelレポート）

---

### ステップ6: レポート作成

#### 6-1. 総合レポートの生成
```bash
cd /Users/noguchisara/projects/work/iphone-market-research
uv run python scripts/generate_report.py data/results/simulation_YYYYMMDD.xlsx
```

**レポート内容**:
- 現在の成約率分布
- 価格調整案のサマリー
- シミュレーション結果
- 推奨アクション

**出力**:
- `data/results/buyback_optimization_report_YYYYMMDD.xlsx`

---

## 📁 ファイル構造

```
work/iphone-market-research/
├── README.md
├── 買取価格調査フロー.md                    # このファイル
│
├── kintone_YYYYMMDD.csv                     # きんとんからエクスポート
│
├── scripts/
│   ├── preprocess_kintone_data.py           # データ前処理
│   ├── analyze_buyback_data.py              # データ集計・分析
│   ├── recommend_base_price.py              # 基準価格調整案
│   ├── recommend_deduction_rate.py          # 減額率調整案
│   ├── simulate_new_prices.py               # シミュレーション
│   └── generate_report.py                   # レポート生成
│
└── data/
    ├── processed/
    │   └── preprocessed_YYYYMMDD.csv        # 前処理済みデータ
    └── results/
        ├── analysis_YYYYMMDD.csv            # 分析結果
        ├── base_price_recommendations_YYYYMMDD.csv      # 基準価格調整案
        ├── deduction_rate_recommendations_YYYYMMDD.csv  # 減額率調整案
        ├── simulation_YYYYMMDD.xlsx         # シミュレーション結果
        └── buyback_optimization_report_YYYYMMDD.xlsx    # 総合レポート
```

---

## 🔧 スクリプトの実装状況

- [ ] `scripts/preprocess_kintone_data.py`
- [ ] `scripts/analyze_buyback_data.py`
- [ ] `scripts/recommend_base_price.py`
- [ ] `scripts/recommend_deduction_rate.py`
- [ ] `scripts/simulate_new_prices.py`
- [ ] `scripts/generate_report.py`

---

## 📝 TODO

### 実装が必要なもの
1. **ランク決定ロジックの共有**
   - 表面・背面・側面の状態 → ランクへの変換ルール
   - きんとんに登録されているマッピングテーブル？

2. **減額率・減額固有値の現在値**
   - 不具合等（15項目）の減額率
   - 修理（7項目）の減額固有値（機種ごと）

3. **基準価格マスタ**
   - 機種・容量・ランク別の現在の基準価格

### 次のアクション
1. スクリプト実装の開始
2. テストデータでの動作確認
3. 本番データでの分析実行

---

最終更新: 2025-11-25 (火)
