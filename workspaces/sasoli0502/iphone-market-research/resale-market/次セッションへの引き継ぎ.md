# 次セッションへの引き継ぎ - iPhone中古市場相場調査システム

**作成日**: 2025-11-06
**プロジェクト**: work/iphone-market-research/

---

## 📌 プロジェクト概要

iPhone X（2017年）以降の全86モデル×容量について、主要ECサイトから中古価格データを自動収集し、販売価格決定のための相場分析を行うシステム。

### 調査対象
- **モデル**: iPhone X〜iPhone 16シリーズ（全86組み合わせ）
- **条件**: SIMフリー、全カラー、容量別
- **目的**: 販売価格の決定

---

## ✅ 現在の状況

### 完了した作業

#### 1. プロジェクト環境構築完了
```bash
work/iphone-market-research/
├── CLAUDE.md              # プロジェクト詳細仕様
├── README.md              # 使い方ガイド
├── pyproject.toml         # 依存関係（uv管理）
├── .gitignore
├── data/                  # データ保存先（Git管理外）
│   └── raw/
│       └── rakuten/       # iPhone XR 64GB (138件)取得済み
├── scripts/              # 実装済みスクリプト
│   ├── models.py         # 86モデル定義
│   ├── config.py         # API設定管理
│   ├── scraper_rakuten.py   # 楽天スクレイパー（動作確認済み✅）
│   ├── scraper_yahoo.py     # Yahoo!スクレイパー（API利用不可❌）
│   ├── collect_all.py       # 一括収集スクリプト
│   └── analyze.py           # 分析・レポート作成
└── reports/              # 分析結果出力先
```

#### 2. API設定状況

| サイト | 状態 | 認証情報 |
|--------|------|----------|
| **楽天市場** | ✅ 動作確認済み | アプリID: `1037682033117300178` |
| **Yahoo!ショッピング** | ❌ 403エラー | Client ID: `dj00aiZpPXdFUkVaaXMwUnNOdCZzPWNvbnN1bWVyc2VjcmV0Jng9YmY-` |
| その他 | - | API非対応（手動調査必要）|

#### 3. 環境変数設定（永続化済み）

`~/.zshrc`に以下が追加済み:
```bash
export RAKUTEN_APP_ID="1037682033117300178"
export YAHOO_CLIENT_ID="dj00aiZpPXdFUkVaaXMwUnNOdCZzPWNvbnN1bWVyc2VjcmV0Jng9YmY-"
```

新しいターミナルでは自動読み込み。現在のセッションでは:
```bash
source ~/.zshrc
```

#### 4. テスト実行済み

**iPhone XR 64GB**で楽天市場からデータ取得成功:
- 取得件数: 138件（重複除去後）
- 価格帯: 10,300円〜20,328円
- 平均価格: 18,225円
- 中央値: 18,480円
- ✅ USBメモリ等のアクセサリは自動除外

---

## 🚀 次にやること

### 優先度1: 楽天APIで全データ収集

```bash
cd /Users/noguchisara/projects/work/iphone-market-research

# 環境変数確認
export RAKUTEN_APP_ID='1037682033117300178'

# 全86モデル収集（推定2〜4時間）
uv run python scripts/collect_all.py --channels rakuten
```

**注意点**:
- 86モデル × 3キーワード × 3ページ = 約774リクエスト
- 1リクエスト1秒 + 処理時間 = 数時間かかる
- バックグラウンド実行推奨

### 優先度2: データ分析レポート作成

```bash
# 収集したデータを分析
uv run python scripts/analyze.py
```

**出力ファイル**:
- `reports/iphone_price_report_YYYYMMDD_HHMMSS.xlsx`
  - チャネル別シート
  - 統合シート
  - モデル×容量ごとの統計（件数、最低/平均/中央/最高価格）
- `reports/iphone_price_report_YYYYMMDD_HHMMSS.csv`

---

## ⚠️ 既知の問題・制約

### Yahoo!ショッピングAPI - 利用不可

**状況**:
- アプリケーション登録済み
- Client ID取得済み
- **403 Forbidden**エラーが継続発生
- 原因: Yahoo!の仕様変更で追加申請が必要な可能性

**対応方針**:
1. 当面は楽天APIのみで進める
2. Yahoo!は後日、追加申請方法を調査
3. または手動調査で補完

### API非対応サイト

以下のサイトは公開APIがなく、スクリプトでの自動収集不可:
- バックマーケット
- イオシス
- ムスビー
- メルカリ
- PayPayフリマ

**対応方針**:
- 主要10〜20モデルに絞って手動調査
- または楽天データで十分か判断してから決定

---

## 📊 技術詳細

### データ構造

**JSONファイル例** (`data/raw/rakuten/rakuten_iPhone_XR_64GB.json`):
```json
[
  {
    "product_name": "【中古】iPhoneXR 64GB...",
    "price": 15900,
    "url": "https://...",
    "shop_name": "○○ショップ",
    "image_url": "https://...",
    "review_count": 10,
    "review_average": 4.5,
    "search_keyword": "iPhone XR 64GB 本体 SIMフリー",
    "model": "iPhone XR",
    "capacity": "64GB",
    "scraped_at": "2025-11-06T15:09:34"
  }
]
```

### 検索ロジック

**キーワード**（各モデルで3パターン）:
1. `{モデル} {容量} 本体 SIMフリー`
2. `{モデル} {容量} SIMフリー 本体`
3. `{モデル} {容量} 中古`

**フィルタリング**（19種類の除外キーワード）:
- USBメモリ、ケース、カバー、フィルム、ガラス、保護
- 充電器、ケーブル、イヤホン、バッテリー、アダプタ
- スタンド、ホルダー、リング、ストラップ
- SIMカード、メモリーカード、SDカード

### API制限

**楽天市場API**:
- リクエスト間隔: 1秒（スクリプトで自動調整）
- ページ取得: 最大3ページ/キーワード
- 1ページ30件まで

---

## 🔧 トラブルシューティング

### 環境変数が認識されない

```bash
# 確認
echo $RAKUTEN_APP_ID

# 空の場合は再設定
source ~/.zshrc
# または
export RAKUTEN_APP_ID='1037682033117300178'
```

### APIエラーが発生

**400エラー（Bad Request）**:
- 一部の古いモデル（iPhone X）で発生
- 商品が少ない/ないモデルで起きやすい
- → スキップして次へ進む（正常動作）

**429エラー（Too Many Requests）**:
- レート制限超過
- → スクリプトが自動的に待機
- 頻発する場合は`SLEEP_INTERVAL`を増やす

### データが取得できない

```bash
# 個別テスト実行
uv run python scripts/scraper_rakuten.py
```

---

## 📖 参考情報

### モデル一覧（全86組み合わせ）

| 年 | モデル | 容量 |
|----|--------|------|
| 2017 | iPhone X | 64GB, 256GB |
| 2018 | iPhone XR | 64GB, 128GB, 256GB |
| 2018 | iPhone XS/XS Max | 64GB, 256GB, 512GB |
| 2019 | iPhone 11 | 64GB, 128GB, 256GB |
| 2019 | iPhone 11 Pro/Pro Max | 64GB, 256GB, 512GB |
| 2020 | iPhone 12 mini/12 | 64GB, 128GB, 256GB |
| 2020 | iPhone 12 Pro/Pro Max | 128GB, 256GB, 512GB |
| 2021 | iPhone 13 mini/13 | 128GB, 256GB, 512GB |
| 2021 | iPhone 13 Pro/Pro Max | 128GB, 256GB, 512GB, 1TB |
| 2022 | iPhone 14/14 Plus | 128GB, 256GB, 512GB |
| 2022 | iPhone 14 Pro/Pro Max | 128GB, 256GB, 512GB, 1TB |
| 2023 | iPhone 15/15 Plus | 128GB, 256GB, 512GB |
| 2023 | iPhone 15 Pro/Pro Max | 128GB, 256GB, 512GB, 1TB |
| 2024 | iPhone 16/16 Plus | 128GB, 256GB, 512GB |
| 2024 | iPhone 16 Pro/Pro Max | 256GB, 512GB, 1TB |

### 依存パッケージ

```toml
dependencies = [
    "pandas>=2.0.0",
    "polars>=0.19.0",
    "requests>=2.31.0",
    "beautifulsoup4>=4.12.0",
    "lxml>=4.9.0",
    "selenium>=4.15.0",
    "plotly>=5.17.0",
    "openpyxl>=3.1.0",
]
```

---

## 💡 改善アイデア（将来的に）

1. **Yahoo!ショッピングAPI対応**
   - 追加申請方法を調査
   - または手動調査テンプレート作成

2. **他サイト対応**
   - バックマーケット、イオシス、ムスビー等
   - 手動調査用Excelテンプレート作成

3. **データ分析強化**
   - 価格推移グラフ（時系列分析）
   - モデル間比較チャート
   - 在庫数トレンド

4. **自動化**
   - cron/スケジューラーで定期実行
   - Slack/Discord通知

---

## ✅ 次セッションで最初に読むべきファイル

このファイル（`次セッションへの引き継ぎ.md`）を読んでから:

1. `README.md` - 使い方の詳細
2. `CLAUDE.md` - プロジェクト仕様

---

**次回セッション開始コマンド**:
```bash
cd /Users/noguchisara/projects/work/iphone-market-research
export RAKUTEN_APP_ID='1037682033117300178'
uv run python scripts/config.py  # 設定確認
```

**データ収集開始**:
```bash
uv run python scripts/collect_all.py --channels rakuten
```

---

**作成者**: Claude
**最終更新**: 2025-11-06 15:40
