# Vercelデプロイ問題 - トラブルシューティングドキュメント

**作成日時**: 2025-11-07 18:34 (金)
**ステータス**: 🔴 未解決（デプロイ停滞中）

---

## 🎯 プロジェクトの目標

### そもそも何を作っているのか

**プロジェクト名**: クレジットカード運用最適化システム（HTML版）

**目的**:
- 複数のクレジットカード（9枚）の残高と引き落とし日を管理
- 請求書払い（ヤマト、徐さん、ユニホー、ドンキ等）のスケジュール管理
- 「今日カードを使ったら何日後に引き落としか」を即座に確認
- **どのカードを使えば最も猶予期間が長いか**を可視化

**なぜHTML化？**:
- Python版は存在するが、毎回スクリプト実行が必要
- スマホ・PCどこからでもブラウザで即アクセスしたい
- リアルタイムで残高を更新して再計算できる
- Vercelで無料ホスティング → 社内で共有可能

### 完成した機能（index.html）

✅ **実装済み**:
1. **カード残高入力欄** - 9枚のカードの残高を手入力で更新
2. **今日使った場合の引き落とし日計算** - 猶予期間順にランキング表示（🥇🥈🥉）
3. **締日アラート** - 締日まで7日以内のカードに「締日まで〇日」を表示
4. **請求書カード払いスケジュール** - 申請日・金額・引き落とし日を一覧表示
5. **引き落としスケジュール** - 日付順に引き落とし予定を表示
6. **信号色ステータス** - 🟢余裕/🟡要注意/🔴残り少 で視覚的に判断

**現在の状態**:
- ✅ ローカルで完全に動作確認済み
- ✅ GitHub にプッシュ済み
- ❌ Vercel デプロイがうまくいかない ← **今ここ**

---

## 📋 問題の概要

### 症状
- **URL**: https://finance-cashflow.vercel.app
- **現象**: 404 NOT_FOUND エラーが表示される
- **原因**: Vercelが古いコミット（28b56e7）を繰り返しデプロイしており、最新コミットを認識していない

### 期待される動作
- 最新の `index.html`（カード残高入力、締日アラート、請求書スケジュール等の全機能実装済み）が表示されること
- 最新のコミット（521e2fe）がデプロイされること

---

## 🗂️ 現在のファイル構成

### ローカル環境（正常）

```
/Users/noguchisara/projects/work/finance-cashflow/
├── index.html               ✅ 完全版ダッシュボード（30,824 bytes）
├── test.html                (デバッグ用)
├── dashboard_v1.html        (バックアップ)
├── vercel.json              ✅ Vercel設定ファイル
├── README.md
├── .vercel/                 (Vercel CLI設定)
├── docs/
│   └── master-data-v2.yaml
├── scripts/
│   └── optimize_credit_schedule.py
└── data/                    (Git管理外)
```

### GitHub（確認済み）

- **リポジトリ**: https://github.com/sasoli0502/finance-cashflow
- **ブランチ**: main
- **最新コミット**: `521e2fe` "Deploy via Vercel CLI" (4分前)
- **index.html**: 存在確認済み（49分前にpush済み）

### Vercel（問題あり）

- **プロジェクト名**: finance-cashflow
- **Production URL**: https://finance-cashflow.vercel.app
- **現在のデプロイコミット**: `28b56e7` ⚠️ **古いコミット**
- **ステータス**: ✅ Ready (緑) だが、古いコミットのまま

---

## 🔍 問題の詳細分析

### タイムライン

| 時刻 | イベント | 結果 |
|------|---------|------|
| 17:29 | `index.html` 作成・完成 | ✅ ローカルで動作確認済み |
| 〜18:00 | 複数回コミット・プッシュ（348490a, 7622c51等） | ❌ Vercelが認識せず |
| 18:09 | Vercel Settings > Git で **Disconnect** | - |
| 18:10 | 再接続（Reconnect） | ❌ 新しいデプロイが追加されたがコミットは28b56e7のまま |
| 18:20 | Vercel CLI インストール・ログイン | - |
| 18:24 | `vercel --prod` 実行 | ❌ Git作者権限エラー |
| 18:30 | 新規コミット（521e2fe）作成・強制プッシュ | ✅ GitHubには反映 |
| 18:34 | **現在** | ⏳ Vercelが521e2feを認識していない |

### Git履歴（ローカル）

```
521e2fe (HEAD -> main, origin/main) Deploy via Vercel CLI
7622c51 Force Vercel redeploy - 20251107-180916
348490a Trigger Vercel redeploy
48a90f2 Fix: vercel.json設定を修正
b8675b4 Add: test.html for debugging
898d8b0 Remove: 古いdashboard.htmlを削除 (index.htmlに統一)
b6f91fb Add: Vercel設定ファイル (静的HTML配信用)
029039d Rename: dashboard.html → index.html (Vercel対応)
da4c752 Add: 全機能実装 - 締日アラート、請求書スケジュール、引き落としスケジュール
28b56e7 Initial commit: クレジットカード運用最適化システム ← ⚠️ Vercelはここでスタック
```

---

## 🚨 試したこと（すべて失敗）

### 1. 空のコミットで再デプロイトリガー
```bash
git commit --allow-empty -m "Trigger Vercel redeploy"
git push origin main
```
**結果**: ❌ Vercelが認識せず

### 2. Vercel Settings > Git で Disconnect → Reconnect
**結果**: ❌ 新しいデプロイは追加されたがコミット番号は28b56e7のまま

### 3. Vercel CLI でデプロイ
```bash
vercel --prod
```
**結果**: ❌ エラー発生
```
Error: Git author noguchisara@example.com must have access to the team sasoli's projects on Vercel to create deployments.
```

### 4. 強制プッシュ
```bash
git push origin main --force
```
**結果**: ✅ GitHubには反映、❌ Vercelは未反応

---

## 🔧 考えられる原因

### 1. VercelとGitHubの連携問題
- **Webhook設定**: VercelがGitHubのpushイベントを受け取れていない可能性
- **確認方法**: GitHub Settings > Webhooks でVercel webhookの状態を確認

### 2. デフォルトブランチの不一致
- GitHubのデフォルトブランチとVercelのProduction Branchが一致していない可能性
- **確認必要**: Vercel Settings > Git > Production Branch が `main` になっているか

### 3. Vercelのキャッシュ問題
- Vercelが古いGit参照をキャッシュしている可能性
- **対処**: 手動再デプロイまたはプロジェクト再接続

### 4. 権限・認証問題
- Vercel CLIでのデプロイ時にチーム権限エラーが発生
- Git作者情報（noguchisara@example.com）がVercelチームに登録されていない

---

## ✅ 次のセッションでやるべきこと

### 優先度1: GitHub Webhook確認

1. **GitHubリポジトリにアクセス**:
   ```
   https://github.com/sasoli0502/finance-cashflow
   ```

2. **Settings** タブ → 左側メニュー **Webhooks** をクリック

3. **確認事項**:
   - Vercel用のwebhookが登録されているか
   - Payload URL: `https://api.vercel.com/...` のようなURL
   - Recent Deliveries で最近のイベントが成功しているか（緑のチェック）
   - エラーが出ている場合は詳細を確認

4. **もし問題があれば**:
   - Webhookを削除
   - Vercel側で再接続して自動的に再作成させる

---

### 優先度2: Vercel Production Branch確認

1. **Vercelダッシュボード**: https://vercel.com/dashboard

2. **finance-cashflow** プロジェクト → **Settings** → **Git**

3. **下にスクロール** して **"Production Branch"** セクションを探す

4. **確認事項**:
   - Production Branch が `main` になっているか
   - もし違うブランチになっていれば `main` に変更

5. **スクリーンショット撮影** して状態を記録

---

### 優先度3: GitHubから直接編集してデプロイトリガー

Webhook/ブランチ設定が正しい場合、GitHubのWebインターフェースから直接編集すれば確実にデプロイがトリガーされます。

1. **GitHub** → `finance-cashflow` リポジトリ

2. **index.html** をクリック

3. 右上の **鉛筆アイコン（Edit this file）** をクリック

4. **ファイルの一番下に空行を1つ追加**（小さな変更でOK）

5. 下部の **"Commit changes"** をクリック
   - Commit message: "Trigger Vercel deploy from GitHub"
   - **Commit directly to the main branch** を選択

6. **Commit** ボタンをクリック

7. **1-2分待つ** → Vercel Deployments タブで新しいデプロイを確認

---

### 優先度4: Vercelプロジェクトの再作成（最終手段）

上記すべてがダメな場合、プロジェクトを作り直す：

1. **現在のVercelプロジェクトを削除**
   - Settings > Advanced > Delete Project

2. **新規プロジェクト作成**
   - Add New Project
   - GitHubから `sasoli0502/finance-cashflow` を選択
   - Framework Preset: `Other`
   - Build Command: 空欄
   - Output Directory: 空欄
   - Deploy

3. **カスタムドメイン再設定**（必要なら）

---

## 📝 確認済み事項

### ✅ ローカル環境
- [x] index.html が存在し、完全版のコード（30,824 bytes）
- [x] Git履歴に最新コミット（521e2fe）が存在
- [x] origin/main が最新コミットを指している

### ✅ GitHub
- [x] リポジトリにアクセス可能（プライベートリポジトリ）
- [x] mainブランチに最新コミット（521e2fe）が存在
- [x] index.html がリポジトリに存在（49分前にpush済み）

### ⚠️ Vercel（問題あり）
- [x] プロジェクトが存在し、アクセス可能
- [x] GitHubリポジトリと接続済み（58分前にConnected）
- [ ] **最新コミットを認識していない**（28b56e7のまま）
- [ ] Webhook設定の確認が必要
- [ ] Production Branch設定の確認が必要

---

## 🔑 重要な情報

### 認証情報

- **GitHub Personal Access Token**: `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`
  - 用途: Git認証（リモートURLに埋め込み済み）
  - 保存場所: `.git/config`

- **Vercel CLI**: ログイン済み（2025-11-07 18:24）
  - ユーザー: sasoli0502
  - プロジェクト: sasolis-projects-6aadbf10/finance-cashflow

### URL

- **GitHub**: https://github.com/sasoli0502/finance-cashflow
- **Vercel Dashboard**: https://vercel.com/dashboard
- **Production URL**: https://finance-cashflow.vercel.app (現在404)

---

## 📚 参考資料

### Vercel公式ドキュメント

- Git連携: https://vercel.com/docs/deployments/git
- Webhook設定: https://vercel.com/docs/deployments/git/vercel-for-github
- トラブルシューティング: https://vercel.com/docs/deployments/troubleshoot-project-collaboration

### vercel.json設定内容

```json
{
  "routes": [
    {
      "src": "/(.*)",
      "dest": "/$1"
    }
  ]
}
```

---

## 💡 デバッグコマンド

### ローカルでの確認

```bash
# 現在のディレクトリに移動
cd /Users/noguchisara/projects/work/finance-cashflow

# Git状態確認
git status
git log --oneline -10

# index.htmlの存在確認
ls -lh index.html

# リモートURL確認
git remote -v

# 最新を取得
git fetch origin
git log origin/main --oneline -5
```

### Vercel CLIでの確認

```bash
# プロジェクト情報確認
vercel ls

# プロジェクト詳細
vercel inspect

# デプロイ履歴
vercel list
```

---

## 📞 次のセッションの担当者へ

このドキュメントを読んだ上で、以下の順番で対応してください：

1. **優先度1**: GitHub Webhook確認（5分）
2. **優先度2**: Vercel Production Branch確認（5分）
3. **優先度3**: GitHubから直接編集してデプロイトリガー（10分）
4. もしすべて失敗したら **優先度4**: プロジェクト再作成（15分）

---

**ドキュメント終了**
**最終更新**: 2025-11-07 18:34 (金)
**次回更新**: 問題解決時または新しい情報が得られた時
