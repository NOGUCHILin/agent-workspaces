# finance-cashflow

資金繰り管理・クレジットカード最適化プロジェクト

<project-purpose>
このプロジェクトは2つの主要機能を持ちます：

1. **請求書カード払い最適化**（対話型）
   - 支払先・金額・期限から、最適なクレジットカードと申請日を判断

2. **資金繰り分析システム**（自動化）
   - 仕訳帳CSVから日次資金繰り表・損益計算書・各種レポートを自動生成
   - 過去データから今後の資金繰りを予測
</project-purpose>

<instructions>
## データ配置ルール

```
data/
├── source/           # 元データ（ユーザーが配置）
│   ├── 仕訳帳_YYYYMMDD_HHMM.csv        # マネーフォワードからエクスポート
│   └── 社内資金繰り表_YYYYMMDD.csv      # 社内管理の実残高データ
├── processed/        # 整形済みデータ（自動生成）
│   ├── transactions_cleaned.csv
│   └── transactions_grouped.csv
├── proposals/        # カード払い提案書（対話で生成）
│   └── YYYY-MM-DD_提案内容.md
└── reports/          # 各種レポート（自動生成）
    ├── cashflow_detailed_YYYYMMDD.html
    ├── cashflow_daily_YYYYMMDD.html
    ├── pl_statement_YYYYMMDD.html
    └── forecast_YYYYMMDD.html
```

---

## 機能A: 請求書カード払い最適化（対話型）

### 使い方

ユーザーが「○○社に△△円を支払いたい、期限は□□日」と相談すると、Claude Codeが以下の手順で判断します。

### 判断相談の流れ

1. **カード状況確認**: `docs/master-data.md` でカード利用可能額・仕様を確認
2. **判断ロジック適用**: `docs/decision-rules.md` に従って最適なカードを選択
3. **営業日計算**: `docs/holidays.csv` を参照して申請日を算出
4. **提案書生成**: `data/proposals/YYYY-MM-DD_提案内容.md` に保存

### 提案書フォーマット

- ファイル名: `YYYY-MM-DD_簡単な説明.md`（例: `2025-10-29_11月支払計画.md`）
- 内容: 支払先、金額、カード選択理由、申請日、営業日計算根拠

### スケジュール整合性確認ルール

**重要**: スケジュール作成・追加のたびに、必ず以下のチェックを実行すること。

#### 確認項目

1. **既存スケジュールとの重複チェック**
   - `data/proposals/` 配下の既存スケジュールを確認
   - 同じ支払先・同じ月の支払いが重複していないか確認
   - 重複がある場合は、どちらが正しいかユーザーに確認

2. **カード枠回復スケジュールとの整合性**
   - カード引き落とし日と引き落とし額を確認
   - 既存スケジュールに記載された枠回復日・金額と一致しているか確認
   - 不一致がある場合は、master-data.mdと既存スケジュールを最新化

3. **利用可能額の計算**
   - 各申請日時点での利用可能額を算出
   - 使用予定額が利用可能額を超えていないか確認
   - 複数の申請がある場合は、時系列順に計算

4. **申請期限の妥当性**
   - 申請日から振込日までが3営業日以上あるか確認（`holidays.csv`参照）
   - 土日祝日の振込日は前営業日に実行されることを考慮

#### チェック実行タイミング

- 新規スケジュール作成時（必須）
- 既存スケジュールへの追加時（必須）
- master-data.mdのカード情報更新時（推奨）

### 月次ルーティン運用

**重要**: 請求書カード払いは3つのサービスを使い分ける。詳細は `docs/decision-rules.md` 参照。

#### 請求書カード払いサービス（3種類）

| サービス | 期日超過 | 利用可能カード | 用途 |
|----------|---------|---------------|------|
| **マネーフォワード** | ❌ 不可 | Visa/Master/JCB（全カード） | **最優先** |
| **byGMO** | ❌ 不可 | **アメックス専用** | ドンキ等 |
| **DGFT** | ✅ **可能** | Visa/Master/JCB（**トヨタ✗、GPC✗**） | 期日超過時 |

#### 基本方針（必読）

1. **最優先目標: クレジットカード支払いを最大限遅らせる**
   - 月後半振込の場合: しんきんVisa/JCB > アメックス > Amazon > トヨタ
   - 締め日直後に決済されると引落が翌月に回り、さらに遅延可能

2. **アメックスも請求書カード払い可能**（byGMO経由）
   - 期日厳守が必要な支払い（ドンキ等）で使用

3. **期日超過戦略（DGFT限定）**
   - ユニホー・ビズビは期日超過して支払うことで引落を1ヶ月遅延
   - **注意**: DGFTではトヨタカード・GPCは使用不可

4. **請求書分割ルール**
   - **分割可能**: 徐さん（仕入）のみ
   - **分割不可**: ヤマト、ビズビ、家賃3件

#### 支払先ごとの期日・カード配分

| 支払先 | 期日 | 期日超過 | サービス | カード | 振込日 |
|--------|------|---------|----------|--------|--------|
| **ヤマト** | 25日 | **厳守** | マネーフォワード | しんきんVisa | 25日 |
| **ドンキ** | 末日 | **厳守** | byGMO | アメックス | 末日 |
| **ユニホー** | 末日 | 超過OK | DGFT | Amazon | 翌月5日 |
| **ビズビ** | 末日 | 超過OK | DGFT | Amazon | 翌月5日 |
| **徐さん** | 未定 | 超過OK | マネーフォワード | しんきんJCB/Visa | 20日 |

#### 月次ルーティン実行チェックリスト

**毎月1日**（前月末期日超過分）:
- [ ] DGFT: ユニホー申請（Amazon、振込希望日5日）→ 決済約2日 → 引落翌月26日
- [ ] DGFT: ビズビ申請（Amazon、振込希望日5日）→ 決済約2日 → 引落翌月26日

**毎月12日頃**:
- [ ] 徐さんに請求書分割を依頼（金額確定後）
- [ ] マネーフォワード: 徐さん申請（しんきんJCB、振込希望日20日）→ 決済約16日 → 引落翌々月10日

**毎月19日頃**:
- [ ] マネーフォワード: ヤマト申請（しんきんVisa、振込希望日25日）→ 決済約22日 → 引落翌々月10日

**毎月24日頃**:
- [ ] byGMO: ドンキ申請（アメックス、振込希望日末日）→ 決済約26日 → 引落翌々月10日

#### カード別役割（新ルール）

| カード | 請求書払い配分 | サービス | 申請日 | 振込日 | 決済日 | 引落日 |
|--------|---------------|----------|--------|--------|--------|--------|
| しんきんVisa | ヤマト | マネーフォワード | 19日頃 | 25日 | 約22日 | 翌々月10日 |
| しんきんJCB | 徐さん | マネーフォワード | 12日頃 | 20日 | 約16日 | 翌々月10日 |
| アメックス | ドンキ | byGMO | 24日頃 | 末日 | 約26日 | 翌々月10日 |
| Amazon | ユニホー+ビズビ | DGFT | 1日 | 5日 | 約2日 | 翌月26日 |

#### 重要な制約

- **トヨタカード**: 請求書カード払いでは使用しない（DGFT非対応のため）
- **GPC（ヨドバシ）**: マネーフォワードでのみ使用可能（DGFTでは使えない）
- **アメックス**: byGMO専用
- **セゾン**: 請求書カード払い不可（Amexブランド）

---

## 機能B: 資金繰り分析システム（自動化）

### 必要なデータ

Claude Codeが分析を実行する際、以下のデータが必要です。なければ要求します：

#### 必須データ

1. **仕訳帳CSV** (`data/source/仕訳帳_YYYYMMDD_HHMM.csv`)
   - 取得元: マネーフォワードクラウド会計
   - エクスポート方法: 会計 → 帳票 → 仕訳帳 → CSV出力
   - エンコーディング: Shift-JIS（自動変換します）
   - 必須列: `取引No`, `取引日`, `借方勘定科目`, `借方金額(円)`, `貸方勘定科目`, `貸方金額(円)`, `摘要`

2. **社内資金繰り表CSV**（オプション、実残高補正に使用）
   - 配置先: `data/source/社内資金繰り表_YYYYMMDD.csv`
   - 用途: 計算残高と実残高の照合

#### 参照データ（定期更新）

3. **カード・支払先マスターデータ** (`docs/master-data.md`)
   - 更新タイミング: カード枠変更、支払先追加時

4. **営業日データ** (`docs/holidays.csv`)
   - 更新タイミング: 年度更新時

### 分析フロー

```
① データ配置確認
   └─ data/source/に仕訳帳CSVがあるか確認
   └─ なければユーザーに要求: 「最新の仕訳帳CSVを data/source/ に配置してください」

② データクリーニング
   └─ uv run python scripts/clean_journal_data.py
   └─ data/processed/transactions_cleaned.csv を生成

③ 各種分析（並列実行可能）
   ├─ 日次資金繰り表: scripts/generate_cashflow_detailed.py
   │   → data/reports/cashflow_detailed_YYYYMMDD.html
   │
   ├─ 損益計算書: scripts/generate_pl_statement.py
   │   → data/reports/pl_statement_YYYYMMDD.html
   │
   ├─ クレカ経費分析: scripts/analyze_credit_card.py
   │   → data/credit_card_monthly_YYYYMMDD.csv
   │
   └─ 資金繰り予測: scripts/forecast_cashflow.py
       → data/reports/forecast_YYYYMMDD.html

④ レポート表示
   └─ 生成されたHTMLをブラウザで開く
```

### 対話の例

```
ユーザー: 「資金繰り分析を実行して」
Claude: 「data/source/配下を確認します...
         仕訳帳CSVが見つかりました（2025-10-29版）。
         データクリーニングを開始します...」
         ↓
         「分析が完了しました。以下のレポートを生成しました：
         - 詳細版日次資金繰り表: cashflow_detailed_20251030.html
         - 損益計算書: pl_statement_20251030.html
         ブラウザで開きますか？」
```

### スラッシュコマンド

以下のコマンドで各機能を呼び出せます：

- `/cash-analyze` - 仕訳帳から全レポート生成
- `/cash-forecast` - 資金繰り予測を実行
- `/card-optimize` - カード払い最適化判断

---

## 実行環境

- Python 3.10+ + uv
- 主要ライブラリ: polars, pandas, plotly
- 実行コマンド: `uv run python scripts/<スクリプト名>.py`
</instructions>

<key-references>
## カード払い最適化
- `docs/master-data.md` - カード枠・支払先・利用可能額
- `docs/decision-rules.md` - 判断フロー・計算方法・請求書分割ルール
- `docs/holidays.csv` - 営業日計算
- `data/proposals/クレジットカード月次ルーティン.md` - **月次ルーティン定義（必読）**
- `data/proposals/2025-10-29_11月請求書カード払い計画.md` - 既存スケジュール例

## 資金繰り分析
- `scripts/clean_journal_data.py` - データクリーニング
- `scripts/generate_cashflow_detailed.py` - 詳細資金繰り表
- `scripts/generate_pl_statement.py` - 損益計算書
- `scripts/forecast_cashflow.py` - 資金繰り予測
- `scripts/run_all_analysis.py` - 一括実行

## データフロー
- `docs/data-flow.md` - 全体の流れを図示
</key-references>
