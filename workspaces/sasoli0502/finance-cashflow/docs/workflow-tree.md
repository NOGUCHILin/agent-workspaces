# 資金繰り管理ワークフロー

## 解決したい課題（優先順位）

| 優先度 | 課題 | 現状 | 理想 |
|--------|------|------|------|
| 1 | クレカ支払い額の把握 | 都度代表に確認 | 毎日累計＋確定後に記入 |
| 2 | 請求書カード払いの申請タイミング | 頭で覚えている | リマインド＋可視化 |
| 3 | カード枠の残高管理 | 枠不足が発生 | 事前に予測・回避 |
| 4 | 売上予測の精度向上 | 関数で予測 | 精度を高めたい（今後） |

---

## 全体ワークフロー

```
資金繰り管理
│
├─────────────────────────────────────────────────────────────────────
│ 【日次】入金・出金・残高管理
├─────────────────────────────────────────────────────────────────────
│
├── 1. 実残高の確認
│   │
│   ├── 銀行口座
│   │   ├── 三菱UFJ
│   │   │   ├── ネットバンキング（通常）
│   │   │   └── 通帳（ネットバンキング不可時）
│   │   │
│   │   └── GMOあおぞら
│   │       └── ネットバンキングのみ（通帳なし）
│   │
│   │   ※芝信金・城南信金は融資返済専用→頻繁な確認不要
│   │
│   └── 店舗レジ金
│       └── スマレジで確認
│
├── 2. スプレッドシートに入金・出金を記入
│   │
│   ├── 入金（売上）
│   │   ├── ムスビ、BM、直売
│   │   └── 予測値 → 確定日が近づいたら実績に近い値に更新
│   │
│   └── 出金
│       ├── 仕入
│       ├── 広告費
│       ├── パーツ、修理、住居、人件費、商品
│       ├── 外注費、営業費等
│       └── クレカ支払い（後述）
│
├── 3. 計算残高と実残高を照合
│   │
│   ├── 一致 → OK
│   │
│   └── 不一致（稀）
│       └── 入金・出金を徹底的に再確認
│
├── 4. クレカ残高をサイトに記入 ⚠️ 課題あり
│   │
│   ├── 利用可能額の記入（9枚全て）
│   │   └── 代表のスクショを見て記入
│   │
│   ├── 今月の利用額累計
│   │   └── 代表のスクショから確認・記入
│   │
│   └── 支払日・支払金額 ← ⚠️ ネック
│       ├── 現状：都度代表に電話・メールで確認
│       ├── 課題：スムーズに確認できない
│       └── 理想：毎日確認、締め後に確定額を記入
│           └── ※明細反映が1週間遅れる場合あり
│              └── 請求書で確定額を確認してから記入
│
└── 5.（随時）大きな変動があれば予測を更新
    └── 来月の資金繰り予測を修正
│
│
├─────────────────────────────────────────────────────────────────────
│ 【月次】請求書カード払い申請 ⚠️ 課題あり
├─────────────────────────────────────────────────────────────────────
│
├── 1. 申請タイミングの判断 ← ⚠️ 最大のネック
│   │
│   ├── 目的
│   │   └── クレカ支払いを最も遅らせる
│   │
│   ├── 判断に必要な情報
│   │   ├── 各カードの締め日
│   │   ├── 各カードの支払日
│   │   ├── 各カードの利用可能額
│   │   └── 振込希望日（支払先の期日）
│   │
│   ├── 判断ロジック
│   │   ├── 締め日直後に決済 → 引落が翌月に延びる
│   │   └── 引落が最も遅くなるカードを選択
│   │
│   ├── 現状の問題
│   │   ├── 頭の中で覚えている（忘れるリスク）
│   │   └── 残高不足で申請できないことがある
│   │       ├── 締日が遅いカードの枠が既に少ない
│   │       └── 予想より利用額が多かった
│   │
│   └── 理想
│       ├── リマインド：「○日に△△の申請」と通知
│       └── 判断材料の可視化：カード枠・締日・引落日
│
├── 2. 申請前の確認
│   │
│   ├── カードの利用可能額を確認（サイト）
│   │
│   └── 引落が最も遅くなるカードを選択
│       │
│       ├── マネーフォワード対応カード（Visa/Master/JCB）
│       │   ├── Amazon（Mastercard）
│       │   ├── MI（Visa）
│       │   ├── しんきんVisa
│       │   ├── しんきんJCB
│       │   ├── JFR（大丸）（Visa）
│       │   └── トヨタ（Visa）
│       │
│       ├── byGMO対応カード（Amex）
│       │   ├── アメックス
│       │   └── セゾン（Amex）
│       │
│       └── 利用不可
│           └── GPC（システム制限）
│
├── 3. 申請実行
│   │
│   ├── マネーフォワード
│   │   └── Visa / Master / JCB対応
│   │
│   ├── byGMO
│   │   └── アメックス専用
│   │
│   └── DGFT
│       └── 期日超過OK案件用
│
├── 4. 申請後の記録
│   │
│   ├── 申請履歴の確認
│   │   ├── 各サービスのサイト
│   │   └── メール
│   │
│   └── クレカサイトに入力
│       └── 引落日に請求書カード払い金額を入力
│
└── 5. 資金繰り表への反映
    └── スプレッドシートの該当カード列・支払日に金額記入
│
│
├─────────────────────────────────────────────────────────────────────
│ 【定期支払先一覧】
├─────────────────────────────────────────────────────────────────────
│
├── ヤマト（荷造運賃）
│   ├── 期日：25日 **厳守**
│   ├── サービス：マネーフォワード
│   ├── カード：しんきんVisa
│   └── 金額目安：100万円ほど
│
├── ドンキ（地代家賃）
│   ├── 期日：末日 **厳守**
│   ├── サービス：byGMO
│   ├── カード：アメックス
│   └── 金額目安：25万円
│
├── ユニホー（地代家賃）
│   ├── 期日：末日（超過OK）
│   ├── サービス：DGFT
│   ├── カード：Amazon
│   ├── 振込日：翌月5日
│   └── 金額目安：25万円
│
├── ビズビ（仕入）
│   ├── 期日：末日（超過OK）
│   ├── サービス：DGFT
│   ├── カード：Amazon
│   ├── 振込日：翌月5日
│   └── 金額目安：10万円
│
├── 徐さん（仕入）
│   ├── 期日：未定
│   ├── サービス：マネーフォワード
│   ├── カード：しんきんJCB + アメックス
│   ├── 振込日：20日
│   └── 金額目安：150万円
│
└── レンタルオフィス（地代家賃）
    ├── 期日：末日
    ├── 支払方法：現金払い
    └── 金額：6万円
```

---

## 使用ツール・システム

| ツール | 用途 |
|--------|------|
| スプレッドシート | 資金繰り表（日次入金・出金・残高管理） |
| クレカ管理サイト（自社） | カード残高記入、優先カード判断、請求書払い金額記入 |
| 三菱UFJネットバンキング | 銀行残高確認 |
| GMOあおぞらネットバンキング | 銀行残高確認 |
| スマレジ | 店舗レジ金確認 |
| マネーフォワード | 請求書カード払い（Visa/Master/JCB） |
| byGMO | 請求書カード払い（アメックス） |
| DGFT | 請求書カード払い（期日超過OK案件） |

---

## クレジットカード一覧

| カード名 | ブランド | 締め日 | 支払日 | 限度額 | 請求書カード払い |
|---------|---------|--------|--------|--------|-----------------|
| アメックス | Amex | 22日 | 翌月10日 | 635万円 | ○ byGMO |
| MI | Visa | 5日 | 26日 | 100万円 | ○ マネフォ |
| Amazon | Mastercard | 末日 | 翌月26日 | 200万円 | ○ マネフォ |
| GPC | Visa | 末日 | 翌月26日 | 50万円 | × |
| セゾン | Amex | 10日 | 翌月4日 | 700万円 | ○ byGMO |
| しんきんJCB | JCB | 15日 | 翌月10日 | 100万円 | ○ マネフォ |
| しんきんVisa | Visa | 15日 | 翌月10日 | 160万円 | ○ マネフォ |
| JFR（大丸） | Visa | 15日 | 翌月10日 | 100万円 | ○ マネフォ |
| トヨタ | Visa | 5日 | 翌月2日 | 120万円 | ○ マネフォ |

---

---

## ヒアリング結果

### 1. データソース・アクセス方法

| # | 質問 | 回答 |
|---|------|------|
| 1-1 | 資金繰り表のスプレッドシートURL | https://docs.google.com/spreadsheets/d/1Gg4Lvvlx25GGk-LdEnr8apUO2Q4e2ZOYovaAlBfV7os/ |
| 1-2 | クレカ管理サイト（自社）のURL | http://100.102.44.111:9000/index.html |
| 1-3 | クレカ管理サイトの認証方法 | 不明 |
| 1-4 | クレカ管理サイトはAPI/スクレイピング可能か？ | 不明 |

### 2. 銀行・カード情報の取得方法

| # | 質問 | 回答 |
|---|------|------|
| 2-1 | 「代表のスクショ」はどこに保存される？ | Slack |
| 2-2 | スクショ以外に残高・利用額を取得する方法は？ | 代表から口頭で聞く |
| 2-3 | 銀行API連携（マネーフォワード ME等）は利用可能か？ | 不可（個人カードのためアクセス禁止）※会社カード3枚はアクセス可能 |
| 2-4 | カード利用額の更新頻度は？ | 毎日 |

### 3. 請求書カード払いサービス

| # | 質問 | 回答 |
|---|------|------|
| 3-1 | マネーフォワード請求書払いはAPI連携可能か？ | ○ 可能（OAuth2.0認証） |
| 3-2 | byGMOはAPI連携可能か？ | △ 銀行APIは充実、請求書払い専用APIは不明 |
| 3-3 | DGFTはAPI連携可能か？ | ○ 可能（2025年1月提供開始） |
| 3-4 | 申請は完全手動必須か、一部自動化可能か？ | 一部自動化可能（API連携サービスあり） |

### 4. 通知・リマインド

| # | 質問 | 回答 |
|---|------|------|
| 4-1 | リマインドの送信先 | Slack |
| 4-2 | 通知を受け取る担当者 | その日の資金繰り整理担当 |
| 4-3 | 通知のタイミング | 10:00〜14:00（種類ごとに分ける） |

#### 通知の種類と頻度

| 通知の種類 | タイミング |
|-----------|-----------|
| 請求書カード払いの申請リマインド | 申請日1週間前〜当日まで毎日 |
| カード締め日の通知 | 締め日1週間前〜当日まで毎日 |
| カード枠不足の警告 | 不足したら毎日 |
| 支払い確定額の入力リマインド | 毎日 |

### 5. 判断ロジックの詳細

| # | 質問 | 回答 |
|---|------|------|
| 5-1 | 「引落が最も遅くなるカード」の選択基準 | 請求書の支払日から逆算して、クレカの支払日が最も遅くなるカード |
| 5-2 | 枠不足の判定しきい値 | 該当請求書の金額を支払えるか支払えないか |
| 5-3 | 複数カード併用時の優先順位ルール | クレカ支払日が同一ならどちらでもOK |

### 補足情報

#### クレジットカードの分類

| カード名 | 種別 | 明細アクセス |
|---------|------|-------------|
| しんきんJCB | 会社 | ○ いつでも可能 |
| しんきんVisa | 会社 | ○ いつでも可能 |
| アメックス | 会社 | ○ いつでも可能 |
| MI | 個人 | × 代表経由 |
| Amazon | 個人 | × 代表経由 |
| GPC | 個人 | × 代表経由 |
| セゾン | 個人 | × 代表経由 |
| JFR（大丸） | 個人 | × 代表経由 |
| トヨタ | 個人 | × 代表経由 |

#### 日次業務の時間
- 資金繰り整理：10時過ぎから開始

---

## 技術調査結果

### クレカ管理ダッシュボードの構成

#### ソースコード
- **場所**: `/Users/noguchilin/dev/noguchisara-projects/work/finance-cashflow/`
- **メインファイル**: `index.html`（約1500行、HTML+JavaScript）
- **サーバー**: `server.js`（Node.js静的ファイルサーバー、ポート9000）
- **ホスト**: `noguchisara`マシン（Tailscale経由でアクセス）

#### データ保存方式
ブラウザの**localStorage**を使用（サーバー側DBなし）

| キー | 内容 |
|-----|------|
| `cardBalances` | カード残高（毎日更新） |
| `invoicePayments` | 請求書払いデータ |
| `withdrawalAmounts` | 引き落とし金額 |

#### カードマスターデータ構造 (CARDS配列)

```javascript
{
    id: 'shinkin_visa',      // カード識別子
    name: 'しんきんVisa',     // 表示名
    closingDay: 15,          // 締め日（31=月末）
    paymentDayOffset: 10,    // 支払日
    paymentMonthOffset: 1,   // 支払月オフセット（0=当月、1=翌月）
    creditLimit: 1600000,    // 限度額
    invoicePayment: true     // 請求書払い対応
}
```

#### 請求書払いデータ構造 (INVOICE_PAYMENTS配列)

```javascript
{
    date: '2025-12-19',           // 申請日
    settlementDate: '2025-12-22', // 決済日（引落計算基準）
    name: 'ヤマト（12月分）',      // 支払先名
    amount: 1200000,              // 金額
    card: 'shinkin_visa',         // カードID
    category: '荷造運賃',          // カテゴリ
    status: 'pending',            // pending/completed
    completedDate: null,          // 完了日
    note: '振込希望日12/25'        // 備考
}
```

#### 主要機能
1. **カード残高入力**: 9枚すべての利用可能額を手動入力
2. **引き落とし日計算**: 締日・支払日から自動計算（土日祝後ろ倒し）
3. **猶予日数ランキング**: 今日使った場合の引落が遅い順に表示
4. **月次ルーティン**: 支払先ごとのカード配分を表示
5. **請求書カード払いスケジュール**: チェックボックスで完了管理
6. **引き落としスケジュール**: カードごとの引落金額を入力・合計表示

### 自動化の実現可能性

| 機能 | 方法 | 難易度 |
|------|------|--------|
| Slackリマインド | ダッシュボードのデータを読み取り→Slack Webhook | ◎ 容易 |
| 残高入力の自動化 | 会社カード3枚のみAPI取得可能、個人6枚は手動維持 | △ 一部可能 |
| 請求書払い申請リマインド | INVOICE_PAYMENTSから申請日を取得→通知 | ◎ 容易 |
| 枠不足警告 | cardBalances + 予定金額を比較→通知 | ◎ 容易 |

### 課題
- **データがlocalStorage**: ブラウザごとに別データ、サーバー共有なし
- **請求書払いデータがハードコード**: 新規追加は手動でHTMLを編集必要
- **API連携なし**: 外部サービスとの自動連携機能がない

### 改善案（将来）
1. データをJSON/SQLiteに移行してサーバー側で永続化
2. Slack Bot統合でリマインド自動送信
3. 請求書払いデータの管理画面追加

---

### 資金繰り表スプレッドシートの構成

#### 基本情報
- **URL**: `https://docs.google.com/spreadsheets/d/1Gg4Lvvlx25GGk-LdEnr8apUO2Q4e2ZOYovaAlBfV7os/`
- **シート名**: 資金繰り表（gid=419643659）
- **権限**: 外部共有中（複数人編集可能）

#### シート一覧（主要なもの）
| シート名 | 用途 |
|---------|------|
| 資金繰り表 | **日次の入出金・残高管理（メイン）** |
| 金額KPI | 金額関連のKPI管理 |
| 在庫内訳 | 在庫の内訳管理 |
| 日次損益計算 | 日次の損益計算 |
| 買取価格 | 買取価格表 |
| 貸付・融資リスト | 融資関連の管理 |

#### 資金繰り表シートの列構造

| 列範囲 | カテゴリ | サブカテゴリ例 |
|--------|---------|---------------|
| A | - | 日付（YYYY-MM-DD形式） |
| B-G | 売上 | ムスビ、BM、アジリ、stores、直売再販 |
| H-? | 仕入 | 在庫買取、直接買取 |
| ?-? | 経費 | 出勤（店舗）等 |
| ?-? | 経営 | 人件費等 |
| ?-AF | 運送 | **クレカ**、融資、残高 |
| AG-AK | 残高 | 口座残高、予測残高 |

#### 行構造
- **行1-2**: ヘッダー（固定表示）
  - 行1: 大カテゴリ（売上、仕入、経費、経営、運送、残高）
  - 行2: サブカテゴリ
- **行3以降**: 日次データ（日付順）

#### 自動化連携のポイント
- **Google Sheets API**: OAuth2.0認証で読み書き可能
- **クレカ支払い列**: 運送カテゴリ内の「クレカ」列に金額を入力
- **残高照合**: 最右列の「口座残高」と実残高を比較

---

最終更新: 2026-01-11
