# クレジットカード運用最適化ロジック

作成日: 2025-11-06

## 目的

支払猶予を最大化しつつ、カード枠の制約を守り、支払期限を遵守する最適なカード配分を計算する。

---

## 最適化の優先順位

1. **支払猶予の最大化** ⭐（最優先）
2. **支払期限を守る**
3. **運用のシンプルさ**
4. **カード枠の有効活用**

---

## アルゴリズム

### Step 1: カードの支払猶予期間を計算

各カードについて、申請日から支払日までの日数（支払猶予期間）を計算する。

#### 計算ロジック

```
申請日 = 締め日 + 1日
着金日 = 申請日 + 4営業日
支払日 = 着金月の（締め日から計算された）支払日

支払猶予期間 = 支払日 - 申請日
```

#### 例: Amazon（締め日31日、支払日翌月26日）

```
申請日: 毎月1日（締め日31日の翌日）
着金日: 毎月5日（申請日+4営業日）
支払日: 翌月26日

支払猶予期間: 約51日
```

#### 例: しんきんVisa（締め日15日、支払日翌月10日）

```
申請日: 毎月16日
着金日: 毎月20日（申請日+4営業日）
支払日: 翌々月10日（着金が15日以降なので、翌々月扱い）

支払猶予期間: 約50日
```

---

### Step 2: カードを支払猶予期間でソート

請求書カード払い可能なカードを、支払猶予期間が長い順にソートする。

**優先順位（支払猶予期間の長い順）:**

1. トヨタ（約52日）- 翌々月2日支払い
2. Amazon（約51日）- 翌月26日支払い
3. しんきんVisa（約50日）- 翌々月10日支払い
4. しんきんJCB（約50日）- 翌々月10日支払い
5. JFR（約50日）- 翌々月10日支払い
6. MI（約21日）- 当月26日支払い

---

### Step 3: 固定費（請求書カード払い）の配分

固定費を優先的に配分する。

**対象:**
- ユニホー: 25万円
- ドンキ: 25万円
- レンタルオフィス: 6.5万円
- **合計: 56.5万円**

**配分方針:**
- 支払猶予が最も長いカードに集約（運用をシンプルに）
- カード枠を確認して実行可能性をチェック

**推奨配分（案）:**
- Amazon: 56.5万円（枠に余裕がある場合）

---

### Step 4: 変動費（請求書カード払い）の配分

変動費を配分する。

**対象:**
- 徐さん: 150万円前後（分割可能）
- ヤマト: 120万円前後（**分割不可**）
- ビズビ: 10万円前後
- **合計: 280万円前後**

**配分方針（優先度順）:**

#### 4-1. 【最優先】ヤマト（120万円・分割不可）を優先配分

**ロジック:**
```python
# 1. ヤマトをトヨタに優先配分
if トヨタの利用可能額 >= 120万円:
    トヨタにヤマト120万円を配分
    トヨタの残り枠 = 0円
else:
    警告: ヤマトを配分できません
```

**選択理由:**
- トヨタ: 枠120万円（ヤマトと完全一致）
- 支払猶予57日（最長）
- 請求書カード払い対応

**実装結果（2025年11月）:**
- ✅ トヨタにヤマト120万円を配分
- ✅ 家賃3件（56.5万円）は自動的にAmazonに再配分

#### 4-2. 家賃3件（56.5万円）の再配分

**ヤマト優先配分により、家賃3件は自動的に次の候補カードに配分される:**

```python
# 家賃3件: ユニホー、ドンキ、レンタルオフィス（合計56.5万円）
# 支払猶予が長いカード順に配分（トヨタは既に使用済みのためスキップ）
配分先 = Amazon（支払猶予56日）
```

**実装結果（2025年11月）:**
- ✅ Amazon: ユニホー25万 + ドンキ25万 + レンタルオフィス6.5万 = 56.5万円

#### 4-3. 徐さん（150万円前後・分割可能）を配分

残りの枠を使って、支払猶予が長いカードに分割配分：

**実装結果（2025年11月・94.94万円の場合）:**
- Amazon: 34.7万円（家賃分の残り枠）
- しんきんJCB: 5.8万円
- MI: 54.44万円
- **合計: 94.94万円** ✅

**配分戦略:**
1. 支払猶予が長いカードから順に配分
2. 各カードの残り枠を最大限活用
3. 複数カードに分散して柔軟性を確保

#### 4-4. ビズビ（10万円）を配分

残り枠があるカードに配分：

**実装結果（2025年11月）:**
- MI: 10万円 ✅

---

### Step 5: 固定費（通常クレカ払い）の配分

通信費（73万円）を配分する。

**配分方針:**
- 請求書払いで使用していない大きな枠のカードに固定
- 候補: アメックス（枠635万円）、セゾン（枠700万円）

**推奨配分:**
- アメックス: 73万円

---

### Step 6: 変動費（通常クレカ払い）の配分

変動費を残り枠に配分する。

**対象:**
- LINE広告: 3万円
- 備品・消耗品費: 20万円
- 支払手数料: 11万円
- **合計: 34万円**

**配分方針:**
- 残り枠があるカードに分散
- 優先順位: 支払猶予が長いカード

---

### Step 7: 広告チャージの配分

広告チャージを残り枠で調整する。

**対象:**
- Google広告: 1日9万円 × 月の日数
- Yahoo広告: 1日1万円 × 月の日数
- **合計: 月300万円前後**

**配分方針:**

1. **請求書払いで使用したカードの広告チャージを減額**
   - 例: しんきんJCBで徐さん50万円を払う場合、広告チャージを80万円→30万円に減額

2. **減額分を他カードに振り分け**
   - 優先: アメックス（枠635万円）、セゾン（枠700万円）
   - 支払猶予も考慮（アメックス: 翌月10日、セゾン: 翌月4日）

---

## 制約条件

### 必須制約

1. **カード枠を超えない**
   - 各カードの利用額 ≤ 利用可能額

2. **支払期限を守る**
   - 請求書の着金日 ≤ 支払期限日

3. **分割不可の支払いは1枚のカードで**
   - ヤマト、ビズビ等は分割できない

### 推奨制約

1. **請求書カード払いはAmex以外を使用**
   - Amexは請求書カード払い不可

2. **広告チャージは毎日発生**
   - 1つのカードに集中させすぎない

---

## 出力形式

### 最適スケジュール

| 支払先 | 金額 | カード | 申請日 | 着金日 | 支払日 | 猶予日数 |
|--------|------|--------|--------|--------|--------|---------|
| ユニホー | 25万円 | Amazon | 11/1 | 11/5 | 12/26 | 51日 |
| ... | ... | ... | ... | ... | ... | ... |

### カード別使用状況

| カード | 利用可能額 | 請求書払い | 通信費 | 広告 | その他 | 合計 | 残り枠 |
|--------|-----------|----------|--------|------|--------|------|--------|
| Amazon | 69.9万円 | 156.5万円 | - | - | - | 156.5万円 | ⚠️枠超過 |
| ... | ... | ... | ... | ... | ... | ... | ... |

### 注意事項・警告

- 枠超過の警告
- 支払期限ギリギリの警告
- 調整が必要な広告チャージの通知

---

## 実装上の注意点

### ヤマト優先配分の実装（2025-11-06追加）

**スクリプト内での優先順位制御:**

```python
def allocate_payments(self):
    """支払を最適配分"""
    # 【優先度1】ヤマト120万円をトヨタに配分（最優先）
    yamato_payment = next((p for p in self.payments if p.id == 'yamato'), None)
    if yamato_payment:
        toyota_card = self.cards.get('toyota')
        if toyota_card and toyota_card.available_balance >= yamato_payment.amount:
            yamato_payment.allocate(toyota_card, yamato_payment.amount)
            toyota_card.available_balance -= yamato_payment.amount
        else:
            self.warnings.append(f"⚠️ ヤマト（{yamato_payment.amount:,}円）をトヨタに配分できません（枠不足）")

    # 【優先度2】請求書カード払いの支払いを配分（ヤマト以外）
    invoice_payments = [p for p in self.payments
                       if p.category in ['地代家賃', '仕入', '荷造運賃']
                       and p.id != 'yamato'  # ヤマトは除外
                       and not p.allocations]  # 未配分のもの

    for payment in invoice_payments:
        if payment.is_splittable:
            self._allocate_splittable(payment)
        else:
            self._allocate_non_splittable(payment)

    # 【優先度3】通常クレカ払いを配分
    # 【優先度4】広告チャージを配分
```

**ポイント:**
1. ヤマトを最初に処理してトヨタの枠を確保
2. `and not p.allocations`で二重配分を防止
3. 家賃3件は自動的に次の候補（Amazon）に配分される

---

最終更新: 2025-11-06
