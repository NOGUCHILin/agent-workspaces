# クレジットカード運用ダッシュボード 仕様書

作成日: 2025-11-11
ファイル: [index.html](../index.html)

---

## 📋 概要

クレジットカードの利用可能額管理、請求書カード払いスケジュール、引き落としスケジュールを一元管理するWebダッシュボード。

### 主な機能

1. **カード残高管理** - 各カードの利用可能額を入力・保存
2. **請求書カード払いスケジュール** - 申請予定の請求書払いを表示
3. **引き落としスケジュール** - 請求書払い + 通常クレカ払いの引き落とし予定を表示
4. **おすすめカード表示** - 今日使った場合の最適なカードを提案

---

## 🗂️ データ構造

### CARDS配列

各クレジットカードのマスター情報。

```javascript
const CARDS = [
    {
        id: 'toyota',                    // カードID（一意）
        name: 'トヨタファイナンス',       // 表示名
        closingDay: 5,                   // 締め日（1-31）
        paymentDayOffset: 2,             // 支払日（1-31）
        paymentMonthOffset: 1,           // 支払月オフセット（0=当月, 1=翌月）
        creditLimit: 1200000,            // 総与信枠（円）
        invoicePayment: true             // 請求書カード払い可否
    },
    // ...
];
```

### DEFAULT_BALANCES

各カードの利用可能額（初期値）。LocalStorageに保存された値があればそちらを優先。

```javascript
const DEFAULT_BALANCES = {
    'toyota': 1200000,
    'amazon': 436000,
    'shinkin_visa': 402000,
    // ...
};
```

### INVOICE_PAYMENTS配列

請求書カード払いの申請データ。

```javascript
const INVOICE_PAYMENTS = [
    {
        date: '2025-11-14',              // 申請日（YYYY-MM-DD）
        settlementDate: '2025-11-12',    // 決済日（カードが切られた日）
        name: 'ヤマト',                  // 支払先名
        amount: 1198000,                 // 決済額（手数料込み、円）
        card: 'shinkin_visa',            // 使用カードID
        category: '荷造運賃',            // カテゴリ
        status: 'completed',             // 状態（'completed' or 'pending'）
        note: '振込希望日11/14、決済完了' // 備考
    },
    // ...
];
```

**重要フィールド:**
- `settlementDate`: 引き落とし日計算の基準日（振込希望日の2営業日前）
- `status`:
  - `'completed'` = 決済完了（緑色表示、チェックマーク付き）
  - `'pending'` = 未決済（赤色「（暫定）」表示）

---

## 🎨 主要機能の詳細

### 1. カード残高管理セクション

#### 機能
- 各カードの利用可能額を入力
- 入力値はLocalStorageに自動保存
- 使用率に応じて色分け表示

#### 色分けルール
```javascript
使用率 < 30%  → 緑色（status-good）
30% ≤ 使用率 < 70% → 黄色（status-warning）
70% ≤ 使用率 → 赤色（status-danger）
```

#### LocalStorage保存キー
- `cardBalances` - JSON形式で全カードの残高を保存

---

### 2. 請求書カード払いスケジュール

#### 表示内容
- 申請日ごとにグループ化
- 支払先、金額、使用カード、引き落とし日を表示

#### 決済状態による表示分け

**決済完了（status: 'completed'）:**
- 背景色：緑のグラデーション
- ボーダー：緑色の太枠
- 右側に大きな✓マーク
- タイトルに✅アイコン
- チェックボックス：自動チェック・無効化

**未決済（status: 'pending'）:**
- 通常の白背景
- チェックボックス：有効

#### 引き落とし日の計算

```javascript
決済日（settlementDate）を基準に計算
↓
カードの締め日と比較
↓
締め日前 → 当月締め
締め日後 → 翌月締め
↓
支払月 = 締め月 + paymentMonthOffset
支払日 = paymentDayOffset
↓
土日祝日の場合は翌営業日に調整
```

---

### 3. 引き落としスケジュール

#### 表示内容

**請求書払いがあるカード:**
```
・ しんきんVisa: 1,513,531円 （請求書1,313,531円 + 通常200,000円）
    - ヤマト（請求書払い）: 1,198,000円
    - 徐さん（2/2）（請求書払い）（暫定）: 41,882円
    - ビズビ（請求書払い）（暫定）: 73,649円
    + 通常クレカ払い: [200,000] 円
```

**請求書払いがないカード:**
```
・ GPC: [入力フィールド] 円
```

#### 機能
1. **請求書払いのグループ化**
   - 同じカード・同じ引き落とし日の請求書払いをまとめて表示
   - 内訳として各支払先を列挙

2. **暫定表示**
   - `status: 'pending'` の請求書払いに「（暫定）」を赤色・太字で表示

3. **通常クレカ払い入力**
   - 請求書払いがあるカードでも、通常クレカ払い分を追加入力可能
   - 入力値はLocalStorageに保存（キー: `withdrawalAmounts`）
   - 請求書払い金額 + 通常払い金額 = 合計金額

4. **合計金額の自動計算**
   - 日付ごとに全カードの引き落とし額を合計

#### LocalStorage保存形式

```javascript
{
    "2025-12-10_shinkin_visa": 200000,
    "2026-01-10_amazon": 150000,
    // キー: "{日付}_{カードID}"
    // 値: 通常クレカ払い金額（円）
}
```

---

### 4. おすすめカード表示

#### 機能
- 今日クレジットカードを使った場合、最も引き落とし日が遅いカードを提案
- 上位3枚をランキング表示

#### 表示項目
- カード名
- 引き落とし日
- 利用可能額
- 使用可否判定

#### ランキング表示
- 1位：金色のグラデーション背景
- 2位：銀色のグラデーション背景
- 3位：銅色のグラデーション背景

---

## 💾 データ永続化

### LocalStorage使用キー

| キー | 内容 | 形式 |
|-----|------|------|
| `cardBalances` | カード残高 | `{"toyota": 1200000, "amazon": 436000, ...}` |
| `withdrawalAmounts` | 引き落とし金額 | `{"2025-12-10_shinkin_visa": 200000, ...}` |

### データの読み込み優先順位

1. LocalStorageに保存された値
2. `DEFAULT_BALANCES`の初期値

---

## 🔧 主要関数

### カード残高管理

```javascript
loadBalances()           // LocalStorageから残高を読み込み
saveBalances(balances)   // LocalStorageに残高を保存
updateBalance(cardId)    // 特定カードの残高を更新
renderCardBalances()     // カード残高セクションを描画
```

### 請求書カード払いスケジュール

```javascript
renderInvoiceSchedule()           // 請求書払いスケジュールを描画
calculatePaymentDate(card, date)  // 引き落とし日を計算
toggleTaskComplete(date, idx)     // チェックボックスでタスク完了切替
```

### 引き落としスケジュール

```javascript
renderWithdrawalSchedule()                    // 引き落としスケジュールを描画
handleWithdrawalAmountChange(dateKey, cardId, value)  // 引き落とし金額変更
getWithdrawalAmount(dateKey, cardId)          // LocalStorageから金額取得
setWithdrawalAmount(dateKey, cardId, amount)  // LocalStorageに金額保存
```

### ユーティリティ

```javascript
formatDate(date)              // 日付を「YYYY-MM-DD (曜日)」形式に変換
adjustForHolidays(date)       // 土日祝日を翌営業日に調整
getLastDayOfMonth(year, month)  // 月末日を取得
```

---

## 🎨 スタイル仕様

### カード残高の色分け

```css
.status-good    /* 緑色 - 使用率30%未満 */
.status-warning /* 黄色 - 使用率30-70% */
.status-danger  /* 赤色 - 使用率70%以上 */
```

### 決済完了の表示

```css
.status-completed {
    background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
    border: 2px solid #28a745;
}

.status-completed::before {
    content: '✓';  /* 大きなチェックマーク */
}
```

### レスポンシブ対応

- 768px以下でカードグリッドが1カラムに変更
- フォントサイズ・パディング調整

---

## 📝 運用ルール

### 請求書カード払いの申請ルール

1. **振込希望日**: 5日、10日、15日、20日、25日、30日から選択
2. **申請期限**: 振込希望日の4営業日前まで
3. **決済期限**: 振込希望日の2営業日前まで
4. **決済日（settlementDate）**: 決済期限日を設定

### 月次申請スケジュール

各支払先の申請日と振込希望日は以下の通り：

| 支払先 | 申請日 | 振込希望日 | 使用カード |
|-------|--------|----------|----------|
| ヤマト運輸 | 毎月1日 | 毎月5日 | Amazon |
| ユニホー | 毎月4日 | 毎月10日 | トヨタ（専用） |
| 徐さん・ビズビ | 毎月14日 | 毎月20日 | しんきんVisa・JCB |
| ドンキ | 毎月24日 | 毎月末日 | しんきんVisa |

**申請日の計算根拠**: 振込希望日の4営業日前

### データ更新手順

#### 新規の請求書払いを追加

1. `INVOICE_PAYMENTS`配列に新しいオブジェクトを追加
2. 必須フィールドを設定：
   - `date`: 申請日
   - `settlementDate`: 決済日（振込希望日の2営業日前）
   - `name`: 支払先名
   - `amount`: 決済額（手数料込み）
   - `card`: カードID
   - `status`: `'pending'`（未決済）

#### 決済完了時の更新

1. 該当する請求書払いの`status`を`'completed'`に変更
2. ブラウザをリロード
3. 請求書払いスケジュールで緑色表示に変わることを確認

#### カード残高の更新

1. ダッシュボードの「💰 カード残高管理」セクションで金額を入力
2. 自動的にLocalStorageに保存される
3. ページをリロードしても値が保持される

---

## 🔒 セキュリティ・制限事項

### LocalStorageの制限

- ドメインごとに約5-10MBの容量制限
- ブラウザのキャッシュクリアで削除される可能性
- 定期的なバックアップ推奨

### データの同期

- LocalStorageはブラウザ固有
- 複数デバイス間での同期機能なし
- 手動でデータをエクスポート/インポートする機能は未実装

---

## 🐛 既知の制限事項

1. **営業日計算**
   - HOLIDAYS_2025配列に手動で祝日を登録
   - 2026年以降の祝日は未対応

2. **時刻の考慮**
   - 日付のみで計算（時刻は考慮しない）

3. **カードの増減**
   - カード追加・削除時はCARDS配列を手動編集

---

## 📚 関連ドキュメント

- [CLAUDE.md](../CLAUDE.md) - プロジェクト全体の説明
- [decision-rules.md](decision-rules.md) - 請求書カード払いのルール
- [master-data-v2.yaml](master-data-v2.yaml) - カード情報マスター

---

## 🔄 更新履歴

| 日付 | 内容 |
|------|------|
| 2025-11-13 | 月次申請スケジュール最適化（徐さん・ビズビ: 16日→14日、ドンキ: 16日→24日に変更） |
| 2025-11-11 | 決済完了デザイン変更、請求書払いと通常払いの合算表示機能追加 |
| 2025-11-08 | 引き落としスケジュールのカードグループ化、決済日フィールド追加 |
| 2025-11-07 | HTMLダッシュボード初版完成 |

---

**最終更新**: 2025-11-13
**バージョン**: 1.2
