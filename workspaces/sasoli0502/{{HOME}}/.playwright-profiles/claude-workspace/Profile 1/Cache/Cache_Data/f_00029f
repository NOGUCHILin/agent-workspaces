"use strict";(globalThis.webpackChunknotion_next=globalThis.webpackChunknotion_next||[]).push([[85673],{160992:(e,t,n)=>{n.d(t,{K:()=>d});n(581454);var r=()=>n(907258),o=()=>n(484714),a=()=>n(590526),i=()=>n(119081),s=()=>n(381678);function d(){const e=(0,o().v3)(),t=(0,a().O$)(r().AppStoreSidebarSpaceViewStore),n=(0,a().K8)((()=>(0,s()._)(e)),[e]);return(0,a().K8)((()=>{var e;if(!n)return[];const r=(null==t||null===(e=t.getSettings())||void 0===e?void 0:e.agent_chat_modules)??[];return 0===r.length?[]:r.map((e=>({defaultEnabled:e.defaultEnabled,workflowModuleStore:i().P.createChildStore(n,e.pointer)})))}),[t,n])}},332724:(e,t,n)=>{n.d(t,{W:()=>d});var r=()=>n(907258),o=()=>n(484714),a=()=>n(590526),i=()=>n(712505),s=()=>n(207214);function d(e){const{omitCurrentPage:t,includeCurrentPageId:n=!1}=e,d=(0,o().v3)(),c=(0,s().L)(d);return(0,a().K8)((()=>{const{sidebarSpaceStore:e,currentUserStore:o,sidebarSpaceViewStore:a,mainEditorCurrentBlockStore:s}=r().default.state;if(e&&o&&a)return{spaceStore:e,userStore:o,spaceViewStore:a,blockStore:t?void 0:s,peekStore:i().default.state.open?i().default.state.targetStore:void 0,workflowStore:c,currentPageId:!t&&n?null==s?void 0:s.id:void 0}}),[c,t,n])}},358993:(e,t,n)=>{n.d(t,{K$:()=>T,XA:()=>I});n(16280),n(410838),n(944114),n(898992),n(354520),n(672577),n(737550);var r=()=>n(799288),o=()=>n(728272),a=()=>n(234459),i=()=>n(201980),s=()=>n(534177),d=()=>n(910302),c=()=>n(354785),l=()=>n(680514),u=()=>n(29554),p=()=>n(594794),S=()=>n(77246),h=()=>n(244828),m=()=>n(687879),f=()=>n(791256),v=()=>n(555102),g=()=>n(57685),C=()=>n(140992),x=()=>n(65824);function T(e){const{mentions:t,threadStore:n,clientStore:r,environment:o,spaceStore:i}=e,{chatThreadStore:s}=function(e){const{threadStore:t,clientStore:n,environment:r,spaceId:o,threadId:i}=e;if(t)return{chatThreadStore:n.getOrCreateClientAIChatThreadStore(t.id),isNewThread:!1};const s=i??(0,p().Z1)({environment:r,table:a().To,spaceId:o});return{chatThreadStore:n.getOrCreateClientAIChatThreadStore(s),isNewThread:!0}}({threadStore:n,clientStore:r,environment:o,spaceId:i.id});s.setState({...s.state,stagedData:{...s.state.stagedData,mentionStagedData:t}})}async function I(e){const{agentChatIntegrations:t,aiChatFeatureController:n,args:a,clientStore:p,environment:T,hasAgentIntegrationsFeatureFlag:I,mainEditorCurrentBlockStore:b,peekViewBlockStore:k,inferenceContext:y,sourceIdForEventCorrelation:w,threadStore:_,parentPointer:E,invokedFromBlockId:M,temporaryAiThreadManager:P,sendPartialTranscript:A,sendPatchResponse:D,inputSurfaceOverride:R}=e,{prompt:B,config:F,prebuiltPrompt:V}=a,{promptWithoutSelectionContextTokens:O,hasSelectionContextTokens:K}=function(e){if(!e||0===e.length)return{promptWithoutSelectionContextTokens:e,hasSelectionContextTokens:!1};let t=!1;const n=i().RQ(e).filter((e=>!i().qXl(e)||(!i().uoE(i().uPN(e))||(t=!0,!1))));return{promptWithoutSelectionContextTokens:n.length>0?i().bBR(n):void 0,hasSelectionContextTokens:t}}(B),$=(null==V?void 0:V.displayText)??O;let L,U=_,W=!1;if(!y)throw new Error("No inference context");const{spaceStore:q,userStore:X,spaceViewStore:N}=y;if(!q)throw new Error("No space store");if(U){const e=(0,l().xX)({threadStore:U,environment:T,spaceStore:q,userStore:X});e&&e!==U&&(U=e,W=!0)}const z=(0,S().vE)([b,k].filter(s().O9));z&&d().DL({pageStore:z,environment:T,triggeredFrom:"agent"}),p.setState({...p.state,userSelectedConfig:!0}),function(e){const{environment:t,threadStore:n}=e;if(!n)return;const r=n.getTranscript().find((e=>"search"===e.type));r&&void 0===r.showResults&&(0,x().V)({environment:t,threadStore:n,stepId:r.id,traceId:r.traceId,showResults:!1})}({environment:T,threadStore:U});const G=P.getOrCreateThreadId({environment:T,spaceId:q.id,maybeThreadStore:U}),Q=p.getOrCreateClientAIChatThreadStore(G);e.localMentions&&e.localMentions.size()>0&&!U&&Q.setState({...Q.state,stagedData:{...Q.state.stagedData,mentionStagedData:e.localMentions}});const{preUserSteps:H,stagedMentionStep:j,stagedAttachmentSteps:Z}=function(e){const{chatThreadStore:t,environment:n,spaceId:r,selectedBlockStores:o=[],textSelection:a}=e,i=[],s=t.getStagedMentionPointers(),d=(0,v().BX)({environment:n,spaceId:r,pointers:s,selectedBlockStores:o,textSelection:a});d&&i.push(d);const c=t.getAndClearStagedAssistantAttachmentSteps();return c&&c.length&&i.push(...c),{preUserSteps:i,stagedMentionStep:d,stagedAttachmentSteps:c}}({chatThreadStore:Q,environment:T,spaceId:q.id,selectedBlockStores:K?void 0:e.selectedBlockStores,textSelection:K?void 0:e.textSelection}),J=Z&&Z.length>0;if(!(void 0!==$&&!(0,i().w9s)($))&&!J)return{didSubmit:!1,threadStore:U,didChangeThread:W};const Y=V?(0,v().Jv)({environment:T,spaceStore:q,userStore:X,value:V.displayText,locale:V.locale,promptType:V.type,args:V.args}):(0,v().Kf)({environment:T,spaceStore:q,userStore:X,value:B});if(U){const t=await async function(e){const{threadStore:t,environment:n,clientStore:a,inferenceSpaceStore:s,userStore:d,preUserSteps:c,userStep:l,chatThreadStore:u,clearLocalMentions:p,sendPatchResponse:S}=e;if(!(0,g().T)(t))return!1;const m=[...c,l],{serverCommitResult:f}=h().createAndCommit({userAction:"unifiedChatInputActions.persistMultiplayerThreadMessage",environment:n,canUndo:!1,perform:e=>{(0,C().Vn)({environment:n,spaceStore:s,threadStore:t,userStore:d,addSteps:m,transaction:e}),(0,C().Mi)({threadStore:t,transaction:e,updatedById:d.id,updatedByTable:"notion_user"})}});return i().jgW(l.value).some(r().ut)&&(await f,await(0,C().WE)({environment:n,clientStore:a,threadStore:t,sendPatchResponse:S,stepIdsToInclude:[l.id]})),u.setState({...u.state,stagedData:{...u.state.stagedData,mentionStagedData:new(o().d)}}),p&&p(),!0}({threadStore:U,environment:T,clientStore:p,inferenceSpaceStore:q,userStore:X,preUserSteps:H,userStep:Y,chatThreadStore:Q,clearLocalMentions:e.clearLocalMentions,sendPatchResponse:e.sendPatchResponse});if(t)return{didSubmit:!0,threadStore:U,didChangeThread:W}}if(!U||(0,f().av)(U)||void 0===U){const e=(0,f().hw)({config:F,hasAgentIntegrationsFeatureFlag:I})?await(0,f().oE)({agentChatIntegrations:t,environment:T,spaceStore:q,spaceViewStore:N}):void 0,r=(0,v().Xd)({environment:T,inferenceContext:y,config:F,addSteps:[e,...H,Y],surface:R??n.contextStepSurface,invokedFromBlockId:M});let o;o=U?(0,m().addStepsToExistingThreadAndRun)({environment:T,clientStore:p,spaceStore:q,userStore:X,threadStore:U,addSteps:r,waitForServerCommit:!0,sendPartialTranscript:A,sendPatchResponse:D,temporaryAiThreadManager:P}):(0,m().addTranscriptToNewThreadAndRun)({environment:T,spaceStore:q,transcript:r,parentPointer:E,threadId:G}),W=!0,L=o,function(e){const{config:t,prompt:n,spaceStore:r,threadStore:o,environment:a,sourceEventId:i,suggestedQuery:s,attachmentCount:d=0}=e;if("researcher"!==t.type)return;const l=(0,u().r4)(n,r);c().uH({environment:a,researchModeThreadId:o.id,queryLength:l.length,queryWords:l.split(/\s+/).filter(Boolean).length,source:"welcome_page",searchSessionId:void 0,qnaSessionId:void 0,sourceEventId:i,suggestedQuery:s,attachmentCount:d})}({config:F,prompt:$,spaceStore:q,threadStore:o,environment:T,sourceEventId:w,suggestedQuery:!1,attachmentCount:(null==Z?void 0:Z.length)??0})}else{var ee,te;(0,C().kh)({threadStore:U,config:F,environment:T});const e=[],t=U.getTranscript().findLast((e=>"context"===e.type)),r=(null==t?void 0:t.value.collectionViewBlockId)??(null==t?void 0:t.value.blockId),o=null==t?void 0:t.value.peekBlockId;r===(null===(ee=y.blockStore)||void 0===ee?void 0:ee.id)&&o===(null===(te=y.peekStore)||void 0===te?void 0:te.id)||e.push((0,v().WM)({environment:T,inferenceContext:y,surface:R??n.contextStepSurface,config:F,invokedFromBlockId:M}));const a=N.getSettings(),i=null==a?void 0:a.agent_personalization_settings;(null==t?void 0:t.value.context_page_id)!==(null==i?void 0:i.context_page_id)&&e.push((0,v().WM)({environment:T,inferenceContext:y,surface:R??n.contextStepSurface,config:F,invokedFromBlockId:M})),null!=Z&&Z.length&&e.push(...Z),j&&e.push(j),e.push(Y),(0,m().addStepsToExistingThreadAndRun)({environment:T,clientStore:p,spaceStore:q,userStore:X,threadStore:U,addSteps:e,waitForServerCommit:!0,sendPartialTranscript:A,sendPatchResponse:D,temporaryAiThreadManager:P}),h().createAndCommit({userAction:"unifiedChatInputActions.updateThreadUpdatedTime",environment:T,canUndo:!1,perform:e=>{(0,C().Mi)({threadStore:U,transaction:e,updatedById:X.id,updatedByTable:"notion_user"})}}),L=U}if(Q.setState({...Q.state,stagedData:{...Q.state.stagedData,mentionStagedData:new(o().d)}}),e.clearLocalMentions&&e.clearLocalMentions(),!L)throw new Error("Expected a thread store after submitting");return{didSubmit:!0,threadStore:L,didChangeThread:W}}},383814:(e,t,n)=>{n.d(t,{G:()=>l});var r=()=>n(755531),o=()=>n(242422),a=()=>n(295633),i=()=>n(179034),s=()=>n(384446),d=()=>n(207214),c=()=>n(486674);function l(e){const t=e.RouterStore.state.route.name;if("agent"===t)return(0,d().k)(e);if("meet"===t){var n;const t=(0,r().S)(),d=null===(n=e.currentUser)||void 0===n?void 0:n.id;if(!t||!d)return;if(!o().default.checkGate({gateName:"agent_in_meetings_route"}))return;const c=e.idCreator.getSpaceIdCreatorSync(t.id),l=(0,s().YJ)(d,c);return new(a().B)(e,{id:l,table:i().ev,spaceId:t.id})}return(0,c().a)()}},485673:(e,t,n)=>{n.r(t),n.d(t,{UnifiedChatInputProvider:()=>Y});n(410838),n(898992),n(354520),n(581454),n(737550);var r=n(296540),o=()=>n(920198),a=()=>n(907258),i=()=>n(60481),s=()=>n(59226),d=()=>n(484714),c=()=>n(590526),l=()=>n(444199),u=()=>n(77311),p=()=>n(232615),S=()=>n(591779),h=()=>n(277153),m=()=>n(728272),f=()=>n(179034),v=()=>n(743246),g=()=>n(201980),C=()=>n(496603),x=()=>n(28070),T=()=>n(965454),I=()=>n(981475),b=()=>n(483795),k=()=>n(962753),y=()=>n(383814),w=()=>n(38554),_=()=>n(21259),E=()=>n(206051),M=()=>n(428257),P=()=>n(712505),A=()=>n(140992),D=()=>n(358993),R=()=>n(626001),B=()=>n(497952),F=()=>n(160992),V=()=>n(144222),O=()=>n(332724),K=()=>n(392899),$=(n(944114),()=>n(739831)),L=()=>n(530849),U=()=>n(365646),W=()=>n(158489),q=()=>n(134025),X=()=>n(155792),N=()=>n(384944),z=()=>n(865454);class G extends(()=>n(757695))().Store{getInitialState(){return{stores:{}}}getStore(e){return this.state.stores[e]||(this.state.stores[e]=new(n(29923).R)({key:`aiChatDrafts:${e}`,namespace:n(553737).Bq,important:!0,trackingType:"necessary"})),this.state.stores[e]}}const Q=new G;function H(e){return Q.getStore(e)}var j=()=>n(684335),Z=()=>n(197836),J=n(474848);function Y(e){const{aiChatFeatureController:t,clientStore:n,nextConfig:G,setNextConfig:Q,onEsc:Y,onLoaded:te,onThreadChange:ne,onWillSubmit:re,sourceIdForEventCorrelation:oe,threadStore:ae,parentPointer:ie,invokedFromBlockId:se,disabled:de,placeholder:ce,mockTextStoreWithSetter:le,onSubmitHandlerReady:ue,onStartTyping:pe,ignoreKeyboardMode:Se,hidePeekFace:he}=e,me=(0,d().v3)(),[fe,ve]=(0,r.useState)(!1),ge=(0,s().X)("agent_integrations"),Ce=(0,s().X)("agent_enable_context_block_selection"),xe=(0,s().X)("agent_disable_save_previewed_steps"),Te=(0,w().U)(),{textStore:Ie,resetTextAndDraft:be,saveDraftDebounced:ke,inputSurfaceOverride:ye,setTextValue:we}=function({aiChatFeatureController:e,clientStore:t,mockTextStoreFromProps:n}){const o=e.aiChatType,a=(0,c().K8)((()=>{const e=t.state.primeInput;if(null!=e&&e.chatTypes.includes(o))return e}),[t,o]),{draftStore:i,initialDraftValue:s}=(0,c().K8)((()=>{const t=e.draftStorageKey,n=t?H(t):void 0;return{draftStore:n,initialDraftValue:(null==n?void 0:n.state)??(0,g().x9d)("")}}),[e]),d=(0,r.useRef)(void 0),l=(0,b().AI)({initialValue:null!=a&&a.text?(0,g().x9d)(a.text):s}),{store:u,setValue:p}=n??l,S=(0,r.useMemo)((()=>{if(i)return(0,C().sg)((e=>{!function(e,t){t&&(0,g().AhH)(t)>0?e.setState(t):e.setState(void 0)}(i,e)}),500)}),[i]),h=(0,r.useCallback)((()=>{null==S||S.cancel(),null==i||i.setState(void 0),p(void 0),d.current=void 0}),[i,S,p,d]);return(0,r.useEffect)((()=>()=>{null==S||S.cancel()}),[S]),(0,r.useEffect)((()=>{null!=a&&a.text&&!n&&(p((0,g().x9d)(a.text)),d.current=a.surfaceOverride,t.setState({...t.state,primeInput:void 0}))}),[o,t,a,n,p]),{textStore:u,resetTextAndDraft:h,saveDraftDebounced:S,inputSurfaceOverride:d.current,primeInput:a,setTextValue:p}}({aiChatFeatureController:t,clientStore:n,mockTextStoreFromProps:le}),_e=(0,o().L)(),Ee=(0,T().AD)(),Me=(0,c().O$)(a().AppStoreMainEditorCurrentBlockStore),Pe=(0,c().O$)(P().default.peekTargetStore),Ae=(0,c().K8)((()=>(0,y().G)(me)),[me]),De=(0,c().K8)((()=>{const e=Boolean(Ae),n="custom_agent"===t.aiChatType||"custom_agent_preview"===t.aiChatType,r=(null==Ae?void 0:Ae.table)===f().ev&&(null==Ae?void 0:Ae.getSystemBlockTypeStore().getValue()),o=!r||ee[r],a=null==ae?void 0:ae.getTranscript().findLast((e=>"context"===e.type)),i="daily_brief_reminder"===(null==a?void 0:a.value.surface)||"daily_brief_reminder"===I().globalChatPanelRuntimeStore.state.openSource;return!(!e||!o||n||i)&&!fe}),[t.aiChatType,fe,Ae,ae]),Re=De&&!Te,Be=(0,c().K8)((()=>{if(null==_e||!_e.id)return;const e=Ee.getOrCreateThreadId({environment:me,spaceId:null==_e?void 0:_e.id,maybeThreadStore:ae});return n.getOrCreateClientAIChatThreadStore(e)}),[n,null==_e?void 0:_e.id,me,Ee,ae]),Fe=(0,O().W)({omitCurrentPage:!De,includeCurrentPageId:Te&&De}),{mentions:Ve,handleChangeMentions:Oe,handleRemoveMentionChip:Ke,handleTextChange:$e,localMentions:Le,resetMentionsState:Ue,clearLocalMentions:We}=function({threadStore:e,clientStore:t,environment:n,spaceStore:o,textStore:a,setTextValue:i,saveDraftDebounced:s,inferenceContext:d,currentPageExplicitlyOmitted:l,setCurrentPageExplicitlyOmitted:u,shouldAutoAddCurrentPageToMentions:p,currentPageOrWorkflowStore:S,chatThreadStore:g}){const[C,x]=(0,r.useState)(new(m().d)),[T,I]=(0,r.useState)([]),b=(null==S?void 0:S.pointer.table)===f().ev||(null==S?void 0:S.pointer.table)===v().C0?null==S?void 0:S.pointer:void 0,k=(0,c().K8)((()=>(null==g?void 0:g.state.stagedData.mentionStagedData)??C),[g,C]),y=(0,r.useMemo)((()=>{if(!p)return k;if(!b||k.has(b))return k;const e=[b,...Array.from(k)];return new(m().d)(e)}),[k,p,b]),w=(0,r.useCallback)((()=>{x(new(m().d))}),[]),_=(0,r.useCallback)((r=>{if(!o||null==d||!d.userStore)return;b&&r.has(b)&&l&&u(!1),e?(0,D().K$)({mentions:r,threadStore:e,clientStore:t,environment:n,spaceStore:o,userStore:d.userStore}):x(r)}),[e,t,n,o,d,x,l,u,b]),E=(0,r.useCallback)((e=>{b&&h().L3.isEqualIdTable(e,b)&&u(!0);const t=new(m().d)(y);t.delete(e),_(t);const n=a.getValue();if(!n)return;let r=!1;const c=n.filter((t=>!(0,R().Bw)(t,e,o??void 0,null==d?void 0:d.userStore)||(r=!0,!1)));if(r){i(c),null==s||s(c);const t=T.filter((t=>!h().L3.isEqualIdTable(e,t)));t.length!==T.length&&I(t)}}),[y,_,a,T,I,i,u,b,s,o,null==d?void 0:d.userStore]),M=(0,r.useCallback)((e=>{null==s||s(e);const t=(0,R().dd)(e,o??void 0,null==d?void 0:d.userStore),{newMentionPointers:n,newInputMentionPointers:r}=(0,R().kQ)({currentTextMentionPointers:t,inputMentionPointers:T,allMentionPointers:Array.from(y)});n&&_(new(m().d)(n)),r&&I(r)}),[s,T,y,_,o,null==d?void 0:d.userStore]);(0,r.useEffect)((()=>{e&&C.size()>0&&g&&(g.setState({...g.state,stagedData:{...g.state.stagedData,mentionStagedData:C}}),w())}),[e,C,g,w]);const P=(0,r.useCallback)((()=>{w(),I([]),u(!1)}),[w,u]);return{mentions:y,handleChangeMentions:_,handleRemoveMentionChip:E,handleTextChange:M,localMentions:C,resetMentionsState:P,clearLocalMentions:w,setCurrentPageExplicitlyOmitted:u}}({threadStore:ae,clientStore:n,environment:me,spaceStore:_e,textStore:Ie,setTextValue:we,saveDraftDebounced:ke,inferenceContext:Fe,currentPageExplicitlyOmitted:fe,setCurrentPageExplicitlyOmitted:ve,shouldAutoAddCurrentPageToMentions:Re,currentPageOrWorkflowStore:Ae,chatThreadStore:Be}),{attachments:qe,handleDeleteStagedAttachment:Xe}=function({chatThreadStore:e}){const t=(0,c().K8)((()=>null==e?void 0:e.getStagedAttachmentUploadStoreIfExists()),[e]),n=(0,c().K8)((()=>(0,x().ev)(t)??[]),[t],{useDeepEqual:!0}),o=(0,r.useCallback)((n=>{t&&e&&(t.onDeleteFileUpload(n),e.unstageAttachmentInferenceTranscriptStep({fileId:n}))}),[t,e]);return{attachments:n,handleDeleteStagedAttachment:o}}({chatThreadStore:Be}),Ne=function({clientStore:e,threadStore:t,spaceStore:n}){const o=(0,d().v3)();return(0,r.useCallback)((r=>{if(!n||!t)return;const a=(0,z().getAgentPreviewWrapper)(o).getPreviewedSteps(),i=[];for(const e of a){const t=[];for(const n of(0,W().XS)(e)){const e=r.invertedOperations.length;A().Hp({environment:o,operation:n.operation,recordCache:o.defaultRecordCache.inMemoryRecordCache,transaction:r});const a=r.invertedOperations.slice(e),i=[];for(const t of a)(0,L().E)(t)||!(0,q().$Y)(t)&&!(0,q().mP)(t)||i.push(t);t.push({...n,invertedOperations:i})}const a={...(0,U().oA)(e,"applied:partial"),threadOperations:t};i.push(a);const s=$().X.createChildStore(n,{id:e.id,table:X().mS,spaceId:n.id});N().zv({store:s.getStepStore(),data:{state:(0,U().Gu)(a),threadOperations:a.threadOperations},transaction:r})}const s=e.getOrCreateClientAIChatThreadStore(t.id);s.setState({...s.state,temporarySteps:s.state.temporarySteps.map((e=>i.find((t=>t.id===e.id))||e))})}),[o,n,e,t])}({clientStore:n,threadStore:ae,spaceStore:_e}),ze=(0,A().zS)({clientStore:n,threadStore:ae,initialPerform:xe?void 0:Ne}),Ge=(0,F().K)(),{selectedBlockStores:Qe,multiTextSelection:He}=function({enableBlockSelection:e,mentions:t,aiChatFeatureController:n,configType:o}){const a=n.supportsUserSpecifiedContext(o),s=(0,K().b)(),d=(0,c().K8)((()=>{if(!e||!a)return[];const n=E().default.state;if(n.phase!==i().o.Selected)return[];return n.stores.filter((e=>!Array.from(t).some((t=>t.table===f().ev&&t.id===e.id)))).filter((e=>s(e)))}),[e,a,t,s]),l=(0,c().K8)((()=>{if(!e||!a)return;const t=p().default.state;return"editing"===t.mode?t.multiSelection:void 0}),[e,a]),u=(0,c().K8)((()=>{if(!e||!a)return;const t=I().globalChatPanelRuntimeStore.getCompletionTextSelection()??l;return t&&s(t.start.store)?t:void 0}),[e,a,s,l],{useDeepEqual:!0});return(0,r.useEffect)((()=>{l&&s(l.start.store)&&I().globalChatPanelRuntimeStore.update((e=>({...e,completionContext:void 0})))}),[l,s]),{selectedBlockStores:d,multiTextSelection:u}}({enableBlockSelection:Ce,mentions:Ve,aiChatFeatureController:t,configType:G.type}),je=(0,c().K8)((()=>(0,k().FO)(me,null==_e?void 0:_e.id)),[me,_e]);!function(e){const{enableAutoInsertion:t,multiTextSelection:n,saveDraftDebounced:o,selectedBlockStores:a,setTextValue:i,textStore:s}=e,d=(0,r.useRef)(void 0),c=(0,r.useRef)(void 0),l=(0,r.useRef)(void 0),p=(0,r.useRef)(void 0);(0,r.useEffect)((()=>()=>{l.current&&window.clearTimeout(l.current),p.current&&window.clearTimeout(p.current)}),[]),(0,r.useEffect)((()=>{if(!t)return d.current=void 0,void(l.current&&(window.clearTimeout(l.current),l.current=void 0));if(void 0===n||(0,u().k)(n))return d.current=void 0,void(l.current&&(window.clearTimeout(l.current),l.current=void 0));const e=(0,B().hL)(n);if(!e)return;const r=function(e){if(!e||"text"!==e.type)return"";const t=e.start,n=e.end,r=t.spaceId?`:${t.spaceId}`:"",o=n.spaceId?`:${n.spaceId}`:"";return`text:${t.id}${r}:${t.index}-${n.id}${o}:${n.index}`}(e);r!==d.current&&(l.current&&window.clearTimeout(l.current),l.current=window.setTimeout((()=>{const t=s.getValue(),n=(0,B().iR)({currentTextValue:t,data:e,mode:"replaceSameType"});i(n),null==o||o(n),d.current=r,l.current=void 0}),250))}),[t,n,o,i,s]),(0,r.useEffect)((()=>{if(!t)return c.current=void 0,void(p.current&&(window.clearTimeout(p.current),p.current=void 0));if(0===a.length)return c.current=void 0,void(p.current&&(window.clearTimeout(p.current),p.current=void 0));const e=(0,B().$c)(a);if(!e)return;const n=function(e){if(!e||"blocks"!==e.type)return"";return`blocks:${e.blocks.map((e=>e.spaceId?`${e.id}:${e.spaceId}`:e.id)).sort().join(",")}`}(e);n!==c.current&&(p.current&&window.clearTimeout(p.current),p.current=window.setTimeout((()=>{const t=s.getValue(),r=(0,B().iR)({currentTextValue:t,data:e,mode:"replaceSameType"});i(r),null==o||o(r),c.current=n,p.current=void 0}),250))}),[t,o,a,i,s])}({enableAutoInsertion:"automatic"===t.selectionContextInsertionMode,multiTextSelection:He,saveDraftDebounced:ke,selectedBlockStores:Qe,setTextValue:we,textStore:Ie}),function(e){const{enableManualInsertion:t,saveDraftDebounced:n,setTextValue:o,textStore:a}=e,i=(0,c().K8)((()=>I().globalChatPanelRuntimeStore.state.selectionContextInsertRequests),[],{useDeepEqual:!0});(0,r.useEffect)((()=>{if(!t)return;if(!i||0===i.length)return;let e=a.getValue();for(const t of i)e=(0,B().iR)({currentTextValue:e,data:t.data,mode:"append"});o(e),null==n||n(e),I().globalChatPanelRuntimeStore.update((e=>{const t=e.selectionContextInsertRequests;if(!t||0===t.length)return e;let n=0;for(;n<i.length&&n<t.length&&(null===(r=t[n])||void 0===r?void 0:r.id)===(null===(o=i[n])||void 0===o?void 0:o.id);){var r,o;n+=1}const a=t.slice(n);return{...e,selectionContextInsertRequests:a.length>0?a:void 0}}))}),[t,i,n,o,a])}({enableManualInsertion:"manual"===t.selectionContextInsertionMode,saveDraftDebounced:ke,setTextValue:we,textStore:Ie});const{errorState:Ze,handleChatSubmissionError:Je,clearError:Ye}=(0,V().yG)({}),{inputMode:et,threadMode:tt,upsellMessage:nt,upgradeButtonTextProps:rt,isUpgradeSystemEnabled:ot,onStartRecording:at,onStopRecording:it}=(0,j().W)({errorState:Ze,attachments:qe,clientStore:n,threadStore:ae,nextConfig:G,spaceStore:_e,textStore:Ie}),st=(0,r.useCallback)((async e=>{try{var r;if(de)return;"edit-reference"===(null===(r=M().l.getSource())||void 0===r?void 0:r.type)&&M().l.clear(),be(),re&&await re(e);const o=await(0,D().XA)({agentChatIntegrations:Ge,aiChatFeatureController:t,args:e,clearLocalMentions:We,clientStore:n,environment:me,hasAgentIntegrationsFeatureFlag:ge,inferenceContext:Fe,localMentions:ae?void 0:Le,mainEditorCurrentBlockStore:Me,peekViewBlockStore:Pe,selectedBlockStores:"manual"===t.selectionContextInsertionMode?void 0:Qe,textSelection:"manual"===t.selectionContextInsertionMode?void 0:He,sourceIdForEventCorrelation:oe,threadStore:ae,temporaryAiThreadManager:Ee,parentPointer:ie,invokedFromBlockId:se,sendPartialTranscript:!0,sendPatchResponse:!0,inputSurfaceOverride:ye});o.didChangeThread&&ne({newThreadStore:o.threadStore,submitFrom:e.submitFrom}),(0,_().D)({stores:[]}),I().globalChatPanelRuntimeStore.update((e=>({...e,completionContext:void 0})))}catch(a){var o;Je(a,"UnifiedChatInputProvider.handleSubmitCallback",{threadExists:Boolean(ae),spaceId:null==_e?void 0:_e.id,configType:null===(o=e.config)||void 0===o?void 0:o.type})}}),[de,be,re,Ge,t,We,n,me,ge,Fe,ae,Le,Me,Pe,ne,Qe,He,oe,Ee,ie,se,ye,Je,null==_e?void 0:_e.id]);(0,r.useEffect)((()=>{null==ue||ue(st)}),[ue,st]),function(){const e=(0,c().K8)((()=>I().globalChatPanelRuntimeStore.state.completionContext),[]),t=(0,K().t)();(0,r.useEffect)((()=>()=>{"textSelection"===(null==e?void 0:e.type)&&t(e)&&p().default.setState({mode:"editing",multiSelection:(0,l().O)(e.textSelection),forceExtendAnnotations:{}})}),[e,t])}();const dt=(0,S().ZC)(null==ae?void 0:ae.id);(0,r.useEffect)((()=>{dt&&dt!==(null==ae?void 0:ae.id)&&ve(!1)}),[dt,null==ae?void 0:ae.id,ve]);const ct=(0,S().ZC)(null==_e?void 0:_e.id);return(0,r.useEffect)((()=>{null!=_e&&_e.id&&ct&&(null==_e?void 0:_e.id)!==ct&&(Ue(),Q("reset"),be(),Ee.reset())}),[null==_e?void 0:_e.id,ct,be,Ee,Q,Ue]),(0,r.useEffect)((()=>{null==te||te()}),[te]),_e?(0,J.jsx)(Z().h,{aiChatFeatureController:t,attachments:qe,clientStore:n,mentions:Ve,nextConfig:G,currentPageInContext:De,onChangeMentions:Oe,onChangeNextConfig:Q,onDeleteStagedAttachment:Xe,onEsc:Y,onRemoveMentionChip:Ke,onStopInference:ze,onSubmit:st,onTextChange:$e,spaceStore:_e,textStore:Ie,threadStore:ae,disabled:de,errorState:Ze,onClearError:Ye,onStartTyping:pe,placeholder:ce,ignoreKeyboardMode:Se,selectedBlockStores:Qe,multiTextSelection:He,isSimplifiedInputEnabled:je,inputMode:et,threadMode:tt,upsellMessage:nt,upgradeButtonTextProps:rt,isUpgradeSystemEnabled:ot,onStartRecording:at,onStopRecording:it,hidePeekFace:he}):null}const ee={home_custom_db:!1,home_main:!1,home_trending:!1,home_similar_users:!1,home_most_visited:!1,home_last_edited:!1,home_favorites:!1,home_my_tasks:!1,home_posts:!1,home_shortcuts:!1,people_collection_view_page:!1,person_profile_main:!1,library_collection_view_page:!1,internal_system_collection_view_page:!1,meetings_collection_view_page:!1,team_page:!1}},497952:(e,t,n)=>{n.d(t,{$c:()=>l,hL:()=>c,iR:()=>u});n(898992),n(354520),n(581454);var r=()=>n(179034),o=()=>n(201980),a=()=>n(460957),i=()=>n(718957);const s=40;function d(e){return e.length<=s?e:`${e.slice(0,s).trimEnd()}â€¦`}function c(e){if(e.start.store.pointer.table!==r().ev||e.end.store.pointer.table!==r().ev)return;if(e.start.store.pointer.id===e.end.store.pointer.id&&e.start.store.pointer.spaceId===e.end.store.pointer.spaceId&&e.start.index===e.end.index)return;const t=d((0,a().E)({mode:"editing",multiSelection:e,forceExtendAnnotations:{}}).trim());return t?{type:"text",text:t,start:{id:e.start.store.pointer.id,spaceId:e.start.store.pointer.spaceId,index:e.start.index},end:{id:e.end.store.pointer.id,spaceId:e.end.store.pointer.spaceId,index:e.end.index}}:void 0}function l(e){const t=(0,i().BO)(e);if(!t)return;const n=d((0,a().E)({mode:"editing",multiSelection:t,forceExtendAnnotations:{}}).trim());return n?{type:"blocks",text:n,blocks:e.map((e=>({id:e.pointer.id,spaceId:e.pointer.spaceId})))}:void 0}function u(e){const{currentTextValue:t,data:n,mode:r}=e,a="replaceSameType"===r?function(e){const{textValue:t,kind:n}=e;if(!t||0===t.length)return t;const r=t.filter((e=>{if(!(0,o().qXl)(e))return!0;const t=(0,o().uoE)((0,o().uPN)(e));if(!t)return!0;return(0,o().$sA)(t).type!==n}));return r.length>0?r:void 0}({textValue:t,kind:n.type}):t,i=(0,o().wmz)((0,o().tcA)(n));if("replaceSameType"===r)return[i,(0,o().Ey_)(" "),...a??[]];const s=a??[],d=s[s.length-1],c=void 0===d?"":"string"==typeof d?d:d[0],l=s.length>0&&!/[\s\u00a0]$/.test(c);return[...s,...l?[(0,o().Ey_)(" ")]:[],i,(0,o().Ey_)(" ")]}}}]);