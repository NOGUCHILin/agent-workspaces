"use strict";(globalThis.webpackChunknotion_next=globalThis.webpackChunknotion_next||[]).push([[33695],{533695:(e,t,n)=>{n.d(t,{Z:()=>ve});n(18107),n(813451),n(967357),n(898992),n(354520),n(581454),n(737550);var r=n(296540),i=()=>n(726637),a=()=>n(484714),o=()=>n(590526),s=()=>n(699143),l=()=>n(493552),d=()=>n(621594),c=()=>n(69708),u=()=>n(534177),g=()=>n(618425),p=(n(944114),()=>n(496603));var h=()=>n(151838),f=()=>n(616878),S=()=>n(791256),m=()=>n(256001),x=()=>n(78620),y=()=>n(383894),b=()=>n(401497),v=n(474848);const C="https://notion.slack.com/app_redirect?channel=proj-agent-2-0";function k(){const e=(0,b().IS)((()=>({container:{display:"flex",alignItems:"center",gap:8,paddingTop:8,paddingBottom:4,paddingInlineStart:8,paddingInlineEnd:8},link:{color:"inherit",textDecoration:"underline",cursor:"pointer"}})),[]);return(0,v.jsx)("div",{style:e.container,children:(0,v.jsxs)(l().D,{styleKey:"captionRegular",colorVariant:"secondary",children:["2ï¸âƒ£  Agent 2.0 is enabled. Share feedback in ",(0,v.jsx)("a",{href:C,target:"_blank",rel:"noopener noreferrer",style:e.link,children:"#proj-agent-2-0"}),", and ðŸ‘Ž any bad behavior."]})})}var w=()=>n(920741),j=()=>n(203066),T=()=>n(153321),I=()=>n(920198),E=()=>n(744947),M=()=>n(631524),R=()=>n(906380),D=()=>n(145820),A=()=>n(100622),F=()=>n(571376),U=()=>n(240959);function K(e){const{threadStore:t}=e,n=(0,c().tz)(),[i,a]=(0,r.useState)(!1),d=(0,o().K8)((()=>{var e;return null==t||null===(e=t.getData())||void 0===e?void 0:e.run_id}),[t]),u=(0,I().L)(),g=(0,r.useMemo)((()=>{if(d&&u)return E().t.createChildStore(u,{table:D().QR,id:d,spaceId:u.id})}),[d,u]),p=(0,o().K8)((()=>null==g?void 0:g.getData()),[g]),h=(0,o().K8)((()=>null==g?void 0:g.getCreatedAt()),[g]),f=(0,o().K8)((()=>null==g?void 0:g.getDequeueAfter()),[g]),S=(0,r.useCallback)((()=>{a((e=>!e))}),[]),m=(0,r.useMemo)((()=>{const e={run_id:d,status:null==p?void 0:p.status,trigger_id:null==p?void 0:p.trigger_id,trigger_data:null!=p&&p.trigger_data?JSON.parse(p.trigger_data):void 0,error:null==p?void 0:p.error,workflow_version:null==p?void 0:p.workflow_version,spend:null==p?void 0:p.spend,paused_reason:null==p?void 0:p.paused_reason,created_at:h,finished_at:null==p?void 0:p.finished_at,trigger_at:null==p?void 0:p.trigger_at,dequeue_after:f};return JSON.stringify(e,null,2)}),[d,p,h,f]),x=(0,r.useMemo)((()=>{if(!f||"pending"!==(null==p?void 0:p.status))return;const e=f-Date.now();return e<=0?void 0:{relative:(0,U().a)(e),absolute:new Date(f).toLocaleString()}}),[f,null==p?void 0:p.status]),y=(0,b().IS)((()=>({wrap:{border:`1px solid ${A().Tj.border.secondary}`,background:A().Tj.background.secondaryTranslucent},headerButton:{borderRadius:7},codeInner:{borderRadius:8,backgroundColor:A().Tj.codeBlockBackground,padding:12},icon:{transition:"transform 0.2s ease-in-out",transformOrigin:"center",transform:i?"rotate(90deg)":"rotate(0deg)"},metadata:{display:"grid",fontSize:12,paddingInlineStart:8,marginTop:4,marginBottom:4,gridTemplateColumns:"120px 1fr",gap:4},metadataKey:{color:A().Tj.text.secondary},metadataValue:{color:A().Tj.text.primary,marginInlineStart:0},statusBadge:{display:"inline-flex",alignItems:"center",padding:"2px 8px",borderRadius:4,fontSize:11,fontWeight:600,textTransform:"uppercase"},statusPending:{backgroundColor:A().Tj.yellow.background.secondary,color:A().Tj.yellow.text.primary},statusRunning:{backgroundColor:A().Tj.blue.background.secondary,color:A().Tj.blue.text.primary},statusSuccess:{backgroundColor:A().Tj.green.background.secondary,color:A().Tj.green.text.primary},statusFailure:{backgroundColor:A().Tj.red.background.secondary,color:A().Tj.red.text.primary},statusSkipped:{backgroundColor:A().Tj.gray.background.secondary,color:A().Tj.gray.text.primary},statusPaused:{backgroundColor:A().Tj.purple.background.secondary,color:A().Tj.purple.text.primary}})),[i]);if(!d||!g)return null;const C={Status:null!=p&&p.status?(0,v.jsx)("span",{style:{...y.statusBadge,...(e=>{switch(e){case"pending":return y.statusPending;case"running":return y.statusRunning;case"success":return y.statusSuccess;case"failure":return y.statusFailure;case"skipped":return y.statusSkipped;case"paused":return y.statusPaused;default:return{}}})(p.status)},children:p.status}):null,"Trigger ID":null==p?void 0:p.trigger_id,"Created At":h?new Date(h).toLocaleString():null,"Finished At":null!=p&&p.finished_at?new Date(p.finished_at).toLocaleString():null,Duration:(k=h,w=null==p?void 0:p.finished_at,k&&w?(0,U().a)(w-k):null),"Workflow Version":null==p?void 0:p.workflow_version,Spend:null!=p&&p.spend?`$${p.spend.toFixed(4)}`:null,"Paused Reason":null==p?void 0:p.paused_reason,"Eligible For Dequeue":f?new Date(f).toLocaleString():null,"Has Error":null!=p&&p.error?"Yes":null};var k,w;return(0,v.jsxs)(s().Y1,{direction:"vertical",padding:4,borderRadius:8,style:y.wrap,children:[(0,v.jsx)(s().Y1,{direction:"horizontal",gap:2,align:"center-left",children:(0,v.jsx)(s().Y1,{width:"fill",children:(0,v.jsx)(M().p,{style:y.headerButton,iconLeading:{icon:R().arrowChevronSingleRightSmallIcon,size:"xs",colorVariant:"secondary",style:y.icon},"aria-label":n.formatMessage({id:"aiInferenceTranscript.viewWorkflowRun",defaultMessage:"View workflow automation run details"}),onClick:S,children:(0,v.jsx)(l().D,{styleKey:"captionMedium",children:"workflow automation run"})})})}),(0,v.jsx)(j().N,{children:i?(0,v.jsx)(T().P.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},exit:{opacity:0,height:0},transition:{duration:.2},children:(0,v.jsxs)(s().Y1,{direction:"vertical",gap:4,padding:8,children:[x?(0,v.jsx)(l().D,{styleKey:"captionRegular",color:"text/secondary",children:n.formatMessage({id:"workflow.waiting.debugMessage",defaultMessage:"Run resumes in {duration} ({time})."},{duration:x.relative,time:x.absolute})}):null,(0,v.jsx)("dl",{style:y.metadata,children:Object.entries(C).filter((([,e])=>null!==e)).map((([e,t])=>(0,v.jsxs)(r.Fragment,{children:[(0,v.jsx)("dt",{style:y.metadataKey,children:e}),(0,v.jsx)("dd",{style:y.metadataValue,children:t})]},e)))}),(0,v.jsx)("div",{style:y.codeInner,children:(0,v.jsx)(F().X,{value:m,language:"json"})})]})}):null})]})}var _=()=>n(98126);function V(){const e=(0,b().IS)((()=>({container:{backgroundColor:A().Tj.background.secondaryTranslucent,borderRadius:8,padding:12,display:"flex",alignItems:"center",gap:12,marginTop:16}})),[]);return(0,v.jsxs)("div",{style:e.container,children:[(0,v.jsx)(_().k,{size:"sm"}),(0,v.jsx)(l().D,{styleKey:"bodyRegular",colorVariant:"secondary",children:(0,v.jsx)(c().sA,{id:"agentThreadPeek.enqueuedRun.waiting",defaultMessage:"Waiting to start..."})})]})}var B=()=>n(83626),L=(n(672577),()=>n(907258)),z=()=>n(692031),P=()=>n(79926),Y=()=>n(849255),W=()=>n(695115),N=()=>n(26697),O=()=>n(467273),H=()=>n(209969),q=()=>n(627503),Q=()=>n(523389),$=()=>n(637433),J=()=>n(340498),X=()=>n(798880),Z=()=>n(366437),G=()=>n(483795),ee=()=>n(405623),te=()=>n(244828),ne=()=>n(982979),re=()=>n(140992),ie=()=>n(827368),ae=()=>n(119994),oe=()=>n(803078);function se(e){const{step:t,threadStore:r,clientStore:i,disableUserMessageEditing:a}=e;return"agent-message"===t.type?(0,v.jsx)(n(156747).Z,{step:t,threadStore:r}):"user-injected"===t.type?(0,v.jsx)(n(47942).m,{step:t,clientStore:i,threadStore:r,runningInference:!1}):(0,v.jsx)(le,{step:t,clientStore:i,threadStore:r,disableUserMessageEditing:a})}function le(e){const{step:t,clientStore:n,threadStore:i,disableUserMessageEditing:s}=e,l=(0,a().v3)(),d=(0,c().tz)(),g=t.userId===l.currentUser.id,p=(0,o().K8)((()=>i.getSpaceStore()),[i]),h=(0,o().K8)((()=>{if(p&&t.userId)return Y().L.createChildStore(p,{table:X().oo,id:t.userId})}),[p,t.userId]),f=(0,o().K8)((()=>null==h?void 0:h.getDisplayName(d)),[h,d]),m=(0,o().K8)((()=>{var e;return"search"===(null===(e=(0,S().L2)(i))||void 0===e?void 0:e.type)}),[i]),x=(0,o().K8)((()=>{var e;return"researcher"===(null===(e=(0,S().L2)(i))||void 0===e?void 0:e.type)}),[i]),y=(0,o().K8)((()=>{var e;return"markdown-chat"===(null===(e=(0,S().L2)(i))||void 0===e?void 0:e.type)}),[i]),[C,k]=(0,r.useState)(!1),w=(0,r.useRef)(null),j=(0,r.useRef)(null),{store:T,setValue:I}=(0,G().AI)({initialValue:t.value}),E=(0,r.useCallback)((()=>{k(!1),I(t.value)}),[t.value,I,k]),M=function(e){const{step:t,clientStore:n,threadStore:i,environment:a,textRef:o,setIsEditing:s,mockTextStore:l}=e,d=(0,r.useCallback)((()=>{s(!0),setTimeout((()=>{var e;null===(e=o.current)||void 0===e||e.focus()}),1)}),[s,o]),c=(0,r.useCallback)((e=>{s(!1),function(e){const{environment:t,threadStore:n,clientStore:r,step:i,newValue:a}=e,o=n.getTranscript().find(O().z),s=(null==o?void 0:o.id)===i.id,{serverCommitResult:l}=te().createAndCommit({userAction:"AgentUserStep.saveUserStepChanges",environment:t,canUndo:!0,perform:e=>{const{type:t}=i;"agent-prebuilt-prompt"===t?(0,re().ki)({threadStore:n,stepId:i.id,newValue:a,transaction:e}):"user"===t?(0,re().D7)({threadStore:n,step:i,newValue:a,transaction:e}):(0,u().HB)(t),(0,re().Pz)({threadStore:n,stepId:i.id,transaction:e})}});(0,re().WE)({environment:t,threadStore:n,clientStore:r,forceRegenerateTitle:s,stepIdsToInclude:[i.id],waitBeforeSending:l,sendPatchResponse:!0})}({environment:a,threadStore:i,clientStore:n,step:t,newValue:e})}),[a,i,n,t,s]),g=(0,r.useCallback)((()=>{const e=l.getValue();e&&0!==e.length&&c(l.getValue()||[])}),[c,l]);return{handleEditClick:d,saveEdit:g}}({step:t,clientStore:n,threadStore:i,environment:l,textRef:w,setIsEditing:k,mockTextStore:T});(0,r.useEffect)((()=>{if(!C)return;const e=e=>{j.current&&!j.current.contains(e.target)&&E()};return document.addEventListener("mousedown",e),()=>{document.removeEventListener("mousedown",e)}}),[C,E]);const R=(0,b().IS)((()=>({container:{position:"relative",display:"flex",flexDirection:"column",alignItems:g?"flex-end":"flex-start",gap:2}})),[g]),D=0===(t.value||[]).length;return(0,v.jsxs)("div",{style:R.container,ref:j,"data-agent-chat-user-step-id":t.id,children:[!g&&h&&p?(0,v.jsx)(ae().U,{type:"user",userStore:h,spaceStore:p,displayName:f??""}):void 0,D?void 0:(0,v.jsx)(ge,{isCurrentUser:g,userStore:h,isEditing:C,mockTextStore:T,textRef:w,onSaveEdit:M.saveEdit,onEditClick:M.handleEditClick,disableUserMessageEditing:s,isSearchConfig:m,isResearcherConfig:x,isMarkdownChatConfig:y,step:t,threadStore:i}),(0,v.jsx)(he,{isCurrentUser:g,isEditing:C,onCancelEdit:E,onSaveEdit:M.saveEdit,mockTextStore:T})]})}function de(e){const{store:t,onClick:n,clickable:i,isCurrentUser:a}=e,o=(0,c().tz)(),{bodyStyleKey:s}=(0,ie().yq)(),l=(0,ie().Cd)(s),d=(0,b().IS)((()=>({bubble:{paddingTop:6,paddingBottom:6,paddingInlineStart:a?14:0,paddingInlineEnd:a?14:0,borderRadius:a?16:0,...a&&{backgroundColor:A().Tj.background.tertiaryTranslucent},transition:"background-color 0.1s ease",...i?{cursor:"pointer"}:{}},richText:{...l,whiteSpace:"pre-wrap",wordWrap:"break-word",wordBreak:"break-word"}})),[i,a,l]),u=(0,r.useCallback)((e=>{i&&n&&("Enter"!==e.key&&" "!==e.key||(e.preventDefault(),n()))}),[i,n]);return(0,v.jsx)("div",{style:d.bubble,onClick:i?n:void 0,onKeyDown:i?u:void 0,role:i?"button":void 0,tabIndex:i?0:void 0,"aria-label":i?o.formatMessage(Se.editMessage):void 0,children:(0,v.jsx)(ee().A,{store:t,disabled:!0,style:d.richText,disableSlashCommands:!0,disableEmbedMenu:!0,disableEmojiCommands:!0,disableComment:!0,disableSelectAllBlocks:!0,disableSelectionDrag:!0,disableEnter:!0,disableMobileActionBar:!0,disableStyleAnnotations:!0,disableInsertedDeletedAnnotations:!0,disableSuggestionAnnotations:!0,inPageFind:Z().Os.none,enableChatSelectionContextTokens:!0})})}function ce(e){const{step:t,isVisible:n}=e,i=(0,a().v3)(),s=(0,c().tz)(),l=(0,r.useMemo)((()=>t.value??[]),[t.value]),{value:d}=(0,P().fJ)(z().e),u=(0,o().O$)(L().AppStoreSidebarSpaceStore),g=(0,r.useCallback)((async()=>{u&&d&&await(0,ne().w)({environment:i,spaceStore:u,copySourceData:{type:"textValue",textValue:l,name:"AgentUserInitiatedStep.CopyButton"},copiedMessageLabel:s.formatMessage(d.clipboardMessages.copiedToClipboard)})}),[i,s,l,u,d]),p=(0,b().IS)((()=>({copyButton:{opacity:n?1:0,visibility:n?"visible":"hidden",transition:"opacity 0.1s ease, visibility 0.1s ease"}})),[n]);return(0,v.jsx)(N().m,{placement:"top",delayThreshold:300,renderTooltip:()=>s.formatMessage({id:"aiInferenceTranscript.userStep.copyText",defaultMessage:"Copy text"}),render:e=>(0,v.jsx)(W().A,{...e,onClick:g,icon:q().a,colorVariant:"secondary",style:p.copyButton,ariaLabel:s.formatMessage({id:"aiInferenceTranscript.userStep.copyTextAriaLabel",defaultMessage:"Copy text"})})})}function ue(e){const{onCancel:t,onSave:n,saveDisabled:r}=e,i=(0,c().tz)();return(0,v.jsxs)(v.Fragment,{children:[(0,v.jsx)(W().A,{onClick:t,icon:$().xMarkCircleFillIcon,colorVariant:"secondary",style:{borderRadius:"50%"},iconStyle:{width:J().Ev.default,height:J().Ev.default},ariaLabel:i.formatMessage({id:"aiInferenceTranscript.userStep.cancel",defaultMessage:"Cancel"})}),(0,v.jsx)(W().A,{onClick:n,icon:H().checkmarkCircleFillIcon,colorPalette:"blue",colorVariant:"accentPrimary",disabled:r,style:{borderRadius:"50%"},iconStyle:{width:J().Ev.default,height:J().Ev.default},ariaLabel:i.formatMessage({id:"aiInferenceTranscript.userStep.save",defaultMessage:"Save"})})]})}function ge(e){const{isCurrentUser:t,isEditing:n,mockTextStore:a,textRef:o,onSaveEdit:s,onEditClick:l,disableUserMessageEditing:d,isSearchConfig:c,isResearcherConfig:u,isMarkdownChatConfig:g,step:p,threadStore:h}=e,[f,S]=(0,r.useState)(!1),m=(0,b().IS)((()=>({messageRow:{display:"flex",flexDirection:"column",alignItems:t?"flex-end":"flex-start",paddingBottom:8,width:"100%"},bubbleWrapper:{maxWidth:t&&!n?"calc(95% - 40px)":"95%",...n?{width:"100%"}:{},...t&&!n?{marginInlineStart:70}:{}},stagingAndInputWrap:{borderRadius:16,padding:c?"6px 14px":"2px 14px 32px 14px",paddingBottom:n?48:"6px",minHeight:32,minWidth:68},textContainer:c?{paddingTop:0,paddingBottom:0}:{}})),[t,c,n]),x=t&&!n&&!d,y=Boolean(i().A.isMobile);return(0,v.jsxs)("div",{style:m.messageRow,onMouseEnter:()=>S(!0),onMouseOver:()=>S(!0),onMouseLeave:()=>S(!1),children:[(0,v.jsx)("div",{style:m.bubbleWrapper,children:n?(0,v.jsx)(oe().k,{onSubmit:s,store:a,textRef:o,fontSize:c||u||g?16:void 0,stagingAndInputWrapStyle:m.stagingAndInputWrap,textContainerStyle:m.textContainer,testId:"agent-edit-message-input"}):(0,v.jsx)(de,{store:a,onClick:x&&y?l:void 0,clickable:x&&y,isCurrentUser:t})}),(0,v.jsx)(pe,{isRowHovered:f,isEditing:n,step:p,threadStore:h,onEditClick:x&&!y?l:void 0,canEdit:x&&!y,isCurrentUser:t})]})}function pe(e){const{isRowHovered:t,isEditing:n,step:i,threadStore:a,onEditClick:o,canEdit:s,isCurrentUser:l}=e,d=(0,c().tz)(),u=(0,r.useMemo)((()=>function(e,t){if(void 0===e)return;const n=new Date(e);if(Number.isNaN(n.getTime()))return;const r=new Date,i=n.getDate()===r.getDate()&&n.getMonth()===r.getMonth()&&n.getFullYear()===r.getFullYear(),a=n.getFullYear()===r.getFullYear();return i?t.formatTime(n,{hour:"numeric",minute:"2-digit"}):a?t.formatDate(n,{month:"short",day:"numeric"}):t.formatDate(n,{month:"short",day:"numeric",year:"numeric"})}(i.createdAt,d)),[d,i.createdAt]),g=(0,b().IS)((()=>({container:{display:"flex",flexDirection:"row",alignItems:"center",justifyContent:l?"flex-end":"flex-start",height:28,paddingTop:4,opacity:t?1:0,visibility:t?"visible":"hidden",transition:"opacity 0.1s ease, visibility 0.1s ease"},timestamp:{fontSize:12,lineHeight:"16px",color:A().Tj.text.tertiary,marginInlineEnd:6,display:"flex",alignItems:"center"},buttonsContainer:{display:"flex",flexDirection:"row",alignItems:"center",width:s?48:24}})),[t,l,s]);return n?null:(0,v.jsxs)("div",{style:g.container,children:[u?(0,v.jsx)("div",{style:g.timestamp,children:u}):void 0,(0,v.jsxs)("div",{style:g.buttonsContainer,children:[!0===s?(0,v.jsx)(fe,{onClick:o}):void 0,(0,v.jsx)(ce,{step:i,threadStore:a,isVisible:t})]})]})}function he(e){const{isEditing:t,onCancelEdit:n,onSaveEdit:r,mockTextStore:i}=e,a=0===(0,o().K8)((()=>i.getValue()||[]),[i]).length,s=(0,b().IS)((()=>({actionsRow:{position:"absolute",bottom:22,insetInlineEnd:8,display:t?"flex":"none",gap:2,alignItems:"center",zIndex:10}})),[t]);return t?(0,v.jsx)("div",{style:s.actionsRow,children:(0,v.jsx)(ue,{onCancel:n,onSave:r,saveDisabled:a})}):null}function fe(e){const{onClick:t}=e,n=(0,c().tz)();return(0,v.jsx)(N().m,{placement:"top",delayThreshold:300,renderTooltip:()=>n.formatMessage(Se.editMessage),render:e=>(0,v.jsx)(W().A,{...e,onClick:t,icon:Q().pencilLineSmallIcon,colorVariant:"secondary",ariaLabel:n.formatMessage(Se.editMessage)})})}const Se=(0,c().YK)({editMessage:{id:"aiInferenceTranscript.agentUserStep.editMessage",defaultMessage:"Edit message"}});const me=r.memo((function(e){var t;const{turn:r,isFirstUserTurn:i,spaceStore:a,threadStore:l,clientStore:d,showDebug:c,disableUserMessageEditing:u,aiChatFeatureController:g}=e,p=(0,o().K8)((()=>l.getSpaceId()||""),[l]),h=(0,b().IS)((()=>({userTurn:{...c&&{boxShadow:"calc(var(--direction, 1) * -4px) 0 0 0 rgba(0,0,255,0.3)"}},attachmentCarousel:{overflowX:"scroll",overscrollBehaviorX:"contain",scrollSnapType:"x proximity",scrollbarWidth:"none",gap:"inherit",gridColumn:"full",display:"grid",gridTemplateColumns:"inherit",alignItems:"self-start"}})),[c]);return(0,v.jsx)("div",{style:h.userTurn,children:(0,v.jsxs)(s().Y1,{direction:"vertical",gap:8,children:[r.configStep?(0,v.jsx)(B().uQ,{step:r.configStep,threadStore:l,clientStore:d},r.configStep.id):null,r.contextStep?(0,v.jsx)(B().uQ,{step:r.contextStep,threadStore:l,clientStore:d,children:(0,v.jsx)(n(65590).E,{step:r.contextStep,displayMode:c?i?"dateAndPageChip":"pageChip":"date"})},r.contextStep.id):null,r.userSpecifiedContextStep?(0,v.jsx)(B().uQ,{step:r.userSpecifiedContextStep,threadStore:l,clientStore:d,children:(0,v.jsx)(n(639162).H,{spaceStore:a,context:r.userSpecifiedContextStep})},r.userSpecifiedContextStep.id):null,r.attachmentsStep&&r.attachmentsStep.length>0?(0,v.jsx)("div",{style:h.attachmentCarousel,children:(0,v.jsx)(s().Y1,{direction:"horizontal",align:"center-right",gap:{column:8,row:0},padding:"1px",children:null===(t=r.attachmentsStep)||void 0===t?void 0:t.map((e=>(0,v.jsx)(B().uQ,{step:e,threadStore:l,clientStore:d,children:(0,v.jsx)(s().Y1,{direction:"horizontal",align:"center-right",children:(0,v.jsx)(n(28070).kp,{uploadProgress:{status:"complete",fileUrl:e.fileUrl,fileName:e.fileName,contentType:e.contentType},permissionRecordOverride:{table:n(234459).To,id:l.id,spaceId:p},showImagePreview:!0,aiChatFeatureController:g})})},e.id)))})}):null,r.userInitiatedStep?(0,v.jsx)(B().uQ,{step:r.userInitiatedStep,threadStore:l,clientStore:d,children:(0,v.jsx)(se,{clientStore:d,threadStore:l,step:r.userInitiatedStep,disableUserMessageEditing:u})},r.userInitiatedStep.id):null]})})})),xe=100,ye=(0,c().YK)({workflowFailure:{id:"aiInferenceTranscript.transcriptTurns.workflowFailure",defaultMessage:"Custom agent failed. Please try running the custom agent again."},workflowRetryableFailure:{id:"aiInferenceTranscript.transcriptTurns.workflowRetryableFailure",defaultMessage:"Custom agent encountered an error and will retry automatically."},workflowStuck:{id:"aiInferenceTranscript.transcriptTurns.workflowStuck",defaultMessage:"Custom agent appears to be stuck. Please try running the custom agent again."}});function be(e){switch(e){case"failure":return ye.workflowFailure;case"retryableFailure":return ye.workflowRetryableFailure;case"stuck":return ye.workflowStuck}}function ve(e){const{transcript:t,spaceStore:n,threadStore:i,clientStore:b,configType:C,isCustomAgent:j,runningInference:T,showDebugOverride:I,aiChatFeatureController:E,showAttribution:M,onFollowUpSelect:R}=e,D=(0,a().v3)(),A=(0,o().K8)((()=>b.state.showDebug),[b])||Boolean(I),F=(0,r.useMemo)((()=>{const e=(0,m().R0)({transcript:t,isRunningInference:T,showDebug:A});return e.slice(Math.max(0,e.length-xe))}),[t,T,A]),U=function(e,t=p().n4){const[n,i]=(0,r.useReducer)(((e,t)=>{const{input:n,isEqualFn:r}=t;let i=n.length!==e.length;const a=[];for(let o=0;o<n.length;o++){const t=n[o],s=e[o];r(t,s)?a.push(s):(a.push(t),i=!0)}return i?a:e}),e);return(0,r.useEffect)((()=>{i({input:e,isEqualFn:t})}),[e,t]),n}(F),_=U.findLastIndex((e=>"user-turn"===e.type)),B=U.findIndex((e=>"user-turn"===e.type)),L=(0,o().K8)((()=>(0,S().xE)({threadStore:i,transcript:t,clientStore:b})),[i,t,b]),z=(0,o().K8)((()=>f().f.getState().statuses),[]),P=(0,o().K8)((()=>j&&(0,S().SJ)(i)),[i,j]),Y=(0,o().K8)((()=>i.getConfig()),[i]),W=E.isAgentChat&&"workflow"===(null==Y?void 0:Y.type)&&Y.enableScriptAgent&&!1;return(0,v.jsx)(x().c8,{threadStore:i,clientStore:b,environment:D,children:(0,v.jsx)(g().wJ,{surfaceName:"ai_chat",children:(0,v.jsx)(h().A,{store:i,render:()=>(0,v.jsxs)(s().Y1,{direction:"vertical",gap:A?12:0,children:[W?(0,v.jsx)(k,{}):void 0,U.map(((e,t)=>{switch(e.type){case"user-turn":{const r=U.slice(0,t).filter((e=>"agent-turn"===e.type)).length,a=z.slice(r).some((e=>"undo"===e)),o=t!==_||a;return(0,v.jsx)(me,{turn:e,isFirstUserTurn:t===B,spaceStore:n,threadStore:i,clientStore:b,runningInference:T,showDebug:A,disableUserMessageEditing:o,aiChatFeatureController:E},`user-turn-${t}`)}case"agent-turn":{const r=U.slice(0,t).filter(m().hY).at(-1);return(0,v.jsx)(w().l,{turn:e,previousUserTurn:r,isLastTurn:t===U.length-1,configType:C,isCustomAgent:j,spaceStore:n,threadStore:i,clientStore:b,runningInference:T,showDebug:A,aiChatFeatureController:E,showAttribution:M,onFollowUpSelect:R},`agent-turn-${t}`)}default:(0,u().HB)(e)}})),P?(0,v.jsx)(V,{}):void 0,L?(0,v.jsx)(y().N,{icon:d().exclamationMarkCircleSmallIcon,title:(0,v.jsx)(l().D,{styleKey:"bodyRegular",colorVariant:"secondary",children:(0,v.jsx)(c().sA,{...be(L)})})}):void 0,A?(0,v.jsx)(K,{threadStore:i,clientStore:b}):void 0]})})})})}}}]);