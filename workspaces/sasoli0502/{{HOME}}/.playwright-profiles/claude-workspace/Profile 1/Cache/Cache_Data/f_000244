"use strict";(globalThis.webpackChunknotion_next=globalThis.webpackChunknotion_next||[]).push([[15780],{94871:(e,t,o)=>{o.r(t),o.d(t,{initializeComplianceIntegrationStore:()=>p,refreshComplianceIntegrationStore:()=>h});o(898992),o(354520),o(581454);var n=()=>o(907258),a=()=>o(165358),i=()=>o(388821),r=()=>o(332393),s=()=>o(606219),l=()=>o(496603),c=()=>o(229833),d=()=>o(753812),u=()=>o(461232),g=()=>o(888526);async function h(e){const{sidebarSpaceStore:t}=n().default.state;t&&await p({environment:e.environment,spaceId:t.id,force:!0})}async function p(e){const{environment:t,spaceId:o,force:h}=e;if(!t.currentUser.id)return;await n().default.waitUntilRendered();const p=g().A.state;if(!p.loaded&&!p.loading||p.loaded&&o!==p.spaceId||h){g().A.setState({...g().A.state,loading:!0});const e=async()=>{const e=await d().callApi({eventName:"searchIntegrations",environment:t,data:{query:"",type:"compliance",spaceId:o}});return"success"!==e.type?(a().log({level:"error",from:"complianceIntegrationActions",type:"searchIntegrationsError",error:(0,c().convertErrorToLog)(e.error)}),{status:"rejected",error:e.error}):{status:"resolved",value:e}},n=async()=>{try{return{status:"resolved",value:await u().C({environment:t,spaceId:o})}}catch(e){return a().log({level:"error",from:"complianceIntegrationActions",type:"fetchWebhookSubscriptionsError",error:(0,c().convertErrorToLog)(e)}),{status:"rejected",error:e}}},[h,p]=await Promise.all([e(),n()]);if("rejected"===h.status||"rejected"===p.status)return;const{value:b}=h,{value:m}=p,v=i().RecordMapWithRole.create(b.data.recordMap),f=i().RecordMapWithRole.create(m.recordMap);g().A.setState({loaded:!0,loading:!1,spaceId:o,integrations:l().Ul(l().oE(b.data.integrationIds.map((e=>v.getModel({table:r().Li,id:e})))).filter(r().kC),(({created_at:e})=>e)),webhookSubscriptions:l().oE(m.webhookSubscriptionIds.map((e=>f.getModel({table:s().TF,id:e,spaceId:o}))))})}}},101919:(e,t,o)=>{o.d(t,{A:()=>a});o(296540);var n=o(474848);const a=function(e){const{hasMarginTop:t}=e,a=(0,o(401497).IS)((()=>{const e={display:"block",marginBottom:4,fontSize:12,color:o(100622).Tj.text.secondary};return t&&(e.marginTop=14),{style:e}}),[t]),{forId:i,children:r,style:s}=e;return(0,n.jsx)("label",{style:{...a.style,...s},htmlFor:i,children:r})}},187881:(e,t,o)=>{o.r(t),o.d(t,{eyeFillIcon:()=>i,iconDefinition:()=>a});o(296540);var n=o(474848);const a={viewBox:"0 0 20 20",fittedViewBox:"0.96 4.19 18.07 11.62",svg:(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("path",{d:"M10 8.894a1.104 1.104 0 1 1-.003 2.207A1.104 1.104 0 0 1 10 8.894"}),(0,n.jsx)("path",{d:"M10 4.194c3.878 0 7.26 2.075 8.862 5.127l.073.163c.126.333.126.7 0 1.033l-.073.163c-1.602 3.052-4.984 5.126-8.862 5.126-3.757 0-7.049-1.946-8.707-4.843l-.156-.283a1.46 1.46 0 0 1 0-1.359l.156-.283C2.95 6.141 6.243 4.194 10 4.194m0 2.496a3.307 3.307 0 0 0-3.306 3.307l.004.17A3.307 3.307 0 0 0 9.83 13.3l.17.004a3.305 3.305 0 0 0 3.3-3.137l.005-.17a3.307 3.307 0 0 0-3.135-3.303z"})]})},i=(0,o(340498).wt)("eyeFill",a,"fill")},461232:(e,t,o)=>{o.d(t,{C:()=>w,v:()=>k});o(898992),o(354520),o(803949),o(581454);var n=()=>o(907258),a=()=>o(755531),i=()=>o(242422),r=()=>o(675133),s=()=>o(792057),l=()=>o(812174),c=()=>o(950566),d=()=>o(824862),u=()=>o(798880),g=()=>o(606219),h=()=>o(496603),p=()=>o(559926),b=()=>o(594794),m=()=>o(244828),v=()=>o(753812),f=()=>o(384944);const y=(0,o(69708).YK)({webhookUrlError:{id:"webhookActions.webhookUrlError",defaultMessage:"Connection failed. Please wait and try again or try another URL."}});async function k(e){const{environment:t,integration:o,webhookUrl:i,webhookSecret:k,webhookHeaders:w,webhookSubscriptionId:I,onError:x,onSuccess:S=(()=>{})}=e,{currentUserRootStore:M,sidebarSpaceStore:C}=n().default.state;if(!M||!C)return{error:{success:!1}};const j={};w.map((e=>{const{key:t,value:o}=e;return{key:t.trim(),value:String(o).trim()}})).filter((({key:e,value:t})=>e&&t)).forEach((({key:e,value:t})=>{j[e]=t}));const A={headers:j};if("failed"===(await v().callApi({eventName:"testWebhookConnection",environment:t,data:{integrationId:o.id,webhookUrl:i,webhookSecret:k||void 0,webhookCustomization:A,spaceId:C.id}})).type)return s().f1(r().A.formatMessage(y.webhookUrlError)),{error:{success:!1}};const{serverCommitResult:_}=m().createAndCommit({userAction:"webhookActions.createWebhookSubscription",environment:t,canUndo:!0,perform:n=>{n.postSubmitCallbacks=[x];const r=C.id;if(e.webhookSubscriptionId){const e=(0,a().S)(),r=I&&e?l().g.createChildStore(e,{id:I,table:g().TF,spaceId:e.id}):void 0;if(r){const e=r.getWebhookUrl()!==i,a=r.getWebhookSecret()!==k,s=!h().n4(r.getWebhookCustomization(),A);(e||a||s)&&(p().zW(t,{integration_id:o.id,has_updated_webhook_url:e||void 0,has_updated_webhook_secret:a||void 0}),f().zv({transaction:n,data:{webhook_url:i,webhook_secret:k,webhook_customization:A,health:{status:"active"}},store:r}))}}else{const e=(0,b().Z1)({environment:t,table:d().GP,spaceId:r});f().vt({environment:t,table:d().GP,args:{id:e,space_id:r,parent:{table:"space",id:C.id},type:"external",name:o.getName(),icon:o.getInfo().icon,integration_id:o.id,capabilities:o.getCapabilities(),createdBy:{table:u().oo,id:M.id}},inMemoryRecordCache:C.inMemoryRecordCache,transaction:n}),f().vt({environment:t,table:g().TF,args:{id:(0,b().Z1)({environment:t,spaceId:r,table:g().TF}),bot_id:e,space_id:r,parentPointer:{table:"space",id:C.id},createdByPointer:{table:u().oo,id:M.id},api_version:c().h9,webhook_url:i,webhook_secret:k,webhook_customization:A,health:{status:"active"}},inMemoryRecordCache:C.inMemoryRecordCache,transaction:n}),p().dm(t,{integration_id:o.id,configuration_type:"manual",bot_id:e})}}});return await _,S(),{value:{success:!0}}}async function w(e){const t=i().default.checkGate({gateName:"webhooks_beta"}),{environment:o,spaceId:n}=e;if(!o.currentUser.isLoggedIn()||!t)return{webhookSubscriptionIds:[],recordMap:{__version__:3}};const a=await v().callCellCompatibleApi({eventName:"getWebhookSubscriptions",environment:o,data:{spaceId:n},cellNavigation:{cellId:void 0,spaceId:n}});if("failed"===a.type)throw a.error;return a.data}},479770:(e,t,o)=>{o.r(t),o.d(t,{ConfigureIntegrationModal:()=>$});o(16280),o(581454);var n=o(296540),a=()=>o(907258),i=()=>o(242422),r=()=>o(484714),s=()=>o(590526),l=()=>o(401497),c=()=>o(560729),d=()=>o(792057),u=()=>o(128933),g=()=>o(93676),h=()=>o(812174),p=()=>o(695115),b=()=>o(31511),m=()=>o(98126),v=()=>o(160432),f=()=>o(26697),y=()=>o(995847),k=()=>o(332393),w=()=>o(798880),I=()=>o(606219),x=()=>o(20498),S=()=>o(69708),M=()=>o(100622),C=()=>o(496603),j=()=>o(973647),A=()=>o(461232),_=()=>o(690197),U=()=>o(101919),T=()=>o(232930),L=()=>o(929521),P=()=>o(63515),R=()=>o(94871),E=()=>o(963186),z=(o(898992),o(354520),()=>o(631524)),F=()=>o(302501),N=()=>o(709550),W=()=>o(187881),B=()=>o(176412),K=()=>o(617668),V=o(474848);const D=(0,S().YK)({remove:{id:"integrations.configureIntegrationModal.webhookHeadersRemove",defaultMessage:"Remove"},toggleSecretVisibility:{id:"integrations.configureIntegrationModal.toggleSecretVisibility",defaultMessage:"Toggle secret visibility"}});function H(e){const{headers:t,onChange:o}=e,a=Y(),i=(0,n.useCallback)(((e,n)=>{const a=t.map(((t,o)=>o===n?e:t));o(a)}),[t,o]),r=(0,n.useCallback)((e=>{const n=t.filter(((t,o)=>o!==e));o(n)}),[t,o]);return(0,V.jsxs)(V.Fragment,{children:[(0,V.jsx)(U().A,{style:{display:"flex",alignItems:"center",marginTop:24},children:(0,V.jsx)(S().sA,{id:"integrations.configureIntegrationModal.webhookHeadersInput",defaultMessage:"Webhook Headers"})}),(0,V.jsxs)("div",{style:{maxHeight:"30vh",overflow:"auto",width:"100%"},children:[t.length>0?(0,V.jsxs)("div",{style:a.headerRow,children:[(0,V.jsx)(F().A,{style:a.columnLabel,isSmall:!0,children:(0,V.jsx)(S().sA,{id:"integrations.configureIntegrationModal.webhookHeadersKey",defaultMessage:"Key"})}),(0,V.jsx)(F().A,{style:{...a.columnLabel,marginInlineStart:8,marginInlineEnd:32},isSmall:!0,children:(0,V.jsx)(S().sA,{id:"integrations.configureIntegrationModal.webhookHeadersValue",defaultMessage:"Value"})})]}):void 0,t.map(((e,t)=>(0,V.jsx)(O,{header:e,onChange:i,onDelete:r,index:t},t)))]}),(0,V.jsx)(z().p,{style:{marginTop:8},colorPalette:"gray",iconLeading:K().plusIcon,onClick:()=>{o([...t,{key:"",value:""}])},children:(0,V.jsx)(S().sA,{id:"integrations.configureIntegrationModal.webhookHeadersAdd",defaultMessage:"New"})})]})}function O(e){const{header:t,index:o,onChange:a,onDelete:i}=e,r=(0,S().tz)(),s=Y(),[l,c]=n.useState(!1);return(0,V.jsxs)("div",{style:s.headerRow,children:[(0,V.jsx)(b().A,{value:t.key,onChange:e=>{a({key:e.target.value,value:t.value},o)}}),(0,V.jsx)(b().A,{style:s.valueColumn,value:t.value,onChange:e=>{a({key:t.key,value:e.target.value},o)},type:l?"text":"password",right:(0,V.jsx)("div",{style:{display:"flex"},children:(0,V.jsx)(p().A,{icon:l?W().eyeFillIcon:B().L,onClick:()=>c(!l),ariaLabel:r.formatMessage(D.toggleSecretVisibility),colorPalette:"blue",colorVariant:"accentPrimary",iconStyle:{height:18,width:18},style:{height:18}})})}),(0,V.jsx)(p().A,{style:s.removeButton,onClick:()=>{i(o)},icon:N().o,ariaLabel:r.formatMessage(D.remove)})]})}function Y(){return(0,l().IS)((()=>({removeButton:{width:28,height:28,marginInlineStart:4},headerRow:{marginTop:8,display:"flex"},valueColumn:{marginInlineStart:8},columnLabel:{width:"100%",textAlign:"start"}})),[])}const G=(0,S().YK)({toggleSecretVisibility:{id:"integrations.configureIntegrationShowSecret.toggleSecretVisibility",defaultMessage:"Toggle secret visibility"}});function q(e){const{secret:t,onChange:o,submit:a,placeholder:i}=e,r=(0,S().tz)(),[s,l]=n.useState(!1);return(0,V.jsx)(b().A,{type:s?"text":"password",value:t,onChange:o,placeholder:i,style:{padding:"4px 8px"},focusInitial:!1,onKeyDown:e=>{"Enter"===e.key&&a()},right:t&&(0,V.jsx)("div",{style:{display:"flex"},children:(0,V.jsx)(p().A,{icon:s?W().eyeFillIcon:B().L,onClick:()=>{l(!s)},ariaLabel:r.formatMessage(G.toggleSecretVisibility),colorPalette:"blue",colorVariant:"accentPrimary",iconStyle:{height:18,width:18},style:{height:18}})})})}var Z=()=>o(862215),Q=()=>o(476832);const X=(0,S().YK)({webhookUrlPlaceholder:{id:"integrations.configureIntegrationModal.webhookUrlInput.placeholder",defaultMessage:"Paste webhook URL"},webhookSecretPlaceholder:{id:"integrations.configureIntegrationModal.webhookSecretInput.placeholder",defaultMessage:"Paste token"},updateButton:{id:"integrations.configureIntegrationModal.submitButton.update",defaultMessage:"Update"},createButton:{id:"integrations.configureIntegrationModal.submitButton.create",defaultMessage:"Connect"},errorOccurred:{id:"integrations.configureIntegrationModal.error.dialog",defaultMessage:"Failed to connect {integration}. Please contact support."},closeModalAriaLabel:{id:"integrations.configureIntegrationModal.closeButtonLabel",defaultMessage:"Close integration configuration modal"}});function $(){const e=(0,S().tz)(),t=(0,r().v3)(),o=(0,l().IS)((()=>({errorText:{color:M().Tj.red.text.accentPrimary,fontSize:12},input:{display:"flex",flexDirection:"column",alignItems:"flex-start",width:360},helpInfo:{display:"inline-flex",marginInlineStart:1}})),[]),z=(0,L().useConnectIntegrationModalStyles)(),F=(0,s().K8)((()=>E().A.state.open),[]),N=(0,s().K8)((()=>E().A.state.open?E().A.state.integrationId:void 0),[]),W=(0,s().K8)((()=>E().A.state.open?E().A.state.webhookSubscriptionId:void 0),[]),B=(0,s().O$)(a().AppStoreSidebarSpaceStore),K=N&&B?g().C.createChildStore(B,{id:N,table:k().Li}):void 0,D=W&&B?h().g.createChildStore(B,{id:W,table:I().TF,spaceId:B.id}):void 0;(0,n.useEffect)((()=>{const{webhookUrl:e,webhookSecret:t,webhookCustomization:o}={webhookUrl:(null==D?void 0:D.getWebhookUrl())||"",webhookSecret:(null==D?void 0:D.getWebhookSecret())||"",webhookCustomization:(null==D?void 0:D.getWebhookCustomization())||void 0};Y(e),$(t);const n=(null==o?void 0:o.headers)||{},a=Object.entries(n).map((([e,t])=>({key:e,value:t}))).sort(((e,t)=>e.key.localeCompare(t.key)));ee(a)}),[D]);const[O,Y]=n.useState(""),[G,$]=n.useState(""),[J,ee]=n.useState([]),[te,oe]=n.useState(!1),[ne,ae]=n.useState(!1),[ie,re]=n.useState(!1),[se,le,ce,de]=(0,s().K8)((()=>{if(!K)return[void 0,void 0,void 0,void 0];const e=K.getModel();return[e,null==e?void 0:e.name,null==e?void 0:e.type,("internal"!==(null==e?void 0:e.type)&&(null==e?void 0:e.getInfo().developer_name))??"Unknown"]}),[K]),ue=(0,x().D4)(N),ge=C().h1({},x().bX,null==ue?void 0:ue.customization).headers.hmac,he=(0,n.useCallback)((t=>{if("internal"===(null==se?void 0:se.type))throw new Error("internal integrations are not supported");t&&(re(!1),d().f1(e.formatMessage(X.errorOccurred,{integration:de})))}),[se,de,e]),pe=(0,n.useCallback)((async()=>{if(!ie){if(!ue||!(0,x().Nl)({env:"production",integrationConfig:ue,webhookUrlToValidate:O,experimentService:i().default,actor:{table:w().oo,id:t.currentUser.id||""},spaceId:(null==B?void 0:B.id)||""}))return oe(!0),void re(!1);if(oe(!1),ge&&!G)return ae(!0),void re(!1);if(re(!0),se){const e=await A().v({environment:t,integration:se,webhookUrl:O,webhookSecret:G,webhookHeaders:J,webhookSubscriptionId:W,onError:he,onSuccess:()=>u().D6({label:(0,V.jsx)(S().sA,{id:"configureIntegrationModal.snackbar.title",defaultMessage:"Added {integrationName} to your workspace",values:{integrationName:le}})})});if(j().Q.isFail(e))return void re(!1);await P().refreshExternalIntegrationStore({environment:t}),await R().refreshComplianceIntegrationStore({environment:t}),ve()}}}),[t,he,se,le,ie,G,J,ge,W,O,ue,B]),be=(0,n.useCallback)((e=>$(e.target.value)),[]),me=(0,n.useCallback)((e=>{ee(e)}),[]),ve=()=>{E().A.setState({open:!1}),Y(""),$(""),oe(!1),ae(!1),re(!1)};return se&&ue&&B&&"internal"!==ce?(0,V.jsx)(c().A,{innerStyle:z.modal,isOpen:F,onDismiss:ve,render:()=>(0,V.jsxs)("div",{style:z.mobileModal,children:[(0,V.jsxs)("div",{style:z.innerModal,children:[(0,V.jsx)(p().A,{icon:y().xMarkSmallIcon,onClick:ve,style:z.cancelButton,hoveredStyle:z.hovered,ariaLabel:e.formatMessage(X.closeModalAriaLabel)}),(0,V.jsx)(Z().K,{integrationModel:se,integrationConfig:ue,spaceStore:B}),(0,V.jsxs)("div",{style:o.input,children:[(0,V.jsxs)(U().A,{style:{display:"flex",alignItems:"center",marginTop:40},children:[(0,V.jsx)(S().sA,{id:"integrations.configureIntegrationModal.webhookUrlInput",defaultMessage:"Webhook URL"}),(0,V.jsx)(f().m,{placement:"bottom",render:e=>(0,V.jsx)(_().A,{...e,href:(0,T().x)("guides.publicAPI"),analyticsFrom:"workspace_connections",style:o.helpInfo}),renderTooltip:()=>(0,V.jsx)(S().sA,{id:"integrations.configureIntegrationModal.webhookUrlInput.tooltip",defaultMessage:"Enter the webhook URL provided by {integrationName}",values:{integrationName:de}})})]}),(0,V.jsx)(b().A,{type:"text",style:{padding:"4px 8px"},value:O,onChange:e=>{Y(e.target.value),oe(!1)},placeholder:e.formatMessage(X.webhookUrlPlaceholder),focusInitial:!0,onKeyDown:async e=>{"Enter"===e.key&&await pe()}}),te?(0,V.jsx)("div",{style:{marginTop:5,...o.errorText},children:(0,V.jsx)(S().sA,{id:"integrations.configureIntegrationModal.invalidUrl",defaultMessage:"Invalid webhook URL"})}):null]}),ue.acceptsSecretToken?(0,V.jsxs)("div",{style:o.input,children:[(0,V.jsxs)(U().A,{style:{display:"flex",alignItems:"center",marginTop:24},children:[(0,V.jsx)(S().sA,{id:"integrations.configureIntegrationModal.webhookSecretInput",defaultMessage:"Token"}),(0,V.jsx)(f().m,{placement:"bottom",render:e=>(0,V.jsx)(_().A,{...e,href:(0,T().x)("guides.publicAPI"),analyticsFrom:"workspace_connections",style:o.helpInfo}),renderTooltip:()=>(0,V.jsx)(S().sA,{id:"integrations.configureIntegrationModal.webhookTokenInput.tooltip",defaultMessage:"Enter the token provided by {integrationName}",values:{integrationName:de}})})]}),(0,V.jsx)(q,{secret:G,onChange:be,submit:pe,placeholder:e.formatMessage(X.webhookSecretPlaceholder)}),ne?(0,V.jsx)("div",{style:{marginTop:5,...o.errorText},children:(0,V.jsx)(S().sA,{id:"integrations.configureIntegrationModal.invalidSecret",defaultMessage:"Webhook secret is required."})}):null]}):void 0,ue.acceptsCustomHeaders?(0,V.jsx)("div",{style:o.input,children:(0,V.jsx)(H,{headers:J,onChange:me})}):void 0,(0,V.jsx)(v().A,{colorPalette:"blue",style:z.connect,onClick:pe,disabled:""===O||ge&&""===G,children:ie?(0,V.jsx)(m().k,{}):(0,V.jsx)("span",{children:W?e.formatMessage(X.updateButton):e.formatMessage(X.createButton)})})]}),ue.website_url?(0,V.jsx)(Q().r,{signupUrl:ue.signupUrl??ue.website_url}):void 0]})}):null}},888526:(e,t,o)=>{o.d(t,{A:()=>r});var n=()=>o(140934);class a extends(()=>o(757695))().Store{constructor(...e){super(...e),this.integrations=new(n().ComputedStore)((()=>{const e=this.state;return e.loaded?e.integrations:[]}),{debugName:"ComplianceIntegrationStore.integrations"}),this.webhookSubscriptions=new(n().ComputedStore)((()=>{const e=this.state;return e.loaded?e.webhookSubscriptions:[]}),{debugName:"ComplianceIntegrationStore.webhookSubscriptions"})}getInitialState(){return{loaded:!1,loading:!1}}}const i=new a;(0,o(852832).exposeDebugValue)("ComplianceIntegrationStore",i);const r=i},963186:(e,t,o)=>{o.d(t,{A:()=>a});class n extends(()=>o(757695))().Store{getInitialState(){return{open:!1}}}const a=new n}}]);