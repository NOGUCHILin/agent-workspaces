"use strict";(globalThis.webpackChunknotion_next=globalThis.webpackChunknotion_next||[]).push([[20741],{27455:(e,t,n)=>{n.d(t,{Zp:()=>l,fT:()=>i,v3:()=>s});n(944114);var r=n(296540),a=()=>n(100622),o=n(474848);const i={xxs:4,xs:6,sm:8,md:10,lg:12},s={none:0,sm:12,md:16,lg:20,xl:24},l=r.forwardRef((function(e,t){const{children:r,colorPalette:l,colorVariant:d="primary",borderRadius:c="md",borderVariant:u,padding:p="none",shadowVariant:g}=e,f=(0,n(401497).IS)((()=>{const e=l?a().Tj[l]:a().Tj,t=[];return g&&t.push(a().Tj.shadow.base[g]),u&&t.push(`inset 0 0 0 1px ${e.border[u]}`),{card:{width:"100%",padding:"number"==typeof p?p:s[p],borderRadius:i[c],boxShadow:t.join(", "),background:(0,n(534177).O)(e.background,d)?e.background[d]:e.background.primary}}}),[l,d,c,u,p,g]);return(0,o.jsx)("div",{style:f.card,ref:t,children:r})}))},75318:(e,t,n)=>{n.d(t,{j:()=>o});n(296540);var r=n(474848);const a={viewBox:"0 0 16 16",fittedViewBox:"1.95 1.94 12.11 12.1",svg:(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("path",{d:"M10 7.45a.55.55 0 1 1 0 1.1H6a.55.55 0 1 1 0-1.1z"}),(0,r.jsx)("path",{d:"M8 1.95a6.05 6.05 0 1 1 0 12.1 6.05 6.05 0 0 1 0-12.1m0 1.1a4.95 4.95 0 1 0 0 9.9 4.95 4.95 0 0 0 0-9.9"})]})},o=(0,n(340498).wt)("minusCircleSmall",a,"small")},78620:(e,t,n)=>{n.d(t,{c8:()=>v,Mp:()=>y});var r=n(296540),a=()=>n(59226),o=()=>n(590526),i=()=>n(165358),s=()=>n(229833),l=(n(16280),n(944114),()=>n(365646)),d=()=>n(800204),c=()=>n(134025),u=()=>n(155792),p=()=>n(244828);var g=()=>n(140992),f=()=>n(791256),m=n(474848);const h=(0,r.createContext)({confirmToolUse:()=>{},rejectToolUse:()=>{},showDebug:!1});function y(){return(0,r.useContext)(h)}function v({threadStore:e,clientStore:t,environment:n,sendPartialTranscript:y,children:v}){const S=(0,o().K8)((()=>(0,f().JK)(e)),[e]),x=(0,a().X)("workflows_confirm_tool_use_reenqueue"),b=(0,r.useCallback)((async t=>{if(!e)return;const r=e.getData(),a=null==r?void 0:r.run_id,o=e.getSpaceId();if(a&&o)try{!function(e){const{environment:t,threadStore:n,confirmToolStepIds:r,rejectToolStepIds:a}=e,o=n.getSpaceId();if(!o)throw new Error("Thread has no space ID");const i=n.getMessages(),s=[];for(let l=0;l<i.length;l++){const e=n.getMessageStoreAt(l);if(!e)continue;const t=e.getStep();t&&s.push(t)}const g=(0,d().ey)(s);0!==g.length&&(0,p().createAndCommit)({userAction:"confirmToolStepsInThread",environment:t,canUndo:!1,perform:e=>{for(const t of g){const s=r.includes(t.id),d=void 0!==a?a.includes(t.id):!s;if(!s&&!d)continue;const g=s?"confirmation:confirmed":"confirmation:rejected",f=(0,l().oA)(t,g),m=i.indexOf(t.id),h=n.getMessageStoreAt(m);if(!h)continue;const y=c().op.update({pointer:{table:u().mS,id:t.id,spaceId:o},path:["step"],args:f});(0,p().applyOperation)({store:h,operation:y,transaction:e})}}})}({environment:n,threadStore:e,confirmToolStepIds:t.confirmToolStepIds,rejectToolStepIds:t.rejectToolStepIds}),await n.api.callApi({eventName:"reenqueueWorkflowAutomation",environment:n,data:{runIds:[a],spaceId:o}})}catch(g){i().log({level:"error",from:"ToolUseConfirmationContext.updateToolStatesAndReenqueue",type:"toolUpdateAndReenqueueError",error:(0,s().convertErrorToLog)(g)})}}),[n,e]),I=(0,r.useCallback)((r=>{e&&(S&&x?b({confirmToolStepIds:r}):g().WE({environment:n,clientStore:t,threadStore:e,confirmToolStepIds:r,stepIdsToInclude:y?r:void 0}))}),[e,t,n,y,S,x,b]),w=(0,r.useCallback)((r=>{e&&(S&&x?b({confirmToolStepIds:[],rejectToolStepIds:r}):g().WE({environment:n,clientStore:t,threadStore:e,rejectToolStepIds:r,stepIdsToInclude:y?r:void 0}))}),[e,t,n,y,S,x,b]),M=(0,o().K8)((()=>t.state.showDebug),[t]),j=(0,r.useMemo)((()=>({confirmToolUse:I,rejectToolUse:w,showDebug:M})),[I,w,M]);return(0,m.jsx)(h.Provider,{value:j,children:v})}h.displayName="ToolUseConfirmationContext"},105256:(e,t,n)=>{n.d(t,{c:()=>Ve,r:()=>Ae});n(18107),n(410838),n(944114),n(517642),n(658004),n(733853),n(845876),n(432475),n(515024),n(731698),n(967357),n(898992),n(823215),n(354520),n(672577),n(581454),n(737550);var r=n(296540),a=()=>n(664594),o=()=>n(106702),i=()=>n(920198),s=()=>n(59226),l=()=>n(242422),d=()=>n(908006),c=()=>n(484714),u=()=>n(590526),p=()=>n(401497),g=()=>n(739831),f=()=>n(463086),m=()=>n(699143),h=()=>n(695115),y=()=>n(631524),v=()=>n(493552),S=()=>n(26697),x=()=>n(365646),b=()=>n(158489),I=()=>n(584262),w=()=>n(510818),M=()=>n(145480),j=()=>n(775842),C=()=>n(477336),T=()=>n(454503),k=()=>n(613601),A=()=>n(29037),R=()=>n(349679),D=()=>n(764781),U=()=>n(627503),P=()=>n(617668),B=()=>n(863330),F=()=>n(406533),E=()=>n(721479),V=()=>n(599813),L=()=>n(995847),N=()=>n(340498),O=()=>n(388821),_=()=>n(234459),K=()=>n(155792),z=()=>n(798880),q=()=>n(201980),$=()=>n(69708),Y=()=>n(944584),W=()=>n(148024),H=()=>n(44729),G=()=>n(384944),X=()=>n(666144),Q=()=>n(23420),Z=()=>n(994877),J=()=>n(876098),ee=()=>n(576727),te=()=>n(140022),ne=()=>n(977270),re=()=>n(703748),ae=()=>n(770160),oe=()=>n(766854),ie=()=>n(799832),se=()=>n(486674),le=()=>n(548527),de=()=>n(535960),ce=()=>n(599412),ue=()=>n(616878),pe=()=>n(428257),ge=()=>n(732797),fe=()=>n(295304),me=()=>n(244828),he=()=>n(155382),ye=()=>n(299261),ve=()=>n(982979),Se=()=>n(140992),xe=()=>n(555102),be=()=>n(256001),Ie=()=>n(584499),we=()=>n(305425),Me=()=>n(83626),je=n(474848);function Ce(e){const{headerBlockValue:t,threadTitle:n,intl:r}=e;return void 0!==t?t:void 0!==n?q().x9d(n):q().x9d(r.formatMessage(ke.defaultPageTitle))}const Te={default:N().Ev.sm,large:N().lD.default},ke=(0,$().YK)({responseCopied:{id:"aiInferenceTranscript.agentActionsRow.copiedToClipboard",defaultMessage:"Response copied to clipboard"},saveToPage:{id:"aiInferenceTranscript.agentActionsRow.saveToPage",defaultMessage:"Save to private pages"},defaultPageTitle:{id:"inferenceTranscript.AIStepFollowupAction.defaultPageTitle",defaultMessage:"AI Summary"},insertIntoPage:{id:"aiInferenceTranscript.agentActionsRow.saveToCurrentPage",defaultMessage:"Insert into this page"},insertIntoDatabase:{id:"aiInferenceTranscript.agentActionsRow.saveToDatabase",defaultMessage:"Create page in this database"},retry:{id:"aiInferenceTranscript.agentActionsRow.retry",defaultMessage:"Retry"}});function Ae(e){var t;const{isHovered:n,runningInference:a,turn:o,threadStore:i,configType:d,isCustomAgent:f,spaceStore:h,isLastTurn:y,parts:v,threadId:S,previousUserPromptKey:b,variant:I}=e,w=(0,c().v3)(),M=(0,s().X)("agent_contact_help_button"),j=(0,u().K8)((()=>"on"===l().default.getEligibleGroup({experimentId:"ai_product_retention_agent_retry_button",defaultGroup:"control"})),[]),{undoableToolResults:C,hasModifiedRecords:T,feedbackStep:k,feedbackTraceId:A}=(0,Ie().N)({turn:o,parts:v,spaceStore:h}),{operationsToUndo:R,stepsWithOperationsToUndo:D,hasUndoneOperations:U}=(0,he().ji)({diffResultSteps:C,threadStore:i}),{handleUndo:P}=Ve({operationsToUndo:R,stepsWithOperationsToUndo:D,threadOverrideStore:i}),[B,F]=(0,r.useState)(!1),E=function(e){const{hasUndoneOperations:t,operationsToUndo:n}=e;return(0,r.useMemo)((()=>t&&0===n.length?"reverted":n.length>0?"undo":"none"),[t,n])}({hasUndoneOperations:U,operationsToUndo:R}),V=(0,u().K8)((()=>{const e=ue().f.getState().statuses;for(let t=e.length-1;t>=0;t--)if("undo"===e[t])return t}),[]),L=o.steps.length>0,N=v.some((e=>e.isFinished))||0===v.length&&L||"error"===(null===(t=o.steps.at(-1))||void 0===t?void 0:t.type)&&y,O=v.some((e=>{var t;return"tool-use"===e.type&&"requested"===(null===(t=e.toolResultStep)||void 0===t?void 0:t.userConfirmation)})),_=(N||0===v.length)&&!O&&!a&&Boolean(o.lastStepId),z=Boolean(k)&&Boolean(A)&&Boolean(i)&&_,q=T&&"undo"===E&&V===o.feedbackComponentIndex,$=q&&(_||B),W=T&&"reverted"===E&&_,H=z&&j,G=!a&&(n||y&&_),X=n||y&&$,Q=(0,r.useCallback)((()=>{try{const e=Y().calculateMetricsFromTranscript(Array.from(D));Y().trackUndoClicked({environment:w,from:"undo_button",undoneToolTypes:e.toolTypes})}catch(e){}P(),F(!1)}),[w,P,D]),{handleRetry:Z,retryFromStepId:J}=function(e){const t=(0,c().v3)(),{threadStore:n}=e,a=(0,u().K8)((()=>{var e;return null===(e=n.getTranscript().findLast((e=>"user"===e.type)))||void 0===e?void 0:e.id}),[n]),o=(0,r.useCallback)((()=>{a&&(0,Se().WF)({environment:t,threadStore:n,stepId:a,isRetry:!0})}),[t,n,a]);return{handleRetry:o,retryFromStepId:a}}({threadStore:i}),ee=(0,r.useMemo)((()=>(0,be().Lq)({turn:o}).trim()),[o]),te=(0,r.useMemo)((()=>o.steps.some((e=>"agent-search-query-generation"===e.type&&e.queries.some((e=>e.maybeNotionHelp))))),[o.steps]),ne=(0,r.useMemo)((()=>o.steps.some((e=>"agent-inference"===e.type))),[o.steps]),re=(0,r.useCallback)((()=>{var e;let t;try{t=q?Y().calculateMetricsFromTranscript(Array.from(D)):void 0}catch(n){}Y().trackAgentRetryButtonClicked({environment:w,stepId:J??"",promptKey:b,hasUndo:q,undoneToolTypes:q&&null!==(e=t)&&void 0!==e&&e.toolTypes?t.toolTypes:[]}),q?(F(!1),P().finally((()=>{Z()}))):Z()}),[Z,P,q,w,b,J,D]);(0,r.useEffect)((()=>{ue().f.updateStatus({threadId:S,index:o.feedbackComponentIndex,status:E,previousStepId:o.previousStepId})}),[o.feedbackComponentIndex,E,S,o.previousStepId]),(0,r.useEffect)((()=>{const e=new Set;for(const a of o.steps)if("agent-tool-result"===a.type&&(0,x().wU)(a)&&a.result)for(const{id:t}of a.result.revertedToolNamesAndIDs)e.add(t);if(0===e.size)return;const t=i.getTranscript().filter((e=>"agent-tool-result"===e.type)).filter((e=>"revert"!==e.toolName&&void 0!==e.toolCallId)),n=i.getSpaceId();if(!n)return;const r=t.filter((t=>{if(!t.toolCallId||!e.has(t.toolCallId))return!1;const r=g().X.createChildStore(i,{table:K().mS,id:t.id,spaceId:n}).getThreadOperationStores();if(0===r.length)return!1;return!(r.length>0&&r.every((e=>{const t=e.getValue();return"undo"===(null==t?void 0:t.userAction)})))}));0!==r.length&&me().createAndCommit({userAction:"TranscriptAgentActions.autoMarkRevertedStepsAsUndone",environment:w,canUndo:!1,perform:e=>{for(const t of r)(0,ye().A)({transaction:e,threadStore:i,step:t,userAction:"undo"})}})}),[o.steps,i,w]);const ae=(0,p().IS)((()=>({hoverDependentActions:{opacity:G?1:0,transition:"opacity 0.2s ease"},undoActions:{opacity:X?1:0,transition:"opacity 0.2s ease"}})),[G,X]);return(0,je.jsx)(m().Y1,{direction:"horizontal",width:"fill",height:48,style:{paddingTop:"large"===I?12:8},align:"top-left",children:(0,je.jsxs)(m().Y1,{direction:"horizontal",align:"center-left",style:ae.hoverDependentActions,gap:"large"===I?4:void 0,children:["error"!==(null==k?void 0:k.type)&&ne?(0,je.jsxs)(je.Fragment,{children:[(0,je.jsx)(Ue,{runningInference:a,variant:I,agentResponseMarkdown:ee,spaceStore:h,threadStore:i,configType:d}),f?null:(0,je.jsx)(De,{turn:o,runningInference:a,variant:I,threadStore:i,configType:d})]}):null,H?(0,je.jsx)(Re,{disabled:a||!J||B,variant:I,onClick:re}):void 0,z&&k&&A?(0,je.jsx)(Pe,{step:k,traceId:A,threadStore:i,previousUserPromptKey:b,variant:I}):void 0,!a&&M&&te?(0,je.jsx)(Le,{turn:o,threadId:S,variant:I,spaceStore:h}):void 0,$?(0,je.jsxs)(m().Y1,{direction:"horizontal",align:"center-left",gap:"large"===I?void 0:4,style:ae.undoActions,children:[(0,je.jsx)(Fe,{isConfirmingUndo:B,onClick:()=>F(!B),variant:I}),B?(0,je.jsx)(Ee,{onClick:Q,variant:I}):void 0]}):void 0,W?(0,je.jsx)(Be,{}):void 0]})})}function Re(e){const t=(0,$().tz)(),{onClick:n,variant:r,disabled:a}=e;return(0,je.jsx)(S().m,{renderTooltip:()=>(0,je.jsx)($().sA,{...ke.retry}),render:e=>(0,je.jsx)(h().A,{icon:{icon:"large"===r?j().a:C().l,size:Te[r]},size:"md",ariaLabel:t.formatMessage(ke.retry),onClick:n,disabled:a,...e})})}function De(e){const{runningInference:t,variant:n,turn:o,threadStore:i,configType:l}=e,p=(0,$().tz)(),g=(0,c().v3)(),f=(0,a().T)(),m=(0,r.useMemo)((()=>(0,be().Lq)({turn:o,lastStepOnly:!0}).trim()),[o]),y=(0,s().X)("agent_generate_image"),v=(0,s().X)("bullets_in_simple_tables_yuh"),x=(0,r.useMemo)((()=>y?M().W.filter((e=>"image"!==e)):M().W),[y]),b=(0,u().K8)((()=>{const e=i.getTranscript().find((e=>"title"===e.type));return null==e?void 0:e.value}),[i]),{currentPageStore:w,destinationType:j}=(0,u().K8)((()=>{const e=(0,se().a)();return{currentPageStore:e,destinationType:null!=e&&e.isCollectionView()?"database":null!=e&&e.isPageBlock()?"page":"private"}}),[]),C=(0,r.useCallback)((e=>{const t="chat"===g.RouterStore.state.route.name;(0,de().u)({environment:g,store:e,pageVisitSource:I().y8.AIQna,...t?{}:{openInSidePeek:!0}})}),[g]),T=(0,r.useCallback)((e=>{const{pageStore:t,headerBlockStore:n,transaction:r}=e;n&&(H().zz({parentStore:t,childStore:n,transaction:r}),G().zv({store:n,data:{alive:!1},transaction:r}))}),[]),k=(0,r.useCallback)((async e=>{const t=await(0,ce().M)({environment:g,from:"ai_agent",pageVisitSource:I().y8.AIQna,navigateOnCreate:!1});if(!t)return;const n=t.getSpaceId(),r=(0,we().a9)({markdown:m,pageId:t.id,spaceId:n,idCreator:g.idCreator.getSpaceIdCreatorSync(n),actorPointer:{table:z().oo,id:e},citationFormat:"link",omitBlockTypes:x,simpleBulletsEnabled:v});me().createAndCommit({userAction:"AgentTranscript.saveTurnToPage",environment:g,canUndo:!1,perform:e=>{var n,a;const o=(0,we().HS)({environment:g,transaction:e,rootStore:t,blockOperations:r}),i="header"===(null===(n=o[0])||void 0===n?void 0:n.getType())?o[0]:void 0,s=Ce({headerBlockValue:null==i||null===(a=i.getTitleStore())||void 0===a?void 0:a.getValue(),threadTitle:b,intl:p});fe().R9({environment:g,store:t.getBlockTitleStore(),value:s,transaction:e}),T({pageStore:t,headerBlockStore:i,transaction:e})}}),C(t)}),[g,C,T,p,b,m,x,v]),A=(0,r.useCallback)(((e,t)=>{const n=e.getSpaceId(),r=(0,we().a9)({markdown:m,pageId:e.id,spaceId:n,idCreator:g.idCreator.getSpaceIdCreatorSync(n),actorPointer:{table:z().oo,id:t},citationFormat:"link",omitBlockTypes:x,simpleBulletsEnabled:v}),a=[],o=e.isEmptyPage();me().createAndCommit({userAction:"AgentTranscript.saveTurnToExistingPage",environment:g,canUndo:!1,perform:t=>{var n,i;const s=(0,we().HS)({environment:g,transaction:t,rootStore:e,blockOperations:r});for(const e of s)a.push(e.id);if(!o)return;const l="header"===(null===(n=s[0])||void 0===n?void 0:n.getType())?s[0]:void 0,d=Ce({headerBlockValue:null==l||null===(i=l.getTitleStore())||void 0===i?void 0:i.getValue(),threadTitle:b,intl:p});if(fe().R9({environment:g,store:e.getBlockTitleStore(),value:d,transaction:t}),l){const e=a.indexOf(l.id);e>=0&&a.splice(e,1)}T({pageStore:e,headerBlockStore:l,transaction:t})}}),a.length>0&&d().default.afterNextFlush((()=>{(0,Q().B)(a,!1,g)}))}),[g,p,T,b,m,x,v]),R=(0,r.useCallback)((async(e,t)=>{const n=(0,ie().U)(e);if(!n)return k(t);let r,a=!1;me().createAndCommit({userAction:"AgentTranscript.saveTurnToDatabase",environment:g,canUndo:!1,perform:e=>{var o,i;const s=(0,oe().H)({environment:g,collectionContextStore:n,groupsPointer:[],insertAtIndex:0,shouldCoerce:!1,transaction:e,from:{createBlock:"cvb_add_item"},inMemoryRecordCache:g.defaultRecordCache.inMemoryRecordCache,isKeyboard:!1});if(!s)return void(a=!0);const l=s.newStore;r=l;const d=l.getSpaceId(),c=(0,we().a9)({markdown:m,pageId:l.id,spaceId:d,idCreator:g.idCreator.getSpaceIdCreatorSync(d),actorPointer:{table:z().oo,id:t},citationFormat:"link",omitBlockTypes:x,simpleBulletsEnabled:v}),u=(0,we().HS)({environment:g,transaction:e,rootStore:l,blockOperations:c}),f="header"===(null===(o=u[0])||void 0===o?void 0:o.getType())?u[0]:void 0,h=Ce({headerBlockValue:null==f||null===(i=f.getTitleStore())||void 0===i?void 0:i.getValue(),threadTitle:b,intl:p});fe().R9({environment:g,store:l.getBlockTitleStore(),value:h,transaction:e}),T({pageStore:l,headerBlockStore:f,transaction:e})}}),a?await k(t):r&&C(r)}),[g,C,T,k,p,b,m,x,v]),D=(0,r.useCallback)((async e=>{m&&f&&(null!=e&&e.isCollectionView()?await R(e,f):null!=e&&e.isPageBlock()?A(e,f):await k(f))}),[A,R,f,k,m]),U="database"===j?ke.insertIntoDatabase:"page"===j?ke.insertIntoPage:ke.saveToPage;if(!m)return null;const F=p.formatMessage(U);return(0,je.jsx)(S().m,{renderTooltip:()=>(0,je.jsx)($().sA,{...U}),render:e=>(0,je.jsx)(h().A,{icon:{icon:"large"===n?P().plusIcon:B().plusSmallIcon,size:Te[n]},size:"md",ariaLabel:F,onClick:()=>{Y().trackAgentFollowUpAction({environment:g,threadId:i.id,mode:l,action:"save_as_page"}),D(w)},disabled:t,...e})})}function Ue(e){const{runningInference:t,variant:n,agentResponseMarkdown:a,spaceStore:o,threadStore:i,configType:s}=e,l=(0,$().tz)(),d=(0,c().v3)(),u=(0,r.useCallback)((async()=>{Y().trackAgentFollowUpAction({environment:d,threadId:i.id,mode:s,action:"copy"}),await(0,ve().w)({environment:d,spaceStore:o,copySourceData:{type:"markdown",markdown:a,name:"AgentCopyResponseButton.copy"},copiedMessageLabel:l.formatMessage(ke.responseCopied)})}),[a,s,d,o,i,l]),p=l.formatMessage({id:"aiInferenceTranscript.agentActionsRow.copyResponse",defaultMessage:"Copy response"});return(0,je.jsx)(S().m,{renderTooltip:()=>p,render:e=>(0,je.jsx)(h().A,{icon:{icon:"large"===n?D().V:U().a,size:Te[n]},size:"md",ariaLabel:p,onClick:()=>{u()},disabled:t,...e})})}function Pe(e){const{step:t,traceId:n,threadStore:r,previousUserPromptKey:a,variant:o}=e;return(0,je.jsxs)(je.Fragment,{children:["error"!==t.type?(0,je.jsx)(Me().zg,{step:t,traceId:n,feedbackType:"thumbs_up",threadStore:r,iconColorVariant:"secondary",mode:"feedback-positive",promptKey:a,variant:o}):void 0,(0,je.jsx)(Me().zg,{step:t,traceId:n,feedbackType:"thumbs_down",threadStore:r,iconColorVariant:"secondary",variant:o,promptKey:a,label:"error"===t.type?(0,je.jsx)(v().D,{styleKey:"captionMedium",colorVariant:"secondary",children:(0,je.jsx)($().sA,{id:"AgentUserFeedbackActions.errorFeedbackText",defaultMessage:"Share feedback"})}):void 0})]})}function Be(){const e=(0,p().IS)((()=>({revertedText:{marginInlineStart:6,display:"flex",alignItems:"center"}})),[]);return(0,je.jsx)("div",{style:e.revertedText,children:(0,je.jsx)(v().D,{styleKey:"bodyRegular",colorVariant:"secondary",children:(0,je.jsx)($().sA,{id:"AgentUserFeedbackActions.changesReverted",defaultMessage:"Changes reverted"})})})}function Fe(e){const{isConfirmingUndo:t,onClick:n,variant:r}=e,a=(0,$().YK)({labelCancel:{id:"AgentUserFeedbackActions.cancel",defaultMessage:"Cancel"},labelUndo:{id:"AgentUserFeedbackActions.undo",defaultMessage:"Undo"}});return t?(0,je.jsx)(y().p,{size:"md",onClick:n,colorVariant:"secondary",iconLeading:{icon:"large"===r?V().xMarkIcon:L().xMarkSmallIcon,size:Te[r]},children:(0,je.jsx)(v().D,{styleKey:"captionMedium",children:(0,je.jsx)($().sA,{...a.labelCancel})})},"cancel"):(0,je.jsx)(y().p,{size:"md",onClick:n,colorVariant:"secondary",iconLeading:{icon:"large"===r?T().arrowUTurnUpLeftIcon:k().arrowUTurnUpLeftSmallIcon,size:Te[r]},children:(0,je.jsx)(v().D,{styleKey:"captionMedium",children:(0,je.jsx)($().sA,{...a.labelUndo})})},"undo")}function Ee(e){const{onClick:t,variant:n}=e,r=(0,$().YK)({labelConfirmUndo:{id:"AgentUserFeedbackActions.confirmUndo",defaultMessage:"Confirm Undo"}});return(0,je.jsx)(y().p,{size:"md",onClick:t,colorPalette:"red",iconLeading:{icon:"large"===n?A().checkmarkIcon:R().checkmarkSmallIcon,size:Te[n]},children:(0,je.jsx)(v().D,{styleKey:"captionMedium",children:(0,je.jsx)($().sA,{...r.labelConfirmUndo})})})}function Ve(e){const{operationsToUndo:t,stepsWithOperationsToUndo:n,threadOverrideStore:a}=e,l=(0,c().v3)(),d=(0,i().L)(),u=(0,ae().useThreadStoreFromCurrentRoute)(),p=a??u,g=(0,o().$)(),f=(0,s().X)("agent_server_undo");return{handleUndo:(0,r.useCallback)((async()=>{const e=pe().l.getSource(),r="edit-reference"===(null==e?void 0:e.type);if(!p||!d||!g)return;if(f){const e=Array.from(n).map((e=>e.id));if(0===e.length)return;try{const t=await l.api.callCellCompatibleApi({eventName:"undoAgentOperations",environment:l,data:{threadId:p.id,spaceId:d.id,stepIds:e},cellNavigation:{spaceId:d.id}});if("failed"===t.type)throw t.error;t.data.recordMap&&X()._O({environment:l,userId:l.currentUser.id,inMemoryRecordCache:d.inMemoryRecordCache,recordMap:O().RecordMapWithRole.create(t.data.recordMap),debugSource:"undoAgentOperations"});const a=Array.from(n).map((e=>({name:e.toolName,id:e.toolCallId}))),o=(0,xe().Xw)({environment:l,spaceId:d.id,message:`The user has undone the following tools:\n${a.map((e=>`- ${e.name}${e.id?` ({{[prefix=tool]${e.id}}})`:""}`)).join("\n")}`,notificationType:"info",metadata:{action:"undo",tools:a}}),{serverCommitResult:i}=me().createAndCommit({userAction:"GroupStepRenderer.handleUndo",environment:l,canUndo:!1,perform:e=>{(0,Se().Vn)({threadStore:p,environment:l,spaceStore:d,userStore:g,addSteps:[o],transaction:e})}});return r&&pe().l.clear(),i}catch(s){throw s}}const a=(0,b().p7)(t),o=Array.from(n).map((e=>({name:e.toolName,id:e.toolCallId}))),{serverCommitResult:i}=me().createAndCommit({userAction:"GroupStepRenderer.handleUndo",environment:l,canUndo:!1,isUndoTransaction:!0,perform:e=>{for(const n of a)(0,Se().Hp)({transaction:e,operation:n,recordCache:null==d?void 0:d.inMemoryRecordCache,environment:l});for(const r of n)p&&(0,ye().A)({transaction:e,threadStore:p,step:r,userAction:"undo"});const t=(0,xe().Xw)({environment:l,spaceId:d.id,message:`The user has undone the following tools:\n${o.map((e=>`- ${e.name}${e.id?` ({{[prefix=tool]${e.id}}})`:""}`)).join("\n")}`,notificationType:"info",metadata:{action:"undo",tools:o}});(0,Se().Vn)({threadStore:p,environment:l,spaceStore:d,userStore:g,addSteps:[t],transaction:e})}});return r&&pe().l.clear(),i}),[t,d,l,p,g,n,f])}}function Le(e){const{turn:t,variant:n,threadId:a,spaceStore:o}=e,{isMobileNative:i}=(0,c().Y0)(),s=(0,$().YK)({labelGetHelp:{id:"AgentUserFeedbackActions.getHelp",defaultMessage:"Contact Notion support"}}),l=(0,c().v3)(),d=(0,u().K8)((()=>(0,J().Q)()&&ee().default.state.isZendeskEnabled),[]),[p,g]=(0,le().P)(1),m=(0,r.useRef)(!1);(0,r.useEffect)((()=>{g&&!m.current&&(m.current=!0,Y().trackGetHelpButtonImpression({environment:l,threadId:a}))}),[g,l,a]);const h=(0,r.useCallback)((async()=>{if(W().VX(l,{qnaSessionId:a,from:"qna_modal_chat"}),(0,te().trackAiDetectedGetSupportPillClick)(l,{sessionId:a}),d){(0,re().dismissChatSidebar)();const e=await async function(e,t,n){if(!n)return;const r=f().E.createChildStore(n,{table:_().To,id:t,spaceId:n.id}),a=r.getTranscript(),o=a.findIndex((t=>t.id===e.id)),i=a.slice(0,o).find((e=>"user"===e.type));if(i)return await(0,w().rf)({value:i.value,loadRecordModel:n.loadRecordModel})}(t.steps[0],a,o);Z().SI({environment:l,from:"ai_assistant_pill",prepopulatedContent:e})}else i?ge().r.setState({...ge().r.state,open:!0,source:"transcriptAgent"}):ne().assistantMenuActions.openCornerChatHelp()}),[d,t.steps,l,a,i,o]);return(0,je.jsx)(y().p,{ref:p,size:"md",onClick:h,colorVariant:"secondary",iconLeading:{icon:"large"===n?F().questionMarkCircleIcon:E().questionMarkCircleSmallIcon,size:Te[n]},children:(0,je.jsx)(v().D,{styleKey:"captionMedium",children:(0,je.jsx)($().sA,{...s.labelGetHelp})})},"get-help")}},108715:(e,t,n)=>{e.exports=n.p+"3dbd8229ffb78610.png"},155382:(e,t,n)=>{n.d(t,{$5:()=>C,I:()=>M,PA:()=>S,WM:()=>x,eb:()=>j,ji:()=>w,pg:()=>k,yX:()=>v});n(944114),n(517642),n(658004),n(733853),n(845876),n(432475),n(515024),n(731698),n(581454);var r=n(296540),a=()=>n(920198),o=()=>n(590526),i=()=>n(401497),s=()=>n(739831),l=()=>n(365646),d=()=>n(687249),c=()=>n(800204),u=()=>n(395797),p=()=>n(179034),g=()=>n(519831),f=()=>n(155792),m=()=>n(743246),h=()=>n(496603),y=()=>n(534177);function v(e,t){const n=[];for(const r of e){const e=x(r.toolType),a=S(r,t);if(e)for(const t of a)t.table===p().ev&&n.push({recordPointer:t,agentAction:e})}return n}function S(e,t){if(!e||(n=e.result,!(0,y().Gv)(n)||Array.isArray(n)))return[];var n;const r=e.result;if("appId"in r&&"string"==typeof r.appId)return[{table:p().ev,id:r.appId}];if("pageId"in r&&"string"==typeof r.pageId)return[{table:p().ev,id:r.pageId}];if("collectionViewBlockId"in r&&"string"==typeof r.collectionViewBlockId)return[{table:p().ev,id:r.collectionViewBlockId}];if("pageIds"in r&&Array.isArray(r.pageIds))return r.pageIds.map((e=>({table:p().ev,id:e})));if("workflowId"in r&&"string"==typeof r.workflowId&&t)return[{table:m().C0,id:r.workflowId,spaceId:t}];if("entities"in r){return function(e){const t=[];for(const n of e){const e=(0,d().dw)(n);e&&t.push(e)}return h().hS(t,(e=>`${e.table}-${e.id}`))}(r.entities)}return(0,l().gY)(e,"query-data-sources")&&"collectionIds"in r&&Array.isArray(r.collectionIds)?r.collectionIds.map((e=>({id:e,table:g().Vl}))):[]}function x(e){switch(e){case"create-database":case"notion.createDatabase":case"create-pages":case"create-agent":case"create-agent-v2":return"create";case"update-database":case"update-database-data-sources":case"update-database-views":case"update-database-triggers":case"notion.updateDatabase":case"update-page":case"update-page-v2":case"update-user-integrations":case"toggle-user-integration-tools":case"enter-setup-mode":case"exit-setup-mode":case"update-agent":case"update-agent-v2":case"callFunction":case"runScript":case"revert":return"update";case"delete-pages":case"delete-agent":return"delete";case"search":case"queryCalendar":case"queryMail":case"view":case"view-notifications":case"view-version-history":case"view-database-files":case"view-channel":case"view-slack-channel":case"view-code-repo":case"query-data-sources":case"error":case"result":case"wait":case"edit-json":case"query-salesforce-tool":case"list-machines":case"create-machine":case"destroy-machine":case"terminal":case"browser":case"summarize-meeting-note":case"generate-image":case"mcpServer.getPrompt":case"mcpServer.listPrompts":case"mcpServer.listResources":case"mcpServer.readResource":case"mcpServer.runTool":case"mcpServer.listTools":case"images.generate":case"slack.addReactionToMessage":case"slack.createThreadInChannel":case"slack.createThreadInDirectMessage":case"slack.findUserByEmail":case"slack.getThreadsInChannelSince":case"slack.getUser":case"slack.parseSlackUriOrUrl":case"slack.queryChannels":case"slack.removeReactionFromMessage":case"slack.replyInThread":case"slack.updateMessage":case"slack.viewFileUrl":case"slack.loadMessage":case"notion.addCommentToDiscussion":case"notion.getPageDiscussions":case"notion.sendNotification":case"notion.viewFileUrl":case"calendar.fetchPlaybook":case"calendar.listCalendars":case"calendar.listEvents":case"calendar.listCoworkersEvents":case"calendar.createEvents":case"calendar.updateEvents":case"calendar.cancelEvents":case"calendar.suggestMeetingTimes":case"mail.listTools":case"mail.runTool":case"mail.getPrompt":case"files.getFileContent":case"files.getFileName":case"files.getFileUrl":case"cursor.createAgent":case"cursor.addFollowup":case"cursor.getAgent":case"cursor.listRepositories":case"worker.runTool":case"worker.listTools":case"workers.list":case"query-agent-threads":case"investigate-agent-thread":case"run-agent":case"update-todos":case"computer.listMachines":case"computer.listSecrets":case"computer.createMachine":case"computer.destroyMachine":case"computer.setSecret":case"computer.terminal":case"computer.browser":case"computer.viewFileUrl":case"computer.getJobStatus":case"computer.getJobLogs":case"notion.createAgent":case"notion.loadAgent":case"notion.loadUser":case"notion.updateAgent":case"notion.loadDatabase":case"notion.loadDataSource":case"notion.getFormulaValue":case"notion.loadPage":case"notion.createPage":case"notion.updatePage":case"notion.querySql":case"notion.queryView":case"notion.createAndRunThread":case"web.search":case"web.loadPage":case"search.autosearch":case"asana.search":case"box.search":case"discord.search":case"github.search":case"github.grepCode":case"github.lsDirectory":case"github.loadPR":case"github.loadIssue":case"github.loadCommit":case"github.loadFile":case"gmail.search":case"gmail.loadThread":case"gmail.query":case"googleDrive.search":case"googleDrive.loadFile":case"googleCalendar.search":case"googleCalendar.query":case"jira.search":case"jira.loadIssue":case"linear.search":case"linear.loadIssue":case"microsoftTeams.search":case"microsoftTeams.loadMessage":case"microsoftTeams.viewChannel":case"microsoftTeams.viewChat":case"outlook.search":case"outlook.loadMessage":case"outlook.loadThread":case"outlook.query":case"asana.loadTask":case"sharepoint.loadFile":case"salesforce.search":case"sharepoint.search":case"slack.search":case"notion.queryThreads":case"notion.investigateThread":case"modules.list":case"modules.create":case"modules.update":case"modules.delete":case"fs.readDir":case"fs.readFiles":case"test.getState":case"escalate":return;default:(0,y().HB)(e)}}const b=new Set,I={operationsToUndo:n(415622).Pc,hasUndoneOperations:!1,stepsWithOperationsToUndo:b};function w({diffResultSteps:e,threadStore:t}){var n;const r=Boolean((0,a().L)()),i=null===(n=(0,a().L)())||void 0===n?void 0:n.id;return(0,o().K8)((()=>{if(!r||!i)return I;const n=[],a=new Map;for(const r of e.slice().reverse()){if(!r)continue;const e=s().X.createChildStore(t,{table:f().mS,id:r.id,spaceId:i}).getThreadOperationStores();for(const t of e.slice().reverse())n.push(t),a.set(t,r)}if(0===n.length)return I;const o=[],l=new Set;let d=!1;for(const e of n){const t=e.getKeyValue("userAction"),n=e.getKeyValue("invertedOperations")??[];if("undo"===t)d=!0;else{o.push(...n);const t=a.get(e);t&&l.add(t)}}return 0!==o.length||d||0!==l.size?{operationsToUndo:o,hasUndoneOperations:d,stepsWithOperationsToUndo:l}:I}),[e,r,i,t],{useDeepEqual:!0})}function M({runningInference:e,toolResultStep:t,isLastTurn:n}){return!!e&&(t?!(0,u().nP)(t):n)}function j(e){return"callFunction"!==e.toolType&&"runScript"!==e.toolType&&(Boolean(e.error)&&e.error!==c().p9)}function C(e){return(0,i().IS)((()=>({animationStyle:{opacity:e?1:0,transition:"opacity 800ms ease-in-out"}})),[e]).animationStyle}const T=100;function k({numItems:e,animateIndexOffset:t=0,disableAnimation:n=!1,onAllAnimationsComplete:a}){const[o,i]=(0,r.useState)(new Set),s=(0,r.useMemo)((()=>[...Array(e).keys()]),[e]);return(0,r.useEffect)((()=>{if(n)return i(new Set(s)),void(a&&a());for(const n of s){setTimeout((()=>{i((t=>{const r=new Set(t).add(n);return r.size===e&&a&&setTimeout(a,100),r}))}),(n+t)*T+200)}}),[t,s,n,e,a]),o}},205557:(e,t,n)=>{n.r(t),n.d(t,{iconDefinition:()=>r,lightBulbBrightSmallIcon:()=>a});n(296540);const r={viewBox:"0 0 16 16",fittedViewBox:"3.96 1.38 8.07 13.24",svg:(0,n(474848).jsx)("path",{d:"M8 1.385c-2.23 0-4.035 1.793-4.035 3.985 0 .782.193 1.525.56 2.147.09.161.181.312.281.473.454.725.86 1.386.86 2.08a.63.63 0 0 0 .624.625.63.63 0 0 0 .625-.625c.01-1.064-.553-1.972-1.041-2.75l-.27-.448a3 3 0 0 1-.389-1.512C5.215 3.853 6.46 2.625 8 2.625s2.785 1.228 2.785 2.735c0 .558-.137 1.084-.39 1.512l-.269.449-.01.016c-.475.773-1.03 1.675-1.03 2.723a.63.63 0 0 0 .55.62v.015h.074a.63.63 0 0 0 .625-.625c0-.684.406-1.355.859-2.08v-.002l.001-.001q.067-.117.139-.233t.141-.237c.367-.622.56-1.365.56-2.147 0-2.202-1.815-3.985-4.035-3.985m-1.6 10.19a.63.63 0 0 0-.625.625.63.63 0 0 0 .625.625h3.2a.63.63 0 0 0 .625-.625.63.63 0 0 0-.625-.625zm.8 1.8a.63.63 0 0 0-.625.625.63.63 0 0 0 .625.625h1.6A.63.63 0 0 0 9.425 14a.63.63 0 0 0-.625-.625z"})},a=(0,n(340498).wt)("lightBulbBrightSmall",r,"small")},209089:(e,t,n)=>{n.d(t,{l:()=>o});n(296540);var r=n(474848);const a={viewBox:"0 0 20 20",fittedViewBox:"1.62 4.19 16.75 11.61",svg:(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("path",{d:"M4.8 6.75a.65.65 0 1 0 0 1.3.65.65 0 0 0 0-1.3m1.95.65a.65.65 0 1 1 1.3 0 .65.65 0 0 1-1.3 0M10 6.75a.65.65 0 1 0 0 1.3.65.65 0 0 0 0-1.3m1.95.65a.65.65 0 1 1 1.3 0 .65.65 0 0 1-1.3 0m3.25-.65a.65.65 0 1 0 0 1.3.65.65 0 0 0 0-1.3M4.15 10a.65.65 0 1 1 1.3 0 .65.65 0 0 1-1.3 0m3.25-.65a.65.65 0 1 0 0 1.3.65.65 0 0 0 0-1.3m1.95.65a.65.65 0 1 1 1.3 0 .65.65 0 0 1-1.3 0m3.25-.65a.65.65 0 1 0 0 1.3.65.65 0 0 0 0-1.3m1.95.65a.65.65 0 1 1 1.3 0 .65.65 0 0 1-1.3 0M4.8 11.95a.65.65 0 1 0 0 1.3.65.65 0 0 0 0-1.3m1.93.636c0-.345.28-.625.624-.625h5.25a.625.625 0 1 1 0 1.25h-5.25a.625.625 0 0 1-.625-.625m8.471-.636a.65.65 0 1 0 0 1.3.65.65 0 0 0 0-1.3"}),(0,r.jsx)("path",{d:"M3.75 4.197a2.125 2.125 0 0 0-2.125 2.125v7.356c0 1.174.951 2.125 2.125 2.125h12.5a2.125 2.125 0 0 0 2.125-2.125V6.322a2.125 2.125 0 0 0-2.125-2.125zm-.875 2.125c0-.483.392-.875.875-.875h12.5c.483 0 .875.392.875.875v7.356a.875.875 0 0 1-.875.875H3.75a.875.875 0 0 1-.875-.875z"})]})},o=(0,n(340498).wt)("keyboard",a,"default")},216296:(e,t,n)=>{n.r(t),n.d(t,{circleIcon:()=>a,iconDefinition:()=>r});n(296540);const r={viewBox:"0 0 20 20",fittedViewBox:"2.37 2.37 15.26 15.25",svg:(0,n(474848).jsx)("path",{d:"M2.375 10a7.625 7.625 0 1 1 15.25 0 7.625 7.625 0 0 1-15.25 0M10 3.625a6.375 6.375 0 1 0 0 12.75 6.375 6.375 0 0 0 0-12.75"})},a=(0,n(340498).wt)("circle",r,"default")},222800:(e,t,n)=>{n.d(t,{$:()=>h,V:()=>m});n(581454);var r=()=>n(106702),a=()=>n(920198),o=()=>n(230711),i=()=>n(59226),s=()=>n(484714),l=()=>n(590526),d=()=>n(290247),c=()=>n(499172),u=()=>n(69708),p=()=>n(496603),g=()=>n(169626);const f=(0,u().YK)({permissionDeniedTooltip:{id:"permissions.agentCreation.denied",defaultMessage:"Contact a workspace owner to create agents"}});function m(){const e=(0,a().L)(),t=(0,r().$)(),n=(0,s().v3)(),u=(0,i().X)("agent_creation_permissions");return(0,l().K8)((()=>{if(!u)return{canCreate:!0};const r=null==e?void 0:e.getModel(),a=null==r?void 0:r.getSettings();if(!(e&&t&&r&&a))return{canCreate:!1,reason:"feature_disabled"};const i=(0,o().dp)(e,t.id).getMembershipTypeAsRoleOrNone(),s=d()._.getSpacePermissionGroupIds({userId:n.currentUser.id,spaceId:e.id}),l=(0,p().oE)(Array.from(s).map((e=>{const t=g().h.getGroup(e);if(t){const e=t.getSettings();return{settings:e?{can_create_custom_agents:e.can_create_custom_agents}:void 0}}}))),f={policy:a.custom_agent_creation_policy,userRole:i&&"none"!==i?i:void 0,userPermissionGroups:l};return(0,c().K)(f)}),[e,t,u,n])}function h(){const e=m(),t=(0,u().tz)().formatMessage(f.permissionDeniedTooltip);return{canCreate:e.canCreate,reason:e.reason,tooltipMessage:t}}},299261:(e,t,n)=>{n.d(t,{A:()=>i});var r=()=>n(739831),a=()=>n(155792),o=()=>n(384944);function i({transaction:e,threadStore:t,step:n,userAction:i}){const s=t.getSpaceId();if(!s)return;const l=r().X.createChildStore(t,{table:a().mS,id:n.id,spaceId:s});for(const r of l.getThreadOperationStores())o().zv({store:r,data:{userAction:i},transaction:e})}},310818:(e,t,n)=>{n.d(t,{Sn:()=>s,aG:()=>i});var r=n(296540),a=n(474848);const o=(0,r.createContext)(void 0);function i({children:e,store:t}){return(0,a.jsx)(o.Provider,{value:t,children:e})}function s(){return(0,r.useContext)(o)}o.displayName="AgentThreadListContext"},426327:(e,t,n)=>{n.d(t,{a:()=>o});n(296540);var r=n(474848);const a={viewBox:"0 0 16 16",fittedViewBox:"3.37 2.12 9.25 11.75",svg:(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("path",{d:"M5.75 4.175a.575.575 0 1 0 0 1.15h4.5a.575.575 0 1 0 0-1.15zm0 2a.575.575 0 1 0 0 1.15h4.5a.575.575 0 1 0 0-1.15zm0 2a.575.575 0 1 0 0 1.15H8a.575.575 0 0 0 0-1.15z"}),(0,r.jsx)("path",{d:"M5.25 2.125c-1.036 0-1.875.84-1.875 1.875v8c0 1.036.84 1.875 1.875 1.875h5.5c1.036 0 1.875-.84 1.875-1.875V4c0-1.036-.84-1.875-1.875-1.875zM4.625 4c0-.345.28-.625.625-.625h5.5c.345 0 .625.28.625.625v8c0 .345-.28.625-.625.625h-5.5A.625.625 0 0 1 4.625 12z"})]})},o=(0,n(340498).wt)("docPlainTextSmall",a,"small")},548475:(e,t,n)=>{n.d(t,{M:()=>r});const r=new(n(62175).U)(((e,{spaceId:t})=>t),(async(e,{spaceId:t})=>{const n=await e.api.callApi({eventName:"getAgentTemplates",environment:e,data:{spaceId:t}});return"success"===n.type?n.data.templates:void 0}))},556402:(e,t,n)=>{n.d(t,{i:()=>a});n(296540);const r={viewBox:"0 0 20 20",fittedViewBox:"2.37 3.62 15.25 14",svg:(0,n(474848).jsx)("path",{d:"M2.375 5.75c0-1.174.951-2.125 2.125-2.125h11c1.174 0 2.125.951 2.125 2.125v7.5a2.125 2.125 0 0 1-2.125 2.125H12v1h1.5a.625.625 0 1 1 0 1.25h-7a.625.625 0 1 1 0-1.25H8v-1H4.5a2.125 2.125 0 0 1-2.125-2.125zM4.5 4.875a.875.875 0 0 0-.875.875v7.5c0 .483.392.875.875.875h11a.875.875 0 0 0 .875-.875v-7.5a.875.875 0 0 0-.875-.875z"})},a=(0,n(340498).wt)("display",r,"default")},560089:(e,t,n)=>{n.d(t,{s:()=>l});n(944114),n(898992),n(354520),n(803949);var r=n(296540),a=()=>n(590526),o=()=>n(496603),i=()=>n(534177),s=()=>n(680369);function l(e){const{turn:t,environment:n,spaceStore:l,threadStore:d,clientStore:c,runningInference:u,isMultiDatabaseMode:p,showDebug:g}=e,f=(0,r.useRef)(new Map),m=(0,r.useMemo)((()=>t.steps??[]),[t.steps]),h=(0,r.useMemo)((()=>m.filter((e=>"agent-tool-result"===e.type))),[m]),y=(0,a().K8)((()=>{const e=f.current,t=new Map;let r=!1;const a=new Map;return m.forEach((e=>{if("agent-search-query-generation"===e.type&&e.searchToolCallId){const t=a.get(e.searchToolCallId)||[];t.push(e),a.set(e.searchToolCallId,t)}})),m.forEach((f=>{if("agent-inference"===f.type){const m=h.filter((e=>e.agentStepId===f.id)),y=(0,s().xr)({environment:n,step:f,toolResultsForStep:m,spaceStore:l,threadStore:d,clientStore:c,runningInference:u,isMultiDatabaseMode:p,queryGenStepMapToSearchCallId:a,showDebug:g}).filter(i().O9),v=e.get(f.id);v&&(0,o().n4)(v,y)?t.set(f.id,v):(r=!0,t.set(f.id,y))}})),r||e.size!==t.size?(f.current=t,t):e}),[m,n,h,l,d,c,u,p,g]),v=(0,r.useMemo)((()=>{const e=[];for(const t of y.values())e.push(...t);return e}),[y]);return{stepPartsByStepId:y,allParts:v,allToolResults:h}}},561487:(e,t,n)=>{n.d(t,{C:()=>s});var r=()=>n(300474),a=()=>n(484714),o=()=>n(187174),i=()=>n(548475);function s(){const e=(0,a().v3)(),t=(0,r().r)(),[{status:n,value:s}]=(0,o().Yb)((async()=>{if(void 0===t)return[];return await i().M.awaitData(e,{spaceId:t})??[]}),[e,t]);return{status:n,templates:s??[]}}},584499:(e,t,n)=>{n.d(t,{N:()=>l});n(18107),n(410838),n(967357),n(898992),n(354520),n(581454),n(737550);var r=n(296540),a=()=>n(590526),o=()=>n(365646),i=()=>n(395797),s=()=>n(155382);function l(e){const{turn:t,parts:n,spaceStore:l}=e,d=(0,r.useMemo)((()=>n.filter((e=>"tool-use"===e.type)).map((e=>e.toolResultStep)).filter((e=>null!=e)).filter((e=>!(0,i().I6)(e)&&!(0,i().dB)(e)&&!(0,s().eb)(e)&&o().MV.some((t=>t===e.toolName))))),[n]),c=(0,a().K8)((()=>{const e=(0,s().yX)(d,(null==l?void 0:l.id)??"").length>0,t=d.some((e=>("callFunction"===e.toolName||"runScript"===e.toolName)&&e.threadOperations&&e.threadOperations.length>0));return e||t}),[d,null==l?void 0:l.id]),u=(0,r.useMemo)((()=>{const e=t.steps.findLast((e=>"error"===e.type)),r=Date.now(),a=t.steps.filter((e=>{const t="startedAt"in e&&e.startedAt<r-6e4,n="finishedAt"in e&&e.finishedAt&&e.finishedAt<r-6e4;return t||n})),o=d.at(-1),i=n.findLast((e=>e.isFinished)),s="tool-use"===(null==i?void 0:i.type)?i:null,l=null==s?void 0:s.toolResultStep;return e||o||l||(i?i.step:t.steps.at(-1))||a.at(-1)}),[n,d,t.steps]),p=u&&"traceId"in u?u.traceId:void 0;return{undoableToolResults:d,hasModifiedRecords:c,feedbackStep:u,feedbackTraceId:p}}},741862:(e,t,n)=>{n.d(t,{C3:()=>d,Li:()=>u,VM:()=>l,al:()=>c});var r=()=>n(800204),a=()=>n(68169),o=()=>n(172385),i=()=>n(496703),s=()=>n(498212);function l(e){return function(e){var t,n,s;const{toolResultStep:l,agentRouteParams:d,peekRouteParams:p}=e,g=(0,r().Tn)(null===(t=l.result)||void 0===t?void 0:t.threadUrl);if(null==g||!g.startsWith("thread://"))return;const f=g.slice(9),[,m]=f.split("/"),h=u(m);if(!h)return;if(function(e){var t,n;const o=null===(t=e.result)||void 0===t?void 0:t.workflowId;if(!o||o===a().Lj)return!0;return(0,r().SZ)(null===(n=e.input)||void 0===n?void 0:n.agentUrl)}(l)){const e={name:"chat",configureOpenInDesktopApp:!1,openSettingsTab:void 0,peekMode:null==p?void 0:p.peekMode,peekViewBlockId:null==p?void 0:p.peekViewBlockId,workflowViewType:d.workflowViewType,threadId:h};return{kind:"personal",threadId:h,url:(0,o().X_)(e)}}const y=u(null===(n=l.result)||void 0===n?void 0:n.workflowId)??c(null===(s=l.input)||void 0===s?void 0:s.agentUrl);if(!y)return;const v={...d,agentChatThreadId:h};v.workflowViewType||(v.workflowViewType="activity");const S=(0,i().L)({workflowId:y,params:v});return{kind:"custom",threadId:h,url:S,redirect:!1}}(e)}function d(e,t){if("chat"!==e.name)return;const n={...e,threadId:t};return(0,o().X_)(n)}function c(e){const t=(0,r().Tn)(e);if(null==t||!t.startsWith("agent://"))return;const[,n]=t.split("agent://");if(!n)return;const[,a]=n.split("/");return u(a)}function u(e){if(!e)return;const t=e.trim();return 32===t.length?(0,s().np)(t):36===t.length?t:void 0}},913886:(e,t,n)=>{n.d(t,{D:()=>a});n(296540);const r={viewBox:"0 0 16 16",fittedViewBox:"2.12 3.37 11.75 9.25",svg:(0,n(474848).jsx)("path",{d:"M4 3.375c-1.036 0-1.875.84-1.875 1.875v5.5c0 1.036.84 1.875 1.875 1.875h8c1.036 0 1.875-.84 1.875-1.875v-5.5c0-1.036-.84-1.875-1.875-1.875zm4 4.991L4.26 4.625h7.482zm-4.625 2.122v-4.98l2.49 2.49zm9.25 0-2.49-2.49 2.49-2.489zm-8.37.887 2.493-2.493.81.81c.244.244.64.244.884 0l.81-.81 2.492 2.493z"})},a=(0,n(340498).wt)("envelopeSmall",r,"small")},920741:(e,t,n)=>{n.d(t,{l:()=>ra});n(410838),n(944114),n(517642),n(658004),n(733853),n(845876),n(432475),n(515024),n(731698),n(898992),n(354520),n(672577),n(803949),n(581454),n(737550);var r=n(296540),a=()=>n(59226),o=()=>n(726637),i=()=>n(484714),s=()=>n(590526),l=()=>n(401497),d=()=>n(699143),c=()=>n(365646),u=()=>n(534177);var p=()=>n(395797),g=()=>n(69708),f=()=>n(100622),m=()=>n(571376),h=()=>n(83626),y=()=>n(774952),v=()=>n(621594),S=()=>n(340498),x=()=>n(496603),b=()=>n(588104),I=n(474848);function w(e){const{step:t}=e,a=(0,l().IS)((()=>({container:{padding:8,marginBottom:20},icon:{width:S().Ev.sm,height:S().Ev.sm,fill:f().Tj.red.icon.accentPrimary},codeBlock:{padding:12,borderRadius:8,backgroundColor:f().Tj.background.secondary}})),[]),o=(0,r.useMemo)((()=>JSON.stringify(t,null,2)),[t]),i=(0,x().oE)([t.fromInferenceContextType?`prompt=${t.fromInferenceContextType}`:void 0,t.fromToolName?`tool=${t.fromToolName}`:void 0]).join(", ");return(0,I.jsx)(b().Q,{style:a.container,children:(0,I.jsx)(n(562936).b,{label:`Error ${t.errorType}: ${i}`.trim(),icon:v().exclamationMarkCircleSmallIcon,iconStyle:a.icon,children:(0,I.jsx)("div",{style:a.codeBlock,children:(0,I.jsx)(m().O,{value:o,language:"json"})})})})}function M(e){var t;const{step:n}=e,{evalResult:a,braintrustInfo:o,evaluatedAt:i}=n,[s,d]=(0,r.useState)(new Set),[c,u]=(0,r.useState)(new Set),p=(e,t,n=0)=>{if(Array.isArray(e))return(0,I.jsx)("div",{children:e.map(((e,r)=>(0,I.jsxs)("div",{style:{marginBottom:4},children:[(0,I.jsxs)("strong",{children:["[",r,"]"]}),": ",p(e,`${t}[${r}]`,n)]},r)))});if("object"==typeof e&&null!==e&&!Array.isArray(e)){const r=c.has(t),a=Object.entries(e);return(0,I.jsxs)("div",{children:[(0,I.jsxs)("button",{style:{...g.toggleButton,marginInlineStart:8*n},onClick:()=>(e=>{u((t=>{const n=new Set(t);return n.has(e)?n.delete(e):n.add(e),n}))})(t),type:"button",children:[r?"â–¼":"â–¶"," Object (",a.length," ",1===a.length?"key":"keys",")"]}),r?(0,I.jsx)("div",{style:{...g.nestedObject,marginInlineStart:16*(n+1)},children:a.map((([e,r])=>(0,I.jsxs)("div",{style:g.nestedItem,children:[(0,I.jsx)("strong",{children:e}),": ",p(r,`${t}.${e}`,n+1)]},e)))}):void 0]})}return String(e)},g=(0,l().IS)((()=>({container:{backgroundColor:"rgba(0, 150, 255, 0.1)",border:"1px solid rgba(0, 150, 255, 0.3)",borderRadius:8,padding:12,margin:"8px 0",fontSize:12},header:{fontWeight:"bold",color:"#0096ff",marginBottom:8},braintrustInfo:{marginBottom:6,color:"#666"},section:{marginBottom:6},indentedContent:{marginInlineStart:12,marginTop:4},scoreItem:{marginBottom:2},scoreValue:{fontWeight:"bold"},scoreHeader:{display:"flex",alignItems:"center",gap:4},toggleButton:{background:"none",border:"none",cursor:"pointer",fontSize:10,color:"#666",padding:0,marginInlineStart:4},scoreMetadata:{marginInlineStart:16,marginTop:4,padding:4,backgroundColor:"rgba(0, 0, 0, 0.05)",borderRadius:4,fontSize:11,color:"#555"},nestedObject:{marginTop:4,padding:4,backgroundColor:"rgba(0, 0, 0, 0.03)",borderInlineStart:"2px solid rgba(0, 0, 0, 0.1)",borderRadius:2},nestedItem:{marginBottom:2},timestamp:{fontSize:10,color:"#999",marginTop:8}})),[]),f=null===(t=a.metadata)||void 0===t?void 0:t.scorers;return(0,I.jsxs)("div",{style:g.container,children:[(0,I.jsx)("div",{style:g.header,children:"ðŸ“Š Evaluation Results"}),o.project?(0,I.jsxs)("div",{style:g.braintrustInfo,children:[(0,I.jsx)("strong",{children:"Project:"})," ",o.project,(0,I.jsx)("br",{}),(0,I.jsx)("strong",{children:"Dataset:"})," ",o.dataset,(0,I.jsx)("br",{}),(0,I.jsx)("strong",{children:"ID:"})," ",o.originalInferenceId]}):void 0,Object.keys(a.scores).length>0?(0,I.jsxs)("div",{style:g.section,children:[(0,I.jsx)("strong",{children:"Scores:"}),(0,I.jsx)("div",{style:g.indentedContent,children:Object.entries(a.scores).map((([e,t])=>{let n;if(f&&"object"==typeof f&&null!==f){const t=f[e];t&&"object"==typeof t&&null!==t&&!Array.isArray(t)&&(n=t.metadata)}const r=n&&"object"==typeof n&&null!==n&&!Array.isArray(n),a=s.has(e);return(0,I.jsxs)("div",{children:[(0,I.jsx)("div",{style:g.scoreItem,children:(0,I.jsxs)("div",{style:g.scoreHeader,children:[(0,I.jsxs)("span",{children:[e,": ",(0,I.jsx)("span",{style:g.scoreValue,children:t.toFixed(3)})]}),r?(0,I.jsx)("button",{style:g.toggleButton,onClick:()=>{return t=e,void d((e=>{const n=new Set(e);return n.has(t)?n.delete(t):n.add(t),n}));var t},type:"button",children:a?"â–¼":"â–¶"}):void 0]})}),r&&a?(0,I.jsx)("div",{style:g.scoreMetadata,children:Object.entries(n).map((([t,n])=>(0,I.jsxs)("div",{children:[(0,I.jsx)("strong",{children:t}),": ",p(n,`${e}.${t}`)]},t)))}):void 0]},e)}))})]}):void 0,a.metrics&&Object.keys(a.metrics).length>0?(0,I.jsxs)("div",{style:g.section,children:[(0,I.jsx)("strong",{children:"Metrics:"}),(0,I.jsx)("div",{style:g.indentedContent,children:Object.entries(a.metrics).map((([e,t])=>(0,I.jsxs)("div",{style:g.scoreItem,children:[e,": ",(0,I.jsx)("span",{style:g.scoreValue,children:String(t)})]},e)))})]}):void 0,(0,I.jsxs)("div",{style:g.timestamp,children:["Evaluated at: ",new Date(i).toLocaleString()]})]})}var j=()=>n(807449),C=()=>n(631524),T=()=>n(493552),k=()=>n(827368);const A=(0,g().YK)({agentSkippedTitle:{id:"aiInferenceTranscript.agentRouteTriggerStepRenderer.agentSkippedTitle",defaultMessage:"No action taken"}});function R(e){const{step:t}=e,[a,o]=(0,r.useState)(!1),[i,s]=(0,n(554283).B)(),d=t.message&&t.message.length>0,{bodyStyleKey:c}=(0,k().yq)(),u=(0,k().Cd)(c),p=(0,l().IS)((()=>({container:{display:"flex",flexDirection:"column",marginBlock:8},header:{display:"flex",alignItems:"center",gap:6,color:s&&d?f().Tj.text.primary:f().Tj.text.secondary,...u,cursor:d?"pointer":"default"},headerHovered:{background:"transparent"},headerPressed:{background:"transparent"},chevronIcon:{transition:"transform 0.2s ease-in-out",transformOrigin:"center",transform:a?"rotate(0deg)":"rotate(calc(var(--direction, 1) * -90deg))"},reasoningWrapper:{display:"grid",gridTemplateRows:a?"1fr":"0fr",opacity:a?1:0,transition:"grid-template-rows 0.2s ease-in-out, opacity 0.2s ease-in-out"},reasoningContainer:{overflow:"hidden",paddingInlineStart:22},reasoningContent:{paddingBlock:8}})),[a,d,s,u]),m=(0,r.useCallback)((()=>{d&&o(!a)}),[a,d]);return t.passed?null:(0,I.jsxs)("div",{style:p.container,children:[(0,I.jsxs)(C().p,{ref:i,style:p.header,hoveredStyle:p.headerHovered,pressedStyle:p.headerPressed,onClick:m,disabled:!d,children:[(0,I.jsx)(j().I,{icon:n(75318).j,size:"sm",colorVariant:"secondary"}),(0,I.jsx)(T().D,{styleKey:"bodyRegular",colorVariant:s&&d?"primary":"secondary",children:(0,I.jsx)(g().sA,{...A.agentSkippedTitle})}),d?(0,I.jsx)(j().I,{icon:n(324254).arrowChevronSingleDownSmallIcon,size:"sm",colorVariant:"secondary",style:p.chevronIcon}):null]}),d?(0,I.jsx)("div",{style:p.reasoningWrapper,children:(0,I.jsx)("div",{style:p.reasoningContainer,children:(0,I.jsx)("div",{style:p.reasoningContent,children:(0,I.jsx)(T().D,{styleKey:"bodyRegular",colorVariant:"secondary",children:t.message})})})}):null]})}var D=()=>n(920198),U=()=>n(759113),P=()=>n(829098),B=()=>n(350013),F=()=>n(695115),E=()=>n(26697),V=()=>n(222334),L=()=>n(477336),N=()=>n(324883),O=()=>n(743246),_=()=>n(687879),K=()=>n(638666),z=()=>n(310818),q=()=>n(781317);const $=(0,g().YK)({editTrigger:{id:"agentStepHeader.editTrigger",defaultMessage:"Edit trigger"},reRun:{id:"agentStepHeader.reRun",defaultMessage:"Re-run"}});function Y(e){const{isExpanded:t,isBusy:n=!1,canExpand:a,onToggleExpanded:o,onTitleClicked:c,icon:u,title:p,hideIcon:m,children:h,triggerStep:y,threadStore:v,"aria-expanded":S,"aria-controls":x}=e,b=(0,i().v3)(),w=(0,D().L)(),M=(0,z().Sn)(),{bodyStyleKey:T}=(0,k().yq)(),A=(0,k().Cd)(T),R=(0,g().tz)(),U=(0,s().K8)((()=>{if(w&&null!=y&&y.workflowId)return B().N.createChildStore(w,{table:O().C0,id:y.workflowId,spaceId:w.id})}),[w,null==y?void 0:y.workflowId]),Y=(0,r.useCallback)((async()=>{y&&U&&await(0,K().B)({workflowOrArtifactStore:U,triggerId:y.triggerId,appearance:"editTrigger"})}),[y,U]),W=(0,r.useCallback)((async()=>{y&&U&&w&&v&&(await(0,_().reRunWorkflowFromThread)({environment:b,spaceStore:w,workflowStore:U,threadId:v.id}),await(null==M?void 0:M.refreshThreads()))}),[y,U,w,b,v,M]),H=(0,l().IS)((()=>({button:{width:"100%",height:"auto",paddingBlock:8,paddingInline:12,textAlign:"start",borderEndStartRadius:t?0:void 0,borderEndEndRadius:t?0:void 0,display:"flex",flexDirection:"column",gap:4,alignItems:"start"},chevron:{marginInlineStart:"auto",transform:t?"rotate(90deg)":"rotate(0deg)",transition:"transform 0.2s ease-in-out"},iconContainer:{display:"flex",alignItems:"center",justifyContent:"center",height:20,width:20,opacity:n?.3:1},title:{color:f().Tj.text.secondary,minWidth:0,flexGrow:1,...P().U.bodyRegular,...A},actionButtons:{display:"flex",gap:2}})),[t,n,A]);return(0,I.jsxs)(C().p,{disabled:n||!a&&!c,onClick:c||o,style:H.button,"aria-expanded":S,"aria-controls":x,children:[(0,I.jsxs)(d().Y1,{direction:"horizontal",gap:8,width:"fill",height:"hug",align:"center",children:[!m&&u?(0,I.jsx)("div",{style:H.iconContainer,children:n?(0,I.jsx)(q().ScrollingSquiggle,{}):(0,I.jsx)(j().I,{icon:u,colorVariant:"secondary"})}):void 0,(0,I.jsx)("span",{style:H.title,children:p}),(0,I.jsxs)("div",{style:H.actionButtons,children:[y&&U?(0,I.jsx)(E().m,{renderTooltip:()=>R.formatMessage($.reRun),render:e=>(0,I.jsx)(F().A,{...e,icon:L().l,onClick:W,size:"md",ariaLabel:R.formatMessage($.reRun)})}):void 0,y&&U?(0,I.jsx)(E().m,{renderTooltip:()=>R.formatMessage($.editTrigger),render:e=>(0,I.jsx)(F().A,{...e,icon:N().s,onClick:Y,size:"md",ariaLabel:R.formatMessage($.editTrigger)})}):void 0]}),a?(0,I.jsx)(j().I,{icon:V().arrowChevronSingleRightIcon,colorVariant:"tertiary",size:"default",style:H.chevron}):void 0]}),h]})}var W=()=>n(203066),H=()=>n(153321);function G(e){const{origin:t,content:n,isExpanded:r,shouldSkipContentPadding:a,disableInitialAnimation:o,hideOrigin:i,contentId:s}=e,d=(0,l().IS)((()=>({container:{display:"flex",flexDirection:"column",minWidth:0}})),[]);return i&&n?(0,I.jsx)("div",{style:d.container,children:(0,I.jsx)("div",{children:n})}):n?(0,I.jsxs)("div",{style:d.container,children:[t,(0,I.jsx)(W().N,{children:r?(0,I.jsx)(H().P.div,{id:s,initial:!o&&{height:0,opacity:0},animate:{height:"auto",opacity:1},exit:{height:0,opacity:0},transition:{duration:.2,ease:"easeInOut"},style:{overflow:"hidden",padding:1,margin:-1},children:(0,I.jsx)("div",{style:{paddingTop:a?0:10},children:n})}):void 0})]}):(0,I.jsx)("div",{style:d.container,children:t})}const X=(0,g().YK)({taskTriggered:{id:"agentTrigger.taskTriggered",defaultMessage:"Task triggered"}});function Q(e){const{step:t,threadStore:a}=e,o=(0,g().tz)(),[i,d]=(0,r.useState)(!1),c=(0,r.useId)(),u=(0,r.useMemo)((()=>(0,U().getSpecificWorkflowTrigger)({workflowData:t.workflow,triggerId:t.triggerId})),[t.workflow,t.triggerId]),p=(0,r.useMemo)((()=>(0,U().getTriggerDefinitionBySpecificTrigger)(u)),[u]),m=(0,l().IS)((()=>({wrapper:{borderRadius:10,overflow:"hidden",boxShadow:f().Tj.shadow2XS,transition:"box-shadow 0.15s ease-in-out"},border:{height:1,backgroundColor:f().Tj.border.secondary},content:{paddingTop:0,paddingInlineEnd:12,paddingBottom:10,paddingInlineStart:12},titleContainer:{display:"flex",flexDirection:"column",gap:4,flex:1,minWidth:0,overflow:"hidden",maxWidth:400},titleText:{display:"flex",flexDirection:"row",overflow:"hidden",minWidth:0},triggerPill:{display:"flex",flexDirection:"row",alignItems:"center",gap:4,borderRadius:100,height:28,paddingInline:12,width:"fit-content",backgroundColor:f().Tj.background.tertiary,color:f().Tj.text.secondary},triggerPillLine:{height:15,width:1.5,backgroundColor:f().Tj.border.secondary,marginInlineStart:20}})),[]),h=(0,D().L)(),y=(0,s().K8)((()=>{if(!t.workflowId||!h)return;return{table:"workflow",id:t.workflowId,spaceId:h.id}}),[t.workflowId,h]),v=(0,r.useMemo)((()=>null!=p&&p.TriggerOrRunTitle&&u&&y?(0,I.jsx)(p.TriggerOrRunTitle,{trigger:u,data:t.data,moduleId:u.moduleId??"notion",workflowDefinitionPointer:y,titleContext:"trigger"}):o.formatMessage({defaultMessage:"Trigger",id:"agentTranscript.triggerStep.label"})),[p,u,o,t.data,y]),S=(0,s().K8)((()=>{var e;return null==a||null===(e=a.getData())||void 0===e?void 0:e.run_id}),[a]),x=(0,r.useMemo)((()=>{const e=(null==u?void 0:u.moduleId)??"notion";return t.data&&null!=p&&p.TriggerContent&&u&&y?(0,I.jsx)(p.TriggerContent,{trigger:u,data:t.data,moduleId:e,workflowDefinitionPointer:y,runId:S,workflowId:t.workflowId}):null}),[t.data,p,u,y,S,t.workflowId]);return(0,r.useEffect)((()=>{Boolean(x)&&d(!0)}),[x]),(0,I.jsxs)("div",{children:[(0,I.jsxs)("div",{style:m.triggerPill,children:[(0,I.jsx)(j().I,{icon:n(199483).o,size:"sm",colorVariant:"secondary"}),(0,I.jsx)(g().sA,{...X.taskTriggered})]}),(0,I.jsx)("div",{style:m.triggerPillLine}),(0,I.jsx)("div",{style:m.wrapper,children:(0,I.jsx)(G,{isExpanded:i,contentId:c,origin:(0,I.jsx)(Y,{isExpanded:i,canExpand:!1,onToggleExpanded:()=>d(!i),title:(0,I.jsx)("div",{style:m.titleContainer,children:(0,I.jsx)("div",{style:m.titleText,children:(0,I.jsx)(T().D,{styleKey:"bodyRegular",colorVariant:"secondary",textOverflow:"ellipsis",children:v})})}),icon:null==p?void 0:p.icon,triggerStep:t,threadStore:a,"aria-expanded":i,"aria-controls":c}),content:x?(0,I.jsxs)(I.Fragment,{children:[(0,I.jsx)("div",{style:m.border}),(0,I.jsx)("div",{style:m.content,children:x})]}):void 0,shouldSkipContentPadding:!0})})]})}var Z=()=>n(160432);const J=(0,g().YK)({maxIterationsReached:{id:"aiInferenceTranscript.maxIterationsReached.message",defaultMessage:"Agent paused after reaching maximum iterations"},continueButton:{id:"aiInferenceTranscript.maxIterationsReached.continue",defaultMessage:"Continue"}});function ee(e){const{threadStore:t,clientStore:a}=e,o=(0,i().v3)(),s=(0,l().IS)((()=>({wrapper:{boxShadow:f().Tj.shadow2XS,borderRadius:10,backgroundColor:f().Tj.background.elevated,padding:"10px 12px"}})),[]),c=(0,r.useCallback)((async()=>{await(0,n(140992).WE)({environment:o,clientStore:a,threadStore:t,analyticsArgs:{suggestedPrompt:{promptKey:"max_iterations.continue",promptDescription:"Continue agent execution after max iterations reached"}}})}),[o,a,t]);return(0,I.jsxs)(d().Y1,{direction:"horizontal",width:"fill",align:"center",style:s.wrapper,children:[(0,I.jsx)(d().Y1,{direction:"vertical",width:"fill",gap:2,children:(0,I.jsx)(T().D,{styleKey:"bodyMedium",colorVariant:"primary",children:(0,I.jsx)(g().sA,{...J.maxIterationsReached})})}),(0,I.jsx)(d().Y1,{direction:"horizontal",width:"hug",children:(0,I.jsx)(Z().A,{onClick:c,colorPalette:"blue",children:(0,I.jsx)(g().sA,{...J.continueButton})})})]})}function te(){const e=(0,l().IS)((()=>({container:{display:"flex",alignItems:"center",gap:8,paddingTop:8,paddingBottom:4,paddingInlineStart:8,paddingInlineEnd:8},link:{color:"inherit",textDecoration:"underline",cursor:"pointer"}})),[]);return(0,I.jsx)("div",{style:e.container,children:(0,I.jsxs)(T().D,{styleKey:"captionRegular",colorVariant:"secondary",children:["ðŸš§ The edit recap above is experimental. Try clicking the edits and share feedback in ",(0,I.jsx)("a",{href:"https://notion.enterprise.slack.com/archives/C09KKG5SVK3",target:"_blank",rel:"noopener noreferrer",style:e.link,children:"#proj-agent-diffs"}),"!"]})})}var ne=()=>n(440024),re=()=>n(975366);function ae(e){const{chatPartData:t,aiChatFeatureController:n,turnSteps:r,threadStore:a}=e;return(0,I.jsx)(d().Y1,{direction:"vertical",padding:"0 4px",children:(0,I.jsx)(re().h,{markdown:t.markdown,citationContext:t.citationContext,aiChatFeatureController:n,turnSteps:r,stepId:t.step.id,threadStore:a})})}var oe=()=>n(373009),ie=()=>n(944584),se=()=>n(675133),le=()=>n(849255),de=()=>n(798880),ce=()=>n(201980),ue=()=>n(555102),pe=()=>n(166442);var ge=()=>n(548527);function fe(e){const{partData:t,onFollowUpSelect:n,isLastTurn:a,threadId:o,threadStore:s}=e,l=(0,i().v3)(),[c,p]=(0,ge().P)(1),g=(0,r.useRef)(!1),f=t.followUps.length,m=t.step.traceId,h=(0,r.useCallback)(((e,r)=>{var a,i;const d=t.followUps[r],c=null===(a=d.metadata)||void 0===a?void 0:a.variant,p=null===(i=d.metadata)||void 0===i?void 0:i.option;if(ie().trackFollowUpButtonClicked({environment:l,threadId:o,aiInferenceId:m,followUpCount:f,followUpIndex:r,variant:c,option:p}),c&&p){if("daily_brief"===c)return void function(e){const{environment:t,threadStore:n,option:r}=e,a=n.getSpaceStore();if(!a)return;const o=t.currentUser.id;if(!o)return;const i=le().L.createChildStore(a,{table:de().oo,id:o}),s=se().A.getIntl(),{display:l,actual:d}=function(e,t){switch(e){case"good":return{display:t.formatMessage({id:"dailyBriefFeedback.userMessage.good",defaultMessage:"This brief was helpful."}),actual:"The user thanked you for a helpful daily brief. Tell them great, and that you hope to do the same tomorrow. BE CONCISE."};case"improve_accuracy":return{display:t.formatMessage({id:"dailyBriefFeedback.userMessage.improveAccuracy",defaultMessage:"This brief was inaccurate."}),actual:"The user said the info in the brief is not accurate. (1) Try fact checking to uncover your error (2) if you can't identify it, ask the user what the error is, and apologize. Once they respond, immediately update the daily brief prompt page by adding their feedback as bullet points (under the 'User Feedback' subheader). Tell them you've updated the page and will take their feedback into account for tomorrow's brief. Do NOT ask any additional follow-up questions after updating the page. BE CONCISE. Use short bullets for main asks."};case"improve_relevance":return{display:t.formatMessage({id:"dailyBriefFeedback.userMessage.improveRelevance",defaultMessage:"This brief was not relevant."}),actual:"The user said the info in the brief is not relevant to them. Ask them what projects, individuals, or topics they care about most (and if they have Slack connected, what channels are important). Once they respond, immediately update the daily brief prompt page by adding their preferences as bullet points (under the 'User Feedback' subheader). Tell them you've updated the page and will take their feedback into account for tomorrow's brief. Do NOT ask any additional follow-up questions after updating the page. BE CONCISE. Use short bullets for main asks."}}}(r,s),c=(0,ue().uP)({environment:t,spaceStore:a,userStore:i,displayMessage:(0,ce().x9d)(l),actualMessage:(0,ce().x9d)(d)});(0,_().addStepsToExistingThreadAndRun)({environment:t,clientStore:pe().defaultClientAIChatStore,userStore:i,spaceStore:a,threadStore:n,addSteps:[c],waitForServerCommit:!0,temporaryAiThreadManager:void 0})}({environment:l,threadStore:s,option:p});(0,u().HB)(c)}n(e)}),[l,o,m,f,n,s,t.followUps]),y=a&&f>0;return(0,r.useEffect)((()=>{if(y&&p&&!g.current){var e;g.current=!0;const n=null===(e=t.followUps.find((e=>{var t;return null===(t=e.metadata)||void 0===t?void 0:t.variant})))||void 0===e||null===(e=e.metadata)||void 0===e?void 0:e.variant;ie().trackFollowUpButtonsImpression({environment:l,threadId:o,aiInferenceId:m,followUpCount:f,variant:n})}}),[y,p,l,o,f,m,t.followUps]),y?(0,I.jsx)(d().Y1,{ref:c,direction:"vertical",gap:8,width:"fill",align:"center-left",children:t.followUps.map(((e,n)=>(0,I.jsx)(me,{followUp:e,index:n,onSelect:h},`${t.key}-${n}`)))}):null}const me=(0,r.memo)((function(e){const{followUp:t,onSelect:n,index:a}=e,{bodyStyleKey:o}=(0,k().yq)(),i=(0,r.useCallback)((()=>{n(t.message,a)}),[n,t.message,a]);return(0,I.jsx)(oe().E,{onClick:i,children:(0,I.jsx)(T().D,{styleKey:o,colorVariant:"primary",textOverflow:"ellipsis",children:t.label})})}));var he=()=>n(155382),ye=()=>n(94522),ve=()=>n(78620),Se=()=>n(383894),xe=(n(16280),()=>n(800204)),be=()=>n(68169),Ie=()=>n(506391),we=()=>n(671593),Me=()=>n(638681),je=()=>n(640182),Ce=()=>n(449851),Te=()=>n(423493);function ke(e){for(const t of je().zP){const n=je().JN[t];for(const r of n.effectsArray)if(r===e)return t}throw new Error(`Did not find effect key ${e} in any module`)}function Ae(e){const t=ke(e),n=Te().y[t].effect[e];if(!n)throw new Error(`Did not find effect definition for ${e}`);return n}const Re=["pageDiscussions","discussion"];function De({intl:e,state:t,numResults:n,toolName:r,toolResultStep:a,isMultiDatabaseMode:o,includeToolNoun:i,isReferencingContextPage:s,isLastStep:l,titleStore:d}){switch(r){case"search":switch(t){case"loading":case"reverted":return e.formatMessage({id:"AgentInferenceStepRenderer.search.loading.withQuery",defaultMessage:"Searching"});case"done":return e.formatMessage({id:"AgentInferenceStepRenderer.search.done",defaultMessage:"Searched"})}break;case"queryCalendar":switch(t){case"loading":case"reverted":return e.formatMessage({id:"AgentInferenceStepRenderer.queryCalendar.loading",defaultMessage:"Searching calendar"});case"done":return e.formatMessage({id:"AgentInferenceStepRenderer.queryCalendar.done",defaultMessage:"Searched calendar"})}break;case"queryMail":switch(t){case"loading":case"reverted":return e.formatMessage({id:"AgentInferenceStepRenderer.queryMail.loading",defaultMessage:"Searching email"});case"done":return e.formatMessage({id:"AgentInferenceStepRenderer.queryMail.done",defaultMessage:"Searched email"})}break;case"view":switch(t){case"loading":case"reverted":return e.formatMessage({id:"AgentInferenceStepRenderer.view.loading",defaultMessage:"Viewing"});case"done":if(a&&(0,c().gY)(a,"view")){var p;const t=(null===(p=a.result)||void 0===p?void 0:p.entities)??[];if(t.length>0&&t.some((e=>Re.includes(e.type))))return void 0===d?e.formatMessage({id:"AgentInferenceStepRenderer.view.done.viewedCommentsNoPageSpecified",defaultMessage:"Viewed comments"}):e.formatMessage({id:"AgentInferenceStepRenderer.view.done.viewedCommentsForPage",defaultMessage:"Viewed comments in"});if(t.length<=1)return 1===t.length&&"webpage"===t[0].type?e.formatMessage({id:"AgentInferenceStepRenderer.view.done.singleWebpage",defaultMessage:"Viewed {website}"},{website:(0,Ie().Wo)(t[0].url)}):e.formatMessage({id:"AgentInferenceStepRenderer.view.done",defaultMessage:"Viewed"});const n=new Map;for(const e of t){let t=e.type;"collection"!==t&&"database"!==t||(t="database"),n.set(t,(n.get(t)??0)+1)}if(1!==n.size)return e.formatMessage({id:"AgentInferenceStepRenderer.view.doneMultiple.items",defaultMessage:"Viewed {count} items"},{count:t.length});{const[r,a]=Array.from(n.entries())[0];switch(r){case"page":return e.formatMessage({id:"AgentInferenceStepRenderer.view.doneMultiple.pages",defaultMessage:"Viewed {count} pages"},{count:a});case"database":return e.formatMessage({id:"AgentInferenceStepRenderer.view.doneMultiple.databases",defaultMessage:"Viewed {count} databases"},{count:a});case"user":return e.formatMessage({id:"AgentInferenceStepRenderer.view.doneMultiple.users",defaultMessage:"Viewed {count} users"},{count:a});case"file":return e.formatMessage({id:"AgentInferenceStepRenderer.view.doneMultiple.files",defaultMessage:"Viewed {count} files"},{count:a});case"webpage":return e.formatMessage({id:"AgentInferenceStepRenderer.view.doneMultiple.websites",defaultMessage:"Viewed {count} websites"},{count:a});case"snapshot":return e.formatMessage({id:"AgentInferenceStepRenderer.view.doneMultiple.snapshots",defaultMessage:"Viewed {count} versions"},{count:a});default:return e.formatMessage({id:"AgentInferenceStepRenderer.view.doneMultiple.unknownType",defaultMessage:"Viewed {count} items"},{count:t.length})}}}return e.formatMessage({id:"AgentInferenceStepRenderer.view.done",defaultMessage:"Viewed"})}break;case"view-version-history":switch(t){case"loading":case"reverted":return e.formatMessage({id:"AgentInferenceStepRenderer.viewVersionHistory.loading",defaultMessage:"Viewing version history"});case"done":if(a&&(0,c().gY)(a,"view-version-history")){var f;const t=(null===(f=a.result)||void 0===f?void 0:f.entities)??[];if(t.length<=1)return e.formatMessage({id:"AgentInferenceStepRenderer.viewVersionHistory.done",defaultMessage:"Viewed version history"});const n=new Map;for(const e of t){const t=e.type;n.set(t,(n.get(t)??0)+1)}if(1!==n.size)return e.formatMessage({id:"AgentInferenceStepRenderer.viewVersionHistory.doneMultiple.items",defaultMessage:"Viewed {count} items' version histories"},{count:t.length});{const[r,a]=Array.from(n.entries())[0];switch(r){case"page":return e.formatMessage({id:"AgentInferenceStepRenderer.viewVersionHistory.doneMultiple.pages",defaultMessage:"Viewed {count} pages' version histories"},{count:a});case"database":return e.formatMessage({id:"AgentInferenceStepRenderer.viewVersionHistory.doneMultiple.databases",defaultMessage:"Viewed {count} databases' version histories"},{count:a});default:return e.formatMessage({id:"AgentInferenceStepRenderer.viewVersionHistory.doneMultiple.unknownType",defaultMessage:"Viewed {count} items' version histories"},{count:t.length})}}}return e.formatMessage({id:"AgentInferenceStepRenderer.viewVersionHistory.done",defaultMessage:"Viewed version history"})}break;case"view-notifications":switch(t){case"loading":case"reverted":return e.formatMessage({id:"AgentInferenceStepRenderer.viewNotifications.loading",defaultMessage:"Viewing notifications"});case"done":if(a&&(0,c().gY)(a,"view-notifications")){var m;const t=(null===(m=a.result)||void 0===m?void 0:m.notifications)??[];return t.length<=1?e.formatMessage({id:"AgentInferenceStepRenderer.viewNotifications.doneSingle",defaultMessage:"Viewed notification"}):e.formatMessage({id:"AgentInferenceStepRenderer.viewNotifications.doneMultiple",defaultMessage:"Viewed {count} notifications"},{count:t.length})}return e.formatMessage({id:"AgentInferenceStepRenderer.viewNotifications.doneFallback",defaultMessage:"Viewed notifications"})}break;case"view-database-files":switch(t){case"loading":case"reverted":return e.formatMessage({id:"AgentInferenceStepRenderer.viewDatabaseFiles.loading",defaultMessage:"Viewing code"});case"done":return e.formatMessage({id:"AgentInferenceStepRenderer.viewDatabaseFiles.done",defaultMessage:"Viewed code"})}break;case"create-database":switch(t){case"loading":return e.formatMessage({id:"AgentInferenceStepRenderer.createDatabase.loading",defaultMessage:"Creating database"});case"reverted":return e.formatMessage({id:"AgentInferenceStepRenderer.createDatabase.undone",defaultMessage:"Create database"});case"done":return i?e.formatMessage({id:"AgentInferenceStepRenderer.createDatabase.doneWithNoun",defaultMessage:"Created database"}):e.formatMessage({id:"AgentInferenceStepRenderer.createDatabase.done",defaultMessage:"Created"})}break;case"update-database":return"loading"===t?i?e.formatMessage({id:"AgentInferenceStepRenderer.updateDatabase.loadingWithNoun",defaultMessage:"Updating database"}):e.formatMessage({id:"AgentInferenceStepRenderer.updateDatabase.loading",defaultMessage:"Updating"}):"reverted"===t?e.formatMessage({id:"AgentInferenceStepRenderer.updateDatabase.undone",defaultMessage:"Update database"}):i?e.formatMessage({id:"AgentInferenceStepRenderer.updateDatabase.doneWithNoun",defaultMessage:"Updated database"}):e.formatMessage({id:"AgentInferenceStepRenderer.updateDatabase.done",defaultMessage:"Updated"});case"query-data-sources":{var h;const n=a&&(0,c().gY)(a,"query-data-sources")?(null===(h=a.result)||void 0===h?void 0:h.collectionIds)??[]:[];switch(t){case"loading":case"reverted":return n.length&&!i?e.formatMessage({id:"AgentInferenceStepRenderer.queryDataSources.loading.withSourceIncluded",defaultMessage:"Searching"}):o?e.formatMessage({id:"AgentInferenceStepRenderer.queryDataSources.loading",defaultMessage:"Searching data sources"}):e.formatMessage({id:"AgentInferenceStepRenderer.queryDatabases.loading",defaultMessage:"Searching databases"});case"done":return n.length&&!i?e.formatMessage({id:"AgentInferenceStepRenderer.queryDataSources.done.withSourceIncluded",defaultMessage:"Searched"}):o?e.formatMessage({id:"AgentInferenceStepRenderer.queryDataSources.done",defaultMessage:"Searched data sources"}):e.formatMessage({id:"AgentInferenceStepRenderer.queryDatabases.done",defaultMessage:"Searched databases"})}break}case"update-database-triggers":switch(t){case"loading":return e.formatMessage({id:"AgentInferenceStepRenderer.updateDatabaseTriggers.loading",defaultMessage:"Updating triggers"});case"reverted":return e.formatMessage({id:"AgentInferenceStepRenderer.updateDatabaseTriggers.undone",defaultMessage:"Update triggers"});case"done":return e.formatMessage({id:"AgentInferenceStepRenderer.updateDatabaseTriggers.done",defaultMessage:"Updated triggers"})}break;case"error":return e.formatMessage({id:"AgentInferenceStepRenderer.error",defaultMessage:"Error"});case"create-pages":switch(t){case"loading":return e.formatMessage({id:"AgentInferenceStepRenderer.createPages.loading",defaultMessage:"Creating pages"});case"reverted":return n<=1?e.formatMessage({id:"AgentInferenceStepRenderer.createPages.undone",defaultMessage:"Create page"}):e.formatMessage({id:"AgentInferenceStepRenderer.createPages.undonePlural",defaultMessage:"Create {numResults} pages"},{numResults:n});case"done":return i?e.formatMessage({id:"AgentInferenceStepRenderer.createPages.doneWithNoun",defaultMessage:(0,g().LS)("numResults",{one:"Created {numResults} page",other:"Created {numResults} pages"})},{numResults:n}):e.formatMessage({id:"AgentInferenceStepRenderer.createPages.done",defaultMessage:"Created"})}break;case"delete-pages":switch(t){case"loading":return e.formatMessage({id:"AgentInferenceStepRenderer.deletePage.loading",defaultMessage:"Deleting pages"});case"reverted":return n<=1?e.formatMessage({id:"AgentInferenceStepRenderer.deletePage.undone",defaultMessage:"Delete page"}):e.formatMessage({id:"AgentInferenceStepRenderer.deletePage.undonePlural",defaultMessage:"Delete {numResults} pages"},{numResults:n});case"done":return i?e.formatMessage({id:"AgentInferenceStepRenderer.deletePage.doneWithNoun",defaultMessage:(0,g().LS)("numResults",{one:"Deleted {numResults} page",other:"Deleted {numResults} pages"})},{numResults:n}):e.formatMessage({id:"AgentInferenceStepRenderer.deletePage.done",defaultMessage:"Deleted"})}break;case"update-page":case"update-page-v2":if(s)switch(t){case"loading":return e.formatMessage({id:"AgentInferenceStepRenderer.updatePage.loadingInstructions",defaultMessage:"Updating instructions"});case"reverted":return e.formatMessage({id:"AgentInferenceStepRenderer.updatePage.undoneInstructions",defaultMessage:"Update instructions"});case"done":return e.formatMessage({id:"AgentInferenceStepRenderer.updatePage.doneInstructions",defaultMessage:"Updated instructions"})}switch(t){case"loading":return i?e.formatMessage({id:"AgentInferenceStepRenderer.updatePage.loadingWithNoun",defaultMessage:"Updating page"}):e.formatMessage({id:"AgentInferenceStepRenderer.updatePage.loading",defaultMessage:"Updating"});case"reverted":return n<=1?e.formatMessage({id:"AgentInferenceStepRenderer.updatePage.undone",defaultMessage:"Update page"}):e.formatMessage({id:"AgentInferenceStepRenderer.updatePage.undonePlural",defaultMessage:"Update {numResults} pages"},{numResults:n});case"done":return i?e.formatMessage({id:"AgentInferenceStepRenderer.updatePage.doneWithNoun",defaultMessage:(0,g().LS)("numResults",{one:"Updated {numResults} page",other:"Updated {numResults} pages"})},{numResults:n}):e.formatMessage({id:"AgentInferenceStepRenderer.updatePage.done",defaultMessage:"Updated"})}break;case"update-database-data-sources":switch(t){case"loading":case"reverted":return o?e.formatMessage({id:"AgentInferenceStepRenderer.updateDataSources.loading",defaultMessage:"Updating data sources"}):e.formatMessage({id:"AgentInferenceStepRenderer.updateDatabases.loading",defaultMessage:"Updating databases"});case"done":return o?e.formatMessage({id:"AgentInferenceStepRenderer.updateDataSources.done",defaultMessage:"Updated data sources"}):e.formatMessage({id:"AgentInferenceStepRenderer.updateDatabases.done",defaultMessage:"Updated databases"})}break;case"update-database-views":switch(t){case"loading":case"reverted":return e.formatMessage({id:"AgentInferenceStepRenderer.updateViews.loading",defaultMessage:"Updating views"});case"done":return e.formatMessage({id:"AgentInferenceStepRenderer.updateViews.done",defaultMessage:"Updated views"})}break;case"result":switch(t){case"loading":case"reverted":return e.formatMessage({id:"AgentInferenceStepRenderer.asyncSuccess.loading",defaultMessage:"Finishing task"});case"done":return e.formatMessage({id:"AgentInferenceStepRenderer.asyncSuccess.done",defaultMessage:"Finished task"})}break;default:if((0,xe().og)(r))return function(e,{intl:t,isLoading:n,toolResultStep:r}){return Ae(e).getDescription({intl:t,isLoading:n,toolResultStep:r})}(r,{intl:e,isLoading:"loading"===t,toolResultStep:a});if("update-user-integrations"===r)switch(t){case"loading":case"reverted":return e.formatMessage({id:"AgentInferenceStepRenderer.updateIntegrations.loading",defaultMessage:"Updating integrations"});case"done":return e.formatMessage({id:"AgentInferenceStepRenderer.updateIntegrations.done",defaultMessage:"Updated integrations"})}else if("list-machines"===r)switch(t){case"loading":case"reverted":return e.formatMessage({id:"AgentInferenceStepRenderer.listMachines.loading",defaultMessage:"Listing machines"});case"done":return e.formatMessage({id:"AgentInferenceStepRenderer.listMachines.done",defaultMessage:"Listed machines"})}else if("create-machine"===r)switch(t){case"loading":case"reverted":return e.formatMessage({id:"AgentInferenceStepRenderer.createMachine.loading",defaultMessage:"Creating machine"});case"done":return e.formatMessage({id:"AgentInferenceStepRenderer.createMachine.done",defaultMessage:"Created machine"})}else if("destroy-machine"===r)switch(t){case"loading":case"reverted":return e.formatMessage({id:"AgentInferenceStepRenderer.destroyMachine.loading",defaultMessage:"Destroying machine"});case"done":return e.formatMessage({id:"AgentInferenceStepRenderer.destroyMachine.done",defaultMessage:"Destroyed machine"})}else if("terminal"===r)switch(t){case"loading":return e.formatMessage({id:"AgentInferenceStepRenderer.terminal.loading",defaultMessage:"Running terminal command"});case"reverted":return e.formatMessage({id:"AgentInferenceStepRenderer.terminal.reverted",defaultMessage:"Reverted terminal command"});case"done":return e.formatMessage({id:"AgentInferenceStepRenderer.terminal.done",defaultMessage:"Ran terminal command"})}else if("browser"===r)switch(t){case"loading":return e.formatMessage({id:"AgentInferenceStepRenderer.browser.loading",defaultMessage:"Running browser actions"});case"reverted":return e.formatMessage({id:"AgentInferenceStepRenderer.browser.reverted",defaultMessage:"Reverted browser actions"});case"done":return e.formatMessage({id:"AgentInferenceStepRenderer.browser.done",defaultMessage:"Ran browser actions"})}else if("toggle-user-integration-tools"===r){if(a&&(0,c().gY)(a,"toggle-user-integration-tools"))return function(e){const{intl:t,state:n,toolResultStep:r}=e;if(!r||!(0,c().gY)(r,"toggle-user-integration-tools"))return"loading"===n?t.formatMessage({id:"AgentInferenceStepRenderer.updateIntegrations.loading",defaultMessage:"Updating integrations"}):t.formatMessage({id:"AgentInferenceStepRenderer.updateIntegrations.done",defaultMessage:"Updated integrations"});const a=r.result,o=(e,t)=>!(!e||!e.toLowerCase().includes("mail")&&!e.toLowerCase().includes("calendar")&&"Notion Mail"!==e&&"Notion Calendar"!==e)||!(!t||!(t.includes("mail")||t.includes("calendar")||t.includes(":6010")||t.includes(":5001"))),i=e=>{var t;if(!e||null===(t=r.threadRecordMap)||void 0===t||!t.recordMap)return[];const n=[],a=r.threadRecordMap.recordMap;for(const r of e){if(!Pe(r))continue;const e=a.workflow_module;if(!e)continue;const t=e[r.id];if(!t)continue;let i,s=!1;if(Ve(t)){const e=t.value.data;e&&(i=e.name||e.serverUrl,s=o(e.name,e.serverUrl))}else if(Le(t)){const e=t.data;e&&(i=e.name||e.serverUrl,s=o(e.name,e.serverUrl))}s||i&&n.push(i)}return n},s=null==a?void 0:a.activeIntegrationPointers,l=null==a?void 0:a.inactiveIntegrationPointers,d=e=>{var t;if(!e||null===(t=r.threadRecordMap)||void 0===t||!t.recordMap)return 0;let n=0;const a=r.threadRecordMap.recordMap;for(const r of e){if(!Pe(r))continue;const e=a.workflow_module;if(!e)continue;const t=e[r.id];if(!t)continue;let i=!1;if(Ve(t)){const e=t.value.data;e&&(i=o(e.name,e.serverUrl))}else if(Le(t)){const e=t.data;e&&(i=o(e.name,e.serverUrl))}i||n++}return n},p=d(s),g=d(l),f=i(s),m=i(l),h=e=>0===e.length?"":1===e.length?e[0]:2===e.length?`${e[0]} and ${e[1]}`:`${e.slice(0,-1).join(", ")}, and ${e[e.length-1]}`;let y="";if((0,u().O9)(p)&&p>0){const e=h(f);y=e?"loading"===n?t.formatMessage({defaultMessage:"{numberOfIntegrations, plural, one {Activating {integrationNames} integration} other {Activating {integrationNames} integrations}}",id:"AgentInferenceStepRenderer.activateIntegrationsWithNames.loading"},{numberOfIntegrations:p,integrationNames:e}):t.formatMessage({defaultMessage:"{numberOfIntegrations, plural, one {Activated {integrationNames} integration} other {Activated {integrationNames} integrations}}",id:"AgentInferenceStepRenderer.activateIntegrationsWithNames.done"},{numberOfIntegrations:p,integrationNames:e}):"loading"===n?t.formatMessage({defaultMessage:"{numberOfIntegrations, plural, one {Activating {numberOfIntegrations} integration} other {Activating {numberOfIntegrations} integrations}}",id:"AgentInferenceStepRenderer.activateIntegrations.loading"},{numberOfIntegrations:p}):t.formatMessage({defaultMessage:"{numberOfIntegrations, plural, one {Activated {numberOfIntegrations} integration} other {Activated {numberOfIntegrations} integrations}}",id:"AgentInferenceStepRenderer.activateIntegrations.done"},{numberOfIntegrations:p})}let v="";if((0,u().O9)(g)&&g>0){const e=h(m);v=e?"loading"===n?t.formatMessage({defaultMessage:"{numberOfIntegrations, plural, one {Deactivating {integrationNames} integration} other {Deactivating {integrationNames} integrations}}",id:"AgentInferenceStepRenderer.deactivateIntegrationsWithNames.loading"},{numberOfIntegrations:g,integrationNames:e}):t.formatMessage({defaultMessage:"{numberOfIntegrations, plural, one {Deactivated {integrationNames} integration} other {Deactivated {integrationNames} integrations}}",id:"AgentInferenceStepRenderer.deactivateIntegrationsWithNames.done"},{numberOfIntegrations:g,integrationNames:e}):"loading"===n?t.formatMessage({defaultMessage:"{numberOfIntegrations, plural, one {Deactivating {numberOfIntegrations} integration} other {Deactivating {numberOfIntegrations} integrations}}",id:"AgentInferenceStepRenderer.deactivateIntegrations.loading"},{numberOfIntegrations:g}):t.formatMessage({defaultMessage:"{numberOfIntegrations, plural, one {Deactivated {numberOfIntegrations} integration} other {Deactivated {numberOfIntegrations} integrations}}",id:"AgentInferenceStepRenderer.deactivateIntegrations.done"},{numberOfIntegrations:g})}if(y&&v)return t.formatList([y,v.toLocaleLowerCase()],{style:"long",type:"conjunction"});if(y)return y;if(v)return v;{var S,x;const e=(null==a||null===(S=a.activeIntegrationPointers)||void 0===S?void 0:S.length)||0,r=(null==a||null===(x=a.inactiveIntegrationPointers)||void 0===x?void 0:x.length)||0;return e>0||r>0?"":"loading"===n?t.formatMessage({id:"AgentInferenceStepRenderer.updateIntegrations.loading",defaultMessage:"Updating integrations"}):t.formatMessage({id:"AgentInferenceStepRenderer.updateIntegrations.done",defaultMessage:"Updated integrations"})}}({intl:e,state:t,toolResultStep:a});switch(t){case"loading":case"reverted":return e.formatMessage({id:"AgentInferenceStepRenderer.updateIntegrations.loading",defaultMessage:"Updating integrations"});case"done":return e.formatMessage({id:"AgentInferenceStepRenderer.updateIntegrations.done",defaultMessage:"Updated integrations"})}}else{if("enter-setup-mode"===r)return function(e){const{intl:t,state:n}=e;if("loading"===n)return t.formatMessage({id:"AgentInferenceStepRenderer.enterSetupMode.loading",defaultMessage:"Entering setup mode"});if("reverted"===n)return t.formatMessage({id:"AgentInferenceStepRenderer.enterSetupMode.reverted",defaultMessage:"Setup mode entry reverted"});return""}({intl:e,state:t});if("exit-setup-mode"===r)return function(e){const{intl:t,state:n}=e;if("loading"===n)return t.formatMessage({id:"AgentInferenceStepRenderer.exitSetupMode.loading",defaultMessage:"Exiting setup mode"});if("reverted"===n)return t.formatMessage({id:"AgentInferenceStepRenderer.exitSetupMode.reverted",defaultMessage:"Setup mode exit reverted"});return t.formatMessage({id:"AgentInferenceStepRenderer.exitSetupMode.done",defaultMessage:"Setup complete"})}({intl:e,state:t});if("edit-json"===r)throw new Error("edit-json tool should not be used in the UI");if("create-agent"===r||"create-agent-v2"===r)switch(t){case"loading":return e.formatMessage({id:"AgentInferenceStepRenderer.createAgent.loading",defaultMessage:"Creating agent"});case"reverted":return e.formatMessage({id:"AgentInferenceStepRenderer.createAgent.undone",defaultMessage:"Create agent"});case"done":return e.formatMessage({id:"AgentInferenceStepRenderer.createAgent.done",defaultMessage:"Created agent"})}else if("update-agent"===r||"update-agent-v2"===r)switch(t){case"loading":return e.formatMessage({id:"AgentInferenceStepRenderer.updateAgent.loading",defaultMessage:"Updating agent"});case"reverted":return e.formatMessage({id:"AgentInferenceStepRenderer.updateAgent.undone",defaultMessage:"Update agent"});case"done":return e.formatMessage({id:"AgentInferenceStepRenderer.updateAgent.done",defaultMessage:"Updated agent"})}else if("delete-agent"===r)switch(t){case"loading":return e.formatMessage({id:"AgentInferenceStepRenderer.deleteAgent.loading",defaultMessage:"Deleting agent"});case"reverted":return e.formatMessage({id:"AgentInferenceStepRenderer.deleteAgent.undone",defaultMessage:"Delete agent"});case"done":return e.formatMessage({id:"AgentInferenceStepRenderer.deleteAgent.done",defaultMessage:"Deleted agent"})}else if("query-salesforce-tool"===r){var y;if(a&&(0,c().gY)(a,"query-salesforce-tool"))if("runQuery"===(null==a||null===(y=a.result)||void 0===y?void 0:y.mode)&&a.result.query)return a.result.query;switch(t){case"loading":case"reverted":return e.formatMessage({id:"AgentInferenceStepRenderer.search.loading.withQuery",defaultMessage:"Searching"});case"done":return e.formatMessage({id:"AgentInferenceStepRenderer.search.done",defaultMessage:"Searched"})}}else if("view-channel"===r||"view-slack-channel"===r)switch(t){case"loading":case"reverted":return e.formatMessage({id:"AgentInferenceStepRenderer.view.channel.loading",defaultMessage:"Viewing channel"});case"done":return e.formatMessage({id:"AgentInferenceStepRenderer.view.channel.done",defaultMessage:"Viewed channel"})}else if("view-code-repo"===r)switch(t){case"loading":case"reverted":return e.formatMessage({id:"AgentInferenceStepRenderer.view.codeRepo.loading",defaultMessage:"Viewing code repo"});case"done":return e.formatMessage({id:"AgentInferenceStepRenderer.view.codeRepo.done",defaultMessage:"Viewed code repo"})}else if("summarize-meeting-note"===r)switch(t){case"loading":case"reverted":return e.formatMessage({id:"AgentInferenceStepRenderer.summarizeMeetingNote.loading",defaultMessage:"Summarizing meeting notes"});case"done":return e.formatMessage({id:"AgentInferenceStepRenderer.summarizeMeetingNote.done",defaultMessage:"Summarized meeting notes"})}else if("query-agent-threads"===r)switch(t){case"loading":case"reverted":return e.formatMessage({id:"AgentInferenceStepRenderer.queryAgentThreads.loading",defaultMessage:"Querying agent threads"});case"done":return e.formatMessage({id:"AgentInferenceStepRenderer.queryAgentThreads.done",defaultMessage:"Queried agent threads"})}else if("investigate-agent-thread"===r)switch(t){case"loading":case"reverted":return e.formatMessage({id:"AgentInferenceStepRenderer.investigateAgentThread.loading",defaultMessage:"Investigating agent thread"});case"done":return e.formatMessage({id:"AgentInferenceStepRenderer.investigateAgentThread.done",defaultMessage:"Investigated agent thread"})}else if("run-agent"===r){const n=function(e){var t,n,r;if(!e||!(0,c().gY)(e,"run-agent"))return;if(!function(e){var t,n;const r=null===(t=e.result)||void 0===t?void 0:t.workflowId;if(!r||r===be().Lj)return!0;return(0,xe().SZ)(null===(n=e.input)||void 0===n?void 0:n.agentUrl)}(e))return;const a=null===(t=e.input)||void 0===t?void 0:t.taskDescription;if(!a)return;const o=null===(n=a.progressive)||void 0===n?void 0:n.trim(),i=null===(r=a.past)||void 0===r?void 0:r.trim();if(!o||!i)return;return{progressive:o,past:i}}(a);if(n)return"done"===t?n.past:n.progressive;switch(t){case"loading":case"reverted":return e.formatMessage({id:"AgentInferenceStepRenderer.runAgent.loading",defaultMessage:"Running myself"});case"done":return e.formatMessage({id:"AgentInferenceStepRenderer.runAgent.done",defaultMessage:"Ran myself"})}}else if("runScript"===r)switch(t){case"loading":case"reverted":return e.formatMessage({id:"AgentInferenceStepRenderer.script.loading",defaultMessage:"Running script"});case"done":return e.formatMessage({id:"AgentInferenceStepRenderer.script.done",defaultMessage:"Ran script"})}else if("wait"===r){const n=e.formatMessage({id:"AgentInferenceStepRenderer.wait.loading",defaultMessage:"Waiting"});if(l)return n;switch(t){case"loading":case"reverted":return n;case"done":return e.formatMessage({id:"AgentInferenceStepRenderer.wait.done",defaultMessage:"Waited"})}}else{if("revert"===r)return"loading"===t||"reverted"===t?e.formatMessage({id:"AgentInferenceStepRenderer.revert.loading",defaultMessage:"Reverting"}):e.formatMessage({id:"AgentInferenceStepRenderer.revert.done",defaultMessage:"Reverted"});if("update-todos"===r)return"Update to-dos";if("callFunction"===r){var v;const e=a&&(0,c().gY)(a,"callFunction")?null===(v=a.result)||void 0===v?void 0:v.headerLabel:void 0;if(e){const t=(0,ce().q4_)(e).replaceAll(ce().Sj,"").trim();if(t.length>0)return t}return"Called function"}if("generate-image"===r)switch(t){case"loading":case"reverted":return e.formatMessage({id:"AgentInferenceStepRenderer.generateImage.loading",defaultMessage:"Generating image"});case"done":return e.formatMessage({id:"AgentInferenceStepRenderer.generateImage.done",defaultMessage:"Generated image"})}else if("escalate"===r)switch(t){case"loading":case"reverted":return e.formatMessage({id:"AgentInferenceStepRenderer.escalate.loading",defaultMessage:"Switching to full chat for a better answerâ€¦"});case"done":return e.formatMessage({id:"AgentInferenceStepRenderer.escalate.done",defaultMessage:"Switched to full chat for a better answerâ€¦"})}else(0,u().HB)(r)}}}}const Ue=Me().object({required:{table:Me().literal("workflow_module"),id:Me().string()},optional:{}});function Pe(e){return!!(0,we().Xj)(Ue,e)}const Be=Me().object({required:{},optional:{name:Me().string(),serverUrl:Me().string()}}),Fe=Me().object({required:{},optional:{data:Be,module_type:Me().string()}}),Ee=Me().object({required:{value:Fe},optional:{spaceId:Me().string()}});function Ve(e){return!!(0,we().Xj)(Ee,e)}function Le(e){return!!(0,we().Xj)(Fe,e)}function Ne({toolName:e,variant:t="default",toolResultStep:n}){const r=(0,g().tz)(),o=(0,a().X)("agent_multidb_creation");return(0,I.jsx)(Se().N,{icon:v().exclamationMarkCircleSmallIcon,variant:t,title:(0,I.jsx)(T().D,{styleKey:"bodyRegular",colorVariant:"secondary",children:(0,I.jsx)(g().sA,{id:"AgentToolError.message",defaultMessage:"Oops! Something went wrong while {toolName}",values:{toolName:(0,I.jsx)("span",{style:{textTransform:"lowercase"},children:De({toolName:e,state:"loading",numResults:1,intl:r,isMultiDatabaseMode:o,includeToolNoun:!0,toolResultStep:n})})}})})})}n(823215);var Oe=()=>n(758304),_e=()=>n(505121),Ke=()=>n(68528),ze=()=>n(396896);const qe=Me().union([Me().object({required:{data:Me().string(),mimeType:Me().string(),type:Me().literal("audio")},optional:{}}),Me().object({required:{data:Me().string(),mimeType:Me().string(),type:Me().literal("image")},optional:{}}),Me().object({required:{resource:Me().object({required:{uri:Me().string()},optional:{blob:Me().string(),mimeType:Me().string(),text:Me().string()}}),type:Me().literal("resource")},optional:{}}),Me().object({required:{text:Me().string(),type:Me().literal("text")},optional:{}}),Me().object({required:{type:Me().literal("resource_link"),uri:Me().string()},optional:{description:Me().string(),mimeType:Me().string(),name:Me().string()}})]);function $e(e){return(0,we().Qq)(qe,e)}var Ye=()=>n(27455);const We=(0,g().YK)({imageLoadError:{id:"mcpContent.imageLoadError",defaultMessage:"Unable to load image"},audioLoadError:{id:"mcpContent.audioLoadError",defaultMessage:"Unable to load audio"},binaryData:{id:"mcpContent.binaryData",defaultMessage:"Binary data ({size} bytes)"},showLess:{id:"mcpContent.showLess",defaultMessage:"Show less"},showAll:{id:"mcpContent.showAll",defaultMessage:"Show all data"}});function He(e){const{content:t}=e,[n,a]=(0,r.useState)(!1),o=`data:${t.mimeType};base64,${t.data}`,i=(0,l().IS)((()=>({audioContainer:{maxWidth:400},audioPlayer:{width:"100%",height:40,borderRadius:8}})),[]);return n?(0,I.jsx)(Ye().Zp,{padding:"sm",colorVariant:"secondary",children:(0,I.jsx)(T().D,{styleKey:"captionRegular",colorVariant:"tertiary",children:(0,I.jsx)(g().sA,{...We.audioLoadError})})}):(0,I.jsx)("div",{style:i.audioContainer,children:(0,I.jsx)("audio",{controls:!0,preload:"none",src:o,style:i.audioPlayer,onError:()=>a(!0)})})}var Ge=()=>n(35622),Xe=()=>n(79075),Qe=()=>n(738471);function Ze(e){const{content:t}=e,n=(0,i().v3)(),a=(0,r.useRef)(null),[o,s]=(0,r.useState)(!1),d=`data:${t.mimeType};base64,${t.data}`,c=(0,r.useCallback)((()=>{var e;const t=null===(e=a.current)||void 0===e?void 0:e.getImageDimensions();t&&Ge().o9({environment:n,renderFullScreenNode:()=>(0,I.jsx)(Xe().A,{url:d,error:void 0,imageNaturalHeight:t.naturalHeight,imageNaturalWidth:t.naturalWidth}),fullScreenNodeRect:t.clientRect,contentAspectRatio:t.naturalWidth/Math.max(t.naturalHeight,1)})}),[n,d]),u=(0,l().IS)((()=>({imageContainer:{maxWidth:400,overflow:"hidden"},image:{display:"block",width:"100%",cursor:"zoom-in"}})),[]);return o?(0,I.jsx)(Ye().Zp,{padding:"sm",colorVariant:"secondary",children:(0,I.jsx)(T().D,{styleKey:"captionRegular",colorVariant:"tertiary",children:(0,I.jsx)(g().sA,{...We.imageLoadError})})}):(0,I.jsx)("div",{style:u.imageContainer,children:(0,I.jsx)(Ye().Zp,{borderVariant:"secondary",borderRadius:"sm",children:(0,I.jsx)(Qe().A,{src:d,ref:a,onClick:c,style:u.image,placeholderStyle:u.image,alt:"MCP tool result image",onError:()=>s(!0)})})})}var Je=()=>n(796237),et=()=>n(426327);function tt(e){const{content:t,showFullData:n,onShowFullData:r}=e;let a=t.text;try{a=JSON.parse(t.text)}catch{}const o="object"==typeof a&&null!==a&&(Array.isArray(a)?a.length>100:Object.keys(a).length>100),i=(0,l().IS)((()=>({showAllButton:{marginTop:8}})),[]);return(0,I.jsxs)("div",{children:[(0,I.jsx)(_e().Z,{data:a,shouldExpandNode:(e,t,n)=>n<3,collectionLimit:n||!o?void 0:100}),o&&r?(0,I.jsx)(oe().E,{size:"xs",onClick:()=>r(!n),style:i.showAllButton,children:(0,I.jsx)(g().sA,{...n?We.showLess:We.showAll})}):null]})}function nt(e){const{content:t,showFullData:n,onShowFullData:r}=e,{resource:a}=t,o=void 0!==a.text,i=void 0!==a.blob,s={type:"text",text:a.text??""},d=(0,l().IS)((()=>({resourceHeader:{padding:"8px 12px",backgroundColor:f().Tj.background.secondary},resourceUri:{flex:1,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},resourceContent:{padding:12}})),[]);return(0,I.jsx)(Ye().Zp,{borderVariant:"secondary",borderRadius:"sm",children:(0,I.jsxs)(ze().VP,{children:[(0,I.jsx)("div",{style:d.resourceHeader,children:(0,I.jsxs)(ze().fI,{gap:8,alignItems:"center",children:[(0,I.jsx)(j().I,{icon:et().a,size:"sm",colorVariant:"secondary"}),(0,I.jsx)(T().D,{styleKey:"captionRegular",colorVariant:"secondary",style:d.resourceUri,children:a.uri}),a.mimeType?(0,I.jsx)(T().D,{styleKey:"captionRegular",colorVariant:"tertiary",children:a.mimeType}):null]})}),o?(0,I.jsx)("div",{style:d.resourceContent,children:(0,I.jsx)(tt,{content:s,showFullData:n,onShowFullData:r})}):i?(0,I.jsx)("div",{style:d.resourceContent,children:(0,I.jsx)(T().D,{styleKey:"captionRegular",colorVariant:"tertiary",children:(0,I.jsx)(g().sA,{...We.binaryData,values:{size:(0,Je().pI)(a.blob??"")}})})}):null]})})}var rt=()=>n(249046),at=()=>n(552712),ot=()=>n(8741);function it(e){const{content:t}=e,n=(0,l().IS)((()=>({resourceLinkInfo:{flex:1,overflow:"hidden"},resourceLinkButton:{display:"flex",alignItems:"center",justifyContent:"center",width:28,height:28,borderRadius:4,backgroundColor:f().Tj.background.secondary,textDecoration:"none"}})),[]);return(0,I.jsx)(Ye().Zp,{borderVariant:"secondary",borderRadius:"sm",padding:"sm",children:(0,I.jsxs)(ze().fI,{gap:8,alignItems:"flex-start",children:[(0,I.jsx)(j().I,{icon:et().a,size:"sm",colorVariant:"secondary"}),(0,I.jsxs)(rt().wt,{gap:2,style:n.resourceLinkInfo,children:[(0,I.jsx)(T().D,{styleKey:"bodyMedium",colorVariant:"primary",children:t.name??t.uri}),t.description?(0,I.jsx)(T().D,{styleKey:"captionRegular",colorVariant:"secondary",children:t.description}):null,t.mimeType?(0,I.jsx)(T().D,{styleKey:"captionRegular",colorVariant:"tertiary",children:t.mimeType}):null]}),(0,I.jsx)(at().N,{href:t.uri,external:!0,style:n.resourceLinkButton,children:(0,I.jsx)(j().I,{icon:ot().arrowDiagonalUpRightSmallIcon,size:"sm",colorVariant:"secondary"})})]})})}function st(e){const{output:t,showFullData:n=!1,onShowFullData:r}=e;if(!Array.isArray(t))return(0,I.jsx)(_e().Z,{data:t});const a=t.map((e=>$e(e))).filter((e=>void 0!==e));return 0===a.length?(0,I.jsx)(_e().Z,{data:t}):(0,I.jsx)(ze().VP,{gap:12,children:a.map(((e,t)=>(0,I.jsx)(lt,{item:e,showFullData:n,onShowFullData:r},`${e.type}-${t}`)))})}function lt(e){const{item:t,showFullData:n,onShowFullData:r}=e;switch(t.type){case"text":return(0,I.jsx)(tt,{content:t,showFullData:n,onShowFullData:r});case"image":return(0,I.jsx)(Ze,{content:t});case"audio":return(0,I.jsx)(He,{content:t});case"resource":return(0,I.jsx)(nt,{content:t,showFullData:n,onShowFullData:r});case"resource_link":return(0,I.jsx)(it,{content:t});default:return(0,I.jsx)(_e().Z,{data:t})}}const dt=["image","audio","resource","resource_link"];const ct=(0,g().YK)({inputTab:{id:"mcpTool.inputTab",defaultMessage:"Input"},responseTab:{id:"mcpTool.responseTab",defaultMessage:"Response"},noParameters:{id:"mcpTool.noParameters",defaultMessage:"No parameters"},rejectedByUser:{id:"mcpTool.rejectedByUser",defaultMessage:"Rejected by user"},waitingForResponse:{id:"mcpTool.waitingForResponse",defaultMessage:"Waiting for response..."},noResponse:{id:"mcpTool.noResponse",defaultMessage:"No response available"},waitingForConfirmation:{id:"mcpTool.waitingForConfirmation",defaultMessage:"Do you want to continue?"},cancel:{id:"mcpTool.cancel",defaultMessage:"Reject"},continue:{id:"mcpTool.continue",defaultMessage:"Continue"},headerFormat:{id:"mcpTool.headerFormat",defaultMessage:"{serverName}{separator}{toolName}"}});function ut(e){const{data:t,styles:n}=e;if(!function(e){return"object"==typeof e&&null!==e&&!Array.isArray(e)&&Object.values(e).every((e=>"string"==typeof e||"number"==typeof e||"boolean"==typeof e||null==e))}(t))return pt({data:t,styles:n});const a=Object.entries(t);return(0,I.jsx)("div",{style:n.twoColumnGrid,children:a.map((([e,t])=>(0,I.jsxs)(r.Fragment,{children:[(0,I.jsx)("div",{style:n.parameterName,children:e}),(0,I.jsx)("div",{style:n.parameterValue,children:null==t?"null":String(t)})]},e)))})}function pt(e){const{data:t,styles:n}=e;if(null==t)return(0,I.jsx)(T().D,{as:"span",colorVariant:"tertiary",children:"null"});if("string"==typeof t||"number"==typeof t||"boolean"==typeof t)return(0,I.jsx)(T().D,{as:"span",colorVariant:"primary",children:String(t)});if(Array.isArray(t))return(0,I.jsx)("div",{style:n.formattedArrayContainer,children:t.map(((e,t)=>(0,I.jsxs)("div",{style:n.formattedArrayItem,children:[(0,I.jsx)(T().D,{as:"span",colorVariant:"tertiary",children:`[${t}]`}),(0,I.jsx)("span",{style:n.formattedArrayValue,children:pt({data:e,styles:n})})]},t)))});if("object"==typeof t){const e=Object.entries(t);return(0,I.jsx)("div",{children:e.map((([e,t])=>(0,I.jsxs)("div",{style:n.formattedObjectItem,children:[(0,I.jsx)(T().D,{as:"span",colorVariant:"secondary",style:n.formattedObjectKey,children:`${e}:`}),(0,I.jsx)(T().D,{as:"span",colorVariant:"primary",style:n.formattedObjectValue,children:pt({data:t,styles:n})})]},e)))})}return(0,I.jsx)(_e().Z,{data:t})}function gt(e){const{serverName:t,toolName:a,input:o,output:i,state:s,error:d,isExpandable:c=!0,onToggle:p,serverIconUrl:m,serverUrl:h,showConfirmation:y="hide",onConfirm:v,onCancel:S,promptInjectionDetected:x}=e,b="hide"!==y,w="disabled"===y,M=(0,r.useMemo)((()=>function(e){return!!Array.isArray(e)&&e.some((e=>{const t=$e(e);return void 0!==t&&(0,u().Xk)(dt,t.type)}))}(i)),[i]),[C,A]=(0,r.useState)(!1),[R,D]=(0,r.useState)("input"),[U,P]=(0,r.useState)(!1),[B,F]=r.useState(!1);r.useEffect((()=>{(b||M)&&A(!0)}),[b,M]),r.useEffect((()=>{M&&D("response")}),[M]),r.useEffect((()=>{b||F(!1)}),[b]);const E=void 0!==i||void 0!==d;r.useEffect((()=>{E||"response"!==R||D("input")}),[E,R]);const V="error"===s&&d===xe().p9,L=c&&!b,N=function(e){const{isExpandable:t,isExpanded:n}=e,{bodyStyleKey:r}=(0,k().yq)(),a=(0,k().Cd)(r);return(0,l().IS)((()=>({header:{display:"flex",alignItems:"center",paddingTop:4,paddingInlineEnd:0,paddingBottom:4,paddingInlineStart:4,cursor:t?"pointer":"default",backgroundColor:"transparent",gap:8,userSelect:"none"},headerContent:{display:"flex",alignItems:"center",flex:1,gap:8,minWidth:0},headerText:{display:"flex",alignItems:"center",gap:8,minWidth:0,flexShrink:1},statusIndicator:{display:"flex",alignItems:"center",gap:8},chevron:{transform:n?"rotate(90deg)":void 0,transition:"transform 0.2s ease"},content:{borderRadius:10,overflow:"hidden",boxShadow:`0 0 0 1px ${f().Tj.border.secondary}, 0px 1px 2px rgba(0, 0, 0, 0.04)`,backgroundColor:f().Tj.background.primary,marginTop:8},tabs:{display:"flex",gap:8,marginTop:12,marginBottom:8,marginInlineStart:12},tab:{padding:"4px 12px",cursor:"pointer",transition:"all 0.15s ease",color:f().Tj.text.tertiary,fontSize:13,fontWeight:400,backgroundColor:"transparent",border:"none",borderRadius:6,outline:"none"},activeTab:{backgroundColor:f().Tj.background.secondary,color:f().Tj.text.primary},tabContent:{padding:"8px 16px 12px",maxHeight:400,overflowY:"auto",overflowX:"hidden"},loadingState:{display:"flex",alignItems:"center",justifyContent:"center",padding:40,color:f().Tj.text.tertiary},errorState:{padding:16,backgroundColor:f().Tj.red.background.secondaryTranslucent,borderInlineStart:`3px solid ${f().Tj.red.text.accentPrimary}`},rejectedState:{padding:16,backgroundColor:f().Tj.background.secondary,borderInlineStart:`3px solid ${f().Tj.text.secondary}`},showAllButton:{marginTop:8,padding:"4px 8px",fontSize:13,color:f().Tj.blue.text.accentPrimary,backgroundColor:f().Tj.blue.background.secondaryTranslucent,borderRadius:4,border:"none",cursor:"pointer"},confirmationFooter:{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"16px",borderTop:`1px solid ${f().Tj.border.secondary}`,backgroundColor:f().Tj.background.primary},confirmationButtons:{display:"flex",gap:8},twoColumnGrid:{display:"grid",gridTemplateColumns:"auto 1fr",gap:"8px 16px",alignItems:"baseline"},parameterName:{color:f().Tj.text.secondary,...a,textAlign:"end"},parameterValue:{color:f().Tj.text.primary,...a,fontFamily:"monospace",wordBreak:"break-word"},formattedArrayContainer:{paddingInlineStart:16},formattedArrayItem:{marginBlockEnd:4},formattedArrayValue:{marginInlineStart:8},formattedObjectItem:{marginBlockEnd:8},formattedObjectKey:{fontFamily:"monospace",fontSize:13},formattedObjectValue:{marginInlineStart:8,fontFamily:"monospace",fontSize:13},scrollingSquiggle:{opacity:.3}})),[t,n,a])}({isExpandable:L,isExpanded:C}),O=(0,r.useCallback)((()=>{F(!0),null==v||v()}),[v]),_=(0,r.useCallback)((()=>{if(L){const e=!C;A(e),null==p||p(e)}}),[C,L,p]),K=(0,r.useCallback)((e=>{D(e)}),[]),z=(0,r.useMemo)((()=>{switch(s){case"calling":case"called":default:return null;case"error":return V?{icon:n(995847).xMarkSmallIcon,color:f().Tj.text.secondary}:{icon:n(765974).exclamationMarkTriangleFillIcon,color:f().Tj.red.text.accentPrimary};case"waiting_approval":return{icon:n(274570).clockIcon,color:f().Tj.yellow.text.accentPrimary}}}),[s,V]);return(0,I.jsxs)("div",{children:[(0,I.jsxs)("div",{style:N.header,onClick:_,role:"button",tabIndex:L?0:void 0,"aria-expanded":C,onKeyDown:e=>{!L||"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),_())},children:[(0,I.jsxs)("div",{style:N.headerContent,children:[(0,I.jsx)(n(133532).X,{iconUrl:m,serverUrl:h,serverName:t,size:16}),(0,I.jsxs)("div",{style:N.headerText,children:[(0,I.jsx)(g().sA,{...ct.headerFormat,values:{serverName:(0,I.jsx)(T().D,{as:"span",styleKey:"bodyRegular",colorVariant:"secondary",children:t}),separator:(0,I.jsx)(T().D,{as:"span",styleKey:"bodyRegular",colorVariant:"tertiary",children:" / "}),toolName:(0,I.jsx)(T().D,{as:"span",styleKey:"bodyMedium",colorVariant:"primary",children:a})}}),L?(0,I.jsx)(j().I,{icon:n(906380).arrowChevronSingleRightSmallIcon,size:"sm",colorVariant:"secondary",style:N.chevron}):void 0]}),x?(0,I.jsx)(Ke().R,{}):void 0]}),(0,I.jsxs)("div",{style:N.statusIndicator,children:["calling"===s?(0,I.jsx)(q().ScrollingSquiggle,{style:N.scrollingSquiggle}):void 0,z&&C&&(!b||B)?z.icon({width:16,height:16,fill:z.color}):void 0]})]}),C?(0,I.jsxs)("div",{style:N.content,children:[(0,I.jsxs)("div",{style:N.tabs,role:"tablist",children:[(0,I.jsx)("button",{role:"tab","aria-selected":"input"===R,"aria-controls":"mcp-tab-input",style:{...N.tab,..."input"===R?N.activeTab:{}},onClick:()=>K("input"),children:(0,I.jsx)(g().sA,{...ct.inputTab})}),E?(0,I.jsx)("button",{role:"tab","aria-selected":"response"===R,"aria-controls":"mcp-tab-response",style:{...N.tab,..."response"===R?N.activeTab:{}},onClick:()=>K("response"),children:(0,I.jsx)(g().sA,{...ct.responseTab})}):void 0]}),(0,I.jsxs)("div",{style:N.tabContent,children:["input"===R?(0,I.jsx)("div",{id:"mcp-tab-input",role:"tabpanel","aria-labelledby":"mcp-input-tab",children:($=o,null==$||(Array.isArray($)?0===$.length:"object"==typeof $&&0===Object.keys($).length)?(0,I.jsx)("div",{style:N.loadingState,children:(0,I.jsx)(T().D,{styleKey:"captionRegular",colorVariant:"tertiary",children:(0,I.jsx)(g().sA,{...ct.noParameters})})}):ut({data:o,styles:N}))}):void 0,"response"===R?(0,I.jsx)("div",{id:"mcp-tab-response",role:"tabpanel","aria-labelledby":"mcp-response-tab",children:"error"===s&&d?V?(0,I.jsx)("div",{style:N.rejectedState,children:(0,I.jsx)(T().D,{styleKey:"bodyRegular",colorVariant:"secondary",children:(0,I.jsx)(g().sA,{...ct.rejectedByUser})})}):(0,I.jsx)("div",{style:N.errorState,children:(0,I.jsx)(T().D,{styleKey:"bodyRegular",colorPalette:"red",colorVariant:"accentPrimary",children:d})}):void 0!==i?(0,I.jsx)(st,{output:i,showFullData:U,onShowFullData:P}):"calling"===s?(0,I.jsxs)("div",{style:N.loadingState,children:[(0,I.jsx)(n(98126).k,{size:"default"}),(0,I.jsx)(T().D,{styleKey:"captionRegular",colorVariant:"tertiary",style:{marginInlineStart:8},children:(0,I.jsx)(g().sA,{...ct.waitingForResponse})})]}):(0,I.jsx)("div",{style:N.loadingState,children:(0,I.jsx)(T().D,{styleKey:"captionRegular",colorVariant:"tertiary",children:(0,I.jsx)(g().sA,{...ct.noResponse})})})}):void 0]}),b&&!B&&v&&S?(0,I.jsxs)("div",{style:N.confirmationFooter,children:[(0,I.jsx)(Oe().N,{styleKey:"bodyRegular",colorVariant:"secondary",text:(0,I.jsx)(g().sA,{...ct.waitingForConfirmation}),animate:!0}),(0,I.jsxs)("div",{style:N.confirmationButtons,children:[(0,I.jsx)(oe().E,{onClick:S,disabled:w,children:(0,I.jsx)(g().sA,{...ct.cancel})}),(0,I.jsx)(Z().A,{colorPalette:"blue",onClick:O,disabled:w,isLoading:w,children:(0,I.jsx)(g().sA,{...ct.continue})})]})]}):void 0]}):void 0]});var $}const ft=r.memo((function(e){var t;const{mcpToolUsePartData:n,threadStore:a,runningInference:o,aiChatFeatureController:s,turnSteps:d,onExpandedChange:c}=e,u=(0,i().v3)(),{confirmToolUse:g,rejectToolUse:h,showDebug:y}=(0,ve().Mp)(),{serverName:v,mcpToolName:S,toolUse:x,toolResultStep:b}=n,w=(0,r.useMemo)((()=>{const e={isCalling:!1};if(!x)return e;for(const t of d)"workflow-effect-calling"===t.type?(e.callingStep=t,e.isCalling=!0):"workflow-effect-called"===t.type?(e.calledStep=t,e.isCalling=!1):"workflow-effect-error"===t.type&&(e.errorStep=t,e.isCalling=!1);return e}),[x,d]),M=(0,r.useCallback)((e=>{ie().trackToggleToolCard({environment:u,stepId:n.step.id,showResults:e,from:"mcp_tool_card",toolCardType:"mcpServer.runTool",workflowId:(0,ye().i4)(a)}),null==c||c(e)}),[u,n.step.id,a,c]),j=b&&(0,p().I6)(b),C=o&&(!b||!(0,p().nP)(b))&&!j,[T,k]=(0,r.useState)(!1),A=(0,r.useCallback)((()=>{null!=b&&b.id&&(k(!0),g([b.id]))}),[g,null==b?void 0:b.id]),R=(0,r.useCallback)((()=>{null!=b&&b.id&&h([b.id])}),[h,null==b?void 0:b.id]);(0,r.useEffect)((()=>{j||k(!1)}),[j]);const D=(0,l().IS)((()=>({debugContainer:{background:f().Tj.yellow.background.primary,padding:8,marginBottom:8,borderRadius:4},debugCode:{fontSize:10}})),[]);if(!x||b&&(0,he().eb)(b))return(0,I.jsx)(Ne,{toolName:"mcpServer.runTool",toolResultStep:b,variant:"agent_mobile"===s.aiChatType?"large":"default"});const{callingStep:U,calledStep:P,errorStep:B,isCalling:F}=w,E=(null==U?void 0:U.toolName)||(null==P?void 0:P.toolName)||(null==B?void 0:B.toolName)||S;let V,L=null==b||null===(t=b.result)||void 0===t?void 0:t.content,N=null==b?void 0:b.error;B?(V="error",N=N||B.error):F||T||C&&(null==b||!b.result)?V="calling":j?(V="waiting_approval",null!=P&&P.output&&(L=P.output.content??P.output)):P?(V="called",P.output&&(L=P.output.content??P.output)):V=null!=b&&b.error?"error":"called";const{serverIconUrl:O,serverUrl:_}=(null==b?void 0:b.moduleInfo)||{};let K="hide";"waiting_approval"!==V||T||(K=o?"disabled":"show");const z={runningInference:o,toolRunning:C,isCalling:F,hasUserConfirmed:T,isWaitingForConfirmation:Boolean(j),currentState:V,confirmationState:K,hasCallingStep:Boolean(U),hasCalledStep:Boolean(P),hasErrorStep:Boolean(B),toolResultStepState:null==b?void 0:b.state,toolResultStepId:null==b?void 0:b.id};return(0,I.jsxs)(I.Fragment,{children:[!0===y?(0,I.jsx)("div",{style:D.debugContainer,children:(0,I.jsx)(m().O,{value:JSON.stringify(z,null,2),language:"json",styles:D.debugCode})}):void 0,(0,I.jsx)(gt,{serverName:v,toolName:E,input:(null==U?void 0:U.input)||(null==b?void 0:b.input),output:L,state:V,error:N,promptInjectionDetected:Boolean(null==b?void 0:b.promptInjectionDetected),isExpandable:!0,onToggle:M,serverIconUrl:O,serverUrl:_,showConfirmation:K,onConfirm:A,onCancel:R})]})}));var mt=()=>n(205557);const ht=(0,g().YK)({thinking:{id:"aiInferenceTranscript.thinkingStepTitle.pending",defaultMessage:"Thinking..."}});var yt=()=>n(718827),vt=()=>n(265060);const St=(0,S().xh)("arrowChevronSingleRight",{default:{loader:()=>n.e(30313).then(n.bind(n,222334))},small:{loader:()=>n.e(30313).then(n.bind(n,906380))},fill:{loader:()=>n.e(30313).then(n.bind(n,944924))},fillSmall:{loader:()=>n.e(30313).then(n.bind(n,158115))}},["chevron","right","arrow","direction","forward"]);function xt({icon:e,title:t,content:n,isExpandable:a,isExpandedOverride:i,onExpandedChange:s,onNonExpandableClick:c,toolRunning:u,variant:p="default",hideOrigin:g,hideIcon:m=!1,statusIcon:h}){const[y,v]=(0,r.useState)(i??!1),[S,x]=(0,r.useState)(!1),b=(0,r.useId)(),{bodyStyleKey:w}=(0,k().yq)(),M=S?"primary":"secondary",C=(0,r.useMemo)((()=>u?(0,I.jsx)(q().ScrollingSquiggle,{style:{opacity:.3}}):e),[u,e]),A=(0,r.useCallback)((()=>{v((e=>{const t=!e;return null==s||s(t),t}))}),[s]);(0,r.useEffect)((()=>{void 0!==i&&(v(i),null==s||s(i))}),[i,s]);const R=(0,l().IS)((()=>({expandedIndicator:{flexShrink:0,transition:"transform 0.15s ease-in-out",transform:y?"rotate(90deg)":"rotate(0deg)",fill:f().Tj.icon.tertiary},button:{width:"fit-content",maxWidth:"100%",borderRadius:6,overflow:"hidden"},buttonHovered:{background:"transparent"},buttonPressed:{background:"transparent"},titleText:{overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",flex:1,minWidth:0},statusIcon:{flexShrink:0}})),[y]),D=o().A.isMobile?{onTouchEnd:()=>x(!1),onTouchStart:()=>x(!0)}:{onMouseEnter:()=>x(!0),onMouseLeave:()=>x(!1)};return(0,I.jsx)(G,{isExpanded:!!a&&y,shouldSkipContentPadding:g,contentId:a?b:void 0,origin:g?void 0:a||c?(0,I.jsx)(yt().Ay,{onClick:a?A:c,style:R.button,hoveredStyle:R.buttonHovered,pressedStyle:R.buttonPressed,"aria-expanded":a?y:void 0,"aria-controls":a?b:void 0,...D,children:(0,I.jsx)(Se().N,{icon:C,colorVariant:M,variant:p,hideIcon:m,title:a?(0,I.jsxs)(d().Y1,{direction:"horizontal",align:"center",gap:4,children:[(0,I.jsx)(T().D,{styleKey:w,style:R.titleText,children:t}),h?(0,I.jsx)(j().I,{icon:h,size:"large"===p?"default":"sm",colorVariant:M,style:R.statusIcon}):null,(0,I.jsx)(vt().Q,{iconGroup:St,colorVariant:S?"primary":"secondary",variantName:"large"===p?"default":"small",style:R.expandedIndicator})]}):(0,I.jsxs)(d().Y1,{direction:"horizontal",align:"center",gap:4,children:[t,h?(0,I.jsx)(j().I,{icon:h,size:"large"===p?"default":"sm",colorVariant:M,style:R.statusIcon}):null]})})}):(0,I.jsx)("div",{style:R.button,children:(0,I.jsx)(Se().N,{icon:C,colorVariant:M,hideIcon:m,title:t})}),content:n})}n(908872);function bt(e){if(!e)return"";const t={};let n=0;const r=e.replace(/\[([^\]]*)\]\(([^)]*)\)/g,(e=>{const r=`__LINK_PLACEHOLDER_${n++}__`;return t[r]=e,r})).replace(/\[\^([^\]]*)\]/g,(e=>{const r=`__CITATION_PLACEHOLDER_${n++}__`;return t[r]=e,r})).replace(/{{(\^?)([^{}]+)}}/g,((e,t,n)=>`[^${n}]`));return Object.entries(t).reduce(((e,[t,n])=>e.replace(t,n)),r)}function It(e){const{content:t,paddingInlineStart:n=32,isExpanded:a=!0}=e,{bodyStyleKey:o}=(0,k().yq)(),[i,s]=(0,r.useState)(!1),[d,c]=(0,r.useState)(!1),u=(0,r.useRef)(null),p=(0,l().IS)((()=>({container:{position:"relative",maxHeight:175,paddingInlineStart:n},scrollContainer:{overflowY:"auto",maxHeight:"inherit",maskImage:`linear-gradient(to bottom,\n\t\t\t\t\t\t${i?"transparent 0px":"black 0px"},\n\t\t\t\t\t\tblack 24px,\n\t\t\t\t\t\tblack calc(100% - 24px),\n\t\t\t\t\t\t${d?"transparent 100%":"black 100%"}),\n\t\t\t\t\t\tlinear-gradient(black, black)`,maskSize:"calc(100% - 16px) 100%, 16px 100%",maskPosition:"0 0, 100% 0",maskRepeat:"no-repeat, no-repeat",WebkitMaskImage:`linear-gradient(to bottom,\n\t\t\t\t\t\t${i?"transparent 0px":"black 0px"},\n\t\t\t\t\t\tblack 24px,\n\t\t\t\t\t\tblack calc(100% - 24px),\n\t\t\t\t\t\t${d?"transparent 100%":"black 100%"}),\n\t\t\t\t\t\tlinear-gradient(black, black)`,WebkitMaskSize:"calc(100% - 16px) 100%, 16px 100%",WebkitMaskPosition:"0 0, 100% 0",WebkitMaskRepeat:"no-repeat, no-repeat"}})),[i,d,n]),g=(0,r.useCallback)((()=>{const e=u.current;if(!e)return;const{scrollTop:t,scrollHeight:n,clientHeight:r}=e,a=n>r,o=n-t-r<=0;s(a&&!(t<=0)),c(a&&!o)}),[]);return(0,r.useEffect)((()=>{const e=u.current;if(e)return g(),e.addEventListener("scroll",g,{passive:!0}),()=>{e.removeEventListener("scroll",g)}}),[g,a]),(0,r.useEffect)((()=>{const e=u.current;if(!e)return;const t=e.scrollHeight-e.scrollTop-e.clientHeight<=100;requestAnimationFrame((()=>{t&&(e.scrollTop=e.scrollHeight),g()}))}),[t,g]),(0,I.jsx)("div",{style:p.container,children:(0,I.jsx)("div",{style:p.scrollContainer,ref:u,children:(0,I.jsx)(T().D,{styleKey:o,colorVariant:"secondary",children:(0,I.jsx)(re().h,{markdown:bt(t??"")})})})})}function wt(e){const{thinkingPartData:t,aiChatFeatureController:n,runningInference:a,onExpandedChange:o,hideIcon:i=!1}=e,s=(0,g().tz)(),d=(0,l().eP)(),c=(0,f().O4)({theme:d}),{content:u,isLastThinkingPart:p}=t,m=p&&a,[h,y]=(0,r.useState)(!1),v=(0,r.useCallback)((e=>{y(e),null==o||o(e)}),[o]),S=(0,r.useMemo)((()=>function(e,t){const n=t.formatMessage(ht.thinking);if(!e||0===e.length)return{title:n,isExpandedOverride:void 0};if(!e.slice(0,20).includes("*"))return{title:n,isExpandedOverride:!0};const r=/(?:^|\n)\s*\*\*([^*\n][^\n]*?)\*\*\s*(?:\n|$)/g;let a,o=null;for(;null!==(a=r.exec(e));)o=a[1].trim();return o?{title:o,isExpandedOverride:void 0}:{title:n,isExpandedOverride:void 0}}(u,s)),[u,s]),x=m?(0,I.jsx)(Oe().N,{styleKey:"bodyRegular",colorVariant:"secondary",animate:!0,text:S.title}):(0,I.jsx)(g().sA,{id:"AgentInferenceThinkingPart.thought",defaultMessage:"Thought"});return(0,I.jsx)(xt,{isExpandable:void 0!==u,isExpandedOverride:m&&S.isExpandedOverride,icon:m?(0,I.jsx)(q().ScrollingSquiggle,{strokeColor:c.text.tertiary}):mt().lightBulbBrightSmallIcon,title:x,hideIcon:i,onExpandedChange:v,content:(0,I.jsx)(It,{content:u,paddingInlineStart:i?0:32,isExpanded:h}),variant:"agent_mobile"===n.aiChatType?"large":"default"})}n(18107),n(967357);var Mt=()=>n(907258),jt=()=>n(611648),Ct=()=>n(295633),Tt=()=>n(732810),kt=()=>n(663639),At=()=>n(452004),Rt=()=>n(529099),Dt=()=>n(412237),Ut=()=>n(62616),Pt=()=>n(670371);const Bt={viewBox:"0 0 20 20",fittedViewBox:"4.64 2.4 10.71 15.2",svg:(0,I.jsx)("path",{d:"M6.175 2.4c-.842 0-1.525.683-1.525 1.525v.4c0 1.283.481 2.52 1.349 3.465L8.027 10l-2.028 2.21a5.13 5.13 0 0 0-1.35 3.465v.4c0 .842.684 1.525 1.526 1.525h7.65c.842 0 1.525-.683 1.525-1.525v-.4c0-1.283-.481-2.52-1.349-3.465L11.973 10l2.028-2.21a5.13 5.13 0 0 0 1.349-3.465v-.4c0-.842-.683-1.525-1.525-1.525zM5.9 3.925c0-.152.123-.275.275-.275h7.65c.152 0 .275.123.275.275v.4c0 .97-.364 1.905-1.02 2.62l-2.416 2.632a.625.625 0 0 0 0 .845l2.416 2.633c.62.676.98 1.548 1.017 2.46l-2.907-2.463a1.84 1.84 0 0 0-2.38 0l-2.907 2.464a3.88 3.88 0 0 1 1.017-2.46l2.415-2.633a.625.625 0 0 0 0-.846L6.92 6.945a3.88 3.88 0 0 1-1.02-2.62z"})},Ft=(0,S().wt)("hourglass",Bt,"default");var Et=()=>n(209089),Vt=()=>n(207207),Lt=()=>n(523389),Nt=()=>n(617668),Ot=()=>n(863330),_t=()=>n(259476),Kt=()=>n(637433),zt=()=>n(769145),qt=()=>n(179034),$t=()=>n(519831),Yt=()=>n(29554),Wt=()=>n(246766),Ht=()=>n(81068),Gt=()=>n(736847),Xt=()=>n(700500),Qt=()=>n(438632),Zt=()=>n(792071),Jt=()=>n(328876),en=()=>n(142748),tn=()=>n(728272);function nn(e){return e.map((e=>{const t=ce().uPN(e);if(!t||0===t.length)return e;if(!t.some((e=>ce().jIt(e)&&e.length>2||ce().muW(e)&&e.length>2)))return e;const n=ce().N8A(e),r=t.map((e=>ce().jIt(e)&&e.length>2?ce().ld4(e[1],void 0):ce().muW(e)&&e.length>2?ce().ETy({collectionId:e[1],spaceId:void 0,parentCvbId:void 0}):e));return ce().Ey_(n,r)}))}function rn(e){const{recordMap:t,operations:n}=e,r=new(tn().d),a=t.clone();return n.map((e=>e.pointer)).filter((e=>e.table===qt().ev)).forEach((e=>r.add(e))),(0,Jt().applyOperationsToRecordMap)({recordMap:a,operations:n,updateOnly:!1}),function(e){const{pointers:t,originalRecordMap:n,updatedRecordMap:r}=e;return{type:"block",diffs:t.map((e=>function(e){const{pointer:t,originalRecordMap:n,updatedRecordMap:r}=e;if(t.table!==qt().ev)return;const a=n.getModel(t),o=r.getModel(t),i=null==a?void 0:a.getProperties(),s=null==o?void 0:o.getProperties(),l=!!a&&(0,en()._n)(t,Zt().b4_.fromRecordMap(n)),d=!!o&&(0,en()._n)(t,Zt().b4_.fromRecordMap(r));if(a&&null!=i&&i.title&&!d)return{titleDiff:ce().ITd((0,Qt().hl)({before:i.title,after:[],insertionAnnotation:[ce().Ifu.Inserted],deletionAnnotation:[ce().Ifu.Deleted]}).diffValue),type:"delete",pointer:t,isPage:a.isNavigableBlock()};if((null==o?void 0:o.type)===Xt().xd.table&&!l)return{titleDiff:[],pointer:t,type:"create"};if((null==o?void 0:o.type)===Xt().xd.tableRow&&!l)return{titleDiff:[],pointer:t,type:"create"};if(null!=s&&s.title&&!l)return{titleDiff:ce().ITd((0,Qt().hl)({before:[],after:s.title,insertionAnnotation:[ce().Ifu.Inserted],deletionAnnotation:[ce().Ifu.Deleted]}).diffValue),pointer:t,type:"create"};if(l&&d&&null!=i&&i.title&&null!=s&&s.title&&!(0,x().n4)(nn(i.title),nn(s.title)))return{titleDiff:ce().ITd((0,Qt().hl)({before:nn(i.title),after:nn(s.title),insertionAnnotation:[ce().Ifu.Inserted],deletionAnnotation:[ce().Ifu.Deleted]}).diffValue),type:"update",pointer:t};if(a&&o&&l&&d&&a.type!==o.type)return{titleDiff:[],type:"update",pointer:t}}({pointer:e,originalRecordMap:n,updatedRecordMap:r}))).filter(u().O9)}}({pointers:Array.from(r),originalRecordMap:e.recordMap,updatedRecordMap:a})}var an=()=>n(158489),on=()=>n(584262),sn=()=>n(381175);function ln({toolName:e,operations:t}){const n={};for(const r of t){if(r.pointer.table!==$t().Vl)continue;const t=cn({toolName:e,operation:r});if(0===t.length)continue;const a=r.pointer.id;n[a]||(n[a]=[]),n[a].push(...t)}return n}const dn={"create-pages":!0,"delete-pages":!0,"create-database":!0};function cn({toolName:e,operation:t}){const n=[],r=dn[e]??!1;if("set"===t.command&&t.path.some((e=>"schema"===e)))n.push({agentAction:"create",propertySchema:t.args,hideBadge:r});else if("update"===t.command){const e=Object.values(t.args).map((e=>function(e){if("object"==typeof e&&null!==e&&"type"in e&&"name"in e)return e}(e))).filter(u().O9);t.path.some((e=>"deleted_schema"===e))?n.push(...e.map((e=>({agentAction:"delete",propertySchema:e,hideBadge:r})))):t.path.some((e=>"schema"===e))&&n.push(...e.map((e=>({agentAction:"update",propertySchema:e,hideBadge:r}))))}return n}var un=()=>n(284371),pn=()=>n(187820),gn=()=>n(16006),fn=()=>n(371229),mn=()=>n(535960),hn=()=>n(970236);const yn=20;function vn({menuListItemProps:e,title:t,icon:n,agentAction:r,disabled:a,hideActionBadge:o=!1,onMouseEnter:i,onMouseLeave:s,onClick:c,aiChatFeatureController:u,"aria-expanded":p,"aria-controls":g}){const f=(0,l().IS)((()=>({menuItem:{padding:"6px 8px",borderBottom:"none",borderColor:"transparent",marginTop:0,marginBottom:0}})),[]);return(0,I.jsx)("div",{onMouseEnter:i,onMouseLeave:s,style:{width:"100%"},children:(0,I.jsx)(Ht().A,{...e,style:f.menuItem,title:(0,I.jsxs)(d().Y1,{direction:"horizontal",gap:8,children:[(0,I.jsx)(T().D,{styleKey:"bodyRegular",colorVariant:"secondary",children:t}),o?null:(0,I.jsx)(Sn,{agentAction:r})]}),left:n,leftStyle:u.agentToolDiffRowIconContainerStyles,disabled:a,onClick:c,"aria-expanded":p,"aria-controls":g})})}function Sn({agentAction:e}){const t=(0,l().IS)((()=>({badge:{margin:0}})),[]);switch(e){case"create":return(0,I.jsx)(hn().E,{content:(0,I.jsx)(g().sA,{id:"AgentActionBadge.new",defaultMessage:"New"}),color:"blue",style:t.badge});case"update":return(0,I.jsx)(hn().E,{content:(0,I.jsx)(g().sA,{id:"AgentActionBadge.update",defaultMessage:"Update"}),color:"yellow",style:t.badge});case"delete":return(0,I.jsx)(hn().E,{content:(0,I.jsx)(g().sA,{id:"AgentActionBadge.delete",defaultMessage:"Delete"}),color:"red",style:t.badge});default:return(0,u().HB)(e)}}function xn(e){return(0,I.jsx)(Gt().A,{style:{padding:"4px"},...e})}function bn({theme:e,toolType:t,recordDiffInfos:n,spaceStore:r,intl:a,environment:o,toolResultStep:i,aiChatFeatureController:s}){var l;const d=new Map;if(i&&(0,c().gY)(i,"create-pages")&&null!==(l=i.result)&&void 0!==l&&l.pages)for(const c of i.result.pages)d.set(c.pointer.id,c);const p=n.map(((n,i)=>function({recordDiffInfo:e,index:t,spaceStore:n,intl:r,environment:a,hideActionBadge:o=!1,serverPage:i,theme:s,aiChatFeatureController:l}){const{recordPointer:d,agentAction:c}=e,u=Ct().B.createChildStore(n,d),p=u.getIcon()??(null!=i&&i.icon?{icon:i.icon,pointer:i.pointer}:void 0),g=u.isEmptyPage(),f=u.getRenderTitle({userTimeZone:r.locale,intl:r})??(null!=i&&i.title?(0,Yt().S5)({environment:a,textValue:{value:i.title,spaceId:n.id},parentStore:n,disableHover:!0,disableStyleAnnotations:!1,disableInsertedDeletedAnnotations:!1,disableDateStyleAnnotations:!1,disableSuggestionAnnotations:!1,disableLinks:!1,disabled:!1,emojiType:"raw",theme:s,katex:void 0,formulaValueTypes:[]}):void 0);if(void 0===f)return;const m=(0,I.jsx)("span",{style:un().RC,children:f}),h=e=>{(0,mn().u)({environment:a,store:u,pageVisitSource:on().y8.AIChat,openInNew:(0,sn().V)(e)})};return{key:`${u.id}-${t}`,action:()=>{},render:e=>(0,I.jsx)(In,{menuListItemProps:e,store:u,title:m,agentAction:c,hideActionBadge:o,icon:p,isEmptyPage:g,disabledHover:!u.isDefined(),onClick:h,aiChatFeatureController:l})}}({recordDiffInfo:n,index:i,spaceStore:r,intl:a,environment:o,hideActionBadge:!!t&&(dn[t]??!1),serverPage:d.get(n.recordPointer.id),theme:e,aiChatFeatureController:s}))).filter(u().O9);if(0!==p.length)return{key:"agent-tool-preview-diff-pages",items:p,render:e=>(0,I.jsx)(xn,{...e})}}function In(e){const{menuListItemProps:t,store:n,title:a,agentAction:o,hideActionBadge:i,icon:l,isEmptyPage:d,disabledHover:c,onClick:u,aiChatFeatureController:p}=e,g=(0,s().K8)((()=>(0,pn().Te)(n)),[n]),f=(0,r.useCallback)((e=>(0,I.jsx)(fn().y,{store:n,events:e})),[n]);return(0,I.jsx)(E().m,{noStyle:!0,delayThreshold:0,placement:"left",alignment:"center",originGap:24,disableTooltip:c,renderTooltip:f,render:e=>(0,I.jsx)(vn,{menuListItemProps:t,title:n.isDefined()?(0,I.jsx)(gn().A,{store:n}):a,icon:(0,I.jsx)(pn().B6,{icon:l,isEmptyPage:d,size:yn,disabled:!0,iconRecordCategory:g}),agentAction:o,hideActionBadge:i,onMouseEnter:e.onMouseEnter,onMouseLeave:e.onMouseLeave,onClick:u,aiChatFeatureController:p})})}function wn(e){const{resultStep:t,threadStore:r,stepId:a,aiChatFeatureController:o}=e,d=(0,i().v3)(),p=(0,g().tz)(),f=(0,l().DP)(),m=(0,s().O$)(Mt().AppStoreSidebarSpaceStore),h=(0,s().K8)((()=>{var e;if(t&&((0,c().gY)(t,"update-page")||(0,c().gY)(t,"update-page-v2"))&&null!==(e=t.result)&&void 0!==e&&e.threadDiff)return t.result.threadDiff}),[t]),y=(0,s().K8)((()=>{if(h)return h.diffs;if(!(0,n(379439).P)(t)||!t.threadOperations)return[];const e=r.getTranscript();if(!e)return[];const o=e.findIndex((e=>e.id===a));if(-1===o)return[];const i=e.slice(0,o);return rn({recordMap:(0,an().YO)({transcript:i}),operations:t.threadOperations.map((e=>e.operation))}).diffs}),[h,t,a,r]);return(0,s().K8)((()=>{if(!m||!y)return;const e=bn({recordDiffInfos:y.filter((e=>"delete"===e.type&&e.isPage)).map((e=>{if(e.pointer.table!==qt().ev)return;return Ct().B.createChildStore(m,e.pointer).isNavigableBlock()?{recordPointer:e.pointer,agentAction:"delete"}:void 0})).filter(u().O9),spaceStore:m,intl:p,environment:d,toolType:null==t?void 0:t.toolType,toolResultStep:t,theme:f,aiChatFeatureController:o}),i=y.map((e=>{const t=Ct().B.createChildStore(m,e.pointer),o=(0,n(492414).Ay)({store:t,fullyQualified:!1,pageVisitSource:on().y8.LinkInPage,chatThreadId:r.id});return{key:`${a}-${n(277153).L3.toKey(e.pointer)}`,action:()=>{},render:t=>(0,I.jsx)(Ht().A,{...t,shouldWrapTitle:!0,title:(0,I.jsx)(n(996332).Q,{href:o,disabled:"delete"===e.type,children:Yt().S5({environment:d,textValue:{value:e.titleDiff,spaceId:m.id},parentStore:m,disableHover:!0,disableStyleAnnotations:!1,disableInsertedDeletedAnnotations:!1,disableDateStyleAnnotations:!1,disableSuggestionAnnotations:!1,disableLinks:!0,disabled:!0,emojiType:"raw",theme:f,katex:void 0,formulaValueTypes:[]})})})}})).filter(u().O9),s=i.length?{key:"block-diffs",items:i,render:e=>(0,I.jsx)(Gt().A,{...e})}:void 0;return e||s?[e,s].filter(u().O9):void 0}),[o,y,d,p,t,m,a,f,r.id])}var Mn=()=>n(752860);function jn({environment:e,url:t}){if(Boolean(t)&&(0,u().O9)(t))return()=>{(0,Mn().L)({environment:e,url:t,targetSelf:!1})}}function Cn(e){const{connector:t}=e,a=(0,i().v3)(),[o,s]=(0,r.useState)(!1),d="gmail"===t,c=(0,l().IS)((()=>({container:{display:"flex",flexDirection:"column",gap:8},buttonRow:{display:"flex",paddingInlineStart:28}})),[]),u=(0,r.useCallback)((async()=>{if(d){const e=n(206267).JW();(0,n(576590).navigateToAIConnectorOnboarding)({connector:"gmail",analyticsFrom:"agent_mail_not_connected_error",sessionId:e})}else{s(!0);try{await(0,n(142810).MG)({environment:a})}finally{s(!1)}}}),[a,d]),p=d?(0,I.jsx)(g().sA,{id:"AgentToolUseMailNotConnectedError.connectGmailButton",defaultMessage:"Connect Gmail"}):(0,I.jsx)(g().sA,{id:"AgentToolUseMailNotConnectedError.connectButton",defaultMessage:"Connect to Notion Mail"}),f=d?"Connect Gmail":"Connect to Notion Mail";return(0,I.jsxs)("div",{style:c.container,children:[(0,I.jsx)(Se().N,{icon:n(733816).o,colorVariant:"secondary",title:(0,I.jsx)(T().D,{styleKey:"bodyRegular",colorVariant:"secondary",children:(0,I.jsx)(g().sA,{id:"AgentToolUseMailNotConnectedError.title",defaultMessage:"Email not connected"})})}),(0,I.jsx)("div",{style:c.buttonRow,children:(0,I.jsx)(oe().E,{size:"sm",colorPalette:"blue",onClick:u,isLoading:o,ariaLabel:f,children:p})})]})}var Tn=()=>n(96689);function kn(e){const{toolName:t,toolResultStep:a,aiChatFeatureController:o}=e,c=(0,g().tz)(),p=(0,i().v3)(),m=(0,l().IS)((()=>({container:{borderRadius:10,overflow:"hidden",boxShadow:f().Tj.shadow2XS,border:`1px solid ${f().Tj.border.secondary}`},content:{padding:"10px 12px"},iconContainer:{display:"flex",alignItems:"center",justifyContent:"center",height:20,width:20},permissionDetail:{marginTop:4}})),[]),h=(0,r.useMemo)((()=>De({toolName:t,state:"loading",numResults:0,intl:c,isMultiDatabaseMode:!1,toolResultStep:a})),[t,c,a]),y=(0,s().K8)((()=>function(e,t){const n=null==e?void 0:e.insufficientPermissionsDetails;if(!n)return{action:"write",resourceType:"unknown",resourceStore:void 0};let r,a="unknown";if(n.recordPointer){const{table:e,id:o}=n.recordPointer;try{if(e===qt().ev)a="page",r=new(Ct().B)(t,{table:qt().ev,id:o});else if(e===$t().Vl){a="database";const e=new(Tt().m)(t,{table:$t().Vl,id:o}),n=e.getParentPointer();r=n&&n.table===qt().ev?new(Ct().B)(t,n):e}else e===Tn().NX&&(a="workspace")}catch(i){}}return{action:(o=n.requiredAccess,"reader"===o?"read":"write"),resourceType:a,resourceStore:r};var o}(a,p)),[a,p]);return o.supportsRenderingPermissionError?(0,I.jsx)("div",{style:m.container,children:(0,I.jsx)("div",{style:m.content,children:(0,I.jsxs)(d().Y1,{direction:"horizontal",gap:8,align:"top-left",children:[(0,I.jsx)("div",{style:m.iconContainer,children:(0,I.jsx)(j().I,{icon:n(471095).lockFillIcon,size:"default"})}),(0,I.jsxs)(d().Y1,{direction:"vertical",gap:2,width:"fill",children:[(0,I.jsxs)(T().D,{styleKey:"bodyRegular",textOverflow:"ellipsis",children:[h," â€¢ ",(0,I.jsx)(g().sA,{id:"AgentToolUsePermissionError.status",defaultMessage:"Permission required"})]}),y?(0,I.jsx)("div",{style:m.permissionDetail,children:(0,I.jsx)(T().D,{styleKey:"captionRegular",textOverflow:"ellipsis",children:(()=>{if(!y)return null;const{action:e,resourceType:t,resourceStore:r}=y,a=r?(0,I.jsx)(n(761652).A,{store:r,useInvertedColors:!1,iconSize:14}):t;return"read"===e?(0,I.jsx)(g().sA,{id:"AgentToolUsePermissionError.needsPermissionToRead",defaultMessage:"Needs permission to read {resource}",values:{resource:a}}):"write"===e?(0,I.jsx)(g().sA,{id:"AgentToolUsePermissionError.needsPermissionToWrite",defaultMessage:"Needs permission to write to {resource}",values:{resource:a}}):void(0,u().HB)(e)})()})}):void 0]})]})})}):null}var An=()=>n(852424),Rn=()=>n(562969);function Dn({spaceStore:e,toolType:t,toolResultStep:n,theme:r,aiChatFeatureController:a}){const o=n.threadOperations;let i;var s;((0,c().gY)(n,"create-database")||(0,c().gY)(n,"update-database"))&&(i=null===(s=n.result)||void 0===s?void 0:s.propertyDiff);i||(i=ln({toolName:t,operations:(0,an().tr)(o)}));const l=Object.keys(i);if(0!==l.length){if(1===l.length){const e=l[0];return function({collectionId:e,propertyChangeInfos:t,theme:n,aiChatFeatureController:r}){const a=t.map(((e,t)=>function({propertyChangeInfo:e,index:t,theme:n,aiChatFeatureController:r}){const{agentAction:a,propertySchema:o,hideBadge:i}=e;return{key:`${a}-${o.name}-${t}`,action:()=>{},render:e=>(0,I.jsx)(vn,{menuListItemProps:e,title:o.name,icon:(0,I.jsx)(An().zB,{type:o.type,icon:void 0,size:S().Ev.sm,theme:n}),agentAction:a,disabled:!0,hideActionBadge:i,aiChatFeatureController:r})}}({propertyChangeInfo:e,index:t,theme:n,aiChatFeatureController:r}))).filter(u().O9);if(0===a.length)return;return{key:e,items:a,render:e=>(0,I.jsx)(xn,{...e})}}({collectionId:e,propertyChangeInfos:i[e],theme:r,aiChatFeatureController:a})}return function({collectionIds:e,collectionIdToPropertyChangeInfos:t,theme:n,aiChatFeatureController:r,spaceStore:a}){if(!a)return;const o=[];for(const i of e){const e=Tt().m.createChildStore(a,{table:$t().Vl,id:i,spaceId:a.id}),s=(0,Rn().getCollectionNameOrDefault)({intl:se().A.getIntl(),collectionStore:e}),l=t[i];0!==l.length&&o.push({key:i,action:()=>{},render:e=>(0,I.jsx)(Un,{menuListItemProps:e,collectionId:i,collectionName:s,propertyChangeInfos:l,theme:n,aiChatFeatureController:r})})}if(0===o.length)return;return{key:e.join(","),items:o,render:e=>(0,I.jsx)(xn,{...e})}}({collectionIds:l,collectionIdToPropertyChangeInfos:i,theme:r,aiChatFeatureController:a,spaceStore:e})}}function Un({menuListItemProps:e,collectionId:t,collectionName:n,propertyChangeInfos:a,theme:o,aiChatFeatureController:i}){const[s,d]=(0,r.useState)(!0),c=(0,r.useId)(),u=(0,r.useCallback)((()=>{d(!s)}),[s]),p=(0,r.useMemo)((()=>({key:t,items:a.map(((e,n)=>{const{agentAction:r,propertySchema:a,hideBadge:s}=e;return{key:`${t}-${r}-${a.name}-${n}`,action:()=>{},render:e=>(0,I.jsx)(vn,{menuListItemProps:e,title:a.name,icon:(0,I.jsx)(An().zB,{type:a.type,icon:void 0,size:S().Ev.sm,theme:o}),agentAction:r,disabled:!0,hideActionBadge:s,aiChatFeatureController:i},`${t}-${r}-${a.name}-${n}`)}})),render:e=>(0,I.jsx)(xn,{...e})})),[t,a,o,i]),g=(0,l().IS)((()=>({menuList:{marginInlineStart:22},icon:{flexShrink:0,transition:"transform 0.15s ease-in-out",transform:s?"rotate(90deg)":"rotate(0deg)",opacity:.5}})),[s]);return(0,I.jsx)(G,{isExpanded:s,shouldSkipContentPadding:!0,disableInitialAnimation:!0,contentId:c,origin:(0,I.jsx)(vn,{menuListItemProps:e,title:n,icon:(0,I.jsx)(vt().Q,{iconGroup:St,colorVariant:"secondary",variantName:"small",style:g.icon}),agentAction:"update",disabled:!1,hideActionBadge:!0,onClick:u,aiChatFeatureController:i,"aria-expanded":s,"aria-controls":c}),content:(0,I.jsx)(kt().A,{type:kt().O.Vertical,initialFocus:void 0,sections:[p],style:g.menuList,disableKeyboard:!0})})}var Pn=()=>n(741862);const Bn=(0,g().YK)({newChat:{id:"AgentInferenceToolUse.runAgent.newChat",defaultMessage:"New chat"}});function Fn({threadStore:e,viewThreadButton:t,fallbackTitle:n}){const r=(0,g().tz)(),a=(0,s().K8)((()=>{var t;return null===(t=e.getData())||void 0===t?void 0:t.title}),[e]),o=(0,l().IS)((()=>({container:{display:"flex",flexDirection:"column",gap:10,paddingTop:12,paddingInlineEnd:12,paddingBottom:12,paddingInlineStart:12,borderRadius:12,border:`1px solid ${f().Tj.border.secondary}`,backgroundColor:f().Tj.background.primary},headerRow:{display:"flex",justifyContent:"space-between",alignItems:"center",gap:8},title:{maxWidth:"100%",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}})),[]),i=(null==a?void 0:a.trim())||(null==n?void 0:n.trim())||r.formatMessage(Bn.newChat);return(0,I.jsx)(Gt().A,{children:(0,I.jsx)("div",{style:o.container,children:(0,I.jsxs)("div",{style:o.headerRow,children:[(0,I.jsx)(T().D,{styleKey:"bodyRegular",colorVariant:"secondary",style:o.title,children:i}),t]})})})}var En=()=>n(908268);function Vn({toolResultStep:e,threadStore:t,stepId:a,spaceStore:o,environment:i}){var l,d,u;const p=e&&(0,c().gY)(e,"run-agent")?e:void 0,g=function(e){var t,n;if(!e)return;const r=Ln(null===(t=e.result)||void 0===t?void 0:t.threadUrl);if(r)return r;return Ln(null===(n=e.input)||void 0===n?void 0:n.threadUrl)}(p),f=(null==p||null===(l=p.result)||void 0===l?void 0:l.workflowId)??(0,Pn().al)(null==p||null===(d=p.input)||void 0===d?void 0:d.agentUrl),m=!f||f===be().Lj||""===f,h=(0,s().K8)((()=>t.getTranscript()),[t]),y=(0,r.useMemo)((()=>function(e,t){const n=e.findIndex((e=>e.id===t))-1;for(let r=n>=0?n:e.length-1;r>=0;r-=1){const t=e[r];if("user"===t.type&&t.userId)return t.userId;if("user-injected"===t.type&&t.userId)return t.userId;if("agent-prebuilt-prompt"===t.type&&t.userId)return t.userId}return}(h,a)),[h,a]),v=(0,r.useMemo)((()=>{if(o&&f&&!m)return B().N.createChildStore(o,{table:O().C0,id:f,spaceId:o.id})}),[o,f,m]),S=(0,s().K8)((()=>!!v&&v.canRead()),[v]),x=(0,r.useMemo)((()=>{if(o&&g)return n(463086).E.createChildStore(o,{table:n(234459).To,id:g,spaceId:o.id})}),[o,g]),b=Boolean(y)&&y===(null===(u=i.currentUser)||void 0===u?void 0:u.id);return{shouldShowPreview:Boolean(p&&g&&x&&(m?b:S)),previewThreadStore:x,threadId:g}}function Ln(e){const t=(0,xe().Tn)(e);if(null==t||!t.startsWith("thread://"))return;const n=t.slice(9),[,r]=n.split("/");return(0,Pn().Li)(r)}const Nn=(0,g().YK)({viewThread:{id:"AgentInferenceToolUse.runAgent.viewThread",defaultMessage:"Open thread"}}),On=(0,g().YK)({switchedToFullChat:{id:"AgentInferenceToolUse.escalate.switchedToFullChat",defaultMessage:"Switched to full chat for a better answerâ€¦"}});function _n({toolName:e,toolResultStep:t,intl:n,isLastStep:a}){return(0,r.useMemo)((()=>{if(!a)return;if("wait"!==e||!t||!(0,c().gY)(t,"wait"))return;const r=t.result;if(!r)return;const o=function({intl:e,waitResult:t}){var n;const r=[],a=null===(n=t.message)||void 0===n?void 0:n.trim();a&&r.push(a);const o=function(e,t){if(!Number.isFinite(t))return;const n=new Date(t),r=new Date,a=n.getFullYear()===r.getFullYear()&&n.getMonth()===r.getMonth()&&n.getDate()===r.getDate()?{hour:"numeric",minute:"2-digit"}:{month:"short",day:"numeric",hour:"numeric",minute:"2-digit"},o=e.formatDate(n,a);return e.formatMessage({id:"AgentInferenceToolUse.wait.subtitle.resumeAt",defaultMessage:"Resumes at {time}"},{time:o})}(e,t.resumeAtMs);o&&r.push(o);if(0===r.length)return;return r.join(" Â· ")}({intl:n,waitResult:r});return o?(0,I.jsx)(T().D,{styleKey:"captionRegular",colorVariant:"tertiary",textOverflow:"ellipsis",children:o}):void 0}),[n,a,e,t])}const Kn=r.memo((function(e){var t,o,m;const{stepId:h,toolName:v,toolResultStep:S,toolUse:x,threadStore:b,runningInference:w,aiChatFeatureController:M,isLastTurn:j,onExpandedChange:C,hideIcon:k=!1,hideOutline:A=!1}=e,R=(0,he().I)({runningInference:w,toolResultStep:S,isLastTurn:j}),U=Boolean(S&&(0,p().I6)(S)),P=(0,D().L)(),F=(0,g().tz)(),E=(0,i().v3)(),V=(0,l().DP)(),L=(0,s().K8)((()=>{var e;const t=b.getTranscript();return 0!==t.length&&(null===(e=t.at(-1))||void 0===e?void 0:e.id)===(null==S?void 0:S.id)}),[b,null==S?void 0:S.id]),N=(0,s().K8)((()=>(0,he().yX)([S].filter(u().O9),(null==P?void 0:P.id)??"")),[null==P?void 0:P.id,S]),_=(0,a().X)("agent_multidb_creation"),K=(0,a().X)("run_agent_compacted_personal_agent_view",{disableExposureLogging:"run-agent"!==v}),z=_n({intl:F,toolName:v,toolResultStep:S,isLastStep:L}),{titleStore:q,isTitleStoreReady:$}=function(e){const{toolResultStep:t}=e,n=(0,g().tz)(),r=(0,D().L)(),a=(0,s().K8)((()=>{if(!r)return;const e=(0,he().PA)(t,r.id);if(1!==e.length)return;const n=e[0];return n.table===qt().ev?Ct().B.createChildStore(r,n):n.table===$t().Vl?Tt().m.createChildStore(r,n):n.table===de().oo?le().L.createChildStore(r,n):n.table===O().C0?B().N.createChildStore(r,n):void 0}),[r,t]),o=(0,s().K8)((()=>{if(a instanceof le().L)return a.isReady();if(a instanceof B().N)return void 0!==a.getDraftData();return void 0!==(null==a?void 0:a.getRenderTitle({userTimeZone:n.locale,intl:n}))}),[a,n]);return{titleStore:a,isTitleStoreReady:o}}({toolName:v,toolResultStep:S}),Y=(0,s().K8)((()=>{if("run-agent"===v)return(0,n(651784).OB)(E.RouterStore.state.route)??{}}),[v,E]),W=(0,s().K8)((()=>{if("run-agent"!==v)return;const e=E.RouterStore.state.route;return{peekViewBlockId:"peekViewBlockId"in e?e.peekViewBlockId:void 0,peekMode:"peekMode"in e?e.peekMode:void 0}}),[v,E]),H=(0,s().K8)((()=>Mt().default.state.currentWorkflowStore),[]),G=void 0,X=Vn({toolResultStep:S,threadStore:b,stepId:h,spaceStore:P,environment:E}),Q=(0,r.useMemo)((()=>{if("run-agent"!==v||!S||!(0,c().gY)(S,"run-agent")||!Y)return;const e=(0,Pn().VM)({toolResultStep:S,agentRouteParams:Y,peekRouteParams:W});return e?"personal"===e.kind?(0,I.jsx)(oe().E,{size:"sm",colorPalette:"blue",onClick:()=>{const t=(0,Pn().C3)(E.RouterStore.state.route,e.threadId);if(t)return void(0,Wt().navigate)({environment:E,url:t,redirect:!1});const r=(0,n(770160).shouldAllowOpeningAgentOnSpecifiedRoute)(E.RouterStore.state.route),a=q&&q instanceof B().N?q:void 0,o=Mt().default.state.mainEditorCurrentBlockStore,i=a??H??o;if(r&&i)if(null!=Y&&Y.workflowViewType||null!=W&&W.peekViewBlockId)(0,Wt().navigate)({environment:E,url:e.url,redirect:!1});else try{(0,n(703748).openChatPanel)({environment:E,store:i,chatPanelState:{isOpen:!0,threadId:e.threadId},source:"navigation"})}catch{(0,Wt().navigate)({environment:E,url:e.url,redirect:!1})}else(0,Wt().navigate)({environment:E,url:e.url,redirect:!1})},ariaLabel:F.formatMessage(Nn.viewThread),children:F.formatMessage(Nn.viewThread)}):(0,I.jsx)(oe().E,{size:"sm",colorPalette:"blue",onClick:()=>{const t=(0,Pn().C3)(E.RouterStore.state.route,e.threadId);(0,Wt().navigate)({environment:E,url:t??e.url,redirect:e.redirect})},ariaLabel:F.formatMessage(Nn.viewThread),children:F.formatMessage(Nn.viewThread)}):void 0}),[Y,H,E,F,v,S,q,W]),Z=(0,r.useMemo)((()=>{var e,t;if("run-agent"!==v)return;const n=S&&(0,c().gY)(S,"run-agent")?S:void 0;return(null==n||null===(e=n.result)||void 0===e?void 0:e.workflowId)??(0,Pn().al)(null==n||null===(t=n.input)||void 0===t?void 0:t.agentUrl)}),[v,S]),J="run-agent"===v&&(!Z||Z===be().Lj),ee=J&&K,te=(0,s().K8)((()=>{if(!ee)return!1;const e=X.previewThreadStore;if(!e)return!1;const t=e.getTranscript();for(const r of t){if("agent-inference"!==r.type)continue;const e=(0,n(878456).ie)(r),t=(0,n(362750).lH)(e.value);for(const n of t)if("tool_use"===n.type&&(0,xe().U3)(n.name))return!0}return!1}),[X.previewThreadStore,ee]),ne=(0,r.useMemo)((()=>{if("run-agent"===v&&X.shouldShowPreview&&X.previewThreadStore&&(!ee||te))return function({threadStore:e,spaceStore:t,workflowId:n,viewThreadButton:r,fallbackTitle:a}){return{key:`run-agent-thread-preview-${e.id}`,items:[],render:()=>(0,I.jsx)(Fn,{threadStore:e,viewThreadButton:r,fallbackTitle:a})}}({threadStore:X.previewThreadStore,spaceStore:P,workflowId:Z,viewThreadButton:Q})}),[te,X.previewThreadStore,X.shouldShowPreview,ee,v,Z,P,Q]),re=(0,he().WM)(v),ae=(0,s().K8)((()=>{var e;return null===(e=Mt().default.state.sidebarSpaceViewStore)||void 0===e||null===(e=e.getSettings())||void 0===e||null===(e=e.agent_personalization_settings)||void 0===e?void 0:e.context_page_id}),[]),se=(0,s().K8)((()=>{if(!P||!S||!ae)return!1;const e=(0,he().PA)(S,P.id);return 1===e.length&&e[0].table===qt().ev&&e[0].id===ae}),[S,ae,P]),ue=(0,r.useMemo)((()=>function({toolName:e,agentAction:t,isReferencingContextPage:r}){if(t)return function(e,t){switch(e){case"create":return Ot().plusSmallIcon;case"update":return t?Dt().aiFaceSmallIcon:Lt().pencilLineSmallIcon;case"delete":return _t().trashSmallIcon;default:(0,u().HB)(e)}}(t,r);if((0,xe().og)(e))return function(e){const t=ke(e);return Ae(e).icon??Ce().d.getDefaultIcon(t)}(e);switch(e){case"search":case"query-data-sources":return Vt().magnifyingGlassIcon;case"queryCalendar":return n(381553).Y;case"queryMail":return n(913886).D;case"view":case"view-version-history":case"view-channel":case"view-slack-channel":case"view-code-repo":return Pt().eyeSmallIcon;case"view-notifications":return n(588047).k;case"view-database-files":return n(300985).Z;case"create-database":case"create-pages":return Nt().plusIcon;case"update-database-data-sources":case"update-database":return Ut().c;case"update-database-views":return n(167170)._;case"update-database-triggers":return n(200582).m;case"error":return Kt().xMarkCircleFillIcon;case"delete-pages":return n(236262).trashIcon;case"revert":return n(613601).arrowUTurnUpLeftSmallIcon;case"update-page":case"update-page-v2":return n(105819).pencilLineIcon;case"edit-json":throw new Error("edit-json tool should not be used in the UI");case"result":case"toggle-user-integration-tools":case"enter-setup-mode":case"exit-setup-mode":case"update-user-integrations":case"create-agent":case"create-agent-v2":case"update-agent":case"update-agent-v2":case"delete-agent":case"query-agent-threads":case"investigate-agent-thread":case"run-agent":case"update-todos":case"escalate":return Rt().aiFaceIcon;case"query-salesforce-tool":return zt().salesforceIcon;case"list-machines":case"create-machine":case"destroy-machine":return n(556402).i;case"terminal":case"callFunction":case"runScript":return Et().l;case"browser":return n(470356).c;case"summarize-meeting-note":return n(120282).a;case"wait":return Ft;case"generate-image":return n(824375).sparklesIcon;default:(0,u().HB)(e)}}({toolName:v,agentAction:re,isReferencingContextPage:se})),[re,v,se]),pe=(0,s().K8)((()=>{if(P&&S)return"create-database"===v||"update-database"===v?Dn({toolResultStep:S,theme:V,toolType:v,aiChatFeatureController:M,spaceStore:P}):bn({spaceStore:P,intl:F,environment:E,recordDiffInfos:N,toolType:v,toolResultStep:S,theme:V,aiChatFeatureController:M})}),[P,S,v,F,E,N,V,M]),ge=wn({threadStore:b,stepId:h,resultStep:S,aiChatFeatureController:M}),fe=(0,s().K8)((()=>{if(P)return(0,n(680369).ZX)({environment:E,spaceStore:P,toolResultStep:S,threadStore:b})}),[E,P,S,b]),me=(zn[v]?ge??[]:[pe]).filter(u().O9),ve=("run-agent"===v?[ne]:[ne,...fe??[],...me]).filter(u().O9),Se=ve.length>0,Ie=(0,s().uB)(void 0,At().$),{hasUndoneOperations:we}=(0,he().ji)({diffResultSteps:[S].filter(u().O9),threadStore:b}),Me=S?(0,p().rk)(S):void 0,je=R||U,Te=we||"confirmation:rejected"===Me?"reverted":je?"loading":"done",Re=De({toolName:v,state:Te,numResults:N.length,intl:F,isMultiDatabaseMode:_,toolResultStep:S,toolUse:x,isReferencingContextPage:se,isLastStep:L,titleStore:q}),Ue=(0,r.useMemo)((()=>{return!!S&&("callFunction"===v?(0,c().gY)(S,"callFunction")&&Boolean((null===(e=S.result)||void 0===e?void 0:e.error)??S.error):"runScript"===v?(0,c().gY)(S,"runScript")&&Boolean((null===(t=S.result)||void 0===t?void 0:t.runtimeError)||((null===(n=S.result)||void 0===n||null===(n=n.typecheckErrors)||void 0===n?void 0:n.length)??0)>0):Boolean(S.error));var e,t,n}),[v,S]),Pe=Boolean(null==S?void 0:S.promptInjectionDetected),Be=S&&(0,c().gY)(S,"callFunction")?null===(t=S.result)||void 0===t?void 0:t.headerLabel:void 0,Fe=(0,r.useMemo)((()=>{var e;if(!Be)return b;const t=(0,ce().moK)(Be).at(0),r=null===(e=(0,ce()._vJ)(Be).at(0))||void 0===e?void 0:e.pointer,a=t??r;if(!a)return b;const o=(0,n(865454).getAgentPreviewWrapper)(E).getInMemoryRecordCacheIfIsPreviewingRecord(a,E.currentUser.id);return o?a.table===qt().ev?new(Ct().B)(E,a,{inMemoryRecordCache:o}):a.table===$t().Vl?new(Tt().m)(E,a,{inMemoryRecordCache:o}):b:b}),[Be,E,b]),Ee=(0,s().K8)((()=>{if(!Be)return;const e=b.getSpaceId();return e?(0,Yt().S5)({environment:E,textValue:{value:Be,spaceId:e},parentStore:Fe,disableHover:!1,disableStyleAnnotations:!1,disableInsertedDeletedAnnotations:!1,disableDateStyleAnnotations:!1,disableSuggestionAnnotations:!1,disableLinks:!1,disabled:!1,stopLinkPropagation:!0,katex:E.KatexStore.getKatex(),emojiType:(0,n(712030).FN)(E),formulaValueTypes:[],theme:V}):void 0}),[Be,Fe,E,b,V])??Re,Ve=(0,r.useMemo)((()=>{const e={title:Ee,subtitle:z,hasUndoneOperations:we,state:Me,aiChatFeatureController:M};return"run-agent"===v?(0,I.jsx)(En().n,{...e,titleSuffix:G}):(0,I.jsx)(En().n,{...e,titleSuffixStore:q,isTitleSuffixStoreReady:$})}),[we,G,z,q,v,Ee,Me,$,M]),Le=(0,r.useMemo)((()=>Pe?(0,I.jsxs)(d().Y1,{direction:"horizontal",align:"center",gap:4,children:[Ve,(0,I.jsx)(Ke().R,{})]}):Ve),[Ve,Pe]),Ne=function({state:e,toolName:t,toolResultStep:n,environment:r}){switch(t){case"slack.createThreadInChannel":var a;if("done"===e)return jn({url:n&&(0,c().gY)(n,"slack.createThreadInChannel")?null===(a=n.result)||void 0===a?void 0:a.url:void 0,environment:r});break;case"slack.createThreadInDirectMessage":var o;if("done"===e)return jn({url:n&&(0,c().gY)(n,"slack.createThreadInDirectMessage")?null===(o=n.result)||void 0===o?void 0:o.url:void 0,environment:r});break;case"slack.replyInThread":var i;if("done"===e)return jn({url:n&&(0,c().gY)(n,"slack.replyInThread")?null===(i=n.result)||void 0===i?void 0:i.url:void 0,environment:r});break;case"slack.updateMessage":var s;if("done"===e)return jn({url:n&&(0,c().gY)(n,"slack.updateMessage")?null===(s=n.result)||void 0===s?void 0:s.url:void 0,environment:r})}}({toolName:v,state:Te,toolResultStep:S,environment:E}),Oe=("create-pages"===v||"delete-pages"===v)&&1===N.length,_e=Se&&!we&&!Oe,ze="result"===v&&"done"===Te,qe=(0,r.useCallback)((e=>{try{ie().trackToggleToolCard({environment:E,stepId:h,showResults:e,from:"tool_card",toolCardType:v,workflowId:(0,ye().i4)(b)})}catch(t){}null==C||C(e)}),[E,v,h,b,C]),$e="mail.runTool"===v&&(0,n(960674).D)(null==S?void 0:S.toolName)||v.startsWith("calendar.")&&je||"callFunction"===v||"runScript"===v,Ye=A||"run-agent"===v||"callFunction"===v||"runScript"===v||J&&K,We=(0,l().IS)((()=>({scrollerStyle:{maxHeight:$e?void 0:200},minimalToolWrapper:{borderRadius:10,overflow:"hidden",boxShadow:Ye?void 0:`0 0 0 1px ${f().Tj.border.secondary}, 0px 1px 2px rgba(0, 0, 0, 0.04)`,transition:"box-shadow 0.15s ease-in-out",marginInline:M.toolUsePartMarginInline,...ze&&{borderRadius:0,marginInline:0,boxShadow:void 0}}})),[$e,M.toolUsePartMarginInline,ze,Ye]);if(null!=S&&S.insufficientPermissions)return M.supportsRenderingPermissionError?(0,I.jsx)(kn,{toolName:v,toolResultStep:S,aiChatFeatureController:M}):null;if("MAIL_ACCOUNT_NOT_CONNECTED"===(null==S?void 0:S.errorCode)){var He;const e="string"==typeof(null===(He=S.errorData)||void 0===He?void 0:He.connector)?S.errorData.connector:void 0;return(0,I.jsx)(Cn,{connector:e})}if(S&&(0,he().eb)(S))return null;if("escalate"===v)return(0,I.jsx)(T().D,{styleKey:"body",color:"label-tertiary",children:F.formatMessage(On.switchedToFullChat)});if(R&&!U&&!Se&&0===N.length)return(0,I.jsx)("div",{children:(0,I.jsx)(y().c,{message:Re,animationType:"scrolling-squiggle"})});if("toggle-user-integration-tools"===v&&""===Re&&S&&(0,c().gY)(S,"toggle-user-integration-tools")&&(((null===(o=S.result)||void 0===o||null===(o=o.activeIntegrationPointers)||void 0===o?void 0:o.length)??0)>0||((null===(m=S.result)||void 0===m||null===(m=m.inactiveIntegrationPointers)||void 0===m?void 0:m.length)??0)>0))return null;if("enter-setup-mode"===v)return null;if("revert"===v)return null;if("calendar.fetchPlaybook"===v)return null;const Ge=U||R&&"callFunction"!==v&&"runScript"!==v||function(e){return"result"===e||"create-agent"===e||"create-agent-v2"===e||"exit-setup-mode"===e}(v)||e.forceExpanded;return(0,I.jsx)(xt,{hideOrigin:ze,isExpandable:_e??!1,icon:ue,toolRunning:R,isExpandedOverride:Ge,onNonExpandableClick:Ne,onExpandedChange:qe,title:ze?void 0:Le,statusIcon:Ue?Kt().xMarkCircleFillIcon:void 0,hideIcon:k,content:ze?(0,I.jsx)(kt().A,{type:kt().O.Vertical,initialFocus:void 0,resetFocusOnMouseOut:!0,sections:ve,store:Ie,disableKeyboard:!0,style:{paddingBlock:0,paddingInline:0,marginBottom:8}}):(0,I.jsx)(n(376254).H,{type:jt().A.Y,style:{...We.scrollerStyle,...We.minimalToolWrapper},children:(0,I.jsx)(kt().A,{type:kt().O.Vertical,initialFocus:void 0,resetFocusOnMouseOut:!0,sections:ve,store:Ie,disableKeyboard:!0})}),variant:"agent_mobile"===M.aiChatType?"large":"default"})}));const zn={"update-page":!0,"update-page-v2":!0,"fs.readDir":!1,"fs.readFiles":!1,search:!1,"search.autosearch":!1,"web.search":!1,"web.loadPage":!1,queryCalendar:!1,queryMail:!1,view:!1,"view-notifications":!1,"view-version-history":!1,"view-database-files":!1,"view-channel":!1,"view-slack-channel":!1,"view-code-repo":!1,"create-database":!1,"update-database":!1,"update-database-data-sources":!1,"update-database-views":!1,"query-data-sources":!1,"update-database-triggers":!1,"update-todos":!1,"generate-image":!1,"images.generate":!1,callFunction:!1,runScript:!1,"notion.createDatabase":!1,"notion.updateDatabase":!1,"notion.createAgent":!1,"notion.updateAgent":!1,"notion.loadUser":!1,"notion.loadDatabase":!1,"notion.loadDataSource":!1,"notion.loadPage":!1,"notion.createPage":!1,"notion.updatePage":!1,"notion.querySql":!1,"notion.queryView":!1,"notion.queryThreads":!1,"notion.investigateThread":!1,"notion.getFormulaValue":!1,"notion.createAndRunThread":!1,error:!1,"create-pages":!1,"delete-pages":!1,result:!1,"update-user-integrations":!1,"edit-json":!1,wait:!1,"mcpServer.getPrompt":!1,"mcpServer.listPrompts":!1,"mcpServer.listResources":!1,"mcpServer.readResource":!1,"mcpServer.runTool":!1,"mcpServer.listTools":!1,"test.getState":!1,"slack.addReactionToMessage":!1,"slack.createThreadInChannel":!1,"slack.createThreadInDirectMessage":!1,"slack.findUserByEmail":!1,"slack.getThreadsInChannelSince":!1,"slack.getUser":!1,"slack.parseSlackUriOrUrl":!1,"slack.queryChannels":!1,"slack.removeReactionFromMessage":!1,"slack.replyInThread":!1,"slack.search":!1,"slack.updateMessage":!1,"asana.search":!1,"asana.loadTask":!1,"box.search":!1,"discord.search":!1,"github.search":!1,"github.grepCode":!1,"github.lsDirectory":!1,"github.loadPR":!1,"github.loadIssue":!1,"github.loadCommit":!1,"github.loadFile":!1,"gmail.search":!1,"gmail.loadThread":!1,"gmail.query":!1,"googleDrive.search":!1,"googleDrive.loadFile":!1,"googleCalendar.search":!1,"googleCalendar.query":!1,"jira.search":!1,"jira.loadIssue":!1,"linear.search":!1,"linear.loadIssue":!1,"microsoftTeams.search":!1,"microsoftTeams.loadMessage":!1,"microsoftTeams.viewChannel":!1,"microsoftTeams.viewChat":!1,"outlook.search":!1,"outlook.loadMessage":!1,"outlook.loadThread":!1,"outlook.query":!1,"salesforce.search":!1,"sharepoint.search":!1,"sharepoint.loadFile":!1,"toggle-user-integration-tools":!1,"enter-setup-mode":!1,"exit-setup-mode":!1,"notion.addCommentToDiscussion":!1,"notion.getPageDiscussions":!1,"notion.sendNotification":!1,"calendar.fetchPlaybook":!1,"calendar.listCalendars":!1,"calendar.listEvents":!1,"calendar.listCoworkersEvents":!1,"calendar.createEvents":!1,"calendar.updateEvents":!1,"calendar.cancelEvents":!1,"calendar.suggestMeetingTimes":!1,"mail.listTools":!1,"mail.runTool":!1,"mail.getPrompt":!1,"files.getFileContent":!1,"files.getFileName":!1,"files.getFileUrl":!1,"cursor.createAgent":!1,"cursor.addFollowup":!1,"cursor.getAgent":!1,"cursor.listRepositories":!1,"create-agent":!1,"create-agent-v2":!1,"update-agent":!1,"update-agent-v2":!1,"delete-agent":!1,"query-agent-threads":!1,"investigate-agent-thread":!1,"run-agent":!1,"query-salesforce-tool":!1,"list-machines":!1,"create-machine":!1,"destroy-machine":!1,terminal:!1,browser:!1,"computer.listMachines":!1,"computer.listSecrets":!1,"computer.createMachine":!1,"computer.destroyMachine":!1,"computer.setSecret":!1,"computer.terminal":!1,"computer.browser":!1,"computer.getJobStatus":!1,"computer.getJobLogs":!1,"computer.viewFileUrl":!1,"modules.list":!1,"modules.create":!1,"modules.update":!1,"modules.delete":!1,"summarize-meeting-note":!1,revert:!1,"worker.listTools":!1,"worker.runTool":!1,"workers.list":!1,"notion.loadAgent":!1,"notion.viewFileUrl":!1,"slack.viewFileUrl":!1,"slack.loadMessage":!1,escalate:!1};var qn=()=>n(561487),$n=()=>n(222800);const Yn=["weekly-project-update","morning-brief","slack-task-triager"];function Wn({threadStore:e}){const t=(0,i().v3)(),n=(0,g().tz)(),[a,o]=(0,r.useState)(null),d=(0,s().O$)(ue().bX),c=(0,$n().V)(),u=(0,s().K8)((()=>e.getSpaceStore()),[e]),{templates:p}=(0,qn().C)(),f=p.filter((e=>Yn.some((t=>t===e.id)))),m=(0,he().pg)({numItems:f.length}),h=(0,r.useCallback)((async e=>{if(u&&c&&!a){o(e.id);try{await(0,_().duplicateTemplateAndOpenChat)({environment:t,spaceStore:u,inferenceContext:d,template:e,intl:n,analytics:{origin:"personal_agent_suggested_action"}})}finally{o(null)}}}),[u,c,a,t,d,n]),y=(0,l().IS)((()=>({container:{display:"inline-flex",alignItems:"flex-start",flexDirection:"column",gap:8},templateButton:{borderRadius:34,minHeight:32,paddingTop:6,paddingInlineEnd:10,paddingBottom:6,paddingInlineStart:8},templateButtonContent:{display:"flex",alignItems:"center",gap:4},templateIcon:{width:20,height:20},animatedItem:{transition:"opacity 800ms ease-in-out"}})),[]);return(0,I.jsx)("div",{style:y.container,children:f.map(((e,t)=>(0,I.jsx)("div",{style:{...y.animatedItem,opacity:m.has(t)?1:0},children:(0,I.jsx)(oe().E,{style:y.templateButton,onClick:()=>h(e),isLoading:a===e.id,disabled:null!==a,children:(0,I.jsxs)("div",{style:y.templateButtonContent,children:[(0,I.jsx)("img",{src:e.iconUrl,alt:e.title,style:y.templateIcon}),(0,I.jsx)(T().D,{styleKey:"bodyRegular",children:e.title})]})})},e.id)))})}var Hn=()=>n(884780),Gn=()=>n(450104),Xn=()=>n(917150),Qn=()=>n(344417),Zn=()=>n(188158),Jn=()=>n(899483),er=()=>n(143016),tr=()=>n(813679),nr=()=>n(980319),rr=()=>n(300474),ar=()=>n(804773),or=()=>n(943101),ir=()=>n(250910),sr=()=>n(546926),lr=()=>n(890492),dr=()=>n(96563),cr=()=>n(604018),ur=()=>n(773363),pr=()=>n(528093);function gr({agentSearchResultsBySourceType:e,selectedSourceType:t,onChange:n,aiChatFeatureController:o}){const l=(0,i().v3)(),c=(0,rr().r)(),u=(0,g().tz)(),p=(0,r.useId)(),f=(0,a().X)("notion_ai_workspace_settings"),m=(0,s().K8)((()=>(0,cr().Nr)().length>0),[]),h="agent_mobile"===o.aiChatType,y=f&&m&&!h,v=(0,pr()._)({name:"ai_connectors",spaceId:c,userId:l.currentUser.id}),S=(0,r.useCallback)((()=>{(0,dr().pp)({environment:l,connector:"generic",analyticsFrom:"ai_chat_search_results_tab",connectorsFeatureAvailability:v})}),[v,l]),x=(0,r.useRef)(null),[b,w]=(0,r.useState)(0);(0,or().tK)(x,(()=>{x.current&&w(x.current.clientWidth)}));const M=(0,r.useRef)(null),[j,C]=(0,r.useState)(0);(0,r.useEffect)((()=>{M.current&&C(M.current.clientWidth)}),[M]);const T=(0,r.useMemo)((()=>Array.from(e.keys())),[e]),k=(0,s().K8)((()=>{const e=new Map;for(const t of T)e.set(t,"top-results"===t?u.formatMessage({id:"AgentSearchSourceTabs.topResults",defaultMessage:"Top results"}):(0,nr().$b)({searchSourceType:t,environment:l,intl:u}));return e}),[T,l,u]),A=(0,r.useMemo)((()=>new(ur().k)({style:{fontFamily:"system-ui, sans-serif"}})),[]),R=(0,r.useMemo)((()=>function({availableSourceTypes:e,availableWidth:t,selectedSourceType:n,agentSearchResultsBySourceType:r,sourceTypeToLabel:a,widthEstimator:o,moreButtonWidth:i}){const s=[];let l=0;const d=new Map;for(const p of e){var c;const e=a.get(p)??"",t=(null===(c=r.get(p))||void 0===c?void 0:c.length)??0,n=o.measure(e).width+o.measure(`${t}`).width+fr;l+=n,d.set(p,n)}let u=0;l>t&&(u+=i);for(const p of e){const e=d.get(p)??0;if(u+e>t)break;s.push(p),u+=e}if(!s.includes(n)){const e=d.get(n)??0;for(;s.length>0;){const n=s.pop();if(!n)break;if(u-=d.get(n)??0,u+e<=t)break}s.push(n)}return s}({availableSourceTypes:T,availableWidth:b,selectedSourceType:t,agentSearchResultsBySourceType:e,sourceTypeToLabel:k,widthEstimator:A,moreButtonWidth:j})),[T,b,t,e,k,A,j]),D=(0,r.useMemo)((()=>T.filter((e=>!R.includes(e)))),[T,R]);return(0,I.jsx)(ar().Y,{direction:"horizontal",children:(0,I.jsx)("div",{role:"tablist","aria-label":u.formatMessage({id:"agentSearchSourceTabs.accessibilityLabel",defaultMessage:"Search source tabs"}),id:p,style:{padding:8},children:(0,I.jsxs)(d().Y1,{ref:x,direction:"horizontal",gap:1,align:"center-left",children:[R.map((r=>{const a=e.get(r),o=(null==a?void 0:a.length)??0;return(0,I.jsx)(mr,{sourceType:r,sourceLabel:k.get(r),count:o,isSelected:r===t,onChange:n,tabListId:p},r)})),D.length>0?(0,I.jsx)(vr,{moreButtonRef:M,tabListId:p,overflowSourceTypes:D,sourceTypeToLabel:k,selectedSourceType:t,onChange:n,agentSearchResultsBySourceType:e,showConnectMore:y,onConnectMore:S}):y?(0,I.jsx)(yr,{onConnectMore:S}):null]})})})}const fr=60;const mr=(0,r.memo)((function({sourceType:e,sourceLabel:t,count:n,isSelected:a,onChange:o,tabListId:i}){const s=(0,nr().dM)(e),l=(0,r.useCallback)((()=>{o(e)}),[o,e]);return(0,I.jsx)(hr,{tabListId:i,isSelected:a,onClick:l,children:(0,I.jsxs)(d().Y1,{direction:"horizontal",gap:8,align:"center",children:[s?(0,I.jsx)(tr().$x,{iconGroup:s,iconSize:"sm"}):null,(0,I.jsx)(T().D,{styleKey:"bodyRegular",colorVariant:a?"primary":"secondary",children:t}),(0,I.jsx)(T().D,{styleKey:"captionMedium",colorVariant:a?"secondary":"tertiary",children:n})]})})}));function hr({tabListId:e,isSelected:t,onClick:n,children:r}){const{isTabbable:a,itemRef:o,onKeyDown:i,onFocus:s}=(0,ar().e)(),d=(0,l().IS)((()=>({button:{...t&&{background:f().Tj.background.tertiaryTranslucent}}})),[t]);return(0,I.jsx)(C().p,{ref:o,size:"lg",shape:"pill",onClick:n,onKeyDown:i,onFocus:s,style:d.button,"aria-selected":t,"aria-controls":e,role:"tab",disallowTabbing:!a,children:r})}function yr({onConnectMore:e}){const t=(0,g().tz)().formatMessage({id:"AgentSearchSourcePicker.connectMoreTabLabel",defaultMessage:"Connect apps"});return(0,I.jsx)(E().m,{placement:"top",renderTooltip:()=>t,render:t=>(0,I.jsx)(C().p,{size:"lg",shape:"pill",onClick:e,...t,children:(0,I.jsx)(j().I,{icon:Ot().plusSmallIcon,size:"sm"})})})}function vr({tabListId:e,overflowSourceTypes:t,sourceTypeToLabel:n,selectedSourceType:r,onChange:a,agentSearchResultsBySourceType:o,showConnectMore:i,onConnectMore:s,moreButtonRef:l}){return(0,I.jsx)(ir().A,{alignmentToOrigin:"start",placementToOrigin:"bottom",originGap:4,popupType:ir().z.Popup,renderOrigin:n=>(0,I.jsx)("div",{ref:l,children:(0,I.jsx)(hr,{tabListId:e,isSelected:!1,onClick:()=>n.onClick(),children:(0,I.jsxs)(d().Y1,{direction:"horizontal",gap:8,align:"center",children:[(0,I.jsx)(T().D,{styleKey:"bodyRegular",colorVariant:"secondary",children:(0,I.jsx)(g().sA,{id:"AgentSearchSourcePicker.more",defaultMessage:"More"})}),(0,I.jsx)(T().D,{styleKey:"captionMedium",colorVariant:"tertiary",children:t.length})]})})}),render:()=>(0,I.jsx)(lr().A,{menuType:sr().gu.Popup,width:220,children:(0,I.jsxs)(Gt().A,{children:[t.map((e=>(0,I.jsx)(Sr,{sourceType:e,sourceLabel:n.get(e),agentSearchResultsBySourceType:o,selectedSourceType:r,onSelect:()=>{a(e)}},e))),i?(0,I.jsx)(Ht().A,{focused:!1,onClick:()=>{s()},icon:(0,I.jsx)(j().I,{size:"sm",colorVariant:"secondary",icon:Ot().plusSmallIcon}),title:(0,I.jsx)(g().sA,{id:"AgentSearchSourcePicker.connectMore",defaultMessage:"Connect apps"})}):null]})})})}function Sr({sourceType:e,sourceLabel:t,agentSearchResultsBySourceType:n,selectedSourceType:r,onSelect:a}){const o=n.get(e),i=(null==o?void 0:o.length)??0,s=(0,nr().dM)(e);return(0,I.jsx)(Ht().A,{focused:!1,onClick:a,icon:s?(0,I.jsx)(tr().$x,{iconGroup:s,iconSize:"sm"}):void 0,title:t,right:i>0?(0,I.jsx)(T().D,{styleKey:"captionRegular",colorVariant:"tertiary",children:i}):void 0,isChecked:e===r})}var xr=()=>n(79926),br=()=>n(680474);const Ir=2500,wr=450;function Mr({items:e}){const{value:t}=(0,xr().fJ)(br().fM),[n,a]=(0,r.useState)((()=>{var t;return(null===(t=e[0])||void 0===t?void 0:t.key)??null})),o=(0,r.useRef)(e);(0,r.useEffect)((()=>{o.current=e}),[e]),(0,r.useEffect)((()=>{0!==e.length?a((t=>{var n;return t&&e.some((e=>e.key===t))?t:(null===(n=e[0])||void 0===n?void 0:n.key)??null})):a(null)}),[e]),(0,r.useEffect)((()=>{if("undefined"==typeof window)return;if(e.length<=1)return;const t=window.setInterval((()=>{a((e=>{var t;const n=o.current;if(0===n.length)return null;const r=e?n.findIndex((t=>t.key===e)):-1;return(null===(t=n[r>=0&&r<n.length-1?r+1:0])||void 0===t?void 0:t.key)??null}))}),Ir);return()=>{window.clearInterval(t)}}),[e.length]);const i=(0,l().IS)((()=>({span:{pointerEvents:"none",textOverflow:"ellipsis",whiteSpace:"nowrap",overflow:"hidden"}})),[]),s=(n?e.find((e=>e.key===n)):void 0)??e[0];if(!s)return null;if(!t)return(0,I.jsx)("span",{style:i.span,children:s.text});const{AnimatePresence:d,motion:c}=t;return(0,I.jsx)(d,{mode:"popLayout",initial:!1,children:(0,I.jsx)(c.span,{initial:{y:16,opacity:0},animate:{y:0,opacity:1},exit:{y:-16,opacity:0},transition:{duration:wr/1e3,ease:[.4,0,.2,1]},style:i.span,children:s.text},s.key)})}function jr(e){const t=(0,i().v3)(),n=(0,D().L)(),o=(0,g().tz)(),{bodyStyleKey:m}=(0,k().yq)(),h=(0,a().X)("agent_search_cohere_ranking"),{toolResultStep:v,threadStore:S,clientStore:x,runningInference:b,isLastTurn:w,aiChatFeatureController:M,onExpandedChange:j,queryGenSteps:C,hideIcon:A=!1}=e,R=null==v?void 0:v.id,U=null==v?void 0:v.traceId,P=(0,r.useMemo)((()=>{const e=[],t=new Set;return null==C||C.forEach((n=>{n.queries.forEach(((r,a)=>{const o=(r.questionIntl??r.question??r.keywords).trim();o&&!t.has(o)&&(t.add(o),e.push({key:`${n.id}-${a}`,text:o}))}))})),e}),[C]),B=(0,r.useMemo)((()=>{try{return x.getOrCreateClientAIChatThreadStore(S.id)}catch(e){return null}}),[x,S.id]),F=(0,s().K8)((()=>{var e;if(!R||!B)return;const t=null===(e=B.state.agentSearchResultsByToolResultStepId)||void 0===e?void 0:e[R];return null==t?void 0:t.results}),[B,R]),[E,V]=(0,r.useState)(void 0),L=(0,r.useRef)(null),N=(0,s().uB)(void 0,er().D);(0,Zn().c2)({containerRef:L,citationHoverStore:N,parentStore:n,evaluatorState:void 0});const O=(0,he().I)({runningInference:b,toolResultStep:v,isLastTurn:w}),_=Boolean(v&&(0,p().I6)(v)),K=(0,r.useMemo)((()=>{const e=new Map;if(!v||!(0,c().gY)(v,"search"))return e;const t=(0,nr().iY)({isCohereRankingEnabled:h,resultStep:v,overrideResults:F});if(h&&t.size>1){const n=(0,nr().w_)(t);e.set("top-results",n)}for(const[n,r]of t)e.set(n,r);return e}),[h,v,F]),z=Array.from(K.keys());(0,r.useEffect)((()=>{const e=z[0];e&&!E&&V(e)}),[K,E,z]);const q=(0,r.useMemo)((()=>E?K.get(E)??[]:[]),[K,E]),$=(0,r.useMemo)((()=>q.reduce(((e,t)=>(e[t.id]=t,e)),{})),[q]),Y=(0,nr().be)({citationContext:$}),W=(0,r.useMemo)((()=>{let e=0;for(const t of K.values())e+=t.length;return e}),[K]),H=(0,s().K8)((()=>{if(!n)return[];let e=new Set;var r;v&&(0,c().gY)(v,"search")&&(e=new Set((null===(r=v.result)||void 0===r||null===(r=r.extractedResults)||void 0===r?void 0:r.map((e=>e.id)))??[]));return q.map(((e,r)=>{const a=(0,nr().eL)({index:r,result:e,environment:t,spaceStore:n,hoverStore:N,threadStore:S,showUsedByLLM:false});return a?{menuItem:a,result:e,position:r}:void 0})).filter(u().O9).map((({menuItem:e,result:n,position:r})=>({...e,action:a=>{var o;return ie().trackAgentSearchResultClicked({environment:t,threadStore:S,resultId:n.id,searchSourceType:n.searchSourceType,source:"search_results",position:r,traceId:U,stepId:R}),null===(o=e.action)||void 0===o?void 0:o.call(e,a)}})))}),[q,t,n,N,S,U,R,v,x]),G=(0,r.useMemo)((()=>0===H.length?[]:[{key:`search-results-${E}`,render:e=>(0,I.jsx)(Gt().A,{...e}),items:H}]),[H,E]),X=G.length>0,Q=(0,s().uB)(void 0,At().$),Z=v?(0,p().rk)(v):void 0,J=De({toolName:"search",state:"confirmation:rejected"===Z?"reverted":O||_?"loading":"done",numResults:W,intl:o,isMultiDatabaseMode:!1,toolResultStep:v}),ee=(0,r.useMemo)((()=>{var e,t,n,r;if(v&&(0,c().gY)(v,"search")&&v.input)return null!==(e=v.input)&&void 0!==e&&null!==(e=e.default)&&void 0!==e&&e.questions.length?v.input.default.questions[0]:null!==(t=v.input)&&void 0!==t&&null!==(t=t.internal)&&void 0!==t&&t.questions.length?v.input.internal.questions[0]:null!==(n=v.input)&&void 0!==n&&null!==(n=n.web)&&void 0!==n&&n.queries.length?v.input.web.queries[0]:null!==(r=v.input)&&void 0!==r&&null!==(r=r.users)&&void 0!==r&&r.queries.length?v.input.users.queries[0]:void 0}),[v]),te=Boolean(ee&&ee.length>0),ne=o.formatMessage({id:"agentSearchToolUsePart.toolNameMessage",defaultMessage:"{toolName} for"},{toolName:J}),re=(0,r.useMemo)((()=>{if(P.length>0)return P;const e=null==ee?void 0:ee.trim();return e?[{key:`fallback-${R??"query"}`,text:e}]:[]}),[P,ee,R]),ae=(0,r.useMemo)((()=>(0,I.jsx)(En().n,{title:te?ne:J,titleSuffix:te?`"${ee}"`:void 0,subtitle:void 0,hasUndoneOperations:!1,state:Z})),[te,ee,J,ne,Z]),oe=v&&(0,p().nP)(v)?X&&W>0:void 0,se=(0,r.useMemo)((()=>X&&E&&n?(0,I.jsxs)(I.Fragment,{children:[K.size>1?(0,I.jsx)(gr,{agentSearchResultsBySourceType:K,selectedSourceType:E,onChange:V,aiChatFeatureController:M}):null,(0,I.jsxs)(Hn().K,{from:"AgentSearchToolUsePart",fallback:({errorId:e,error:t})=>(0,I.jsx)(Gn().LargeSurfaceRenderError,{errorId:e,error:t}),children:[(0,I.jsx)(Xn()._,{type:jt().A.Y,style:{maxHeight:200},children:(0,I.jsx)(kt().A,{type:kt().O.Vertical,initialFocus:void 0,resetFocusOnMouseOut:!0,sections:G,store:Q,disableKeyboard:!0})}),(0,I.jsx)(Jn().cE,{containerRef:L,hoverStore:N,parentStore:n,isSearchChat:!1,getPayloadDataForHref:Y})]})]}):null),[K,X,Q,G,E,V,n,N,Y,M]),le=(0,r.useCallback)((e=>{U&&ie().trackAgentSearchStepToggleResults({environment:t,threadStore:S,traceId:U,showResults:e,from:"agent_search_tool_use"}),null==j||j(e)}),[t,S,U,j]),de=(0,l().IS)((()=>({titleContainer:{flex:1,minWidth:0,overflow:"hidden"},resultWrapper:{borderRadius:10,overflow:"hidden",boxShadow:`0 0 0 1px ${f().Tj.border.secondary}, 0px 1px 2px rgba(0, 0, 0, 0.04)`,transition:"box-shadow 0.15s ease-in-out"}})),[]);return n?v&&(0,he().eb)(v)?(0,I.jsx)(Ne,{toolName:"search",variant:"agent_mobile"===M.aiChatType?"large":"default"}):!O||_||X||0!==W?0===W?null:(0,I.jsx)(xt,{isExpandable:oe??!1,icon:Qn().magnifyingGlassSmallIcon,onExpandedChange:le,hideIcon:A,title:(0,I.jsxs)(d().Y1,{direction:"horizontal",gap:4,align:"center",children:[(0,I.jsx)(T().D,{styleKey:m,style:{marginInlineEnd:4},children:(0,I.jsx)(g().sA,{id:"agentSearchToolUsePart.searchResultsCount",defaultMessage:"{count} results",values:{count:W>=99?"99+":W}})}),(0,I.jsx)(Cr,{sourceTypes:z})]}),content:(0,I.jsxs)("div",{style:de.resultWrapper,ref:L,children:[(0,I.jsx)("div",{style:{...de.titleContainer,paddingTop:12,paddingBottom:4,paddingInlineEnd:14,paddingInlineStart:14},children:ae}),se]}),variant:"agent_mobile"===M.aiChatType?"large":"default"}):(0,I.jsx)("div",{children:(0,I.jsx)(y().c,{message:te&&0===re.length?`${ne} "${ee}"`:J,animationType:"scrolling-squiggle",children:re.length>0?(0,I.jsx)(Mr,{items:re}):null})}):null}function Cr({sourceTypes:e}){return(0,I.jsx)(I.Fragment,{children:e.filter((e=>"top-results"!==e)).map((e=>{const t=(0,nr().dM)(e);return t?(0,I.jsx)(tr().$x,{iconGroup:t,iconSize:"xs"},e):null}))})}function Tr(e){const{partData:t,aiChatFeatureController:n,threadStore:a,clientStore:o,runningInference:s,isLastTurn:l,turnSteps:d,blurOnExpand:c,hideIcons:p=!1,onFollowUpSelect:f}=e,m=(0,i().v3)(),h=(0,r.useCallback)((e=>{c&&e&&(0,ne().I)({environment:m})}),[c,m]);switch(t.type){case"thinking":return(0,I.jsx)(wt,{thinkingPartData:t,aiChatFeatureController:n,onExpandedChange:h,runningInference:s,hideIcon:p});case"chat":return(0,I.jsx)(ae,{chatPartData:t,aiChatFeatureController:n,turnSteps:d,threadStore:a});case"search-tool-use":return(0,I.jsx)(jr,{toolResultStep:t.toolResultStep,threadStore:a,clientStore:o,runningInference:s,isLastTurn:l,aiChatFeatureController:n,onExpandedChange:h,queryGenSteps:t.queryGenSteps,hideIcon:p});case"follow-ups":return(0,I.jsx)(fe,{partData:t,onFollowUpSelect:f,isLastTurn:l,threadId:a.id,threadStore:a});case"tool-use":return(0,I.jsx)(Kn,{stepId:t.step.id,toolName:t.toolName,toolResultStep:t.toolResultStep,toolUse:t.toolUse,threadStore:a,runningInference:s,aiChatFeatureController:n,isLastTurn:l,onExpandedChange:h,forceExpanded:e.forceExpanded,hideIcon:p});case"mcp-tool-use":{const e=(d??[]).filter((e=>"workflow-effect-calling"===e.type||"workflow-effect-called"===e.type||"workflow-effect-error"===e.type));return(0,I.jsx)(ft,{mcpToolUsePartData:t,threadStore:a,runningInference:s,aiChatFeatureController:n,turnSteps:e,onExpandedChange:h})}case"custom-agent-template-picker":return(0,I.jsx)(Wn,{threadStore:a});case"database-agent-setup":case"database-agent-running":case"database-agent-status":return(0,I.jsx)(g().sA,{defaultMessage:"Unsupported step type",id:"aiChatTranscript.unsupportedDBAgentStepType"});default:(0,u().HB)(t)}}const kr=new Set(["revert","calendar.fetchPlaybook","enter-setup-mode"]),Ar=new Set(["MAIL_ACCOUNT_NOT_CONNECTED"]);function Rr(e){if("tool-use"===e.type){if(kr.has(e.toolName))return!1;if(e.toolResultStep&&(0,he().eb)(e.toolResultStep))return!(!e.toolResultStep.errorCode||!Ar.has(e.toolResultStep.errorCode))}return"mcp-tool-use"!==e.type||!e.toolResultStep||!(0,he().eb)(e.toolResultStep)}function Dr(e){return!Rr(e)}function Ur(e){const{parts:t,turn:n,threadStore:o,spaceStore:i,clientStore:s,aiChatFeatureController:u,isLastTurn:m,runningInference:v,isRunning:S=!1,onFollowUpSelect:x,expandByDefault:b=!1}=e,[w,M]=(0,r.useState)(b),j=(0,g().tz)(),{bodyStyleKey:C}=(0,k().yq)(),A=(0,a().X)("agent_multidb_creation"),R=!(0,a().X)("agent_diffs"),D=(0,r.useId)(),U=(0,l().IS)((()=>({summaryContainer:{cursor:"pointer",padding:"0 4px",borderRadius:6,display:"flex",alignItems:"center",gap:6,userSelect:"none"},summary:{overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},listContainer:{marginInlineStart:7,paddingInlineStart:S&&w?14:0},itemWrapper:{position:"relative",paddingInlineStart:16},dot:{position:"absolute",insetInlineStart:0,top:7,width:6,height:6,borderRadius:"50%",backgroundColor:f().Tj.background.accentSecondary},connectingLine:{position:"absolute",insetInlineStart:2.5,top:17,width:1,height:"calc(100% - 2px)",backgroundColor:f().Tj.border.primary},chevron:{flexShrink:0,transition:"transform 150ms ease-in-out",transform:w?"rotate(90deg)":"rotate(0deg)",fill:f().Tj.icon.tertiary}})),[w,S]),[P,B]=(0,r.useState)(!1);(0,r.useEffect)((()=>{b&&M(!0)}),[b]);const F=(0,r.useCallback)((()=>{M((e=>!e))}),[]),E=(0,r.useCallback)((()=>{B(!0)}),[]),V=(0,r.useCallback)((()=>{B(!1)}),[]),L=(0,r.useCallback)((e=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),F())}),[F]),N=(0,r.useMemo)((()=>{var e;return function(e){const{parts:t,state:n,intl:r,isMultiDatabaseMode:a,spaceId:o,stepId:i}=e,s=[];for(const p of t)if("tool-use"===p.type||"search-tool-use"===p.type){if(!Rr(p))continue;s.push(p)}if("done"===n&&t.length>0){const e=t.filter(Rr);return r.formatMessage({id:"generateTurnSummary.workedForSteps",defaultMessage:(0,g().LS)("count",{one:"{count} step",other:"{count} steps"})},{count:e.length})}if(0===s.length)return r.formatMessage((0,y().U)(i));const l=s.filter((e=>!e.isFinished));if(0===l.length)return r.formatMessage((0,y().U)(i));const d=new Set;for(const p of l){const e="search-tool-use"===p.type?"search":p.toolName;d.add(e)}if(d.size>1)return r.formatMessage((0,y().U)(i));const c=Array.from(d)[0],u=l[0];return De({toolName:c,state:"loading",numResults:1,intl:r,isMultiDatabaseMode:a,toolResultStep:u.toolResultStep,toolUse:u.toolUse,includeToolNoun:!0})}({parts:t,state:S?"loading":"done",intl:j,isMultiDatabaseMode:A,spaceId:i.id,stepId:null===(e=n.steps[0])||void 0===e?void 0:e.id})}),[S,t,A,j,i.id,n.steps]),O=(0,r.useMemo)((()=>{if(!S)return[];const e=[],n=new Set;for(const r of t)if("search-tool-use"===r.type&&!r.isFinished)for(const t of r.queryGenSteps)for(let a=0;a<t.queries.length;a++){const o=t.queries[a],i=(o.questionIntl??o.question??o.keywords).trim();i&&!n.has(i)&&(n.add(i),e.push({key:`${r.key}-${t.id}-${a}`,text:i}))}return e}),[S,t]),_=(0,r.useMemo)((()=>{if(S&&1===t.length&&"thinking"===t[0].type)return t[0].content}),[S,t]),K=_&&S&&!w,z=(0,r.useMemo)((()=>t.filter((e=>{if("tool-use"===e.type){if(!e.toolResultStep)return!1;const t=e.toolResultStep;return!!(!(0,p().I6)(t)&&!(0,p().dB)(t)&&!(0,he().eb)(t)&&c().MV.some((e=>e===t.toolName)))}return!1}))),[t]),q=(0,r.useMemo)((()=>t.filter((e=>{if("tool-use"===e.type){const t=e.toolResultStep;return"MAIL_ACCOUNT_NOT_CONNECTED"===(null==t?void 0:t.errorCode)}return!1}))),[t]),$=(0,r.useMemo)((()=>{const e=t.filter((e=>!Dr(e)));return 0!==e.length&&e.every((e=>{if("tool-use"===e.type){if(!e.toolResultStep)return!1;const t=e.toolResultStep;return!(0,p().I6)(t)&&!(0,p().dB)(t)&&!(0,he().eb)(t)&&c().MV.some((e=>e===t.toolName))}return!1}))}),[t]),Y=(0,r.useMemo)((()=>t.filter(Rr)),[t]),W=Y.length,H=$&&R,X=P?"primary":"secondary";if(0===W&&!S)return null;if(1===W&&!S){const e=Y[0];return(0,I.jsx)(h().uQ,{step:e.step,threadStore:o,clientStore:s,children:(0,I.jsx)(Tr,{partData:e,threadStore:o,clientStore:s,spaceStore:i,aiChatFeatureController:u,runningInference:v,isLastTurn:m,turnSteps:n.steps,blurOnExpand:u.supportsBlurOnToolExpand,hideIcons:!1,onFollowUpSelect:x})})}return(0,I.jsxs)(I.Fragment,{children:[H?null:(0,I.jsx)(G,{contentId:D,origin:(0,I.jsx)("div",{role:"button",tabIndex:0,"aria-expanded":w,"aria-controls":D,style:U.summaryContainer,onClick:F,onKeyDown:L,onMouseEnter:E,onMouseLeave:V,children:S?(0,I.jsx)(y().c,{message:N,animationType:"scrolling-squiggle",children:O.length>0?(0,I.jsx)(Mr,{items:O}):null}):(0,I.jsxs)(I.Fragment,{children:[(0,I.jsx)(vt().Q,{iconGroup:St,variantName:"small",style:U.chevron}),(0,I.jsx)(T().D,{styleKey:C,colorVariant:X,style:U.summary,children:N})]})}),content:(0,I.jsx)("div",{style:U.listContainer,children:(0,I.jsx)(d().Y1,{direction:"vertical",gap:12,children:t.filter((e=>!Dr(e))).map(((e,t,r)=>{const a=t===r.length-1;return(0,I.jsxs)("div",{style:U.itemWrapper,children:[(0,I.jsx)("div",{style:U.dot}),a?null:(0,I.jsx)("div",{style:U.connectingLine}),(0,I.jsx)(h().uQ,{step:e.step,threadStore:o,clientStore:s,children:(0,I.jsx)(Tr,{partData:e,threadStore:o,clientStore:s,spaceStore:i,aiChatFeatureController:u,runningInference:v,isLastTurn:m,turnSteps:n.steps,blurOnExpand:u.supportsBlurOnToolExpand,hideIcons:!0,onFollowUpSelect:x})})]},`${e.step.id}-${e.key}`)}))})}),isExpanded:w}),K&&_?(0,I.jsx)(It,{content:_,paddingInlineStart:32}):null,H||!w&&!S&&z.length>0&&R?(0,I.jsx)(d().Y1,{direction:"vertical",gap:12,children:z.map((e=>(0,I.jsx)(h().uQ,{step:e.step,threadStore:o,clientStore:s,children:(0,I.jsx)(Tr,{partData:e,threadStore:o,clientStore:s,spaceStore:i,aiChatFeatureController:u,runningInference:v,isLastTurn:m,turnSteps:n.steps,blurOnExpand:u.supportsBlurOnToolExpand,hideIcons:!1,onFollowUpSelect:x})},`${e.step.id}-${e.key}`)))}):null,!w&&!S&&q.length>0?(0,I.jsx)(d().Y1,{direction:"vertical",gap:12,children:q.map((e=>(0,I.jsx)(h().uQ,{step:e.step,threadStore:o,clientStore:s,children:(0,I.jsx)(Tr,{partData:e,threadStore:o,clientStore:s,spaceStore:i,aiChatFeatureController:u,runningInference:v,isLastTurn:m,turnSteps:n.steps,blurOnExpand:u.supportsBlurOnToolExpand,hideIcons:!1,onFollowUpSelect:x})},`${e.step.id}-${e.key}`)))}):null]})}function Pr(e){const{toolResultsForStep:t,hasMoreAgentSteps:n,isLastTurn:r,runningInference:a}=e;return t.length>0&&t.every(p().nP)&&!n&&r&&a&&!t.some(p().I6)}function Br(e){const{turn:t,threadStore:n,spaceStore:r,aiChatFeatureController:a,items:o,blurOnExpand:i,clientStore:s,isLastTurn:l,runningInference:u,forceExpandUndoableTools:p,hidePartIcons:g,itemGap:f,onFollowUpSelect:m}=e,h=o,y=f??20,v=g??!1;return(0,I.jsx)(d().Y1,{direction:"vertical",gap:y,children:h.map(((e,o)=>{const d=p&&"tool-use"===e.type&&e.toolResultStep&&c().MV.includes(e.toolName);return(0,I.jsx)(Tr,{partData:e,threadStore:n,clientStore:s,spaceStore:r,aiChatFeatureController:a,runningInference:u,isLastTurn:l,turnSteps:t.steps,blurOnExpand:i,forceExpanded:d,hideIcons:v,onFollowUpSelect:m},`${e.step.id}-${o}`)}))})}const Fr=(0,g().YK)({newPlanTitle:{id:"aiInferenceTranscript.agentTodoList.newPlanTitle",defaultMessage:"New plan"},updatedPlanTitle:{id:"aiInferenceTranscript.agentTodoList.updatedPlanTitle",defaultMessage:"Updated plan"},finishedPlanTitle:{id:"aiInferenceTranscript.agentTodoList.finishedPlanTitle",defaultMessage:"Finished plan"}});function Er(e){const{todos:t}=e,{bodyStyleKey:r}=(0,k().yq)();if(0===t.length)return null;const a=function(e){return e.every((e=>"done"===e.status))?Fr.finishedPlanTitle:e.every((e=>"pending"===e.status))?Fr.newPlanTitle:Fr.updatedPlanTitle}(t);return(0,I.jsxs)(d().Y1,{direction:"vertical",gap:6,width:"fill",children:[(0,I.jsx)(d().Y1,{direction:"horizontal",align:"center-left",width:"fill",padding:"0 0 0 32px",children:(0,I.jsx)(T().D,{styleKey:"bodySmSemibold",colorVariant:"secondary",children:(0,I.jsx)(g().sA,{...a})})}),t.map(((e,t)=>{const a="done"===e.status,o="in_progress"===e.status,i=a?n(833243).checkmarkCircleSmallIcon:n(216296).circleIcon,s=e.text.trim()||e.text,l=a?{textDecoration:"line-through"}:o?{fontWeight:600}:void 0;return(0,I.jsxs)(d().Y1,{direction:"horizontal",gap:8,align:"center-left",width:"fill",children:[(0,I.jsx)("div",{style:{display:"flex",alignItems:"center",justifyContent:"center",height:q().SCROLLING_SQUIGGLE_DEFAULTS.height,width:q().SCROLLING_SQUIGGLE_DEFAULTS.width,flexShrink:0},children:(0,I.jsx)(j().I,{icon:i,colorVariant:"tertiary"})}),(0,I.jsx)(T().D,{styleKey:r,colorVariant:"secondary",style:l,children:s})]},e.id??`${e.text}-${t}`)}))]})}var Vr=()=>n(399613),Lr=()=>n(919515);function Nr(){return(0,l().IS)((()=>({wrapper:{boxShadow:f().Tj.shadow2XS,borderRadius:10,backgroundColor:f().Tj.background.elevated,padding:"10px 12px"}})),[])}function Or(e){const{resultStepIdsToConfirm:t}=e,{confirmToolUse:n,rejectToolUse:a}=(0,ve().Mp)(),o=Nr(),l=(0,i().v3)(),c=(0,rr().r)(),u=(0,r.useCallback)((()=>{n(t)}),[n,t]),p=(0,r.useCallback)((()=>{a(t)}),[a,t]),f=(0,r.useCallback)((()=>{c&&(Lr().Ci.setState({...Lr().Ci.state,analyticsFrom:"chat_menu",forceShowAuthNotificationTriggeredAt:void 0}),(0,Vr().t)({connector:"salesforce",environment:l,spaceId:c,analyticsProperties:{buttonName:"user_auth_connect",analyticsFrom:"chat_menu"}}))}),[l,c]),m=(0,s().K8)((()=>"pending"===Lr().Ci.state.userAuthStatus),[]);return(0,I.jsxs)(d().Y1,{direction:"horizontal",gap:8,width:"fill",align:"top-left",style:o.wrapper,children:[(0,I.jsx)(j().I,{icon:zt().salesforceIcon,size:"default"}),(0,I.jsxs)(d().Y1,{direction:"vertical",width:"fill",gap:0,children:[(0,I.jsx)(T().D,{styleKey:"bodyMedium",colorVariant:"primary",children:m?(0,I.jsx)(g().sA,{id:"AgentSalesforceToolUseConfirmation.title",defaultMessage:"Connect your Salesforce account"}):(0,I.jsx)(g().sA,{id:"AgentSalesforceToolUseConfirmation.connectedTitle",defaultMessage:"Salesforce connected"})}),(0,I.jsx)(Oe().N,{styleKey:"bodyRegular",colorVariant:"secondary",text:m?(0,I.jsx)(g().sA,{id:"AgentSalesforceToolUseConfirmation.description",defaultMessage:"Connect to Salesforce for advanced querying and higher quality results."}):(0,I.jsx)(g().sA,{id:"AgentSalesforceToolUseConfirmation.connectedDescription",defaultMessage:"Continue to continue your query."}),animate:!0}),(0,I.jsx)(d().Y1,{direction:"horizontal",gap:8,width:"hug",padding:"8px 0 0 0",children:m?(0,I.jsxs)(I.Fragment,{children:[(0,I.jsx)(oe().E,{onClick:p,children:(0,I.jsx)(g().sA,{id:"AgentSalesforceToolUseConfirmation.cancel",defaultMessage:"Later"})}),(0,I.jsx)(Z().A,{onClick:f,colorPalette:"blue",children:(0,I.jsx)(g().sA,{id:"AgentSalesforceToolUseConfirmation.connect",defaultMessage:"Connect"})})]}):(0,I.jsx)(Z().A,{onClick:u,colorPalette:"blue",children:(0,I.jsx)(g().sA,{id:"AgentSalesforceToolUseConfirmation.continue",defaultMessage:"Continue"})})})]})]})}n(814603),n(147566),n(198721);var _r=()=>n(416783),Kr=()=>n(997274),zr=()=>n(108715);const qr="https://www.notion.com/help/notion-ai-security-practices";function $r(e){const{urls:t,onConfirm:n,onCancel:a}=e,[o,i]=(0,r.useState)(!1),s=(0,l().IS)((()=>({wrapper:{boxShadow:f().Tj.shadow2XS,borderRadius:10,backgroundColor:f().Tj.background.elevated,padding:"16px 20px"},description:{marginBottom:"2px"},urlContainer:{backgroundColor:f().Tj.background.secondary,borderRadius:"6px",padding:"0px 2px",wordBreak:"break-all"},urlText:{fontFamily:"monospace",fontSize:"13px",color:f().Tj.text.secondary,whiteSpace:"pre-wrap",...o?{}:{display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical",overflow:"hidden"}},showAllLink:{fontSize:"13px",marginTop:"-8px",marginBottom:"8px",display:"flex",justifyContent:"flex-end",width:"100%"},agentSecurityImage:{width:"32px",height:"32px"},learnMoreLink:{color:f().Tj.blue.text.accentPrimary},hostnameHighlight:{backgroundColor:f().Tj.yellow.background.secondaryTranslucent,padding:"2px 2px",borderRadius:"4px"}})),[o]),c=r.useMemo((()=>(0,x().sb)(t.map((e=>{try{return new URL(e).hostname}catch{return(0,Kr().xv)(e,50)}})))),[t]),u=r.useMemo((()=>c.map(((e,t)=>(0,I.jsxs)(r.Fragment,{children:[(0,I.jsx)("span",{style:s.hostnameHighlight,children:e}),t<c.length-1?", ":null]},t)))),[c,s.hostnameHighlight]),p=r.useMemo((()=>0===t.length?"":o?t.join("\n\n"):t[0]),[t,o]),m=t.length>1,h=p.length>120,y=m||h;return(0,I.jsxs)(d().Y1,{direction:"vertical",width:"fill",align:"top-left",style:s.wrapper,gap:8,children:[(0,I.jsx)("img",{src:zr(),alt:"Security",style:s.agentSecurityImage}),(0,I.jsx)(T().D,{styleKey:"bodyMedium",colorVariant:"primary",children:(0,I.jsx)(g().sA,{id:"UnsafeUrlConfirmationDialog.title",defaultMessage:"Do you trust {hostnames}?",values:{hostnames:u}})}),(0,I.jsx)(T().D,{styleKey:"bodyRegular",style:s.description,children:(0,I.jsx)(g().sA,{id:"UnsafeUrlConfirmationDialog.description",defaultMessage:"Allowing Notion AI to access untrusted URLs can be a security risk. {learnMoreLink}",values:{learnMoreLink:(0,I.jsx)(_r().V,{hoverColor:"blue",style:s.learnMoreLink,href:qr,external:!0,disableUnderline:!0,children:(0,I.jsx)(g().sA,{id:"unifiedChatFileConfirmationBanner.learnMore",defaultMessage:"Learn more"})})}})}),(0,I.jsx)("div",{style:s.urlContainer,children:(0,I.jsx)("div",{style:s.urlText,children:p})}),y?(0,I.jsx)("div",{style:s.showAllLink,children:(0,I.jsx)(_r().V,{onClick:()=>{i(!o)},hoverColor:"blue",color:f().Tj.text.secondary,disableUnderline:!0,children:o?(0,I.jsx)(g().sA,{id:"UnsafeUrlConfirmationDialog.showLess",defaultMessage:"Show less"}):(0,I.jsx)(g().sA,{id:"UnsafeUrlConfirmationDialog.showAll",defaultMessage:"Show all"})})}):void 0,(0,I.jsxs)(d().Y1,{direction:"horizontal",gap:12,children:[(0,I.jsx)(oe().E,{onClick:a,children:(0,I.jsx)(g().sA,{id:"UnsafeUrlConfirmationDialog.cancel",defaultMessage:"Cancel"})}),(0,I.jsx)(oe().E,{onClick:n,children:(0,I.jsx)(g().sA,{id:"UnsafeUrlConfirmationDialog.allowAccess",defaultMessage:"Allow access"})})]})]})}const Yr=(0,g().YK)({waitingForConfirmation:{id:"AgentToolUseFull.waitingForConfirmation",defaultMessage:"Do you want to continue?"},cancel:{id:"AgentToolUseFull.cancel",defaultMessage:"Reject"},deletePagesButton:{id:"AgentToolUseFull.deletePagesButton",defaultMessage:"Delete pages"},continueButton:{id:"AgentToolUseFull.continueButton",defaultMessage:"Continue"}});function Wr(e){const{resultStepIdsToConfirm:t,variant:n={type:"continue"}}=e,{confirmToolUse:a,rejectToolUse:o}=(0,ve().Mp)(),i=Nr(),s=(0,r.useCallback)((()=>{a(t)}),[a,t]),l=(0,r.useCallback)((()=>{o(t)}),[o,t]);return"potentiallyUnsafeUrl"===n.type?(0,I.jsx)($r,{urls:n.urls,onConfirm:s,onCancel:l}):"salesforceUserConnection"===n.type?(0,I.jsx)(Or,{resultStepIdsToConfirm:t}):(0,I.jsxs)(d().Y1,{direction:"horizontal",width:"fill",gap:"auto",align:"center",style:i.wrapper,children:[(0,I.jsx)(Oe().N,{styleKey:"bodyRegular",text:(0,I.jsx)(g().sA,{...Yr.waitingForConfirmation}),animate:!0}),(0,I.jsxs)(d().Y1,{direction:"horizontal",gap:8,width:"hug",children:[(0,I.jsx)(oe().E,{onClick:l,children:(0,I.jsx)(g().sA,{...Yr.cancel})}),"deletePages"===n.type?(0,I.jsx)(Z().A,{onClick:s,colorPalette:"red",children:(0,I.jsx)(g().sA,{...Yr.deletePagesButton})}):"continue"===n.type?(0,I.jsx)(Z().A,{onClick:s,colorPalette:"blue",children:(0,I.jsx)(g().sA,{...Yr.continueButton})}):null]})]})}var Hr=()=>n(148307),Gr=()=>n(85207),Xr=()=>n(704658);const Qr=(0,g().YK)({title:{id:"AgentUpsellStep.title",defaultMessage:"Youâ€™ve run out of free Notion AI"},subtitle:{id:"AgentUpsellStep.subtitle",defaultMessage:"Upgrade to continue using Notion AI to automate and simplify your work."},bannerImageAlt:{id:"AgentUpsellStep.bannerImageAlt",defaultMessage:"Image of a couple of hand drawn blocks"},minimalMessage:{id:"AgentUpsellStep.minimalMessage",defaultMessage:"Youâ€™ve run out of free Notion AI. <link>Upgrade</link>."}});function Zr(e){const{step:t,threadStore:n,minimal:r=!1}=e;return r?(0,I.jsx)(Jr,{...e}):(0,I.jsx)(ea,{threadStore:n,step:t})}function Jr(e){const t=(0,g().tz)(),n=(0,i().v3)(),{step:a}=e,{featureAvailability:o}=a,[s,d]=(0,r.useState)(!1),c=(0,r.useCallback)((()=>{(0,Gr().RV)({environment:n,upsellType:"upsell",isAssistantEnabled:!1,aiUpsell:o.upsell})}),[n,o.upsell]),u=(0,l().IS)((()=>({container:{display:"flex",alignItems:"center",paddingTop:8,paddingBottom:8,marginTop:1,paddingInline:8,borderRadius:6,cursor:"pointer",transition:"background-color 80ms ease-out",backgroundColor:s?f().Tj.background.tertiary:"transparent"},message:{fontSize:14,color:f().Tj.text.primary,lineHeight:1.4},link:{color:f().Tj.blue.text.accentPrimary,fontWeight:600}})),[s]);return(0,I.jsx)("div",{role:"button",tabIndex:0,style:u.container,onClick:c,onMouseEnter:()=>d(!0),onMouseLeave:()=>d(!1),onKeyDown:e=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),c())},children:(0,I.jsx)("span",{style:u.message,children:t.formatMessage(Qr.minimalMessage,{link:e=>(0,I.jsx)("span",{style:u.link,children:e})})})})}function ea(e){const t=(0,g().tz)(),{step:n,threadStore:r}=e,{featureAvailability:a}=n,o=(0,l().eP)(),{bodyStyleKey:i}=(0,k().yq)(),d=(0,k().Cd)(i),c=(0,s().K8)((()=>r.getSpaceStore()),[r]),u=(0,l().IS)((()=>({container:{paddingTop:0,paddingInline:20,paddingBottom:20,marginBottom:20,maxWidth:500},title:{fontSize:16,fontWeight:600,color:f().Tj.text.primary,marginBottom:8},subtitle:{...d,color:f().Tj.text.secondary,marginBottom:20,lineHeight:1.5},image:{width:100}})),[d]);return(0,I.jsxs)(b().Q,{style:u.container,children:[(0,I.jsx)("img",{style:u.image,alt:t.formatMessage(Qr.bannerImageAlt),src:"dark"===o?Hr().A.images.agent.upsellBannerDarkPng:Hr().A.images.agent.upsellBannerLightPng}),(0,I.jsx)("div",{style:u.title,children:(0,I.jsx)(g().sA,{...Qr.title})}),(0,I.jsx)("div",{style:u.subtitle,children:(0,I.jsx)(g().sA,{...Qr.subtitle})}),(0,I.jsx)(Xr().UpgradeButton,{source:"ai_agent",upsell:a.upsell,display:"primary",spaceStore:c})]})}function ta(e){return"chat"===e||"follow-ups"===e||"custom-agent-template-picker"===e}function na(e,t){if(ta(e.type))return!1;if("tool-use"===e.type&&"wait"===e.toolName)return!1;if("tool-use"===e.type&&"escalate"===e.toolName)return!1;if(!e.isFinished)return!1;if(("tool-use"===e.type||"search-tool-use"===e.type||"mcp-tool-use"===e.type)&&e.toolResultStep&&(0,p().I6)(e.toolResultStep))return!1;return!t.some(p().I6)}const ra=r.memo((function(e){const{turn:t,previousUserTurn:o,isLastTurn:v,configType:S,isCustomAgent:x,spaceStore:b,threadStore:j,clientStore:C,runningInference:T,showDebug:k,aiChatFeatureController:A,showAttribution:D,onFollowUpSelect:U,suppressThinkingAnimation:P=!1,stepGap:B=20}=e,F=A.supportsMinimalTranscript(),E=(0,r.useMemo)((()=>t.steps.some((e=>"agent-trigger"===e.type))),[t.steps]),V=(0,i().v3)(),L=(0,g().tz)(),N=(0,a().X)("agent_multidb_creation"),O=(0,a().X)("agent_simplified_transcript"),_=(0,a().X)("agent_diffs"),K=(0,r.useMemo)((()=>{const e=null==o?void 0:o.userInitiatedStep;return!!e&&(("user"===e.type||"user-injected"===e.type)&&e.userId===V.currentUser.id)}),[o,V.currentUser.id]),z=(0,r.useMemo)((()=>{const e=null==o?void 0:o.userInitiatedStep;if("agent-prebuilt-prompt"===(null==e?void 0:e.type))return e.promptType}),[o]),q=(0,a().X)("custom_agent_show_error_details")&&A.supportsDetailedError,[$,Y]=r.useState(!1),W=(0,r.useMemo)((()=>{for(const e of t.steps)if("agent-inference"===e.type)return!0;return!1}),[t.steps]),H=(0,r.useMemo)((()=>{const e=new Set;for(const n of t.steps)"agent-inference"===n.type&&e.add(n.id);return e}),[t.steps]),G=(0,l().IS)((()=>({agentTurn:{...k&&{boxShadow:"calc(var(--direction, 1) * -4px) 0 0 0 rgba(255,0,0,0.3)"},display:"flex",flexDirection:"column"},codeBlock:{padding:12,borderRadius:8,backgroundColor:f().Tj.codeBlockBackground}})),[k]),X=(0,r.useCallback)((()=>{Y(!0)}),[]),Z=(0,r.useCallback)((()=>{Y(!1)}),[]),{stepPartsByStepId:J,allParts:ne,allToolResults:re}=(0,n(560089).s)({turn:t,environment:V,spaceStore:b,threadStore:j,clientStore:C,runningInference:T,isMultiDatabaseMode:N,showDebug:k}),{renderableSteps:ae,renderableStepPartsByStepId:oe,renderableParts:ie}=(0,r.useMemo)((()=>function(e){const{renderMinimalTranscript:t,steps:n,stepPartsByStepId:r,allParts:a}=e;if(!t)return{renderableSteps:n,renderableStepPartsByStepId:r,renderableParts:a};const o=[],i=new Map,s=[];for(const l of n){if("premium-feature-unavailable"===l.type){o.push(l);continue}if("agent-inference"!==l.type)continue;const e=r.get(l.id);if(!e)continue;const t=e.filter((e=>"chat"===e.type||"custom-agent-template-picker"===e.type));0!==t.length&&(o.push(l),i.set(l.id,t),s.push(...t))}return{renderableSteps:o,renderableStepPartsByStepId:i,renderableParts:s}}({renderMinimalTranscript:F,steps:t.steps,stepPartsByStepId:J,allParts:ne})),[F,t.steps,J,ne]),se=(0,r.useMemo)((()=>!O||k?ae.map((e=>({type:"normal-step",step:e,key:`legacy-${e.id}`}))):function(e){const{steps:t,stepPartsByStepId:n,runningInference:r,isLastTurn:a}=e,o=new Set;for(const u of t)"agent-inference"===u.type&&o.add(u.id);const i=new Map;for(const u of t)if("agent-tool-result"===u.type&&u.agentStepId){const e=i.get(u.agentStepId)??[];e.push(u),i.set(u.agentStepId,e)}const s=[];let l,d=[];const c=()=>{d.length>0&&l&&(s.push({type:"collapsed-group",parts:d,key:`collapsed-${l}`}),d=[],l=void 0)};for(const u of t)if("agent-tool-result"!==u.type){if("agent-search-query-generation"!==u.type)if("agent-inference"!==u.type)c(),s.push({type:"normal-step",step:u,key:u.id});else{const e=n.get(u.id)??[],t=i.get(u.id)??[];for(const n of e)na(n,t)?(l||(l=n.key),d.push(n)):(c(),s.push({type:"standalone-part",part:n,key:n.key}))}}else if("runScript"!==u.toolType||u.agentStepId&&o.has(u.agentStepId)||(c(),s.push({type:"normal-step",step:u,key:u.id})),"update-todos"===u.toolType){r&&a&&(c(),s.push({type:"normal-step",step:u,key:u.id}));continue}if(c(),r&&a){let e=-1;for(let i=t.length-1;i>=0;i--){const r=t[i];if("agent-inference"===r.type&&(n.get(r.id)??[]).some((e=>ta(e.type)))){e=i;break}}const r=[],a=e=>"tool-use"===e.type&&"escalate"===e.toolName;if(e>=0)for(let i=e+1;i<t.length;i++){const e=t[i];if("agent-inference"===e.type){const t=n.get(e.id)??[];r.push(...t.filter((e=>!a(e))))}}else for(const i of t)if("agent-inference"===i.type){const e=n.get(i.id)??[];r.push(...e.filter((e=>!a(e))))}if(r.length>0&&!ta(r[r.length-1].type)){const t=e=>"standalone-part"===e.type&&"tool-use"===e.part.type&&"escalate"===e.part.toolName;if(e<0)return[...s.filter((e=>"normal-step"===e.type||t(e))),{type:"collapsed-group",parts:r,key:"running-view",isRunning:!0}];let n=s.length;for(let e=s.length-1;e>=0;e--){const t=s[e];if("standalone-part"===t.type&&ta(t.part.type)){n=e+1;break}}const a=s.slice(n).filter((e=>"normal-step"===e.type||t(e)));return[...s.slice(0,n),...a,{type:"collapsed-group",parts:r,key:"running-view",isRunning:!0}]}const o=s[s.length-1];"normal-step"===(null==o?void 0:o.type)&&s.push({type:"collapsed-group",parts:[],key:"running-view",isRunning:!0})}return s}({steps:ae,stepPartsByStepId:oe,runningInference:T,isLastTurn:v})),[O,ae,oe,T,v,k]),le=(0,r.useMemo)((()=>{var e;return"agent-trigger"===(null===(e=ae[0])||void 0===e?void 0:e.type)}),[ae]),de=(0,r.useMemo)((()=>se.map((e=>{if("collapsed-group"===e.type)return(0,I.jsx)(Ur,{parts:e.parts,isRunning:e.isRunning,turn:t,threadStore:j,spaceStore:b,clientStore:C,aiChatFeatureController:A,isLastTurn:v,runningInference:T,expandByDefault:le,onFollowUpSelect:U},e.key);if("standalone-part"===e.type){const n=e.part;return(0,I.jsx)(h().uQ,{step:n.step,threadStore:j,clientStore:C,children:(0,I.jsx)(Tr,{partData:n,threadStore:j,clientStore:C,spaceStore:b,aiChatFeatureController:A,runningInference:T,isLastTurn:v,turnSteps:t.steps,blurOnExpand:A.supportsBlurOnToolExpand,onFollowUpSelect:U})},n.key)}const r=e.step;if(!(W||"agent-tool-result"!==r.type||"runScript"!==r.toolType||r.agentStepId&&H.has(r.agentStepId)))return(0,I.jsx)(h().uQ,{step:r,threadStore:j,clientStore:C,children:(0,I.jsx)(Kn,{stepId:r.id,toolName:r.toolType,toolResultStep:r,threadStore:j,runningInference:T,aiChatFeatureController:A,isLastTurn:v})},r.id);if("agent-tool-result"===r.type&&(0,c().gY)(r,"update-todos")){var a;const e=(null===(a=r.result)||void 0===a?void 0:a.todos)??[];if(0===e.length)return;return(0,I.jsx)(h().uQ,{step:r,threadStore:j,clientStore:C,children:(0,I.jsx)(Er,{todos:e})},r.id)}if("agent-inference"===r.type){const e=oe.get(r.id)??[];if(0===e.length)return;return(0,I.jsx)(h().uQ,{step:r,threadStore:j,clientStore:C,children:(0,I.jsx)(Br,{step:r,turn:t,isLastTurn:v,runningInference:T,threadStore:j,spaceStore:b,aiChatFeatureController:A,items:e,blurOnExpand:A.supportsBlurOnToolExpand,clientStore:C,onFollowUpSelect:U})},r.id)}return"error"===r.type?(0,I.jsxs)(h().uQ,{step:r,threadStore:j,clientStore:C,children:[k?(0,I.jsx)(h().ze,{step:r}):(0,I.jsx)(n(807253).P,{errorStep:r,configType:"workflow"}),q?(0,I.jsx)("div",{style:G.codeBlock,children:(0,I.jsx)(m().O,{value:JSON.stringify(r,null,2),language:"json"})}):void 0]},r.id):"agent-debug-error"===r.type?(0,I.jsx)(h().uQ,{step:r,threadStore:j,clientStore:C,children:(0,I.jsx)(w,{step:r})},r.id):"agent-trigger"===r.type?(0,I.jsx)(h().uQ,{step:r,threadStore:j,clientStore:C,children:(0,I.jsx)(Q,{step:r,threadStore:j})},r.id):"agent-route-trigger"===r.type?(0,I.jsx)(h().uQ,{step:r,threadStore:j,clientStore:C,children:(0,I.jsx)(R,{step:r})},r.id):"eval-result"===r.type?(0,I.jsx)(h().uQ,{step:r,threadStore:j,clientStore:C,children:(0,I.jsx)(M,{step:r},r.id)},r.id):"premium-feature-unavailable"===r.type?(0,I.jsx)(h().uQ,{step:r,threadStore:j,clientStore:C,children:(0,I.jsx)(Zr,{threadStore:j,step:r,minimal:F})},r.id):"agent-tool-result"===r.type&&function(e,t){return e.insufficientPermissions&&!t.steps.some((t=>"agent-inference"===t.type&&t.id===e.agentStepId))}(r,t)?(0,I.jsx)(h().uQ,{step:r,threadStore:j,clientStore:C,children:(0,I.jsx)(kn,{toolName:r.toolType,toolResultStep:r,aiChatFeatureController:A})},r.id):k?(0,I.jsx)(h().uQ,{step:r,threadStore:j,clientStore:C},r.id):void 0})).filter(u().O9)),[se,t,oe,j,b,C,A,v,T,k,q,G.codeBlock,U,W,H,le,F]),ce=F&&v&&T&&0===de.length,ue=(0,r.useMemo)((()=>!F&&(v&&!t.hasAgentInferenceStep&&T&&!E)),[F,v,t.hasAgentInferenceStep,T,E]),pe=(0,r.useMemo)((()=>{if(F)return;if(O||!v||!T||!t.hasAgentInferenceStep)return;const e=t.steps.filter((e=>"agent-inference"===e.type));for(let t=e.length-1;t>=0;t--){const n=e[t];if(Pr({toolResultsForStep:re.filter((e=>e.agentStepId===n.id)),hasMoreAgentSteps:t<e.length-1,isLastTurn:v,runningInference:T}))return n.id}}),[F,re,v,O,T,t.hasAgentInferenceStep,t.steps]),{resultStepIdsToConfirm:ge,confirmationVariant:fe}=(0,r.useMemo)((()=>{const e=[];let t,n,r=0,a=!1;return re.filter((e=>(0,p().I6)(e))).filter((e=>"mcpServer.runTool"!==e.toolType)).forEach((n=>{if(e.push(n.id),n.threadOperations&&n.threadOperations.forEach((e=>{e.deletesPage&&r++})),n.pendingConfirmations){const e=n.pendingConfirmations.find((e=>"urlSafety"===e.type));e&&(t=e.urls)}"query-salesforce-tool"===n.toolType&&(a=!0)})),t?n={type:"potentiallyUnsafeUrl",urls:t}:r>0?n={type:"deletePages",pageCount:r}:a?n={type:"salesforceUserConnection"}:e.length>0&&(n={type:"continue"}),{resultStepIdsToConfirm:e,confirmationVariant:n}}),[re]),me=ge.length>0,he=K||E,ye=t.steps.filter((e=>"agent-inference"===e.type)).length,ve=(0,r.useMemo)((()=>{const e=t.steps.findLast((e=>"agent-inference"===e.type));return Array.isArray(null==e?void 0:e.value)&&!(null!=e&&e.value.some((e=>"tool_use"===e.type)))}),[t.steps]),Se=(0,s().K8)((()=>j.getConfig()),[j]);let xe;if(Se&&"workflow"===Se.type){xe=function(e,t){return e.enableScriptAgent?100:t?50:15}(Se,t.steps.some((e=>"agent-trigger"===e.type)))}const be=xe&&!ve&&ye>=xe,Ie=de.length>0||ue||ce,we=(0,s().K8)((()=>x&&(0,n(791256).SJ)(j)),[j,x]),Me=!F&&A.shouldShowActionsInStep&&!me&&(Ie||v)&&!we,je=(0,r.useMemo)((()=>!1),[F,_,v,ie]);return(0,I.jsxs)("div",{onMouseEnter:X,onMouseLeave:Z,style:G.agentTurn,children:[Ie&&D?(0,I.jsx)(n(119994).U,{type:"agent",workflowStore:void 0,displayName:L.formatMessage({id:"TranscriptAgentTurn.notionAI",defaultMessage:"Notion AI"}),gap:8}):null,Ie?(0,I.jsxs)(d().Y1,{direction:"vertical",gap:B,children:[de,ce?(0,I.jsx)("div",{style:{padding:"0 4px"},children:(0,I.jsx)(y().c,{message:(0,y().U)(t.previousStepId),animationType:P?"none":"scrolling-squiggle"})}):null,pe?(0,I.jsx)("div",{style:{padding:"0 4px"},children:(0,I.jsx)(y().c,{message:(0,y().U)(pe),animationType:P?"none":"scrolling-squiggle"})}):null,ue?(0,I.jsx)("div",{style:{padding:"0 4px"},children:(0,I.jsx)(y().c,{message:(0,y().U)(t.previousStepId),animationType:P?"none":"scrolling-squiggle"})}):null,!T&&!F&&me&&he?(0,I.jsx)(Wr,{resultStepIdsToConfirm:ge,variant:fe}):void 0,T||F||!be?void 0:(0,I.jsx)(ee,{threadStore:j,clientStore:C})]}):null,Me?(0,I.jsx)(n(105256).r,{isHovered:$,runningInference:T,turn:t,threadStore:j,configType:S,isCustomAgent:x,spaceStore:b,isLastTurn:v,parts:ie,threadId:j.id,previousUserPromptKey:z,variant:"agent_mobile"===A.aiChatType?"large":"default"}):void 0,je?(0,I.jsx)(te,{}):void 0]})}))},942143:(e,t,n)=>{n.d(t,{i:()=>m});n(581454);var r=()=>n(60481),a=()=>n(212497),o=()=>n(908006),i=()=>n(128933),s=()=>n(547033),l=()=>n(86159),d=()=>n(201980),c=()=>n(659602),u=()=>n(29554),p=()=>n(747674),g=()=>n(718957),f=()=>n(884107);async function m(e){const{environment:t,contentStores:n,textValue:m,parentStore:h,copiedMessageLabel:y}=e;if(n&&n.length>0){const[e,a]=await Promise.all([f().R.clipboardActions.load(),c().g.load()]),i=n.map((e=>e.getBlockTitleStore())),u=i[0],m=i[i.length-1];if(u&&m){const e=d().AhH(m.getValue()||[]),a=(0,g().hn)({store:u,index:0},{store:m,index:e});(0,s().setMultiSelection)({multiSelection:a}),(0,p().t)({environment:t,stores:n,phase:r().o.Editing,pivot:n[0]})}else(0,p().t)({environment:t,stores:n});await o().default.afterNextFlush(),await async function(e){const{environment:t,clipboardActions:n,markdownLinkifyIt:r}=e;if(!t.device.isSafari)return void(await n.copySelectionToClipboard({environment:t,markdownLinkifyIt:r}));if(!document.queryCommandSupported("copy"))return void(await n.copySelectionToClipboard({environment:t,markdownLinkifyIt:r}));const a=document.createElement("span");a.textContent="â€‹",a.style.position="fixed",a.style.opacity="0",a.style.pointerEvents="none",a.style.userSelect="auto",document.body.appendChild(a);const o=e=>{var a;null===(a=e.stopImmediatePropagation)||void 0===a||a.call(e),n.copy({environment:t,event:e,disableSyncTextSelection:!0,markdownLinkifyIt:r})};try{window.addEventListener("copy",o,{capture:!0,once:!0}),l().setOnNode(a,t.device),n.triggerBrowserCopy()}catch{await n.copySelectionToClipboard({environment:t,markdownLinkifyIt:r})}finally{var i;l().clear(t),window.removeEventListener("copy",o,{capture:!0}),null===(i=a.parentNode)||void 0===i||i.removeChild(a)}}({clipboardActions:e,environment:t,markdownLinkifyIt:a})}else{const e=await(0,a().jd)();await e({environment:t,stringValue:(0,u().r4)(m,h)})}i().D6({label:y})}},982979:(e,t,n)=>{n.d(t,{w:()=>m});n(898992),n(354520);var r=()=>n(242422),a=()=>n(221844),o=()=>n(145480),i=()=>n(179034),s=()=>n(798880),l=()=>n(201980),d=()=>n(534177),c=()=>n(942143),u=()=>n(44729),p=()=>n(384944),g=()=>n(244828),f=()=>n(305425);async function m(e){const{environment:t,spaceStore:n,copySourceData:m,copiedMessageLabel:h}=e,y=function(e){var t;const{environment:n,spaceStore:l,copySourceData:c}=e,m=l.id,h=null===(t=n.currentUser)||void 0===t?void 0:t.id;if(!h)return;const y=r().default.checkGate({gateName:"agent_generate_image"}),v=r().default.checkGate({gateName:"bullets_in_simple_tables_yuh"}),S=new(a().A)({name:c.name,isTemporaryData:!0}),x=n.idCreator.getSpaceIdCreatorSync(m),b=x.idInSavedSpace(i().ev),I=y?o().W.filter((e=>"image"!==e)):o().W,{performResult:w}=g().createAndCommit({userAction:`createTemporaryAgentCopyStore.${c.type}`,environment:n,canUndo:!1,perform:e=>{if("markdown"===c.type){const t=(0,f().a9)({markdown:c.markdown,pageId:b,spaceId:m,idCreator:x,actorPointer:{table:s().oo,id:h},citationFormat:"link",omitBlockTypes:I,simpleBulletsEnabled:v}),r=p().Wv({environment:n,type:"page",id:b,inMemoryRecordCache:S,transaction:e,spaceId:m,format:{page_small_text:!0}});return(0,f().HS)({environment:n,transaction:e,rootStore:r,blockOperations:t}),r}if("textValue"===c.type){const t=p().Wv({environment:n,type:"page",id:b,inMemoryRecordCache:S,transaction:e,spaceId:m,format:{page_small_text:!0}}),r=t.getContentStore(),a=p().Wv({environment:n,type:"text",inMemoryRecordCache:S,transaction:e,spaceId:m,properties:{title:c.textValue}});return u().NI({parentStore:r,childStore:a,transaction:e}),t}(0,d().HB)(c)}});return w}({environment:t,spaceStore:n,copySourceData:m}),v=(null==y?void 0:y.getContentStores())??[];let S;"textValue"===m.type?S=m.textValue:"markdown"===m.type?S=(0,l().x9d)(m.markdown):(0,d().HB)(m);const x=null==y?void 0:y.inMemoryRecordCache;x&&x.addCacheFallback(t.defaultRecordCache.inMemoryRecordCache),await(0,c().i)({environment:t,contentStores:v,textValue:S,parentStore:n,copiedMessageLabel:h}),x&&x.removeCacheFallback(t.defaultRecordCache.inMemoryRecordCache)}}}]);