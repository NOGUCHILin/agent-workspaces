"use strict";(globalThis.webpackChunknotion_next=globalThis.webpackChunknotion_next||[]).push([[51240],{482099:(e,t,r)=>{r.d(t,{p:()=>p,t:()=>g});var o=r(296540),a=()=>r(907258),n=()=>r(726637),i=()=>r(484714),s=()=>r(590526),c=()=>r(247584),l=()=>r(449412),d=()=>r(319625),u=()=>r(614949);function p(){const e=(0,i().v3)(),t=(0,o.useRef)(!1),r=(0,s().K8)((()=>a().default.state.renderPhase),[]),n=window.CLIENT_LOAD_TAG;(0,o.useEffect)((()=>{if(n&&!t.current&&"rendered"===r){t.current=!0;const{shouldShowError:r}=(0,u().X)(e);f({isRedirect:!1,isShowingError:r})}}),[n,r,e])}function g(){window.CLIENT_LOAD_TAG&&f({isRedirect:!0,isShowingError:!1})}async function f(e){const t=window.CLIENT_LOAD_TAG;try{await(0,c().httpRequest)({data:{tag:t,isRedirect:e.isRedirect,isShowingError:e.isShowingError,version:n().A.version},format:"json",keepAlive:!0,method:"POST",url:"/api/v3/recordClientLoadComplete"})}catch(r){const e=(0,d().A)(r);(0,l().Fg)(e)}}},683395:(e,t,r)=>{r.d(t,{z:()=>a});r(517642),r(658004),r(733853),r(845876),r(432475),r(515024),r(731698);class o extends(()=>r(757695))().Store{getInitialState(){return{pendingPages:new Map,inFlightPages:new Set}}registerPageForRemoteRoleVerification(e){if(this.state.inFlightPages.has(e.pageId))return;const t=new Map(this.state.pendingPages);t.set(e.pageId,e),this.setState({...this.state,pendingPages:t})}consumePendingPages(){const e=Array.from(this.state.pendingPages.values()),t=new Set(this.state.inFlightPages);for(const r of e)t.add(r.pageId);return this.setState({pendingPages:new Map,inFlightPages:t}),e}markPageComplete(e){const t=new Set(this.state.inFlightPages);t.delete(e),this.setState({...this.state,inFlightPages:t})}}const a=new o},773582:(e,t,r)=>{r.d(t,{I:()=>a,O:()=>n});var o=()=>r(143197);function a(e){const{cursors:t,rootStore:r}=e,a={};for(const o of t)for(const e of o.stack)for(const t of e)a[t.id]=t.index;o().A.setLimitParents(r,a)}function n(e){o().A.removeLimitParents(e.rootStore)}},851240:(e,t,r)=>{r.d(t,{Ay:()=>le,ys:()=>he});r(16280),r(944114),r(898992),r(354520),r(672577),r(430670),r(964979),r(814603),r(147566),r(198721);var o=r.n(r(625473)),a=r(296540),n=()=>r(907258),i=()=>r(59226),s=()=>r(726637),c=()=>r(17022),l=()=>r(908006),d=()=>r(484714),u=()=>r(590526),p=()=>r(105751),g=()=>r(929219),f=()=>r(391400),h=()=>r(711339),m=()=>r(246785),S=()=>r(267956),v=()=>r(887957),C=()=>r(165358),R=()=>r(591779),P=()=>r(785728),k=()=>r(68263),_=()=>r(388821),y=()=>r(179034),b=()=>r(161479),w=()=>r(449412),I=()=>r(319625),M=()=>r(496603),A=()=>r(806080),F=()=>r(763824),O=()=>r(498212),L=()=>r(534177),q=()=>r(561503),T=()=>r(773582),E=()=>r(466721),B=()=>r(666144),D=()=>r(659902),U=()=>r(255460),W=()=>r(865454),x=()=>r(374026),V=()=>r(866654),N=()=>r(466088),$=(r(581454),()=>r(700500)),H=()=>r(651124),K=()=>r(519831),z=()=>r(753812),J=()=>r(905388);async function X(e){if(!(0,J().vL)())return;if("all_views"===e.viewType){const t=e.recordMap,r=((null==t?void 0:t.getByTable(K().Vl).filter((({value:e})=>{var t;return(null==e||null===(t=e.value)||void 0===t||null===(t=t.format)||void 0===t?void 0:t.external_collection_type)===H().uO.Jira})))||[]).map((({value:e})=>(null==e?void 0:e.value)&&{id:e.value.parent_id,table:y().ev,spaceId:e.value.space_id})).filter(L().O9);for(const o of r)await z().callApi({eventName:"resyncJiraCollection",environment:e.environment,data:{pagePointer:o}});return}const t=e.pageStore,r=t.getType(),o=t.getFormat();r&&(0,$().Ef)(r)&&(0,J().MP)(null==o?void 0:o.app_config_uri)&&await z().callApi({eventName:"resyncJiraCollection",environment:e.environment,data:{pagePointer:t.pointer}})}var G=()=>r(303626),j=()=>r(683395),Q=()=>r(865085),Z=()=>r(369763),Y=()=>r(495074),ee=()=>r(968877),te=()=>r(836724),re=()=>r(92136),oe=()=>r(83573),ae=()=>r(606932),ne=()=>r(482099);function ie(e){performance.mark(`OPFS:useLoadPage:${e}`)}function se(e,t,r){return performance.measure(`OPFS:useLoadPage:${e}`,`OPFS:useLoadPage:${t}`,`OPFS:useLoadPage:${r}`)}let ce=!1;function le(e){return function(e){!function(e){const{pageStore:t,store:r}=e,{initialRequestCompleted:o,error:n}=(0,u().K8)((()=>({initialRequestCompleted:r.state.initialRequestCompleted,error:r.state.error})),[r]);(0,a.useEffect)((()=>{if(o&&!n)return Y().A.trackPage(t),()=>{Y().A.untrackPage(t)}}),[o,n,t])}(e);const{isCollectionInPage:t,updateIsCollectionInPage:r}=function(){const e=(0,d().v3)(),[t,r]=(0,a.useState)(!1),o=(0,a.useCallback)((r=>{var o;const{page:a,recordMap:n,inMemoryRecordCache:i}=r;if(t)return!0;const s=null===(o=i.getRecord({pointer:{table:"block",id:a.id,spaceId:a.spaceId},userId:e.currentUser.id}))||void 0===o?void 0:o.value;if(s)for(const e of n.getByTable("block")){var c,l,d;if(("collection_view"===(null===(c=e.value)||void 0===c||null===(c=c.value)||void 0===c?void 0:c.type)||"collection_view_page"===(null===(l=e.value)||void 0===l||null===(l=l.value)||void 0===l?void 0:l.type))&&s.parent_id!==(null===(d=e.value)||void 0===d||null===(d=d.value)||void 0===d?void 0:d.collection_id))return!0}return!1}),[e,t]);return{isCollectionInPage:t,updateIsCollectionInPage:(0,a.useCallback)((e=>{r(o(e))}),[o])}}(),o=(0,a.useRef)(null);(function(e){const{store:t,pageStore:r,observer:o}=e,n=(0,d().v3)(),{loading:m,endOfResultsReached:S,initialRequestCompleted:v,error:R}=(0,u().K8)((()=>({loading:t.state.loading,endOfResultsReached:t.state.endOfResultsReached,initialRequestCompleted:t.state.initialRequestCompleted,error:t.state.error})),[t]),b=ge(e),w=function(e){const{pageStore:t}=e,r=(0,d().v3)(),o=(0,d().Y0)(),n=Q().OPFSBootupRegistry.isEnabled,c=pe(e),l=ue(e),u=(0,a.useCallback)((async e=>{const{request:t,userId:r,abortSignal:o}=e;let a,n;ie("load-opfs-page-cache.start");try{var i;const e=await async function(e){const{userId:t,pageId:r,abortSignal:o}=e,a=(0,Z().getOPFSPageCacheInstance)();if(!a)return;if(!g().A.state.online)return;const n=Q().OPFSBootupRegistry.getPrefetchedPageRequest(r);return n&&"hit"===n.status?n.result:n&&"miss"===n.status?void 0:n&&"pending"===n.status?n.promise:a.readBuffer(t,r,o)}({userId:r,pageId:t.page.id,abortSignal:o});a=e,n=null===(i=a)||void 0===i?void 0:i.iterator.next().value}catch(R){a=void 0,n=void 0,R instanceof DOMException&&R.name}if(ie("load-opfs-page-cache.end"),se("load-opfs-page-cache","load-opfs-page-cache.start","load-opfs-page-cache.end"),null!=o&&o.aborted)throw new Error("Abort signal received");if(!a)throw new Error("No OPFS RecordMap found");if(!a.buffer||0===a.buffer.byteLength)throw new Error("No Valid OPFS RecordMap found");if(!n)throw new Error("Failed to extract first chunk from buffer");return{source:"local",localSource:"opfs",recordMap:_().RecordMapWithRole.create(n),iterator:a.iterator,metadata:a.metadata,metrics:a.metrics,isLast:1===a.metadata.totalChunks}}),[]),f=ge(e),m=(0,i().X)("skip_abort_remote_fetch_for_public_sites");return(0,a.useCallback)((async()=>{const e={page:{id:t.id,spaceId:t.getSpaceId()},cursor:{stack:[]},verticalColumns:s().A.isMobile},a=h().default.mark("required_redirect_metadata_duration"),i=await(0,p().getHtmlStreamQueueEntry)("requiredRedirectMetadata");if(i&&i.pageId===t.id){if(i.requiresRedirect&&i.redirectUrl){h().default.measure(a,{environment:r,data:{requires_redirect:!0,redirect_url:i.redirectUrl}}),(0,ne().t)();const e=new URL(i.redirectUrl);e.hash||(e.hash=window.location.hash),e.search||(e.search=window.location.search),window.location.href=e.toString(),await new Promise((()=>{}))}}else h().default.measure(a,{environment:r,data:{requires_redirect:!1}});try{return{firstPageChunkResult:await c({request:e,mode:"inMemoryOnly",isFirstChunk:!0})}}catch(R){}const d=ve(e),g=d?r.prefetcher.cache.getPrefetchStatus(d):void 0,S=Boolean(r.defaultRecordCache.persistedRecordCache)&&"success"!==g,v=new AbortController,k=new AbortController,_=new AbortController,b=[];n&&r.currentUser.id&&b.push(u({request:e,userId:r.currentUser.id,abortSignal:_.signal})),S&&b.push(c({request:e,mode:o.isAndroid?"inMemoryAndDiskCache":"inMemoryAndDiskCacheWithInexactPreload",isFirstChunk:!0,abortSignal:v.signal}));const w=l({request:e,headers:(0,P().WS)({recordId:t.id,spaceId:t.getSpaceId()}),abortSignal:k.signal});b.push(w),f.concurrentlyWithAsyncRequests();const I=await Promise.any(b),M="none"===I.recordMap.getRole({table:y().ev,id:t.id}),A=(0,N().w)(r);let F="";if("local"===I.source?(F=`${I.source}-${I.localSource} won`,"disk"===I.localSource?(M||m&&A||k.abort(F),_.abort(F)):"opfs"===I.localSource&&(v.abort(F),M||k.abort(F))):"remote"===I.source||"remoteV2"===I.source?(F=`${I.source} won`,v.abort(F),_.abort(F)):(0,L().HB)(I),C().logWithSampleRate({logMessage:{level:"info",from:"useLoadFirstPageChunk",type:"loserAborted",data:{spaceId:t.getSpaceId(),pageId:t.id,userId:r.currentUser.id,reason:F,miscDataToConvertToString:{abortedControllers:[..._.signal.aborted?["opfsAbortController"]:[],...v.signal.aborted?["diskAbortController"]:[],...k.signal.aborted?["remoteAbortController"]:[]].join(", "),permissionRole:I.recordMap.getRole({table:"block",id:t.id,spaceId:t.getSpaceId()})}}},samplePercentage:10}),"local"===I.source&&M)try{return{firstPageChunkResult:await w}}catch(R){}return"local"===I.source&&de({result:I,environment:r,pageStore:t}),{firstPageChunkResult:I}}),[f,o.isAndroid,c,l,u,t,r,n,m])}(e),M=function(e){const{pageStore:t}=e,r=(0,d().v3)(),o=pe(e),n=ue(e),i=ge(e);return(0,a.useCallback)((async e=>{const{firstPageChunkResult:a,dedupeSessionId:c}=e;if(Se(a)){let e=1;const o=a.iterator;let n=o.next();for(;!n.done;){e++;const s=n.value,c=_().RecordMapWithRole.create(s);await B()._O({environment:r,inMemoryRecordCache:t.inMemoryRecordCache,recordMap:c,debugSource:"PageLoadingContainer.OPFSPageCache"}),i.afterEachChunk({source:"local",localSource:"opfs",metadata:a.metadata,metrics:a.metrics,recordMap:c,iterator:o,isLast:a.metadata.totalChunks===e}),n=o.next()}return{chunkCount:a.metadata.totalChunks-1}}{let e=0,l=fe(a);for(;l&&l.length>0;){l=(await F().lX(l,10,(async l=>{const d={page:{id:t.id,spaceId:t.getSpaceId()},cursor:l,verticalColumns:s().A.isMobile};let u;try{u="local"===a.source?await o({request:d,mode:"inMemoryAndDiskCache",isFirstChunk:!1}):await n({request:d,headers:(0,P().WS)({cellId:"cellId"in l?l.cellId:void 0}),dedupeSessionId:c})}catch(R){u=me(a)?{source:"remoteV2",cursors:[],recordMap:_().RecordMapWithRole.create({}),dedupeSessionId:c}:"remote"===a.source?{source:a.source,cursor:{stack:[]},recordMap:_().RecordMapWithRole.create({})}:{source:a.source,localSource:a.localSource,cursor:{stack:[]},recordMap:_().RecordMapWithRole.create({}),didUseAgentInMemoryRecordCache:!1}}return"local"===u.source&&de({result:u,environment:r,pageStore:t}),i.afterEachChunk(u),e++,u}))).flatMap((e=>fe(e)??[]))}return{chunkCount:e}}}),[r,i,o,n,t])}(e),A=(0,i().X)("check_local_role_mismatch_on_page_load");if(m||S||v&&R)return;async function O(){t.setState({...t.state,loading:!0}),ae().A.markRequestFirstChunkStart();const e=performance.now();let a,i=!1;f().A.state.initialRenderCompleted||(i=!0,q().setSubMetric({name:"render_end_to_await_page_chunk_start",startTime:e=>{var t;return null===(t=e.render_start_to_render_end)||void 0===t?void 0:t.endTime},endTime:e}));try{var s;a=function(e){if(Q().OPFSBootupRegistry.isEnabled){const t=Q().OPFSBootupRegistry.getPrefetchedPageRequest(e);if(t&&"hit"===t.status&&t.result){const e=t.result.iterator.next().value;if(!e)return;return{source:"local",localSource:"opfs",recordMap:_().RecordMapWithRole.create(e),iterator:t.result.iterator,metadata:t.result.metadata,metrics:t.result.metrics,isLast:1===t.result.metadata.totalChunks}}}}(r.id);const e="none"===(null===(s=a)||void 0===s?void 0:s.recordMap.getRole({table:y().ev,id:r.id}));if(a&&!e)B()._O({environment:n,inMemoryRecordCache:r.inMemoryRecordCache,recordMap:a.recordMap,debugSource:"PageLoadingContainer.OPFSPageCache"});else{a=(await w()).firstPageChunkResult}}catch(R){return void D(R)}finally{re().y.deletePrefetchPageRequest(r.id)}const c="dedupeSessionId"in a?a.dedupeSessionId:void 0,d="string"==typeof c;if(f().A.state.initialRenderCompleted||f().A.setState({...f().A.state,isDeduplicatingLcpc:d}),!f().A.state.initialRenderCompleted){q().setSubMetric({name:"await_page_chunk_start_to_await_page_chunk_end",startTime:e=>{var t;return null===(t=e.render_end_to_await_page_chunk_start)||void 0===t?void 0:t.endTime},endTime:performance.now()}),q().updateOPFSMetadata({bootupRegistry:Q().OPFSBootupRegistry.opfsBootupRegistryMetadata}),"local"===a.source&&"opfs"===a.localSource&&(q().updateOPFSMetadata({preProcessFirstChunk:Q().OPFSBootupRegistry.preProcessFirstChunk}),q().updateOPFSMetricData({get_handle_duration:a.metrics.getHandle,get_file_duration:a.metrics.getFile,load_content_duration:a.metrics.getBuffer,read_duration:a.metrics.total,file_size:a.metrics.fileSize}));const e=n.prefetcher.cache;q().updateMetricData({page_chunk_source:a.source,local_source:"local"===a.source?a.localSource:void 0,page_chunk_prefetch:e.getPrefetchAnalytic(`loadCachedPageChunk(${r.id})`)})}const u={chunkSource:a.source,chunkLocalSource:"local"===a.source?a.localSource:void 0,isDeduplicatingLcpc:d};"local"===a.source&&"opfs"===a.localSource&&ae().A.updateOPFSMetrics({get_handle_duration:a.metrics.getHandle,get_file_duration:a.metrics.getFile,load_content_duration:a.metrics.getBuffer,read_duration:a.metrics.total,file_size:a.metrics.fileSize}),ae().A.markRequestFirstChunkEnd(u),"local"===a.source&&"opfs"===a.localSource&&(ae().A.updateOPFSMetadata({preProcessFirstChunk:Q().OPFSBootupRegistry.preProcessFirstChunk}),ae().A.updateOPFSMetrics({get_handle_duration:a.metrics.getHandle,get_file_duration:a.metrics.getFile,load_content_duration:a.metrics.getBuffer,read_duration:a.metrics.total})),null==o||o.startRecording(u),T(),await l().default.afterNextFlush(),b.afterEachChunk(a);let p=1;try{p+=(await M({firstPageChunkResult:a,dedupeSessionId:c})).chunkCount}catch(R){return void D(R)}const g={metricName:"load_all_page_chunks",startTime:e,endTime:performance.now()};if(E(),b.afterAllChunks({isInitialRender:i,loadAllPageChunksMetric:g,pageChunkSource:a.source,isDeduplicatingLcpc:d,chunkCount:p}),"local"===a.source&&("disk"===a.localSource||"opfs"===a.localSource)&&A){const e=a.recordMap.getRole({table:y().ev,id:r.id});(0,k().PW)(e)&&j().z.registerPageForRemoteRoleVerification({pageId:r.id,spaceId:r.getSpaceId(),localRole:e})}}function T(){t.setState({...t.state,initialRequestCompleted:!0})}function E(){t.setState({initialRequestCompleted:!0,ready:!0,loading:!1,endOfResultsReached:!0,error:void 0})}function D(e){t.setState({ready:!0,initialRequestCompleted:!0,loading:!1,endOfResultsReached:!1,error:(0,I().A)(e)})}c().e.withListenerIgnored((()=>{O().finally((()=>{Q().OPFSBootupRegistry.deletePrefetchedPageRequest(r.id)}))}))})({...e,updateIsCollectionInPage:r,scrollerRef:o}),function(e){const{store:t,scrollToBlockIds:r,onReady:o,onDone:n,pageStore:i}=e,s=(0,d().v3)();(0,a.useEffect)((()=>{let e;const a=M().Oo((()=>{r&&o&&(e=async function(e,t,r){t&&await U().NH(e,r,t)}(s,r,i))})),c=M().Oo((()=>{o&&l().default.afterNextFlush((()=>{l().default.afterNextFlush((async()=>{if(e){const t=performance.now();await(0,F().Vq)(e,5e3),f().A.state.initialRenderCompleted||q().updateMetricData({scroll_to_blocks_wait_time:performance.now()-t})}o()}))}))})),d=M().Oo((()=>{null==n||n()})),u=()=>{t.state.loading&&a(),t.state.ready&&c(),(t.state.endOfResultsReached||t.state.error)&&d()};return t.addListener(u),()=>{t.removeListener(u)}}),[n,o,i,r,t,s])}(e),function(e){const{store:t}=e,r=(0,u().K8)((()=>t.state.error),[t]),o=(0,u().O$)(g().e),n=(0,R().ZC)(o),i=void 0!==n&&(o&&!n);(0,a.useEffect)((()=>{i&&r&&t.reset()}),[i,t,r])}(e),function(){const e=(0,d().v3)(),t=(0,u().K8)((()=>{var e;return null===(e=n().default.state.mainEditorCurrentBlockStore)||void 0===e?void 0:e.id}),[]),r=(0,u().K8)((()=>n().default.state.currentUserRootStore),[]),o=(0,u().O$)(g().e),i=(0,R().ZC)(o),s=void 0!==i&&(o&&!i);(0,a.useEffect)((()=>{async function o(){const{route:o}=e.RouterStore.state,a=await ee().Ty({environment:e,request:{...o,type:"block-space",blockId:t,spaceId:"spaceId"in o?o.spaceId:void 0,slug:"slug"in o?o.slug:void 0,spaceDomain:"spaceDomain"in o?o.spaceDomain:void 0,requestedOnPublicDomain:"requestedOnPublicDomain"in o?o.requestedOnPublicDomain:void 0,isBot:!1}});if("failed"===a.type)return;const i=a.data;if(S().A.setState({publicPageData:i}),i.spaceId&&r){const e=r.getSpaceViewStores().find((e=>e.getSpaceId()===i.spaceId));e&&n().default.setState({...n().default.state,sidebarSpaceStore:e.getSpaceStore(),sidebarSpaceViewStore:e})}}s&&t&&o()}),[s,e,t,r])}();const{store:m}=e;return(0,u().K8)((()=>({ready:m.state.ready,error:m.state.error,initialRequestCompleted:m.state.initialRequestCompleted,endOfResultsReached:m.state.endOfResultsReached,isCollectionInPage:t,scrollerRef:o})),[m,t,o])}({...e,store:(0,u().uB)(e.store,m().A)})}function de(e){const{result:t,environment:r,pageStore:o}=e;"didUseAgentInMemoryRecordCache"in t&&t.didUseAgentInMemoryRecordCache||B()._O({environment:r,inMemoryRecordCache:o.inMemoryRecordCache,recordMap:t.recordMap,debugSource:"opfs"===t.localSource?"PageLoadingContainer.OPFSPageCache":"PageLoadingContainer.performLocalLoadPageChunk"})}function ue(e){const{pageStore:t}=e,r=(0,d().v3)();return(0,a.useCallback)((async e=>{const{request:o,headers:a,abortSignal:n,dedupeSessionId:i}=e,s=V().JQ(t),c=await V().Vn({environment:r,request:{...o,...s?{omitExistingRecordVersions:s}:{},...i?{dedupeSessionId:i}:{}},abortSignal:n,prefetchCacheKey:ve(o),headers:a});if(null!=n&&n.aborted)throw new Error("Abort signal received");if("success"===c.type){const e=_().RecordMapWithRole.create(c.data.recordMap),t=c.data;return{recordMap:e,cursors:t.cursors,dedupeSessionId:t.dedupeSessionId,source:"remoteV2"}}throw w().O8(c.error,{from:"useLoadRemotePageChunk",type:"pageLoadingError",data:{pageId:t.id,miscDataToConvertToString:{offline:c.offline,status:c.status,body:c.body}}}),new Error("No successful load result found.")}),[r,t])}function pe(e){const t=(0,d().v3)();return(0,a.useCallback)((async e=>{const{request:r,mode:o,isFirstChunk:a,abortSignal:n}=e;if("inMemoryOnly"!==o){const e=re().y.getPrefetchPageRequest(r.page.id);if(e&&"hit"===e.status&&e.response)return{source:"local",localSource:"inMemoryOnly"===e.response.mode?"memory":"disk",cursor:e.response.result.cursor,recordMap:_().RecordMapWithRole.create(e.response.result.recordMap),didUseAgentInMemoryRecordCache:!1};if(e&&"pending"===e.status){const t=await e.promise;return{source:"local",localSource:"inMemoryOnly"===t.mode?"memory":"disk",cursor:t.result.cursor,recordMap:_().RecordMapWithRole.create(t.result.recordMap),didUseAgentInMemoryRecordCache:!1}}}const i=(0,W().getAgentPreviewWrapper)(t),s=i.isPreviewingRecord({table:y().ev,id:r.page.id,spaceId:r.page.spaceId},t.currentUser.id);ie("localLoadPageChunk.start");const c=await G().N.measure("localLoadPageChunk",r.page.id,(()=>V().s4({mode:o,environment:t,request:r,isFirstChunk:a,abortSignal:n,inMemoryRecordCache:s?i.getInMemoryRecordCache():void 0})));ie("localLoadPageChunk.end");se("localLoadPageChunk","localLoadPageChunk.start","localLoadPageChunk.end");if(null!=n&&n.aborted)throw new Error("Abort signal received");const l=_().RecordMapWithRole.create(c.recordMap);return{source:"local",localSource:"inMemoryOnly"===o?"memory":"disk",cursor:c.cursor,recordMap:l,didUseAgentInMemoryRecordCache:Boolean(s)}}),[t])}function ge(e){const{pageStore:t,store:r,scrollToDiscussionId:o,scrollerRef:n,scrollToPosition:i,scrollToBlockIds:s,updateIsCollectionInPage:c,pageVisitStore:u,disableSideEffects:p,observer:g}=e,f=(0,d().v3)(),m=(0,a.useCallback)((()=>{p||E().updatePageVisits(f,{blockStore:t,pageVisitStore:u,incremental:!1}).catch((()=>{}))}),[p,f,t,u]),S=(0,a.useCallback)((e=>{if(p)return;const a=function(e){return Se(e)?e.isLast:0===fe(e).length}(e),d=Se(e)?void 0:fe(e);a||l().default.afterNextFlush((()=>{if(r.state.ready)return;const e=!o||(t=o,Boolean((0,x().V)({discussionId:t})));var t;const a=!0===function(e){const{scrollerRef:t,scrollToPosition:r}=e;if(null===t.current)return;const o=(0,v().NM)(t.current);return!o||!(0,A().Et)(r)||r<=o.scrollHeight-o.clientHeight}({scrollerRef:n,scrollToPosition:i})&&function(e){return!e||te().T.findSelectablesFromIds(e).length===e.length}(s)&&e;a&&r.setState({...r.state,ready:!0})})),c({page:{id:t.id,spaceId:t.getSpaceId()},recordMap:e.recordMap,inMemoryRecordCache:t.inMemoryRecordCache}),f.currentUser.isLoggedIn()&&(oe().A.addFromRecordMapWithRole(e.recordMap),oe().A.isEmpty()||D().l({environment:f})),f.currentUser.isLoggedIn()&&X({environment:f,recordMap:e.recordMap,viewType:"all_views"}),d&&T().I({rootStore:t,cursors:d})}),[p,f,t,s,o,i,n,r,c]),C=(0,a.useCallback)((e=>{p||("personal_home_page"!==t.getType()&&async function(e){const{blockPointer:t,environment:r}=e;r.LocalBacklinkStore.initializeBacklinks({block:{id:t.id,spaceId:(0,b().e)(t.spaceId)},currentUserId:r.currentUser.id,environment:r});try{await r.LocalBacklinkStore.awaitLoaded(t.id)}catch(o){}}({environment:f,blockPointer:t.pointer}),f.currentUser.isLoggedIn()&&X({environment:f,pageStore:t,viewType:"collection_view_full_page"}),null==g||g.onLastChunkLoaded(f),h().default.measure(e.loadAllPageChunksMetric,{environment:f,data:{load_type:e.isInitialRender?"initial":"navigation",page_type:t.getType()||"undefined",page_chunk_source:e.pageChunkSource,is_deduplicating_lcpc:e.isDeduplicatingLcpc,chunk_count:1===e.chunkCount?"1":"2_or_more",chunk_count_raw:e.chunkCount}}))}),[p,f,t,g]);return(0,a.useMemo)((()=>({concurrentlyWithAsyncRequests:m,afterEachChunk:S,afterAllChunks:C})),[m,S,C])}function fe(e){return me(e)?e.cursors.filter((e=>!he(e))):[e.cursor].filter((e=>!he(e)))}function he(e){return!e||0===e.stack.length}function me(e){return"remoteV2"===e.source}function Se(e){return"local"===e.source&&"opfs"===e.localSource}function ve(e){if(function(e){return!e.cursor||0===e.cursor.stack.length}(e))return`loadCachedPageChunk(${e.page.id})`;{const t=(0,O().gB)(o()(e.cursor));return`loadCachedPageChunk(${e.page.id})-${t}`}}(0,r(852832).exposeDebugValue)("toggleLogLocalPageLoadFailures",(()=>{ce=!ce,console.info(ce?"Local page load error logging enabled":"Local page load error logging disabled")}))}}]);